<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>修仙RPG｜洞府（手機優先）</title>
  <style>
    :root{
      --bg:#0b1024; --bg2:#0e1536; --panel:#131a3f; --panel-2:#0f1534; --muted:#9aa3b2; --text:#eaf2ff;
      --accent:#8b5cf6; --accent2:#22d3ee; --hp:#ef4444; --mp:#3b82f6; --bar:#334155; --ok:#22c55e; --warn:#f59e0b;
      --gold:#b98c4b; --gold-2:#7a5b31; --radius:16px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%; margin:0; font-family:"Microsoft JhengHei",system-ui,Segoe UI,Roboto,sans-serif; color:var(--text); background:var(--bg);}  

    /* 舞台：統一手機寬度 */
    .stage{ position:fixed; inset:0; display:grid; justify-items:center; align-items:start; overflow:auto; padding-top:max(6px, env(safe-area-inset-top)); }
    .app{ width:min(420px, 100svw); max-height:100svh; background:linear-gradient(180deg, var(--bg2), var(--panel)); border-radius:var(--radius); box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden; }

    header{ position:relative; padding:19px 7px 10px; background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.08); }
    .topbar{ display:flex; align-items:center; justify-content:center; }
    .left-controls{ position:absolute; left:10px; top:8px; display:flex; align-items:center; gap:8px; }
    .back{ position:relative; padding:6px 6px; border-radius:8px; font-weight:900; letter-spacing:2px; background:#2324d1; color:#fff; border:1px solid rgba(255,255,255,25); cursor:pointer; }
    .pvp-toggle{ padding:6px 7px; border-radius:8px; font-weight:900; letter-spacing:2px; border:1px solid rgba(255,255,255,25); cursor:pointer; background:#374151; color:#e5e7eb; }
    .pvp-toggle.on{ background:#b91c1c; color:#fff; }
    .def-toggle{ padding:6px 8px; border-radius:8px; font-weight:900; letter-spacing:2px; border:1px solid rgba(255,255,255,25); cursor:pointer; background:#374151; color:#e5e7eb; font-size:12px; }
    .def-toggle.on{ background:#b91c1c; color:#fff; }
    .title{ font-weight:900; letter-spacing:6px; color:#c7d2fe; }
    /* 洞府戰力徽章（置於標題右側） */
    .power-badge{
      position:absolute; right:10px; top:8px;
      display:flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:10px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18);
      font-size:12px;
    }
    .power-ico{ font-size:14px; line-height:1 }
    .power-text{ opacity:.95; }
    .power-val{ font-weight:900; min-width:18px; text-align:right; }


    .pbox{ display:block; margin-top:6px; }
    .avatar{ width:40px; height:40px; border-radius:50%; object-fit:cover; background:#222; border:2px solid rgba(255,255,255,.15); }
    /* pinfo：左右兩欄；左欄放「頭像+名字+等級」與「開關列」，右欄放資源板 */
    .pinfo{ display:grid; grid-template-columns:auto 1fr; align-items:end; gap:6px; }
    .prow{ display:flex; align-items:center; gap:6px; }
    .phead{ display:flex; align-items:center; gap:10px; } /* 新增：頭像與名字同列 */
    .pname{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .plv{ font-size:12px; opacity:.9; }


    /* 資源板：有框線、雙列整齊排列 */
    .res-board{
      display:grid;
      grid-template-columns:repeat(3, max-content);
      gap:6px 32px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:10px;
      background:rgba(255,255,255,.06);
      justify-self:end;
    }
    .res-item{ display:flex; align-items:center; gap:2px; font-size:12px; }
    .res-label{ opacity:.95; }
    .res-val{ font-weight:800; }

    .bars{ display:grid; gap:6px; padding:8px 10px 0; }
    /* 把右側數字那一欄拿掉 → 兩欄：標籤 + 進度條（左欄自動吃字寬，避免換行） */
    .stat-row{ display:grid; grid-template-columns:max-content 1fr; align-items:center; gap:8px; }
    .label{ font-size:12px; opacity:.9; text-align:right; white-space:nowrap; }
    .num{ font-size:12px; text-align:right; } /* 保留定義，不再使用 */
    .prog{ height:14px; background:#1f273a; border-radius:999px; position:relative; overflow:hidden; box-shadow: inset 0 2px 0 rgba(255,255,255,06), inset 0 -2px 0 rgba(0,0,0,25); }
    .fill{ height:100%; width:0%; }
    .fill.hp{ background:linear-gradient(90deg,#ef4444,#b91c1c); }
    .fill.mp{ background:linear-gradient(90deg,#3b82f6,#1d4ed8); }
    .fill.fort{ background:linear-gradient(90deg,#22c55e,#16a34a); }
    /* 能量條中央文字（覆蓋在條上） */
    .prog-txt{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:900; text-shadow:0 1px 2px rgba(0,0,0,65); pointer-events:none; }





    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; padding:12px; }
    .cell{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:12px; display:grid; gap:8px; align-items:center; min-height:86px; cursor:pointer; }
    .cell .name{ font-weight:900; letter-spacing:2px; }
    .cell .sub{ font-size:12px; color:var(--muted); }
    .cell.disabled{ opacity:.6; filter:saturate(.7); }

    footer{ padding:8px 10px 12px; text-align:center; color:#94a3b8; font-size:12px; }
  </style>
</head>
<body>
  <div class="stage">
    <div class="app">
      <header>
        <div class="topbar">
          <div class="left-controls">
            <button id="btnBackCity" class="back" title="回主城">回主城</button>
            <button id="btnPvpToggle" class="pvp-toggle" aria-pressed="false" title="PVP：關">PVP</button>
            <button id="btnDefendToggle" class="def-toggle" aria-pressed="false" title="參與防守：關">參與防守</button>
          </div>
          <div class="title">洞 府</div>
          <div class="power-badge" id="cavePowerBox">
            <span class="power-ico">⚔</span>
            <span class="power-text">洞府戰力</span>
            <span class="power-val" id="uiCavePower">0</span>
          </div>
        </div>



          <div class="pbox">
            <div class="pinfo">
              <!-- 左欄：頭像 + 名稱 + 等級（同一列） -->
              <div class="prow phead">
                <img id="uiAvatar" class="avatar" alt="avatar" />
                <div id="uiName" class="pname">—</div>
                <div class="plv">LV.<span id="uiLv">1</span></div>
              </div>

              <!-- 右側：資源板（雙列、含框線） -->
              <div class="res-board" id="resBoard">
                <!-- 第1列：靈石 / 木 / 糧 -->
                <div class="res-item"><span class="res-label">靈石:</span><span class="res-val" id="uiStone">0</span></div>
                <div class="res-item"><span class="res-label">木:</span><span class="res-val" id="uiWood">0</span></div>
                <div class="res-item"><span class="res-label">糧:</span><span class="res-val" id="uiFood">0</span></div>
                <!-- 第2列：水 / 礦 / 佔位（維持 3 欄對齊） -->
                <div class="res-item"><span class="res-label">水:</span><span class="res-val" id="uiWater">0</span></div>
                <div class="res-item"><span class="res-label">礦:</span><span class="res-val" id="uiOre">0</span></div>
                <div style="width:1px;height:1px;"></div>
              </div>
            </div>
          </div>



      </header>

      <div class="bars">
        <div class="stat-row">
          <div class="label">洞府防城值：</div>
          <div class="prog"><div class="fill fort" id="barFort"></div><div class="prog-txt" id="txtFort">2000/2000</div></div>
        </div>
        <div class="stat-row">
          <div class="label">氣血：</div>
          <div class="prog"><div class="fill hp" id="barHp"></div><div class="prog-txt" id="txtHp">--/--</div></div>
        </div>
        <div class="stat-row">
          <div class="label">真元：</div>
          <div class="prog"><div class="fill mp" id="barMp"></div><div class="prog-txt" id="txtMp">--/--</div></div>
        </div>
      </div>



      <div class="grid" id="zone">
        <div class="cell" data-act="compose">
          <div class="name">合成</div>
          <div class="sub">材料合成、符篆、丹藥…（施工中）</div>
        </div>
        <div class="cell" data-act="enhance">
          <div class="name">強化</div>
          <div class="sub">武器/飾品強化（施工中）</div>
        </div>
        <div class="cell" data-act="pet">
          <div class="name">招募大廳</div>
          <div class="sub">孵化、培養、出戰（施工中）</div>
        </div>
        <div class="cell" data-act="farm">
          <div class="name">軍隊</div>
          <div class="sub">播種、澆灌、採收（施工中）</div>
        </div>
        <div class="cell disabled" data-act="reserved">
          <div class="name">—</div>
          <div class="sub">預留空位（未來擴充）</div>
        </div>
      </div>

      <footer>※ 本頁已與主城共用角色資料與雲端 API。進出會即時同步。</footer>
    </div>
  </div>

  <!-- Firebase（compat）—為了可獨立開頁，也補上初始化；若已在上一頁初始化，會直接重用。 -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- 專案共用腳本（與主城一致） -->
  <script src="stats.js"></script>
  <script src="items.js"></script>
  <script src="equip.js"></script>
  <script src="auth.js"></script>
  <!-- 招募相關：怪物資料 / 地圖資料（判別 BOSS）、洞府招募模組 -->
  <script src="monsters.js"></script>
  <script src="map-data.js"></script>
  <script src="洞府招募.js"></script>


  <script>
  (function(){
    // ===== Firebase 初始化（重用或初始化第一個 app） =====
    try{
      var _cfg = { apiKey: "AIzaSyBvKmn0jCTS_jIgEYOuQjc8vyYU40Q5F3I", authDomain: "stellarblue-system.firebaseapp.com", databaseURL: "https://stellarblue-system-default-rtdb.firebaseio.com", projectId: "stellarblue-system", storageBucket: "stellarblue-system.firebasestorage.app", messagingSenderId: "803212433649", appId: "1:803212433649:web:887080d10a51d533b23150", measurementId: "G-YY94484DV9" };
      if (!firebase.apps || firebase.apps.length === 0) { firebase.initializeApp(_cfg); }
      window.DB = firebase.database();
    }catch(e){}


    var state = { player: null };
    function q(id){ return document.getElementById(id); }

    function render(p){
      if(!p) return;
      var avatarUrl = (p.avatar && p.avatar.url) ? p.avatar.url : (window.Auth && Auth.defaultAvatar ? Auth.defaultAvatar(p.element || 'none') : '');
      var av = q('uiAvatar'); if(av) av.src = avatarUrl;
      var nm = q('uiName'); if(nm) nm.textContent = p.name || '';
      var lv = q('uiLv'); if(lv) lv.textContent = p.level || 1;

      // === 貨幣與資源（給洞府顯示） ===
      // 兼容舊存檔：若沒有 resources，給預設初始 100。
      if (!p.currencies) { p.currencies = { stone: 0, diamond: 0 }; }
      if (!p.resources)  { p.resources  = { ore:100, wood:100, food:100, water:100 }; }

      var elStone = q('uiStone'); if (elStone) elStone.textContent = (p.currencies.stone || 0);
      var elOre   = q('uiOre');   if (elOre)   elOre.textContent   = (p.resources.ore  || 0);
      var elWood  = q('uiWood');  if (elWood)  elWood.textContent  = (p.resources.wood || 0);
      var elFood  = q('uiFood');  if (elFood)  elFood.textContent  = (p.resources.food || 0);
      var elWater = q('uiWater'); if (elWater) elWater.textContent = (p.resources.water|| 0);

      // 重新計算上限（含裝備加成）
      var base  = (typeof derivedFrom === 'function') ? derivedFrom(p) : {};
      var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
      var hpMax = (base['氣血上限'] || 0) + (bonus['氣血上限'] || 0);
      var mpMax = (base['真元上限'] || 0) + (bonus['真元上限'] || 0);

      if (!p.hp) { p.hp = { cur: hpMax, max: hpMax }; } else { p.hp.max = hpMax; p.hp.cur = Math.max(0, Math.min(p.hp.cur == null ? hpMax : p.hp.cur, hpMax)); }
      if (!p.mp) { p.mp = { cur: mpMax, max: mpMax }; } else { p.mp.max = mpMax; p.mp.cur = Math.max(0, Math.min(p.mp.cur == null ? mpMax : p.mp.cur, mpMax)); }

      // === 洞府防城值（條+數字）預設 2000/2000；舊存檔補齊 ===
      if (!p.fort) { p.fort = { cur: 2000, max: 2000 }; }
      else {
        p.fort.max = (p.fort.max == null ? 2000 : p.fort.max);
        p.fort.cur = (p.fort.cur == null ? p.fort.max : Math.max(0, Math.min(p.fort.cur, p.fort.max)));
      }

      // === PVP 開關（舊存檔補齊 + UI 同步） ===
      if (p.pvp !== true && p.pvp !== false) { p.pvp = false; }
      var pbtn = q('btnPvpToggle');
      if (pbtn){
        if (p.pvp){
          if (pbtn.classList) pbtn.classList.add('on');
          pbtn.setAttribute('aria-pressed','true');
          pbtn.title = 'PVP：開';
        }else{
          if (pbtn.classList) pbtn.classList.remove('on');
          pbtn.setAttribute('aria-pressed','false');
          pbtn.title = 'PVP：關';
        }
      }

      // === 參與防守 開關（舊存檔補齊 + UI 同步） ===
      if (p.defend !== true && p.defend !== false) { p.defend = false; }
      var dbtn = q('btnDefendToggle');
      if (dbtn){
        if (p.defend){
          if (dbtn.classList) dbtn.classList.add('on');
          dbtn.setAttribute('aria-pressed','true');
          dbtn.title = '參與防守：開';
        }else{
          if (dbtn.classList) dbtn.classList.remove('on');
          dbtn.setAttribute('aria-pressed','false');
          dbtn.title = '參與防守：關';
        }
      }

      // === 洞府戰力（只在參與防守=開 時，計入玩家個人戰力） ===
      var powEl = q('uiCavePower');
      if (powEl){
        var final = {}, k;
        for (k in base){ if (Object.prototype.hasOwnProperty.call(base,k)) final[k] = Number(base[k]||0); }
        for (k in bonus){ if (Object.prototype.hasOwnProperty.call(bonus,k)) final[k] = (final[k]||0) + Number(bonus[k]||0); }
        var score = 0;
        for (k in final){
          if (!Object.prototype.hasOwnProperty.call(final,k)) continue;
          var v = Number(final[k]||0); if (isNaN(v)) continue;
          if (k.indexOf('氣血上限') !== -1) score += Math.floor(v/5);
          else if (k.indexOf('真元上限') !== -1) score += Math.floor(v/10);
          else score += v;
        }
        powEl.textContent = p.defend ? Math.max(0, score|0) : 0;
      }

      // 進度條寬度
      var bft = q('barFort'); if(bft) bft.style.width = (p.fort.max ? ((p.fort.cur / p.fort.max) * 100).toFixed(1) : 0) + '%';
      var bhp = q('barHp');  if(bhp)  bhp.style.width = (p.hp.max   ? ((p.hp.cur   / p.hp.max)   * 100).toFixed(1) : 0) + '%';
      var bmp = q('barMp');  if(bmp)  bmp.style.width = (p.mp.max   ? ((p.mp.cur   / p.mp.max)   * 100).toFixed(1) : 0) + '%';

      // 條上置中文字
      var tft = q('txtFort'); if(tft) tft.textContent = (p.fort.cur || 0) + '/' + (p.fort.max || 0);
      var thp = q('txtHp');   if(thp) thp.textContent = (p.hp.cur   || 0) + '/' + (p.hp.max   || 0);
      var tmp = q('txtMp');   if(tmp) tmp.textContent = (p.mp.cur   || 0) + '/' + (p.mp.max   || 0);
    }



    function saveNow(){ if (window.Auth && Auth.saveCharacter && state.player) { try{ Auth.saveCharacter(state.player); }catch(e){} } }

    // 進洞府：寫一筆活動紀錄（便於後續統計）
    function logEnter(){
      try{
        var u = (window.Auth && Auth.currentUser) ? Auth.currentUser() : null;
        if (u && u.username && window.DB && DB.ref) {
          DB.ref('activity/cave/' + u.username + '/lastEnter').set(Date.now());
        }
      }catch(e){}

      // 同步到角色資料（logs.lastEnterCave）
      try{
        var p = state.player; if(!p) return;
        p.logs = p.logs || {}; p.logs.lastEnterCave = Date.now();
        saveNow();
      }catch(e){}
    }

function wire(){
  var back = document.getElementById('btnBackCity');
  if (back){ back.addEventListener('click', function(){ location.href='game.html'; }); }

  var pvp = document.getElementById('btnPVP'); 
  if(pvp){ pvp.addEventListener('click', function(){
    if (!state.player) return;
    state.player.pvp = !state.player.pvp;
    var on = !!state.player.pvp;
    this.classList.toggle('on', on);
    this.textContent = on ? 'PVP' : 'PVP';
    saveNow();
  });}

  var def = document.getElementById('btnDefend'); 
  if(def){ def.addEventListener('click', function(){
    if (!state.player) return;
    state.player.defend = !state.player.defend;
    var on = !!state.player.defend;
    this.classList.toggle('on', on);
    this.textContent = on ? '參與防守' : '參與防守';
    saveNow();
  });}

  // 區域按鈕：改成能開啟「招募大廳」
  var zone = document.getElementById('zone');
  if (zone){
    zone.addEventListener('click', function(e){
      var cell = e.target.closest('.cell'); if(!cell) return;
      var act = cell.getAttribute('data-act') || '';
      var nm  = cell.querySelector('.name'); 
      var title = nm? nm.textContent.trim() : ('['+act+']');

      // 招募大廳（原 data-act="pet"）
      if (act === 'pet'){
        if (window['洞府招募'] && typeof window['洞府招募'].open === 'function'){
          window['洞府招募'].open({
            getPlayer: function(){ return state.player || null; },
            save:      function(){ try{ saveNow(); }catch(_e){} }
          });
        }else{
          alert('招募模組未載入。');
        }
        return;
      }

      // 其他仍維持「施工中」提示
      alert('「' + title + '」功能施工中，敬請期待！');
    });
  }
}


    // ===== 啟動：帶入玩家資料並渲染（對齊野外地圖） =====
    window.addEventListener('DOMContentLoaded', function(){
      var u = (window.Auth && Auth.currentUser) ? Auth.currentUser() : null;
      if (!u) { location.href = 'index.html'; return; }

      // 取本機快取與雲端資料，選更新的
      var fromCache = (window.Auth && Auth.getCharacter) ? Auth.getCharacter() : null;
      function afterLoaded(fromCloud){
        var a = (fromCache && fromCache._updatedAt) ? fromCache._updatedAt : 0;
        var b = (fromCloud && fromCloud._updatedAt) ? fromCloud._updatedAt : 0;
        var p = (b >= a ? fromCloud : fromCache) || fromCache || fromCloud || null;
        if (!p) { location.href = 'index.html'; return; }
        state.player = p;

        // 掛上裝備模組（供 getBonuses 使用）
        if (window.Equip && Equip.mount) {
          Equip.mount({
            getPlayer: function(){ return state.player; },
            save:      function(){ try{ if (window.Auth && Auth.saveCharacter && state.player){ Auth.saveCharacter(state.player); } }catch(_){ } },
            recalc:    function(){ render(state.player); },
            log:       function(t){ try{ console.log(t); }catch(_){ } }
          });
        }

        render(p);
        logEnter();
        wire();

        // 掛上裝備模組，讓洞府能讀到玩家、計算加成、觸發存檔/重算
        try{
          if (window.Equip && Equip.mount) {
            Equip.mount({
              getPlayer: function(){ return state.player; },
              save:      function(){ try{ if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(state.player); }catch(_){ } },
              recalc:    function(){ render(state.player); },
              log:       function(t){ if(window.console) console.log(t); }
            });
          }
        }catch(_){}

        // 離開頁面時自動存檔
        try{
          window.addEventListener('beforeunload', function(){
            try{ if (state.player && window.Auth && Auth.saveCharacter) { Auth.saveCharacter(state.player); } }catch(_){}
          });
        }catch(_){}
      }

      if (window.Auth && Auth.loadCharacter) {
        try{
          Auth.loadCharacter().then(function(ch){ afterLoaded(ch); }).catch(function(){ afterLoaded(fromCache); });
        }catch(e){ afterLoaded(fromCache); }
      } else {
        afterLoaded(fromCache);
      }
    });
  })();
  </script>
</body>
</html>
