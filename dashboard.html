<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Stellarblueè¡Œå‹•ç¥•æ›¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body {
font-family: "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 50%, #0f1419 100%);
min-height: 100vh;
margin: 0;
padding: 0;
color: #e8eaed;
}

/* æ˜Ÿç©ºèƒŒæ™¯ */
.stars {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
z-index: -1;
}
.star {
position: absolute;
background: #3b82f6;
border-radius: 50%;
animation: twinkle 3s infinite ease-in-out;
}
.star:nth-child(odd) {
animation-delay: 1s;
background: #60a5fa;
}
.star:nth-child(3n) {
animation-delay: 2s;
background: #93c5fd;
}
@keyframes twinkle {
0%, 100% { opacity: 0.3; transform: scale(1); }
50% { opacity: 1; transform: scale(1.2); }
}

/* ä¸»è¦å…§å®¹å€å¡Š */
.main-content {
width: 94vw;
max-width: 450px;
margin: 7vw auto 0 auto;
padding: 7vw 4vw 6vw 4vw;
background: rgba(20, 25, 35, 0.95);
border-radius: 15px;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 16px rgba(59, 130, 246, 0.1);
border: 1px solid rgba(59, 130, 246, 0.2);
backdrop-filter: blur(10px);
}

/* é é¢æ¨™é¡Œ */
.page-title {
font-size: 1.45rem;
font-weight: bold;
color: #3b82f6;
margin-bottom: 1.1em;
letter-spacing: 2px;
text-align: center;
text-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
}

.page-title::before {
content: "â­";
font-size: 1.8rem;
filter: drop-shadow(0 2px 8px rgba(59, 130, 246, 0.4));
}

/* ç©å®¶ç‹€æ…‹é¡¯ç¤º */
.player-status {
background: rgba(59, 130, 246, 0.1);
border: 1px solid rgba(59, 130, 246, 0.3);
border-radius: 10px;
padding: 1em;
margin-bottom: 1.5em;
display: flex;
justify-content: space-between;
align-items: center;
}

.player-info {
display: flex;
gap: 1em;
align-items: center;
}

.player-avatar {
width: 40px;
height: 40px;
background: linear-gradient(135deg, #3b82f6, #1e40af);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2em;
}

.player-details h3 {
margin: 0;
color: #60a5fa;
font-size: 1.1em;
}

.player-stats {
font-size: 0.9em;
color: #d1d5db;
display: flex;
gap: 1em;
}

.sync-status {
font-size: 0.8em;
padding: 0.3em 0.6em;
border-radius: 20px;
background: rgba(34, 197, 94, 0.2);
color: #22c55e;
border: 1px solid rgba(34, 197, 94, 0.3);
}

.sync-status.syncing {
background: rgba(245, 158, 11, 0.2);
color: #f59e0b;
border-color: rgba(245, 158, 11, 0.3);
}

.sync-status.error {
background: rgba(239, 68, 68, 0.2);
color: #ef4444;
border-color: rgba(239, 68, 68, 0.3);
}

/* é€šçŸ¥çœ‹æ¿ */
.notice-board {
background: rgba(30, 64, 175, 0.1);
border-radius: 10px;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
border: 1px solid rgba(59, 130, 246, 0.3);
padding: 1.2em 1em 1em 1em;
max-height: 240px;
overflow-y: auto;
margin-bottom: 2.2em;
border-left: 6px solid #3b82f6;
}

/* é€šçŸ¥é …ç›® */
.notice-item {
margin-bottom: 1.2em;
}

/* é€šçŸ¥æ¨™é¡Œ */
.notice-title {
font-weight: 700;
color: #60a5fa;
font-size: 1.08em;
margin-bottom: 0.3em;
}

/* é€šçŸ¥å…§å®¹ */
.notice-content {
color: #d1d5db;
font-size: 0.99em;
line-height: 1.7;
margin-left: 0.5em;
}

/* æŒ‰éˆ•ç¾¤çµ„ */
.btn-group {
display: flex;
flex-wrap: wrap;
gap: 0.8em;
justify-content: center;
margin-bottom: 1.5em;
}

/* åŠŸèƒ½æŒ‰éˆ• */
.func-btn {
flex: 1 1 40%;
min-width: 105px;
padding: 0.85em 0;
background: linear-gradient(90deg, #3b82f6 0%, #1e40af 100%);
color: #fff;
border: none;
border-radius: 8px;
font-size: 1.07rem;
font-weight: 600;
letter-spacing: 1px;
cursor: pointer;
box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
transition: all 0.3s ease;
}

.func-btn:hover {
background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%);
transform: translateY(-2px);
box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
}

/* æ’è¡Œæ¦œæŒ‰éˆ• - ç¨ç«‹æ”¾ç½® */
.ranking-btn {
width: 100%;
padding: 1em 0;
background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
color: #fff;
border: none;
border-radius: 10px;
font-size: 1.1rem;
font-weight: 700;
letter-spacing: 1px;
cursor: pointer;
margin-bottom: 1.5em;
box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
gap: 0.5em;
}

.ranking-btn:hover {
background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
transform: translateY(-3px);
box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
}

/* ç™»å‡ºæŒ‰éˆ• */
.logout-btn {
width: 100%;
padding: 16px 0;
background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
color: #fff;
border: none;
border-radius: 8px;
font-size: 1.18rem;
font-weight: 600;
letter-spacing: 1px;
cursor: pointer;
box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
transition: all 0.3s ease;
margin-top: 1em;
}

.logout-btn:hover {
background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
transform: translateY(-2px);
box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
}

/* å½ˆçª—æ¨£å¼ */
.modal-bg {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
z-index: 999;
justify-content: center;
align-items: center;
backdrop-filter: blur(10px);
}

.modal-bg.active {
display: flex;
}

/* æ¨¡æ…‹å®¹å™¨ */
.modal {
background: rgba(20, 25, 35, 0.98);
border: 1px solid rgba(59, 130, 246, 0.3);
border-radius: 15px;
min-width: 300px;
max-width: 600px;
width: 90vw;
box-shadow: 0 20px 60px rgba(0,0,0,0.5);
padding: 0;
position: relative;
animation: modalSlideIn 0.3s ease-out;
display: flex;
flex-direction: column;
max-height: 85vh;
overflow: hidden;
backdrop-filter: blur(15px);
}

@keyframes modalSlideIn {
from {
  transform: scale(0.9) translateY(-20px);
  opacity: 0;
}
to {
  transform: scale(1) translateY(0);
  opacity: 1;
}
}

/* æ¨¡æ…‹æ¨™é¡Œå€ */
.modal-header {
padding: 1.2em 1.5em;
background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(30, 64, 175, 0.2) 100%);
border-radius: 15px 15px 0 0;
font-weight: bold;
color: #60a5fa;
font-size: 1.2em;
letter-spacing: 1px;
display: flex;
justify-content: space-between;
align-items: center;
border-bottom: 2px solid rgba(59, 130, 246, 0.3);
}

/* æ¨¡æ…‹é—œé–‰æŒ‰éˆ• */
.modal-close {
background: #ef4444;
border: none;
border-radius: 50%;
width: 35px;
height: 35px;
display: flex;
justify-content: center;
align-items: center;
color: #fff;
font-size: 1.2em;
font-weight: bold;
cursor: pointer;
transition: all 0.2s ease;
}

.modal-close:hover {
background: #dc2626;
transform: scale(1.1);
}

/* æ¨¡æ…‹å…§å®¹å€ */
.modal-body {
padding: 1.5em;
overflow-y: auto;
flex: 1 1 auto;
color: #e8eaed;
font-size: 1em;
line-height: 1.6;
}

/* è·‘é¦¬ç‡ˆå®¹å™¨ */
.marquee-container {
width: 100%;
overflow: hidden;
background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
border-radius: 10px;
margin-bottom: 1.5em;
padding: 0.8em 0;
border: 2px solid rgba(59, 130, 246, 0.3);
}

.marquee-content {
display: inline-block;
white-space: nowrap;
animation: marquee 30s linear infinite;
color: #60a5fa;
font-weight: 600;
}

@keyframes marquee {
0% { transform: translateX(100%); }
100% { transform: translateX(-100%); }
}

.marquee-container:hover .marquee-content {
animation-play-state: paused;
}

/* æ’è¡Œæ¦œåˆ†é æ¨™ç±¤ */
.ranking-tabs {
display: flex;
gap: 0.5em;
margin-bottom: 1.5em;
border-bottom: 2px solid rgba(59, 130, 246, 0.3);
}

.ranking-tab {
padding: 0.8em 1.2em;
background: rgba(31, 41, 55, 0.8);
border: none;
border-radius: 8px 8px 0 0;
cursor: pointer;
font-weight: 600;
color: #9ca3af;
transition: all 0.3s ease;
border-bottom: 3px solid transparent;
}

.ranking-tab.active {
background: #3b82f6;
color: white;
border-bottom-color: #f59e0b;
}

.ranking-tab:hover:not(.active) {
background: rgba(59, 130, 246, 0.2);
color: #60a5fa;
}

/* æ’è¡Œæ¦œå…§å®¹ */
.ranking-content {
display: none;
}

.ranking-content.active {
display: block;
}

/* æ’è¡Œæ¦œåˆ—è¡¨ - åŠ ä¸Šæ»¾å‹•æ¢ */
.ranking-list {
margin-top: 1em;
max-height: 400px;
overflow-y: auto;
padding-right: 0.5em;
}

.ranking-item {
display: flex;
align-items: center;
padding: 1em;
margin-bottom: 0.8em;
background: rgba(31, 41, 55, 0.6);
border-radius: 10px;
border-left: 5px solid #3b82f6;
transition: all 0.3s ease;
border: 1px solid rgba(59, 130, 246, 0.2);
}

.ranking-item:hover {
transform: translateX(5px);
box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
border-color: rgba(59, 130, 246, 0.4);
}

.ranking-number {
font-size: 1.5em;
font-weight: bold;
margin-right: 1em;
min-width: 40px;
text-align: center;
}

.ranking-number.first { color: #ffd700; }
.ranking-number.second { color: #c0c0c0; }
.ranking-number.third { color: #cd7f32; }

.ranking-info {
flex: 1;
}

.ranking-name {
font-weight: bold;
font-size: 1.1em;
margin-bottom: 0.3em;
color: #e8eaed;
}

.score-bar-container {
background: rgba(31, 41, 55, 0.8);
border-radius: 10px;
height: 20px;
overflow: hidden;
position: relative;
}

.score-bar {
height: 100%;
border-radius: 10px;
transition: width 0.8s ease;
position: relative;
}

.score-text {
position: absolute;
right: 10px;
top: 50%;
transform: translateY(-50%);
font-size: 0.9em;
font-weight: bold;
color: #e8eaed;
}

/* å¾…æ›´æ–°æç¤º */
.update-notice {
text-align: center;
color: #9ca3af;
font-style: italic;
padding: 2em;
background: rgba(31, 41, 55, 0.5);
border-radius: 8px;
border: 2px dashed rgba(59, 130, 246, 0.3);
}

/* å…§å®¹æ¨£å¼ */
.section-title {
color: #60a5fa;
font-size: 1.3em;
font-weight: bold;
margin: 1.5em 0 1em 0;
border-bottom: 2px solid rgba(59, 130, 246, 0.3);
padding-bottom: 0.5em;
}

.content-block {
margin-bottom: 1.5em;
padding: 1em;
background: rgba(31, 41, 55, 0.3);
border-radius: 8px;
border-left: 4px solid #3b82f6;
}

.sub-title {
color: #93c5fd;
font-weight: bold;
margin-bottom: 0.8em;
font-size: 1.1em;
}

.content-list {
margin: 0;
padding-left: 1.2em;
}

.content-list li {
margin-bottom: 0.5em;
color: #d1d5db;
}

.warning-text {
color: #fbbf24;
}

.indent {
margin-left: 1em;
}

.highlight-box {
background: rgba(59, 130, 246, 0.1);
border: 1px solid rgba(59, 130, 246, 0.3);
border-radius: 8px;
padding: 1em;
margin: 1em 0;
color: #93c5fd;
}

/* æ»¾å‹•æ¢ç¾åŒ– */
::-webkit-scrollbar {
width: 8px;
}

::-webkit-scrollbar-track {
background: rgba(31, 41, 55, 0.5);
border-radius: 10px;
}

::-webkit-scrollbar-thumb {
background: linear-gradient(135deg, #3b82f6, #1e40af);
border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
background: linear-gradient(135deg, #1e40af, #3b82f6);
}

/* ç‰ˆæ¬Šå€å¡Š */
.copyright-floating {
position: fixed; right: 8px; bottom: 8px;
background: rgba(20, 25, 35, 0.9); color: #9ca3af;
font-size: 13px; padding: 4px 13px 4px 8px;
border-radius: 20px 0 20px 20px; 
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
border: 1px solid rgba(59, 130, 246, 0.2);
z-index: 9999; letter-spacing: 1px; display: flex;
align-items: center; gap: 5px; user-select: none; pointer-events: none;
font-weight: 500;
backdrop-filter: blur(10px);
}
</style>
</head>

<body>
<!-- æ˜Ÿç©ºèƒŒæ™¯ -->
<div class="stars" id="stars"></div>

<!-- å³ä¸‹è§’æµ®å‹•ç‰ˆæ¬Šå€å¡Š -->
<div class="copyright-floating">
<span style="font-size:15px;vertical-align:middle;">â­</span>
Stellarblue Â© å¿µå¿µ æ™ºèƒ½åŠ©ç†ç³»çµ±
</div>

<div class="main-content">
<div class="page-title">Stellarblueè¡Œå‹•ç¥•æ›¸</div>

<!-- ç©å®¶ç‹€æ…‹é¡¯ç¤º -->
<div class="player-status">
<div class="player-info">
  <div class="player-avatar" id="playerAvatar">ğŸ‘¤</div>
  <div class="player-details">
    <h3 id="playerName">è¼‰å…¥ä¸­...</h3>
    <div class="player-stats">
      <span>ğŸ’° <span id="playerCoins">0</span></span>
      <span>â­ <span id="playerPoints">0</span></span>
      <span>ğŸ† <span id="playerLevel">1</span></span>
    </div>
  </div>
</div>
<div class="sync-status" id="syncStatus">åŒæ­¥ä¸­...</div>
</div>

<!-- å…¬å‘Šè·‘é¦¬ç‡ˆ -->
<div class="marquee-container">
<div class="marquee-content">
  ğŸŒŸ Stellarblue æ™ºèƒ½åŠ©ç†ç³»çµ±å·²ä¸Šç·šï¼ŒFirebase é›²ç«¯åŒæ­¥åŠŸèƒ½å·²å•Ÿç”¨ï¼
</div>
</div>

<!-- é€šçŸ¥çœ‹æ¿ -->
<div class="notice-board" id="noticeBoard">
<div class="notice-item">
  <div class="notice-title">ğŸ”¥ Firebase é›²ç«¯åŒæ­¥å·²å•Ÿç”¨</div>
  <div class="notice-content">æ‚¨çš„éŠæˆ²é€²åº¦å°‡è‡ªå‹•ä¿å­˜åˆ°é›²ç«¯</div>
</div>
<div class="notice-item">
  <div class="notice-title">æ–°åŠŸèƒ½é å‘Š</div>
  <div class="notice-content">AIæ™ºèƒ½åŠ©ç†ã€æ•¸æ“šåˆ†ææ¨¡çµ„å³å°‡ä¸Šç·š</div>
</div>
<div class="notice-item">
  <div class="notice-title">ä½¿ç”¨æé†’</div>
  <div class="notice-content">è«‹å®šæœŸæ›´æ–°ç³»çµ±ä»¥ç²å¾—æœ€ä½³é«”é©—</div>
</div>
</div>

<!-- åŠŸèƒ½æŒ‰éˆ• -->
<div class="btn-group">
<button class="func-btn" data-modal="ğŸ¤–AIåŠ©ç†">ğŸ¤–AIåŠ©ç†</button>
<button class="func-btn" data-modal="ğŸ“Šæ•¸æ“šåˆ†æ">ğŸ“Šæ•¸æ“šåˆ†æ</button>
<button class="func-btn" data-modal="ğŸ“‹ä»»å‹™ç®¡ç†">ğŸ“‹ä»»å‹™ç®¡ç†</button>
<button class="func-btn" data-modal="ğŸ“…è¡Œç¨‹è¦åŠƒ">ğŸ“…è¡Œç¨‹è¦åŠƒ</button>
<button class="func-btn" data-modal="ğŸ”æ™ºèƒ½æœå°‹">ğŸ”æ™ºèƒ½æœå°‹</button>
<button class="func-btn" data-modal="âš™ï¸ç³»çµ±è¨­å®š">âš™ï¸ç³»çµ±è¨­å®š</button>
<button class="func-btn" data-modal="ğŸ”—å¿«é€Ÿé€£çµ">ğŸ”—å¿«é€Ÿé€£çµ</button>
<button class="func-btn" data-modal="ğŸ®éŠæˆ²æ¨¡çµ„" onclick="simulateGameplay()">ğŸ®éŠæˆ²æ¨¡çµ„</button>
</div>

<!-- æ’è¡Œæ¦œæŒ‰éˆ• -->
<button class="ranking-btn" onclick="openRankingModal()">
ğŸ† æ•ˆèƒ½æ’è¡Œæ¦œ
</button>

<!-- ç™»å‡ºæŒ‰éˆ• -->
<button class="logout-btn" id="logoutBtn">å®‰å…¨ç™»å‡º</button>
</div>

<!-- å½ˆçª— -->
<div class="modal-bg" id="modalBg">
<div class="modal" id="modalBox">
<div class="modal-header" id="modalHeader">
  <span id="modalTitle">æ¨™é¡Œ</span>
  <button class="modal-close" id="modalClose">Ã—</button>
</div>
<div class="modal-body" id="modalBody">
  å…§å®¹è¼‰å…¥ä¸­...
</div>
</div>
</div>

<script type="module">
// Firebase é…ç½®å’Œåˆå§‹åŒ–
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, get, onValue, push, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
apiKey: "AIzaSyBvKmn0jCTS_jIgEYOuQjc8vyYU40Q5F3I",
authDomain: "stellarblue-system.firebaseapp.com",
databaseURL: "https://stellarblue-system-default-rtdb.firebaseio.com/",
projectId: "stellarblue-system",
storageBucket: "stellarblue-system.firebasestorage.app",
messagingSenderId: "803212433649",
appId: "1:803212433649:web:887080d10a51d533b23150",
measurementId: "G-YY94484DV9"
};

let app, database;
let currentPlayer = null;

// åˆå§‹åŒ– Firebase
try {
app = initializeApp(firebaseConfig);
database = getDatabase(app);
console.log('ğŸ”¥ Firebase åˆå§‹åŒ–æˆåŠŸ');
} catch (error) {
console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
}

// æª¢æŸ¥ç™»å…¥ç‹€æ…‹
function checkLoginStatus() {
const loginStatus = localStorage.getItem('stellarblue_login');
const loginTime = localStorage.getItem('stellarblue_login_time');
const currentTime = Date.now();
const LIMIT = 3600000; // 1å°æ™‚

if (loginStatus !== 'yes' || !loginTime || (currentTime - parseInt(loginTime)) > LIMIT) {
  window.location.href = 'index.html';
  return false;
}
return true;
}

// ğŸ”§ ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ç™»å…¥å¸³è™Ÿä½œç‚ºç©å®¶ID
function getCurrentPlayerId() {
const currentUser = localStorage.getItem('stellarblue_current_user');
if (!currentUser) {
  console.error('âŒ æœªæ‰¾åˆ°ç™»å…¥ç”¨æˆ¶');
  window.location.href = 'index.html';
  return null;
}
return currentUser; // ç›´æ¥è¿”å›ç™»å…¥å¸³è™Ÿï¼ˆstellarblue, admin, secretaryï¼‰
}

// åˆå§‹åŒ–ç©å®¶æ•¸æ“š
async function initializePlayerData() {
const playerId = getCurrentPlayerId();
if (!playerId) return;

const playerRef = ref(database, `players/${playerId}`);

updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');

try {
  const snapshot = await get(playerRef);
  
  if (snapshot.exists()) {
    // ç©å®¶å·²å­˜åœ¨ï¼Œè¼‰å…¥æ•¸æ“š
    currentPlayer = snapshot.val();
    console.log('ğŸ“Š è¼‰å…¥ç¾æœ‰ç©å®¶æ•¸æ“š:', currentPlayer);
  } else {
    // æ–°ç©å®¶ï¼Œå»ºç«‹åˆå§‹æ•¸æ“š
    const playerNames = {
      'stellarblue': 'Stellarblue',
      'admin': 'ç³»çµ±ç®¡ç†å“¡',
      'secretary': 'æ™ºèƒ½ç§˜æ›¸'
    };

    currentPlayer = {
      name: playerNames[playerId] || `ç©å®¶${playerId}`,
      points: 0,
      coins: 100,
      level: 1,
      experience: 0,
      achievements: [],
      lastLogin: new Date().toISOString(),
      settings: {
        sound: true,
        notifications: true
      },
      stats: {
        totalGamesPlayed: 0,
        totalTimeSpent: 0,
        highestScore: 0
      },
      // ğŸ”§ æ–°å¢ï¼šè¨˜éŒ„ç™»å…¥å¸³è™Ÿ
      loginAccount: playerId,
      createdAt: new Date().toISOString()
    };
    
    await set(playerRef, currentPlayer);
    console.log('ğŸ® å»ºç«‹æ–°ç©å®¶æ•¸æ“š:', currentPlayer);
  }
  
  // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
  await update(playerRef, { 
    lastLogin: new Date().toISOString(),
    loginAccount: playerId // ç¢ºä¿æ¯æ¬¡éƒ½æœ‰è¨˜éŒ„ç™»å…¥å¸³è™Ÿ
  });
  
  // æ›´æ–°UI
  updatePlayerUI();
  updateSyncStatus('success', 'å·²åŒæ­¥');
  
  // è¨­å®šè‡ªå‹•ä¿å­˜
  setupAutoSave();
  
} catch (error) {
  console.error('âŒ ç©å®¶æ•¸æ“šåˆå§‹åŒ–å¤±æ•—:', error);
  updateSyncStatus('error', 'åŒæ­¥å¤±æ•—');
}
}

// æ›´æ–°ç©å®¶UIé¡¯ç¤º
function updatePlayerUI() {
if (!currentPlayer) return;

document.getElementById('playerName').textContent = currentPlayer.name;
document.getElementById('playerCoins').textContent = currentPlayer.coins;
document.getElementById('playerPoints').textContent = currentPlayer.points;
document.getElementById('playerLevel').textContent = currentPlayer.level;

// ğŸ”§ æ ¹æ“šç™»å…¥å¸³è™Ÿé¡¯ç¤ºä¸åŒé ­åƒ
const avatarMap = {
  'stellarblue': 'â­',
  'admin': 'ğŸ‘‘',
  'secretary': 'ğŸ¤–'
};

const playerId = getCurrentPlayerId();
const avatar = avatarMap[playerId] || 'ğŸ‘¤';
document.getElementById('playerAvatar').textContent = avatar;

// ğŸ”§ é¡¯ç¤ºç™»å…¥å¸³è™Ÿä¿¡æ¯
const accountInfo = document.getElementById('accountInfo');
if (accountInfo) {
  accountInfo.textContent = `ç™»å…¥å¸³è™Ÿï¼š${playerId}`;
}
}

// æ›´æ–°åŒæ­¥ç‹€æ…‹
function updateSyncStatus(status, text) {
const syncElement = document.getElementById('syncStatus');
syncElement.className = `sync-status ${status}`;
syncElement.textContent = text;
}

// ä¿å­˜ç©å®¶æ•¸æ“šåˆ°Firebase
async function savePlayerData() {
if (!currentPlayer || !database) return;

const playerId = getCurrentPlayerId();
if (!playerId) return;

const playerRef = ref(database, `players/${playerId}`);

try {
  updateSyncStatus('syncing', 'ä¿å­˜ä¸­...');
  
  // ğŸ”§ ç¢ºä¿æ¯æ¬¡ä¿å­˜éƒ½åŒ…å«ç™»å…¥å¸³è™Ÿä¿¡æ¯
  const dataToSave = {
    ...currentPlayer,
    loginAccount: playerId,
    lastSaved: new Date().toISOString()
  };
  
  await update(playerRef, dataToSave);
  updateSyncStatus('success', 'å·²åŒæ­¥');
  console.log('ğŸ’¾ ç©å®¶æ•¸æ“šå·²ä¿å­˜ - å¸³è™Ÿ:', playerId);
} catch (error) {
  console.error('âŒ ä¿å­˜å¤±æ•—:', error);
  updateSyncStatus('error', 'ä¿å­˜å¤±æ•—');
}
}

// è¨­å®šè‡ªå‹•ä¿å­˜
function setupAutoSave() {
// æ¯30ç§’è‡ªå‹•ä¿å­˜ä¸€æ¬¡
setInterval(savePlayerData, 30000);
console.log('â° è‡ªå‹•ä¿å­˜å·²å•Ÿç”¨ (30ç§’é–“éš”)');
}

// æ¨¡æ“¬éŠæˆ²ç©æ³•ï¼ˆæ¸¬è©¦ç”¨ï¼‰
function simulateGameplay() {
if (!currentPlayer) return;

// éš¨æ©Ÿç²å¾—ç©åˆ†å’Œé‡‘å¹£
const pointsGained = Math.floor(Math.random() * 50) + 10;
const coinsGained = Math.floor(Math.random() * 20) + 5;

currentPlayer.points += pointsGained;
currentPlayer.coins += coinsGained;
currentPlayer.stats.totalGamesPlayed += 1;

// æª¢æŸ¥å‡ç´š
const newLevel = Math.floor(currentPlayer.points / 100) + 1;
if (newLevel > currentPlayer.level) {
  currentPlayer.level = newLevel;
  showNotification(`ğŸ‰ æ­å–œå‡ç´šåˆ° ${newLevel} ç´šï¼`);
}

// æ›´æ–°UIå’Œä¿å­˜
updatePlayerUI();
savePlayerData();

const playerId = getCurrentPlayerId();
showNotification(`ğŸ® ${playerId} ç²å¾— ${pointsGained} ç©åˆ†å’Œ ${coinsGained} é‡‘å¹£ï¼`);
}

// é¡¯ç¤ºé€šçŸ¥
function showNotification(message) {
const notification = document.createElement('div');
notification.style.cssText = `
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(59, 130, 246, 0.9);
  color: white;
  padding: 1em 1.5em;
  border-radius: 10px;
  font-weight: bold;
  z-index: 10000;
  animation: slideIn 0.3s ease;
`;
notification.textContent = message;
document.body.appendChild(notification);

setTimeout(() => {
  notification.style.animation = 'slideOut 0.3s ease';
  setTimeout(() => notification.remove(), 300);
}, 3000);
}

// å‰µå»ºæ˜Ÿç©ºèƒŒæ™¯
function createStars() {
const starsContainer = document.getElementById('stars');
const starCount = 50;

for (let i = 0; i < starCount; i++) {
  const star = document.createElement('div');
  star.className = 'star';
  star.style.left = Math.random() * 100 + '%';
  star.style.top = Math.random() * 100 + '%';
  star.style.width = Math.random() * 3 + 1 + 'px';
  star.style.height = star.style.width;
  star.style.animationDelay = Math.random() * 3 + 's';
  starsContainer.appendChild(star);
}
}

// æ’è¡Œæ¦œæ•¸æ“šï¼ˆå¾Firebaseç²å–ï¼‰
async function loadRankingData() {
try {
  const rankingRef = ref(database, 'players');
  const snapshot = await get(rankingRef);
  
  if (snapshot.exists()) {
    const users = snapshot.val();
    const userList = Object.entries(users).map(([key, user]) => ({
      id: key,
      name: user.name,
      points: user.points,
      coins: user.coins,
      level: user.level,
      loginAccount: user.loginAccount || key // é¡¯ç¤ºç™»å…¥å¸³è™Ÿ
    }));
    
    return {
      "ç©åˆ†æ’è¡Œ": userList.sort((a, b) => b.points - a.points),
      "é‡‘å¹£æ’è¡Œ": userList.sort((a, b) => b.coins - a.coins),
      "ç­‰ç´šæ’è¡Œ": userList.sort((a, b) => b.level - a.level)
    };
  }
} catch (error) {
  console.error('âŒ è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
}

// è¿”å›é è¨­æ•¸æ“š
return {
  "ç©åˆ†æ’è¡Œ": [
    { name: currentPlayer?.name || 'ç©å®¶', points: currentPlayer?.points || 0, loginAccount: getCurrentPlayerId() }
  ],
  "é‡‘å¹£æ’è¡Œ": [
    { name: currentPlayer?.name || 'ç©å®¶', coins: currentPlayer?.coins || 0, loginAccount: getCurrentPlayerId() }
  ],
  "ç­‰ç´šæ’è¡Œ": [
    { name: currentPlayer?.name || 'ç©å®¶', level: currentPlayer?.level || 1, loginAccount: getCurrentPlayerId() }
  ]
};
}

// ç”Ÿæˆæ’è¡Œæ¦œå…§å®¹
async function generateRankingContent() {
const rankingData = await loadRankingData();
const categories = Object.keys(rankingData);

let rankingHTML = `
  <h3 style="margin: 0 0 1.5em 0; color: #60a5fa; text-align: center;">ğŸ† Stellarblue å³æ™‚æ’è¡Œæ¦œ</h3>
  <div class="ranking-tabs">
`;

// ç”Ÿæˆåˆ†é æ¨™ç±¤
categories.forEach((category, index) => {
  rankingHTML += `
    <button class="ranking-tab ${index === 0 ? 'active' : ''}" onclick="switchRankingTab('${category}')">
      ${category}
    </button>
  `;
});

rankingHTML += '</div>';

// ç”Ÿæˆå„åˆ†é å…§å®¹
categories.forEach((category, index) => {
  const sortedData = rankingData[category];
  
  rankingHTML += `
    <div class="ranking-content ${index === 0 ? 'active' : ''}" id="ranking-${category}">
      <div class="ranking-list">
  `;

  sortedData.forEach((item, rankIndex) => {
    const rank = rankIndex + 1;
    let rankClass = '';
    let rankIcon = rank;
    
    if (rank === 1) { rankClass = 'first'; rankIcon = 'ğŸ¥‡'; }
    else if (rank === 2) { rankClass = 'second'; rankIcon = 'ğŸ¥ˆ'; }
    else if (rank === 3) { rankClass = 'third'; rankIcon = 'ğŸ¥‰'; }

    const scoreValue = category.includes('ç©åˆ†') ? item.points : 
                      category.includes('é‡‘å¹£') ? item.coins : item.level;
    const maxScore = Math.max(...sortedData.map(u => 
      category.includes('ç©åˆ†') ? u.points : 
      category.includes('é‡‘å¹£') ? u.coins : u.level
    ));
    const scorePercentage = maxScore > 0 ? (scoreValue / maxScore) * 100 : 0;
    
    // ğŸ”§ é¡¯ç¤ºç™»å…¥å¸³è™Ÿä¿¡æ¯
    const accountDisplay = item.loginAccount ? `(${item.loginAccount})` : '';
    
    rankingHTML += `
      <div class="ranking-item">
        <div class="ranking-number ${rankClass}">${rankIcon}</div>
        <div class="ranking-info">
          <div class="ranking-name">${item.name} ${accountDisplay}</div>
          <div class="score-bar-container">
            <div class="score-bar" style="width: ${scorePercentage}%; background: linear-gradient(90deg, #3b82f6 0%, #1e40af 100%);">
              <div class="score-text">${scoreValue}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  rankingHTML += `
      </div>
    </div>
  `;
});

return rankingHTML;
}

// å„æŒ‰éˆ•çš„å…§å®¹
const modalContents = {
"ğŸ¤–AIåŠ©ç†": `
  <div class="section-title">AIæ™ºèƒ½åŠ©ç†åŠŸèƒ½</div>
  
  <div class="content-block">
    <div class="sub-title">èªéŸ³åŠ©ç†</div>
    <ul class="content-list">
      <li>èªéŸ³æŒ‡ä»¤è­˜åˆ¥èˆ‡åŸ·è¡Œ</li>
      <li>æ™ºèƒ½å°è©±èˆ‡å•ç­”</li>
      <li>å¤šèªè¨€æ”¯æ´</li>
      <li>å€‹äººåŒ–å­¸ç¿’é©æ‡‰</li>
    </ul>
  </div>
  
  <div class="highlight-box">
    <strong>ğŸŒŸ Firebase æ•´åˆå®Œæˆï¼š</strong><br>
    æ‚¨çš„å°è©±è¨˜éŒ„å’Œåå¥½è¨­å®šå°‡è‡ªå‹•ä¿å­˜åˆ°é›²ç«¯ï¼Œä¸¦èˆ‡ç™»å…¥å¸³è™Ÿç¶å®š
  </div>
`,
"ğŸ“Šæ•¸æ“šåˆ†æ": `<div class="update-notice">ğŸ“Š æ•¸æ“šåˆ†ææ¨¡çµ„<br><br>Firebase æ•¸æ“šæ”¶é›†ä¸­ï¼Œå³å°‡æ¨å‡ºå€‹äººåŒ–åˆ†æå ±å‘Š</div>`,
"ğŸ“‹ä»»å‹™ç®¡ç†": `<div class="update-notice">ğŸ“‹ ä»»å‹™ç®¡ç†ç³»çµ±<br><br>é›²ç«¯ä»»å‹™åŒæ­¥åŠŸèƒ½é–‹ç™¼ä¸­</div>`,
"ğŸ“…è¡Œç¨‹è¦åŠƒ": `<div class="update-notice">ğŸ“… æ™ºèƒ½è¡Œç¨‹è¦åŠƒ<br><br>æ•´åˆ Firebase è¡Œç¨‹åŒæ­¥åŠŸèƒ½ä¸­</div>`,
"ğŸ”æ™ºèƒ½æœå°‹": `<div class="update-notice">ğŸ” æ™ºèƒ½æœå°‹å¼•æ“<br><br>å»ºç«‹é›²ç«¯æœå°‹ç´¢å¼•ä¸­</div>`,
"âš™ï¸ç³»çµ±è¨­å®š": `<div class="update-notice">âš™ï¸ ç³»çµ±è¨­å®šé¢æ¿<br><br>Firebase è¨­å®šåŒæ­¥é–‹ç™¼ä¸­</div>`,
"ğŸ”—å¿«é€Ÿé€£çµ": `<div class="update-notice">ğŸ”— å¿«é€Ÿé€£çµç®¡ç†<br><br>é›²ç«¯æ›¸ç±¤åŒæ­¥åŠŸèƒ½é–‹ç™¼ä¸­</div>`,
"ğŸ“±æ‡‰ç”¨å·¥å…·": `<div class="update-notice">ğŸ“± æ‡‰ç”¨å·¥å…·é›†<br><br>Firebase å·¥å…·æ•´åˆä¸­</div>`
};

// åˆ‡æ›æ’è¡Œæ¦œåˆ†é 
window.switchRankingTab = function(category) {
// ç§»é™¤æ‰€æœ‰æ´»å‹•ç‹€æ…‹
document.querySelectorAll('.ranking-tab').forEach(tab => {
  tab.classList.remove('active');
});
document.querySelectorAll('.ranking-content').forEach(content => {
  content.classList.remove('active');
});

// æ·»åŠ æ´»å‹•ç‹€æ…‹
event.target.classList.add('active');
document.getElementById(`ranking-${category}`).classList.add('active');
}

// æ‰“é–‹æ’è¡Œæ¦œå½ˆçª—
window.openRankingModal = async function() {
const modalBg = document.getElementById('modalBg');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

modalTitle.textContent = 'ğŸ† å³æ™‚æ’è¡Œæ¦œ';
modalBody.innerHTML = '<div style="text-align: center; padding: 2em;">è¼‰å…¥ä¸­...</div>';
modalBg.classList.add('active');

// ç•°æ­¥è¼‰å…¥æ’è¡Œæ¦œæ•¸æ“š
const rankingContent = await generateRankingContent();
modalBody.innerHTML = rankingContent;
}

// æ¨¡æ“¬éŠæˆ²ç©æ³•
window.simulateGameplay = simulateGameplay;

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
// æª¢æŸ¥ç™»å…¥ç‹€æ…‹
if (!checkLoginStatus()) {
  return;
}

// å‰µå»ºæ˜Ÿç©ºèƒŒæ™¯
createStars();

// åˆå§‹åŒ– Firebase å’Œç©å®¶æ•¸æ“š
initializePlayerData();

// åŠŸèƒ½æŒ‰éˆ•é»æ“Šäº‹ä»¶
document.querySelectorAll('.func-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const modalType = this.getAttribute('data-modal');
    if (modalType === 'ğŸ®éŠæˆ²æ¨¡çµ„') return; // éŠæˆ²æ¨¡çµ„æœ‰ç¨ç«‹è™•ç†
    
    const modalBg = document.getElementById('modalBg');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    modalTitle.textContent = modalType;
    modalBody.innerHTML = modalContents[modalType] || '<div class="update-notice">åŠŸèƒ½é–‹ç™¼ä¸­</div>';
    modalBg.classList.add('active');
  });
});

// é—œé–‰å½ˆçª—
document.getElementById('modalClose').addEventListener('click', function() {
  document.getElementById('modalBg').classList.remove('active');
});

// é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆçª—
document.getElementById('modalBg').addEventListener('click', function(e) {
  if (e.target === this) {
    this.classList.remove('active');
  }
});

// ç™»å‡ºæŒ‰éˆ•
document.getElementById('logoutBtn').addEventListener('click', function() {
  localStorage.removeItem('stellarblue_login');
  localStorage.removeItem('stellarblue_login_time');
  localStorage.removeItem('stellarblue_current_user');
  window.location.href = 'index.html';
});

// ESC éµé—œé–‰å½ˆçª—
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('modalBg').classList.remove('active');
  }
});
});

// é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
window.addEventListener('load', function() {
checkLoginStatus();
});
</script>
</body>
</html>
