<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>修仙RPG｜主城（手機專用 v5）</title>
<style>
  :root{
    --bg:#0b1024; --bg2:#0e1536; --panel:#131a3f; --panel-2:#0f1534; --muted:#9aa3b2; --text:#eaf2ff;
    --accent:#8b5cf6; --accent2:#22d3ee; --hp:#ef4444; --mp:#3b82f6; --bar:#334155; --ok:#22c55e; --warn:#f59e0b;
    --gold:#b98c4b; --gold-2:#7a5b31; --radius:16px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
    --elem-none:#64748b; --elem-water:#38bdf8; --elem-fire:#f97316;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:"Microsoft JhengHei",system-ui,Segoe UI,Roboto,sans-serif; color:var(--text); background:var(--bg);}

  /* 舞台：所有裝置一律以「手機畫面」顯示 */
  .stage{
    position:fixed; inset:0; display:grid; justify-items:center; align-items:start; overflow:auto;
    padding-top:max(6px, env(safe-area-inset-top));
  }
  /* 手機固定寬度（最大 420px），電腦/平板也使用同一寬度，避免版面跑掉 */
  .app{
    width:min(420px, 100svw);
    max-height:100svh;
    background:linear-gradient(180deg, var(--bg2), var(--panel));
    border-radius:var(--radius); box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
  }

  /* ===== Header（兩列） ===== */
  header{
    padding:10px 12px; background:rgba(255,255,255,.06);
    border-bottom:1px solid rgba(255,255,255,.08);
    display:grid;
    grid-template-columns:1fr auto;
    grid-template-areas:
      "left right"
      "medals right";
    gap:8px 10px; align-items:center;
  }
  .h-left{grid-area:left; display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; min-width:0;}
  .avatar{width:44px; height:44px; border-radius:50%; object-fit:cover; background:#222; border:2px solid rgba(255,255,255,.15);}
  .pinfo{display:flex; flex-direction:column; min-width:0;}
  .prow{display:flex; align-items:center; gap:6px; flex-wrap:nowrap; min-width:0;}
  .pname{font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .plv{font-size:12px; opacity:.9;}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px;
        background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
        white-space:nowrap;}
  .elem{font-weight:700;}
  .elem.none{background:var(--elem-none); color:#0b1024;}
  .elem.water{background:var(--elem-water); color:#07223a;}
  .elem.fire{background:var(--elem-fire); color:#2b0a00;}

  /* 勳章：確保為完整圓形且不會被擠壓 */
  .medals{grid-area:medals; display:flex; gap:6px; min-width:0;}
  .medal-slot{
    width:30px; aspect-ratio:1/1; border-radius:50%;
    border:2px solid rgba(255,255,255,.25);
    display:flex; align-items:center; justify-content:center;
    font-size:12px; color:#cbd5e1; background:rgba(255,255,255,.06);
    overflow:hidden; flex:0 0 auto;
  }
  .medal-slot img{width:100%; height:100%; object-fit:cover; display:block;}

  /* 右側：貨幣 + 登出（改成直向排列，登出在貨幣下方） */
  .h-right{grid-area:right; display:flex; flex-direction:column; align-items:flex-end; gap:8px; min-width:0;}
  .coins{display:flex; gap:8px; white-space:nowrap; min-width:0; flex-wrap:nowrap;}
  .coin{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-size:12px;}
  .icon-box{ width:18px; height:18px; border-radius:4px; overflow:hidden; display:grid; place-items:center; }
  .icon-box img{ width:100%; height:100%; object-fit:cover; display:block; }
  /* 長數字支援（999,999+），仍保持單行 */
  .val{max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

  .logout-btn{
    padding:7px 14px; min-width:90px;
    border-radius:999px; border:1px solid rgba(255,255,255,.2);
    background:#ef4444; color:#fff; font-weight:900; cursor:pointer; letter-spacing:1px;
  }
  .logout-btn:active{ transform: translateY(1px); }

  @media (max-width:420px){
    .avatar{width:40px; height:40px}
    .coin{padding:5px 8px}
    .val{max-width:100px}
    .medal-slot{width:28px}
    header{gap:6px 8px; padding:8px 8px}
  }

  .divider{height:1px; background:rgba(255,255,255,.08); margin:6px 0;}
  .main{flex:1; display:flex; flex-direction:column; gap:10px; padding:8px 12px 0; overflow:auto;}
  .bars{display:grid; gap:8px;}
  .stat-row{display:grid; grid-template-columns:48px 1fr 56px; align-items:center; gap:8px;}
  .label{font-size:14px; color:#e2e8f0; text-align:right;}
  .num{font-size:12px; color:#e2e8f0; text-align:right;}
  .prog{height:14px; background:#1f273a; border-radius:999px; position:relative; overflow:hidden; box-shadow: inset 0 2px 0 rgba(255,255,255,.06), inset 0 -2px 0 rgba(0,0,0,.25);}
  .fill{height:100%; width:0%;} .fill.sta{background:linear-gradient(90deg,#eab308,#f59e0b);} .fill.exp{background:linear-gradient(90deg,#16a34a,#4ade80);} .fill.hp{background:linear-gradient(90deg,#ef4444,#b91c1c);}
  .actions{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding-top:6px;}
  .gbtn{padding:5px 0; text-align:center; border-radius:10px; font-size: 12px;  font-weight:800; letter-spacing:2px; color:#fff; background:linear-gradient(#a6783e,#7f5626); border:1px solid #5e3d1a; box-shadow: inset 0 2px 0 rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);}
  .title{text-align:center; color:#c7d2fe; font-weight:900; letter-spacing:6px; padding-top:4px;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; padding-bottom:6px;}
  .card{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:6px; display:grid; grid-template-columns:52px 1fr; gap:10px; align-items:center;}
  .thumb{width:40px; height:40px; border-radius:10px; overflow:hidden; display:grid; place-items:center; background:#1e293b;}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .ctitle{font-weight:800; font-size: 12px; letter-spacing:1px;} .csub{font-size:12px; color:var(--muted);}
  .dock{padding:0 12px 10px;}
  .chatbox{background:#060a1a; border:1px solid rgba(255,255,255,.2); border-radius:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(0,0,0,.4);}
  .corner-btn{position:absolute; width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-top:12px solid #fff; right:10px;}
  .corner-btn.top{top:-6px;} .corner-btn.bottom{bottom:-6px; transform:rotate(180deg);}
  .log{height:92px; overflow:auto; padding:8px 10px; font-size:12px;} .log .item{line-height:1.5} .log .ok{color:var(--ok)} .log .warn{color:var(--warn)} .log .muted{color:var(--muted)}
  .speak{display:flex; gap:8px; border-top:1px solid rgba(255,255,255,.1); padding:8px; background:#0a1024; border-radius:0 0 10px 10px;}
  .speak input{flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#fff; color:#111;}
  .speak button{padding:10px 14px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; font-weight:700;}

  /* Modal、Bag 與邏輯相關樣式保持原樣（從 v4 完整版沿用） */
  .stage, .log { overscroll-behavior: contain; }
  .dock { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
  .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:999; }
  .modal.show{ display:grid; }
  .modal .mask{ position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px); }
  .sheet{ position:relative; width:min(92vw, 520px); border-radius:16px; overflow:hidden; background:var(--panel-2); border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); color:var(--text); }
  .sheet .sec-title{ background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.08); text-align:center; font-weight:900; letter-spacing:4px; padding:8px 12px; position:relative; }
  .sheet .close{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:24px; height:24px; border-radius:999px; display:grid; place-items:center; background:#ef4444; color:#fff; font-weight:900; cursor:pointer; user-select:none; }
  .sheet .body{ padding:12px; display:grid; gap:12px; }
  .attr-list{ display:grid; gap:8px; }
  .attr-row{ display:grid; grid-template-columns:70px 42px 1fr 40px; align-items:center; gap:8px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:6px 8px; }
  .attr-name{ font-weight:700; }
  .attr-val{ font-variant-numeric: tabular-nums; text-align:right; }
  .attr-bar{ height:12px; background:#1f273a; border-radius:999px; overflow:hidden; box-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.3); }
  .attr-fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); }
  .attr-plus{ width:32px; height:26px; border-radius:8px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,#22c55e,#16a34a); color:#fff; font-weight:900; cursor:pointer; display:grid; place-items:center; user-select:none; }
  .attr-plus.hide{ display:none; }
  .remain{ text-align:right; font-size:12px; color:#e2e8f0; }
  .kv{ display:grid; grid-template-columns:1fr 1fr; gap:6px 16px; }
  .kv .item{ display:flex; justify-content:space-between; gap:8px; padding:6px 8px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:8px; }
  .kv .k{ opacity:.85; } .kv .v{ font-variant-numeric: tabular-nums; }

  .bag-tabs{display:flex; gap:8px; padding:8px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.08);}
  .bag-tab{padding:6px 10px; border-radius:8px; font-weight:700; cursor:pointer; user-select:none; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);}
  .bag-tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff;}
  .bag-body{padding:10px; display:grid; gap:8px; max-height:60vh; overflow:auto;}
  .item-row{ display:grid; grid-template-columns:44px 1fr; gap:8px; align-items:center; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:6px 8px; min-height:60px; cursor:pointer; }
  .item-thumb{width:44px; height:44px; border-radius:8px; background:#1e293b; display:grid; place-items:center; font-weight:900;}
  .item-thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .item-main{display:grid; gap:3px;}
  .item-title.cons{display:grid; grid-template-columns: 1fr 90px 80px; align-items:center; column-gap:6px;}
  .item-title.wep{display:grid; grid-template-columns: 64px 1fr auto; align-items:center; column-gap:6px;}
  .item-name{ font-weight:800; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); border-radius:9999px; padding:4px 10px; text-align:center;}
  .count-slot{ justify-self:end; min-width:72px; text-align:right; font-variant-numeric: tabular-nums; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); border-radius:9999px; padding:3px 8px; }
  .meta-effect{justify-self:end;}
  .badge{display:inline-block; padding:1px 6px; font-size:12px; border-radius:9999px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10);}
  .badge.hp{background:#7f1d1d; border-color:#ef4444; color:#fff;}
  .badge-lv{background:rgba(255,255,255,.85); color:#0b1024; font-weight:900; border-radius:8px; padding:2px 6px;}
  .right-meta{display:flex; align-items:center; gap:10px;}
  .dur-chip{background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); border-radius:9999px; padding:2px 8px; font-size:12px; color:#e2e8f0;}
  .item-sub{display:flex; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted); line-height:1.2;}
  .sub-left{white-space:nowrap;} .sub-right{white-space:nowrap; color:#93c5fd;}
  .price{font-size:12px; color:#e2e8f0;}
  .rarity-普通{color:#e5e7eb;} .rarity-精良{color:#22c55e;} .rarity-稀有{color:#38bdf8;} .rarity-史詩{color:#a78bfa;} .rarity-傳說{color:#f59e0b;}
  .dur{font-size:12px; color:#e2e8f0;}
  #bagAction{position:fixed; inset:0; display:none; place-items:center; z-index:1000;}
  #bagAction.show{display:grid;}
  #bagAction .mask{position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px);}
  #bagAction .sheet{position:relative; width:min(92vw, 420px);} #bagAction .ops{display:flex; justify-content:flex-end; gap:8px;}
  .opx{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#fff; font-weight:700; cursor:pointer;}
  .opx.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));}
</style>
</head>
<body>

<!-- ===== 原有 UI/Modal 結構：不改玩法、只動排版 ===== -->
<div id="attrModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="attr"></div>
  <div class="sheet" role="dialog" aria-labelledby="attrTitle">
    <div class="sec-title" id="attrTitle">
      基本屬性
      <div class="close" data-close="attr">✕</div>
    </div>
    <div class="body">
      <div class="remain">未分配屬性點：<b id="ptRemain">0</b></div>
      <div class="attr-list" id="attrList"></div>
      <div class="sec-title">能力值</div>
      <div class="kv" id="statList"></div>
    </div>
  </div>
</div>

<div id="bagModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="bag"></div>
  <div class="sheet" role="dialog" aria-labelledby="bagTitle">
    <div class="sec-title" id="bagTitle">
      儲物袋
      <div class="close" data-close="bag">✕</div>
    </div>
    <div class="bag-tabs">
      <div class="bag-tab active" data-bag-tab="consumable">消耗品</div>
      <div class="bag-tab" data-bag-tab="weapon">武器</div>
      <div class="bag-tab" data-bag-tab="ornament" title="尚未開放">飾品</div>
      <div class="bag-tab" data-bag-tab="hidden"   title="尚未開放">暗器</div>
      <div class="bag-tab" data-bag-tab="material" title="尚未開放">材料</div>
    </div>
    <div class="bag-body" id="bagList"></div>
  </div>
</div>

<div id="bagAction" aria-hidden="true">
  <div class="mask" data-close="bagAction"></div>
  <div class="sheet action" role="dialog" aria-labelledby="bagActionTitle">
    <div class="sec-title" id="bagActionTitle">
      物品操作
      <div class="close" data-close="bagAction">✕</div>
    </div>
    <div class="body">
      <div class="item-row" style="cursor:default">
        <div class="item-thumb" id="actIcon"></div>
        <div class="item-main">
          <div class="item-title cons" id="actTop"></div>
          <div class="item-sub"><span class="sub-left" id="actLeft"></span><span class="sub-right" id="actRight"></span></div>
        </div>
      </div>
      <div class="ops" id="actBtns"></div>
    </div>
  </div>
</div>

<div class="stage">
  <div class="app">
    <header>
      <div class="h-left">
        <img id="uiAvatar" class="avatar" alt="avatar" />
        <div class="pinfo">
          <div class="prow">
            <div class="pname" id="uiName"></div>
            <div class="plv">LV.<span id="uiLv"></span></div>
            <span id="uiElem" class="pill elem none"></span>
          </div>
        </div>
      </div>

      <div class="medals">
        <div class="medal-slot" id="medal1"></div>
        <div class="medal-slot" id="medal2"></div>
        <div class="medal-slot" id="medal3"></div>
        <div class="medal-slot" id="medal4"></div>
        <div class="medal-slot" id="medal5"></div>
      </div>

      <div class="h-right">
        <div class="coins">
          <span class="coin">
            <span class="icon-box"><img alt="靈石" src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Crystal_128_up.png"></span>
            <span class="val" id="uiStone">0</span>
          </span>
          <span class="coin">
            <span class="icon-box"><img alt="鑽石" src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Diamond_Icon.svg"></span>
            <span class="val" id="uiDiamond">0</span>
          </span>
        </div>
        <button id="btnLogout" class="logout-btn" title="登出" aria-label="登出">登出</button>
      </div>
    </header>

    <div class="divider"></div>

    <div class="main">
      <div class="bars">
        <div class="stat-row">
          <div class="label">體力：</div>
          <div class="prog"><div class="fill sta" id="barSta"></div></div>
          <div class="num" id="txtSta">100/100</div>
        </div>
        <div class="stat-row">
          <div class="label">經驗：</div>
          <div class="prog"><div class="fill exp" id="barExp"></div></div>
          <div class="num" id="txtExp">0/100</div>
        </div>
        <div class="stat-row">
          <div class="label">氣血：</div>
          <div class="prog"><div class="fill hp" id="barHp"></div></div>
          <div class="num" id="txtHp">--/--</div>
        </div>
      </div>

      <div class="actions">
        <div class="gbtn" data-open="bag">儲物袋</div>
        <div class="gbtn" data-open="skill">技能</div>
        <div class="gbtn" data-open="equip">裝備欄</div>
        <div class="gbtn" data-open="rank">排行榜</div>
      </div>

      <div class="title">主 城</div>

      <div class="grid">
        <div class="card" data-mod="cave"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">洞府</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="map"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">野外地圖</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="library"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">藏經閣</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="tower"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">試煉塔</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="war"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">規模戰</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="collection"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">卡片收藏</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="dex"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">圖鑑</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="shop"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">商城</div><div class="csub">目前待開發中</div></div></div>
      </div>

      <div class="dock">
        <div class="chatbox">
          <div class="corner-btn top"></div>
          <div class="log" id="log">
            <div class="item ok">獲得 <span class="warn">25靈石</span> / 木靈碎片 ×1 / 小氣血單 ×2。</div>
            <div class="item muted">使用 <span class="warn">靈氣恢復藥</span> 小氣血單 ×1 / 真泉修繕載入寶卷 ×1。</div>
            <div class="item">戰鬥開始！</div>
            <div class="item">對XX蟲造成5點傷害。</div>
          </div>
          <div class="speak">
            <input id="chatInput" type="text" placeholder="輸入文字..." />
            <button id="btnSend">送出</button>
          </div>
          <div class="corner-btn bottom"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="items.js"></script>
<script src="auth.js"></script>
<script src="equip.js"></script>
<script>
/* ===== 公用 ===== */
const qs = s=>document.querySelector(s);
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const pct=(cur,max)=>clamp(Math.round(cur/max*100),0,100);
const fmt = (n)=> new Intl.NumberFormat('zh-Hant').format(n);
const fmtCompact = (n)=> new Intl.NumberFormat('en', { notation:'compact', maximumFractionDigits:1 }).format(n);

const ELEMENT_LABEL = { none:'無元素', water:'水元素', fire:'火元素' };

/* ===== 屬性/能力定義 ===== */
const BASE_ATTRS = [
  {key:'str', name:'力道'},
  {key:'vit', name:'體魄'},
  {key:'dex', name:'身法'},
  {key:'int', name:'悟性'},
  {key:'wis', name:'心神'},
  {key:'luk', name:'氣運'},
];

function derivedFrom(P){
  const A = P.attributes, level = P.level ?? 1;
  return {
    '物理攻擊': A.str*2 + level,
    '法術攻擊': A.int*2 + Math.floor(A.wis*0.5),
    '氣血上限': 80 + A.vit*12 + level*6,
    '真元上限': 40 + A.wis*10 + Math.floor(A.int*6/5),
    '物理防禦': Math.floor(A.vit*1.2) + Math.floor(A.dex*0.6),
    '法術防禦': Math.floor(A.wis*1.3) + Math.floor(A.int*0.5),
    '命中率': 60 + A.dex*2,
    '閃避': 5 + Math.floor(A.dex*1.2),
    '暴擊率': Math.min(50, 3 + Math.floor(A.luk*0.8)),
    '暴擊傷害': 50 + Math.floor(A.luk*1.5),
    '行動條速度': 100 + Math.floor(A.dex*2.2),
    '回氣/回合': 2 + Math.floor(A.wis*0.4),
    '回血/回合': 1 + Math.floor(A.vit*0.5),
    '破甲': Math.floor(A.str*0.6),
    '法穿': Math.floor(A.int*0.6),
    '專精-劍': Math.floor(A.str*0.5 + A.dex*0.4),
    '專精-法': Math.floor(A.int*0.8 + A.wis*0.4),
    '待開發1': 0,
    '待開發2': 0,
  };
}

/* ===== 主程式 API ===== */
window.Game = (()=>{
  const state = { player:null };

  function render(p){
    state.player = p;

    // 頭像/名稱/等級/元素
    const fallbackAvatar = (typeof Auth!=='undefined' && Auth.defaultAvatar)
        ? (Auth.defaultAvatar() || 'https://picsum.photos/seed/xian/96')
        : 'https://picsum.photos/seed/xian/96';
    qs('#uiAvatar').src = p.avatar || fallbackAvatar;
    qs('#uiName').textContent = p.name || '無名散修';
    qs('#uiLv').textContent   = p.level ?? 1;
    const elem = (p.element || 'none').toLowerCase();
    const elemEl = qs('#uiElem');
    if (elemEl){ elemEl.className = `pill elem ${elem}`; elemEl.textContent = ELEMENT_LABEL[elem] || '無元素'; }

    // 勳章
    const slots = [qs('#medal1'), qs('#medal2'), qs('#medal3'), qs('#medal4'), qs('#medal5')];
    slots.forEach(s => s && (s.innerHTML = ''));
    (p.medals || []).slice(0, 5).forEach((m, i) => {
      if (m?.icon && slots[i]) {
        const img = new Image(); img.src = m.icon; slots[i].appendChild(img);
      }
    });

    // 貨幣
    const stone = p.currencies?.stone ?? 0;
    const diamond = p.currencies?.diamond ?? 0;
    qs('#uiStone').textContent   = stone   >= 1_000_000 ? fmtCompact(stone)   : fmt(stone);
    qs('#uiDiamond').textContent = diamond >= 1_000_000 ? fmtCompact(diamond) : fmt(diamond);

    // 狀態條
    const S = p.sta || { cur: 100, max: 100 };
    const E = p.exp || { cur: 0,   max: 100 };

    const hpMaxNow = derivedFrom(p)['氣血上限'];
    const H = {
      cur: Math.min(p.hp?.cur ?? hpMaxNow, hpMaxNow),
      max: hpMaxNow
    };
    if(qs('#barSta')){ qs('#barSta').style.width = pct(S.cur,S.max) + '%'; qs('#txtSta').textContent = `${S.cur}/${S.max}`; }
    if(qs('#barExp')){ qs('#barExp').style.width = pct(E.cur,E.max) + '%'; qs('#txtExp').textContent = `${E.cur}/${E.max}`; }
    if(qs('#barHp')) { qs('#barHp').style.width  = pct(H.cur,H.max) + '%';  qs('#txtHp').textContent  = `${H.cur}/${H.max}`; }
  }

  /* ===== 屬性面板 ===== */
  function openAttr(){ const m = qs('#attrModal'); if(!m) return; renderAttrPanel(); m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
  function closeAttr(){ const m = qs('#attrModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

  function renderAttrPanel(){
    const P = state.player; if(!P) return;

    const list = qs('#attrList');
    if(list){
      list.innerHTML = '';
      BASE_ATTRS.forEach(({key,name})=>{
        const val = P.attributes[key] ?? 10;
        const row = document.createElement('div'); row.className='attr-row';
        row.innerHTML = `
          <div class="attr-name">${name}</div>
          <div class="attr-val" id="val_${key}">${val}</div>
          <div class="attr-bar"><div class="attr-fill" id="bar_${key}" style="width:${Math.min(100,val)}%"></div></div>
          <div class="attr-plus" id="btn_${key}" data-key="${key}">＋</div>
        `;
        list.appendChild(row);
      });
    }

    if(qs('#ptRemain')) qs('#ptRemain').textContent = P.unspentPoints ?? 0;
    updatePlusButtons();
    renderDerived();
  }

  function renderDerived(){
    const P = state.player; if(!P) return;
    const base  = derivedFrom(P);
    const bonus = (window.Equip && Equip.getBonuses) ? Equip.getBonuses() : {};
    const final = {};
    for(const k of Object.keys(base)) final[k] = (base[k]||0) + (bonus[k]||0);

    const box = qs('#statList'); if(!box) return;
    box.innerHTML = '';
    for(const [k,v] of Object.entries(final)){
      const item = document.createElement('div'); item.className='item';
      item.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div>`;
      box.appendChild(item);
    }
  }

  function updatePlusButtons(){
    const remain = state.player?.unspentPoints ?? 0;
    BASE_ATTRS.forEach(({key})=>{
      const btn = qs('#btn_'+key); if(!btn) return;
      btn.classList.toggle('hide', remain<=0);
    });
    if(qs('#ptRemain')) qs('#ptRemain').textContent = remain;
  }

  function wire(){
    document.querySelectorAll('.gbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const txt = b.textContent?.trim();
        if (txt === '儲物袋') return openBag();
        if (txt === '裝備欄') return (window.Equip && Equip.open && Equip.open());
        log(`開啟：${txt}`,'warn');
      });
    });

    document.querySelectorAll('.card').forEach(c=> c.addEventListener('click', ()=> log(`進入模組：${c.querySelector('.ctitle').textContent}`,'warn')));

    qs('#btnSend')?.addEventListener('click', sendChat);
    qs('#chatInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

    qs('#uiAvatar')?.addEventListener('click', openAttr);
    document.querySelectorAll('[data-close="attr"]').forEach(el=> el.addEventListener('click', closeAttr));
    addEventListener('keydown', e=>{ if(e.key==='Escape') { closeAttr(); closeBag(); closeBagAction(); } });

    document.querySelectorAll('[data-close="bag"]').forEach(el=> el.addEventListener('click', closeBag));

    document.addEventListener('click', (e)=>{
      const el = e.target.closest?.('[data-close="bagAction"]');
      if(el) closeBagAction();
    });

    document.addEventListener('click', (e)=>{
      const plus = e.target.closest?.('.attr-plus');
      if (!plus) return;
      const key = plus.dataset.key;
      const P = state.player;
      if(!key || !P || (P.unspentPoints ?? 0) <= 0) return;

      P.attributes[key] = (P.attributes[key] ?? 10) + 1;
      P.unspentPoints -= 1;

      qs('#val_' + key).textContent = P.attributes[key];
      const bar = qs('#bar_' + key);
      if (bar) bar.style.width = Math.min(100, P.attributes[key]) + '%';

      updatePlusButtons();
      renderDerived();

      const d2 = derivedFrom(P);
      const newHpMax = d2['氣血上限'];
      P.hp = P.hp || { cur: newHpMax, max: newHpMax };
      P.hp.max = newHpMax;
      P.hp.cur = Math.min(P.hp.cur, newHpMax);
      if (qs('#barHp')) {
        qs('#barHp').style.width = ((P.hp.cur / P.hp.max) * 100).toFixed(1) + '%';
        qs('#txtHp').textContent = `${P.hp.cur}/${P.hp.max}`;
      }

      if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    });

    document.addEventListener('click', (e)=>{
      const tab = e.target.closest?.('.bag-tab');
      if (!tab) return;
      const k = tab.dataset.bagTab;
      if (!k) return;
      switchBagTab(k);
    });

    document.addEventListener('click', (e)=>{
      const row = e.target.closest?.('.item-row'); if(!row || !row.dataset.type) return;
      openBagAction(row.dataset.type, +row.dataset.idx);
    });

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest?.('.opx'); if(!btn) return;
      const type = btn.dataset.type, op = btn.dataset.op, idx = +btn.dataset.idx;

      if(type==='consumable'){
        if(op==='use')  bagUseConsumable(idx);
        if(op==='sell') bagSellConsumable(idx);
        if(op==='throw')bagThrowConsumable(idx);
        renderBag('consumable');
      }else if(type==='weapon'){
        if(op==='equip') bagEquipWeapon(idx);
        if(op==='sell')  bagSellWeapon(idx);
        if(op==='throw') bagThrowWeapon(idx);
        renderBag('weapon');
      }
      closeBagAction();
    });

    // 登出
    document.getElementById('btnLogout')?.addEventListener('click', ()=>{
      if (confirm('要登出嗎？')) {
        if (window.Auth && Auth.logout) Auth.logout();
        location.href = 'index.html';
      }
    });
  }

  /* ===== Bag ===== */
  function openBag(){ seedBagIfMissing(); renderBag('consumable'); const m = qs('#bagModal'); if(!m) return; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
  function closeBag(){ const m = qs('#bagModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
  function switchBagTab(k){ document.querySelectorAll('.bag-tab').forEach(t=> t.classList.toggle('active', t.dataset.bagTab===k)); renderBag(k); }
  function renderBag(k){
    const P = state.player; if(!P) return;
    const box = qs('#bagList'); if(!box) return;
    box.innerHTML = '';
    if (k==='consumable') renderConsumables(box, P);
    else if (k==='weapon') renderWeapons(box, P);
    else {
      const tip = document.createElement('div'); tip.className='item-sub';
      tip.textContent = '此分頁尚未開放';
      box.appendChild(tip);
    }
  }

  function openBagAction(type, idx){
    const P = state.player; if(!P) return;
    const m = qs('#bagAction'); if(!m) return;

    const isUrl = (s)=> typeof s==='string' && /^https?:\/\//.test(s);
    const clampInt = (n, lo, hi)=> Math.max(lo, Math.min(hi, (n|0)));

    let name='', subLeft='', subRight='', iconUrl=null, btnsHtml='';

    if (type === 'consumable') {
      const it = (P.bag.consumables || [])[idx]; if (!it) return;
      const def = ItemDB.getDef('consumables', it.id);
      iconUrl = isUrl(it.icon) ? it.icon : (isUrl(def?.icon) ? def.icon : null);

      name = it.name || '';
      const eff = it.effect?.hp ? `氣血+${it.effect.hp}` : '';
      subRight = `販售價格 ${it.price ?? 0}`;
      const cnt = clampInt(it.count ?? 0, 0, 9999);

      qs('#actTop').className = 'item-title cons';
      qs('#actTop').innerHTML = `
        <span class="item-name">${name}</span>
        <span class="meta-effect">${eff ? `<span class="badge hp">${eff}</span>` : ''}</span>
        <span class="count-slot">×${cnt}</span>
      `;
      qs('#actLeft').textContent  = '';
      qs('#actRight').textContent = subRight;

      btnsHtml = `
        <button class="opx primary" data-op="use"  data-type="consumable" data-idx="${idx}">使用</button>
        <button class="opx"         data-op="sell" data-type="consumable" data-idx="${idx}">販賣</button>
        <button class="opx"         data-op="throw"data-type="consumable" data-idx="${idx}">丟棄</button>
      `;
    } else if (type === 'weapon') {
      const w = (P.bag.weapons || [])[idx]; if (!w) return;
      const def = ItemDB.getDef('weapons', w.id);
      iconUrl = isUrl(w.icon) ? w.icon : (isUrl(def?.icon) ? def.icon : null);

      name = w.name || '';
      subLeft  = `物理攻擊 ${w.dmg?.[0] ?? 0}-${w.dmg?.[1] ?? 0}`;
      subRight = `販售價格 ${w.price ?? 0}`;

      qs('#actTop').className = 'item-title wep';
      qs('#actTop').innerHTML = `
        <span class="badge-lv">LV.${w.level ?? 1}</span>
        <span class="item-name">${name}</span>
        <span class="right-meta">
          <span>+${w.plus || 0}</span>
          <span class="dur-chip">耐久 ${w.dur?.cur ?? 0}/${w.dur?.max ?? 0}</span>
        </span>
      `;
      qs('#actLeft').textContent  = subLeft;
      qs('#actRight').textContent = subRight;

      btnsHtml = `
        <button class="opx primary" data-op="equip" data-type="weapon" data-idx="${idx}">裝備</button>
        <button class="opx"         data-op="sell"  data-type="weapon" data-idx="${idx}">販賣</button>
        <button class="opx"         data-op="throw" data-type="weapon" data-idx="${idx}">丟棄</button>
      `;
    } else {
      return;
    }

    qs('#actIcon').innerHTML = iconUrl ? `<img src="${iconUrl}" alt="">` : '';
    qs('#actBtns').innerHTML = btnsHtml;

    m.classList.add('show');
    m.setAttribute('aria-hidden', 'false');
  }
  function closeBagAction(){ const m = qs('#bagAction'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); qs('#actBtns').innerHTML = ''; }

  function seedBagIfMissing(){
    const P = state.player; if(!P) return;
    if (!P.bag) { P.bag = ItemDB.getDefaultBag(); return; }
    P.bag.consumables = Array.isArray(P.bag.consumables) ? P.bag.consumables : [];
    P.bag.weapons     = Array.isArray(P.bag.weapons)     ? P.bag.weapons     : [];
    P.bag.ornaments   = Array.isArray(P.bag.ornaments)   ? P.bag.ornaments   : [];
    P.bag.materials   = Array.isArray(P.bag.materials)   ? P.bag.materials   : [];
    P.bag.hidden      = Array.isArray(P.bag.hidden)      ? P.bag.hidden      : [];
  }

  function addConsumableById(id, qty){
    const P = state.player; if(!P || qty<=0) return;
    const def = ItemDB.getDef('consumables', id); if(!def) return;
    const MAX = ItemDB.STACK_MAX;

    let remain = qty;
    for (const s of P.bag.consumables){
      if (s.id !== id) continue;
      const can = Math.max(0, MAX - (s.count||0));
      const add = Math.min(can, remain);
      if (add>0){ s.count = (s.count||0)+add; remain-=add; }
      if (remain<=0) break;
    }
    while (remain > 0) {
      const take = Math.min(MAX, remain);
      P.bag.consumables.push({ ...def, count: take });
      remain -= take;
    }
  }

  function addWeaponById(id, plus=0){
    const P = state.player; if(!P) return;
    const d = ItemDB.getDef('weapons', id); if (!d) return;
    P.bag.weapons.push({ ...d, plus, dur: { cur: d.durMax, max: d.durMax } });
  }

  function renderConsumables(box, P){
    const items = P.bag.consumables || [];
    const url = (s)=> typeof s==='string' && /^https?:\/\//.test(s);

    items.forEach((it, i)=>{
      const def = ItemDB.getDef('consumables', it.id);
      const iconUrl = url(it.icon) ? it.icon : (url(def?.icon) ? def.icon : null);

      const row = document.createElement('div');
      row.className = 'item-row';
      row.dataset.type = 'consumable';
      row.dataset.idx = String(i);

      const effHtml = it.effect?.hp ? `<span class="badge hp">氣血+${it.effect.hp}</span>` : '';
      const cnt = Math.max(0, it.count || 0);

      row.innerHTML = `
        <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${it.name}">`:''}</div>
        <div class="item-main">
          <div class="item-title cons">
            <span class="item-name">${it.name}</span>
            <span class="meta-effect">${effHtml}</span>
            <span class="count-slot">×${cnt}</span>
          </div>
          <div class="item-sub">
            <span class="sub-left"></span>
            <span class="sub-right">販售價格 ${it.price}</span>
          </div>
        </div>
      `;
      box.appendChild(row);
    });
  }

  function renderWeapons(box, P){
    const items = P.bag.weapons || [];
    const url = (s)=> typeof s==='string' && /^https?:\/\//.test(s);

    items.forEach((w, i)=>{
      const def = ItemDB.getDef('weapons', w.id);
      const iconUrl = url(w.icon) ? w.icon : (url(def?.icon) ? def.icon : null);

      const row = document.createElement('div');
      row.className = 'item-row';
      row.dataset.type = 'weapon';
      row.dataset.idx = String(i);

      row.innerHTML = `
        <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${w.name}">`:''}</div>
        <div class="item-main">
          <div class="item-title wep">
            <span class="badge-lv">LV.${w.level}</span>
            <span class="item-name">${w.name}</span>
            <span class="right-meta"><span>+${w.plus || 0}</span><span class="dur-chip">耐久 ${w.dur.cur}/${w.dur.max}</span></span>
          </div>
          <div class="item-sub">
            <span class="sub-left">物理攻擊 ${w.dmg[0]}-${w.dmg[1]}</span>
            <span class="sub-right">販售價格 ${w.price}</span>
          </div>
        </div>
      `;
      box.appendChild(row);
    });
  }

  function bagUseConsumable(i){
    const P = state.player; const it = P.bag.consumables[i]; if(!it) return;
    if (it.effect?.hp){
      const hpMax = derivedFrom(P)['氣血上限'];
      P.hp = P.hp || {cur:hpMax,max:hpMax};
      P.hp.cur = Math.min(P.hp.cur + it.effect.hp, hpMax);
    }
    it.count = (it.count||0) - 1;
    if (it.count <= 0) P.bag.consumables.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('consumable');
  }
  function bagSellConsumable(i){
    const P = state.player; const it = P.bag.consumables[i]; if(!it) return;
    const max = it.count||0;
    const qty = +prompt(`輸入販賣數量（1-${max}）`, String(max));
    if (!qty || qty<1 || qty>max) return;
    P.currencies = P.currencies || {stone:0, diamond:0};
    P.currencies.stone += qty * (it.price||0);
    it.count -= qty;
    if (it.count <= 0) P.bag.consumables.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('consumable');
  }
  function bagThrowConsumable(i){
    const P = state.player; const it = P.bag.consumables[i]; if(!it) return;
    const max = it.count||0;
    const qty = +prompt(`輸入丟棄數量（1-${max}）`, String(max));
    if (!qty || qty<1 || qty>max) return;
    it.count -= qty;
    if (it.count <= 0) P.bag.consumables.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('consumable');
  }

  function bagEquipWeapon(i){
    const P = state.player; const w = P.bag.weapons[i]; if(!w) return;
    if (window.Equip && Equip.equipWeapon) {
      Equip.equipWeapon(w);
    } else {
      P.equip = P.equip || {}; P.equip.weapon = { ...w };
      if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
      renderDerived();
    }
    log(`已裝備：${w.name}`,'ok');
  }
  function bagSellWeapon(i){
    const P = state.player; const w = P.bag.weapons[i]; if(!w) return;
    if (!confirm(`確定要販賣：「${w.name}」？（可得 ${w.price} 靈石）`)) return;
    P.currencies = P.currencies || {stone:0, diamond:0};
    P.currencies.stone += (w.price||0);
    P.bag.weapons.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('weapon');
  }
  function bagThrowWeapon(i){
    const P = state.player; const w = P.bag.weapons[i]; if(!w) return;
    if (!confirm(`確定要丟棄：「${w.name}」？（不可回收）`)) return;
    P.bag.weapons.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('weapon');
  }

  function log(txt, cls=''){ const el=document.createElement('div'); el.className = `item ${cls}`; el.textContent = txt; const box=qs('#log'); if(!box) return; box.appendChild(el); box.scrollTop = box.scrollHeight; }
  function sendChat(){ const inp = qs('#chatInput'); const msg = (inp?.value||'').trim(); if(!msg) return; log(`你：${msg}`,'ok'); inp.value=''; }

  return {
    start(player){
      const p = Object.assign({
        level: 1,
        attributes: { str:10, vit:10, dex:10, int:10, wis:10, luk:10 },
        unspentPoints: 5,
        medals: [],
        equip: { weapon: null, earrings: [null,null], rings: [null,null], cloak: null, armor: null, shoes: null, medals: [null,null,null,null,null] },
        sta: { cur: 100, max: 100 },
        exp: { cur: 0,   max: 100 },
        hp:  { cur: 0,   max: 0 },
        currencies: { stone: 0, diamond: 0 },
      }, player || {});

      const hpMax = derivedFrom(p)['氣血上限'];
      p.hp = { cur: hpMax, max: hpMax };
      p.sta = { cur: 100, max: 100 };
      p.exp = { cur: p.exp?.cur ?? 0, max: 100 };
      if (p.exp.cur < 0 || p.exp.cur > p.exp.max) p.exp.cur = 0;

      wire();
      render(p);
    },
    getPlayer(){ return state.player; },
    save(){ if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(state.player); },
    recalc(){ render(state.player); renderDerived(); },
    log(txt, cls=''){ log(txt, cls); }
  };
})();

window.addEventListener('DOMContentLoaded', () => {
  const char = (window.Auth && Auth.getCharacter && Auth.getCharacter()) || null;
  if (!char) { window.location.href = 'index.html'; return; }

  Game.start(char);

  if (window.Equip && Equip.mount) {
    Equip.mount({
      getPlayer: () => Game.getPlayer(),
      save:      () => Game.save && Game.save(),
      recalc:    () => Game.recalc && Game.recalc(),
      log:       (t)=> Game.log ? Game.log(t) : console.log(t),
    });
  }
});
</script>
</body>
</html>
