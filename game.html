<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>修仙RPG｜主城（手機專用 v5）</title>
<style>
  :root{
    --bg:#0b1024; --bg2:#0e1536; --panel:#131a3f; --panel-2:#0f1534; --muted:#9aa3b2; --text:#eaf2ff;
    --accent:#8b5cf6; --accent2:#22d3ee; --hp:#ef4444; --mp:#3b82f6; --bar:#334155; --ok:#22c55e; --warn:#f59e0b;
    --gold:#b98c4b; --gold-2:#7a5b31; --radius:16px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
    --elem-none:#64748b; --elem-water:#38bdf8; --elem-fire:#f97316;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:"Microsoft JhengHei",system-ui,Segoe UI,Roboto,sans-serif; color:var(--text); background:var(--bg);}

  /* 舞台：所有裝置一律以「手機畫面」顯示 */
  .stage{
    position:fixed; inset:0; display:grid; justify-items:center; align-items:start; overflow:auto;
    padding-top:max(6px, env(safe-area-inset-top));
  }
  /* 手機固定寬度（最大 420px），電腦/平板也使用同一寬度，避免版面跑掉 */
  .app{
    width:min(420px, 100svw);
    max-height:100svh;
    background:linear-gradient(180deg, var(--bg2), var(--panel));
    border-radius:var(--radius); box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
  }

  /* ===== Header（兩列） ===== */
  header{
    padding:10px 12px; background:rgba(255,255,255,.06);
    border-bottom:1px solid rgba(255,255,255,.08);
    display:grid;
    grid-template-columns:1fr auto;
    grid-template-areas:
      "left right"
      "medals right";
    gap:8px 10px; align-items:center;
  }
  .h-left{grid-area:left; display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; min-width:0;}
  .avatar{width:44px; height:44px; border-radius:50%; object-fit:cover; background:#222; border:2px solid rgba(255,255,255,.15);}
  .pinfo{display:flex; flex-direction:column; min-width:0;}
  .prow{display:flex; align-items:center; gap:6px; flex-wrap:nowrap; min-width:0;}
  .pname{font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .plv{font-size:12px; opacity:.9;}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px;
        background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
        white-space:nowrap;}
  .elem{font-weight:700;}
  .elem.none{background:var(--elem-none); color:#0b1024;}
  .elem.water{background:var(--elem-water); color:#07223a;}
  .elem.fire{background:var(--elem-fire); color:#2b0a00;}

  /* 勳章：確保為完整圓形且不會被擠壓 */
  .medals{grid-area:medals; display:flex; gap:6px; min-width:0;}
  .medal-slot{
    width:30px; aspect-ratio:1/1; border-radius:50%;
    border:2px solid rgba(255,255,255,.25);
    display:flex; align-items:center; justify-content:center;
    font-size:12px; color:#cbd5e1; background:rgba(255,255,255,.06);
    overflow:hidden; flex:0 0 auto;
  }
  .medal-slot img{width:100%; height:100%; object-fit:cover; display:block;}

  /* 右側：貨幣 + 登出（改成直向排列，登出在貨幣下方） */
  .h-right{grid-area:right; display:flex; flex-direction:column; align-items:flex-end; gap:8px; min-width:0;}
  .coins{display:flex; gap:8px; white-space:nowrap; min-width:0; flex-wrap:nowrap;}
  .coin{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-size:10px;}
  .icon-box{ width:18px; height:18px; border-radius:4px; overflow:hidden; display:grid; place-items:center; }
  .icon-box img{ width:100%; height:100%; object-fit:cover; display:block; }
  /* 長數字支援（999,999+），仍保持單行 */
  .val{max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

  /* ===== 登出按鈕框線調整 - 加大寬高 ===== */
  .logout-btn{
  padding: 12px 20px;  /* 原本 7px 14px，現在加大 */
  min-width: 83px;    /* 原本 90px，現在加寬 */
  height: 32px;        /* 新增固定高度 */
  border-radius:999px; 
  border:3px solid rgba(255,255,255,.4);  /* 框線加粗 + 增加透明度 */
  background:#ef4444; color:#fff; font-weight:900; cursor:pointer; letter-spacing:1px;
  display: flex;       /* 讓文字垂直置中 */
  align-items: center;
  justify-content: center;
  }
  .logout-btn:active{ transform: translateY(1px); }

  @media (max-width:420px){
    .avatar{width:40px; height:40px}
    .coin{padding:5px 8px}
    .val{max-width:100px}
    .medal-slot{width:28px}
    header{gap:6px 8px; padding:8px 8px}
  }

  .divider{height:1px; background:rgba(255,255,255,.08); margin:6px 0;}
  .main{flex:1; display:flex; flex-direction:column; gap:10px; padding:8px 12px 0; overflow:auto;}
  .bars{display:grid; gap:0px;}
  .stat-row{display:grid; grid-template-columns:48px 1fr 56px; align-items:center; gap:8px;}
  .label{font-size:14px; color:#e2e8f0; text-align:right;}
  .num{font-size:10px; color:#e2e8f0; text-align:right;}
    /* ===== 體力經驗真氣真元框線調整 - 加大高度 ===== */
  .prog{
  height: 13px;        /* 原本 14px，現在加高 */
  background:#1f273a; border-radius:999px; position:relative; overflow:hidden; 
  box-shadow: inset 0 2px 0 rgba(255,255,255,.06), inset 0 -2px 0 rgba(0,0,0,.25);
  border: 2px solid rgba(255,255,255,.25);  /* 新增外框線 */
  }
  .fill{height:100%; width:0%;} .fill.sta{background:linear-gradient(90deg,#eab308,#f59e0b);} .fill.exp{background:linear-gradient(90deg,#16a34a,#4ade80);} .fill.hp{background:linear-gradient(90deg,#ef4444,#b91c1c);} .fill.mp{background:linear-gradient(90deg,#3b82f6,#1d4ed8);}
  .actions{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding-top:6px;}
  .gbtn{padding:5px 0; text-align:center; border-radius:10px; font-size: 12px;  font-weight:800; letter-spacing:2px; color:#fff; background:linear-gradient(#a6783e,#7f5626); border:1px solid #5e3d1a; box-shadow: inset 0 2px 0 rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);}
  .title{text-align:center; color:#c7d2fe; font-weight:900; letter-spacing:6px; padding-top:4px;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; padding-bottom:6px;}
  .card{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:6px; display:grid; grid-template-columns:52px 1fr; gap:10px; align-items:center;}
  .thumb{width:40px; height:40px; border-radius:10px; overflow:hidden; display:grid; place-items:center; background:#1e293b;}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .ctitle{font-weight:800; font-size: 12px; letter-spacing:1px;} .csub{font-size:12px; color:var(--muted);}
  .dock{padding:0 12px 10px;}
  .chatbox{background:#060a1a; border:1px solid rgba(255,255,255,.2); border-radius:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(0,0,0,.4);}
  .corner-btn{position:absolute; width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-top:12px solid #fff; right:10px;}
  .corner-btn.top{top:-6px;} .corner-btn.bottom{bottom:-6px; transform:rotate(180deg);}
  .log{height:92px; overflow:auto; padding:8px 10px; font-size:12px;} .log .item{line-height:1.5} .log .ok{color:var(--ok)} .log .warn{color:var(--warn)} .log .muted{color:var(--muted)}
  .speak{display:flex; gap:8px; border-top:1px solid rgba(255,255,255,.1); padding:8px; background:#0a1024; border-radius:0 0 10px 10px;}
  .speak input{flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#fff; color:#111;}
  .speak button{padding:10px 14px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; font-weight:700;}

  /* Modal、Bag 與邏輯相關樣式保持原樣（從 v4 完整版沿用） */
  .stage, .log { overscroll-behavior: contain; }
  .dock { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
  .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:999; }
  .modal.show{ display:grid; }
  .modal .mask{ position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px); }
  .sheet{ position:relative; width:min(92vw, 520px); border-radius:16px; overflow:hidden; background:var(--panel-2); border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); color:var(--text); }
  .sheet .sec-title{ background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.08); text-align:center; font-weight:900; letter-spacing:4px; padding:8px 12px; position:relative; }
  .sheet .close{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:24px; height:24px; border-radius:999px; display:grid; place-items:center; background:#ef4444; color:#fff; font-weight:900; cursor:pointer; user-select:none; }
  .sheet .body{ padding:12px; display:grid; gap:12px; }
  .attr-list{ display:grid; gap:8px; }
  .attr-row{ display:grid; grid-template-columns:70px 42px 1fr 40px; align-items:center; gap:8px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:6px 8px; }
  .attr-name{ font-weight:700; }
  .attr-val{ font-variant-numeric: tabular-nums; text-align:right; }
  .attr-bar{ height:12px; background:#1f273a; border-radius:999px; overflow:hidden; box-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.3); }
  .attr-fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); }
  .attr-plus{ width:32px; height:26px; border-radius:8px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,#22c55e,#16a34a); color:#fff; font-weight:900; cursor:pointer; display:grid; place-items:center; user-select:none; }
  .attr-plus.hide{ display:none; }
  .remain{ text-align:right; font-size:12px; color:#e2e8f0; }
  .kv{ display:grid; grid-template-columns:1fr 1fr; gap:6px 16px; }
  .kv .item{ display:flex; justify-content:space-between; gap:8px; padding:6px 8px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:8px; }
  .kv .k{ opacity:.85; font-size:12px; }
  .kv .v{ font-variant-numeric: tabular-nums; font-size:12px; }

  .bag-tabs{display:flex; gap:6px; padding:6px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.08);}
  .bag-tab{padding:4px 8px; border-radius:8px; font-weight:700; font-size:11px; cursor:pointer; user-select:none; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);}
  .bag-tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff;}
  /* ⚠ 原本寫 .bag-body 但你的 HTML 用的是 .bag-list，這裡改成 .bag-list 才會生效 */
  .bag-list{padding:8px; display:grid; gap:6px; max-height:65vh; overflow:auto;}


  .item-row{ display:grid; grid-template-columns:36px 1fr; gap:6px; align-items:center; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:5px 8px; min-height:48px; cursor:pointer; }
  .item-thumb{width:36px; height:36px; border-radius:8px; background:#1e293b; display:grid; place-items:center; font-weight:900;}
  .item-thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .item-main{display:grid; gap:2px;}
  /* 改成自適應寬度，右側欄位縮窄；名稱可多行 */
  .item-title.cons{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:4px;}
  .item-title.wep {display:grid; grid-template-columns: 46px 1fr auto; align-items:center; column-gap:6px;}
  /* 名稱可換行，避免被 … 截斷；整體字再小一點 */
  .item-name{
    font-weight:800; font-size:10px; line-height:1.25;
    overflow:visible; white-space:normal; text-overflow:clip; word-break:break-word;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    border-radius:10px; padding:2px 8px; text-align:center;
  }
  .count-slot{
    justify-self:end; min-width:56px; text-align:right; font-variant-numeric: tabular-nums;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    border-radius:9999px; padding:2px 6px; font-size:11px;
  }
  .meta-effect{justify-self:end;}
  .badge{display:inline-block; padding:1px 6px; font-size:9px; border-radius:9999px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10);}
  .badge.hp{background:#7f1d1d; border-color:#ef4444; color:#fff;}
  .badge-lv{background:rgba(255,255,255,.85); color:#0b1024; font-weight:900; border-radius:8px; padding:1px 6px; font-size:11px;}
  .right-meta{display:flex; align-items:center; gap:8px;}
  .dur-chip{background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); border-radius:9999px; padding:1px 6px; font-size:11px; color:#e2e8f0;}
  .item-sub{display:flex; justify-content:space-between; gap:8px; font-size:9px; color:var(--muted); line-height:1.15;}
  /* 允許左右說明也自動換行，避免擠到冒號或出現 … */
  .sub-left{white-space:normal;}
  .sub-right{white-space:normal; color:#93c5fd;}
  .price{font-size:11px; color:#e2e8f0;}

  /* ★ 稀有度顏色：使用「普/精/稀/史/傳」五級，對應 items.js 的 RARITY */
  :root{
    --rar-普:#e5e7eb; --rar-精:#22c55e; --rar-稀:#38bdf8; --rar-史:#a78bfa; --rar-傳:#f59e0b;
  }
  .rarity-普{color:var(--rar-普);}
  .rarity-精{color:var(--rar-精);}
  .rarity-稀{color:var(--rar-稀);}
  .rarity-史{color:var(--rar-史);}
  .rarity-傳{color:var(--rar-傳);}

  /* 小方塊稀有度徽章（顯示「普/精/稀/史/傳」） */
  .rb{display:inline-grid; place-items:center; width:16px; height:16px; font-size:10px; font-weight:900;
      border-radius:4px; margin-right:4px; line-height:1; border:1px solid rgba(255,255,255,.25);}
  .rb-普{background:var(--rar-普); color:#0b1024;}
  .rb-精{background:var(--rar-精); color:#052411;}
  .rb-稀{background:var(--rar-稀); color:#041621;}
  .rb-史{background:var(--rar-史); color:#1a0b2c;}
  .rb-傳{background:var(--rar-傳); color:#231400;}

  /* 既有耐久字樣維持 */
  .dur{font-size:10px; color:#e2e8f0;}

  #bagAction{position:fixed; inset:0; display:none; place-items:center; z-index:1000;}
  #bagAction.show{display:grid;}
  #bagAction .mask{position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px);}
  #bagAction .sheet{position:relative; width:min(92vw, 380px);} #bagAction .ops{display:flex; justify-content:flex-end; gap:6px;}
  .opx{padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#fff; font-weight:700; font-size:12px; cursor:pointer;}
  .opx.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));}


  /* 讓屬性面板的外層彈窗限制高度，避免超出視口 */
#attrModal .sheet{
  /* 原本就有 width/min… 可保留 */
  max-height: min(86svh, 640px);      /* 手機優先：最高只到 86% 視口高 */
  display: grid;
  grid-template-rows: auto 1fr;       /* 上：標題列；下：內容可捲動 */
  overflow: hidden;                    /* 捲動交給 body */
}

/* 標題列固定在最上方，永遠看得到 ✕ */
#attrModal .sheet .sec-title{
  position: sticky;
  top: 0;                              /* 黏到頂端 */
  z-index: 1;
  padding-top: calc(8px + env(safe-area-inset-top, 0px));
  background: rgba(255,255,255,.06);   /* 保留原底色 */
  backdrop-filter: blur(2px);
}

/* 內容區域可獨立捲動；多到超過就出現滾動條 */
#attrModal .sheet .body{
  overflow: auto;
  /* 預留底部安全區，避免 iPhone 底部指示條壓到 */
  padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
}

/* 讓屬性清單在窄手機也好捲動（可選） */
#attrModal .attr-list{
  min-height: 0;   /* 搭配 grid 才能正確壓縮讓父層捲動 */
}
#attrModal .kv{
  min-height: 0;
}

/* 提升關閉鈕點擊面積（不改見到的大小，只增大可點區域） */
#attrModal .close{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px; height: 28px;          /* 稍微放大 */
  touch-action: manipulation;
}
#attrModal .close::before{
  content: "";
  position: absolute;
  inset: -8px;                         /* 外擴 8px 的隱形熱區 */
}
</style>
</head>
<body>

<!-- ===== 原有 UI/Modal 結構：不改玩法、只動排版 ===== -->
<div id="attrModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="attr"></div>
  <div class="sheet" role="dialog" aria-labelledby="attrTitle">
    <div class="sec-title" id="attrTitle">
      基本屬性
      <div class="close" data-close="attr">✕</div>
    </div>
    <div class="body">
      <div class="remain">未分配屬性點：<b id="ptRemain">0</b></div>
      <div class="attr-list" id="attrList"></div>
      <div class="sec-title">能力值</div>
      <div class="kv" id="statList"></div>
    </div>
  </div>
</div>

<div id="bagModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="bag"></div>
  <div class="sheet" role="dialog" aria-labelledby="bagTitle">
    <div class="sec-title" id="bagTitle">
      儲物袋
      <div class="close" data-close="bag">✕</div>
    </div>

    <div class="body">
      <div class="bag-tabs">
        <span class="bag-tab active" data-bag-tab="consumable">消耗品</span>
        <span class="bag-tab" data-bag-tab="weapon">裝備</span>
          <span class="bag-tab" data-bag-tab="ornament">飾品</span>
          <span class="bag-tab" data-bag-tab="hidden">暗器</span>
        <span class="bag-tab" data-bag-tab="material">材料</span>
      </div>
      <div id="bagList" class="bag-list"></div>
    </div>
  </div>
</div>

<div id="bagAction" aria-hidden="true">
  <div class="mask" data-close="bagAction"></div>
  <div class="sheet action" role="dialog" aria-labelledby="bagActionTitle">
    <div class="sec-title" id="bagActionTitle">
      物品操作
      <div class="close" data-close="bagAction">✕</div>
    </div>
    <div class="body">
      <div class="item-row" style="cursor:default">
        <div class="item-thumb" id="actIcon"></div>
        <div class="item-main">
          <div class="item-title cons" id="actTop"></div>
          <div class="item-sub"><span class="sub-left" id="actLeft"></span><span class="sub-right" id="actRight"></span></div>
        </div>
      </div>
      <div class="ops" id="actBtns"></div>
    </div>
  </div>
</div>

<div class="stage">
  <div class="app">
    <header>
      <div class="h-left">
        <img id="uiAvatar" class="avatar" alt="avatar" />
        <div class="pinfo">
          <div class="prow">
            <div class="pname" id="uiName"></div>
            <div class="plv">LV.<span id="uiLv"></span></div>
            <span id="uiElem" class="pill elem none"></span>
          </div>
        </div>
      </div>

      <div class="medals">
        <div class="medal-slot" id="medal1"></div>
        <div class="medal-slot" id="medal2"></div>
        <div class="medal-slot" id="medal3"></div>
        <div class="medal-slot" id="medal4"></div>
        <div class="medal-slot" id="medal5"></div>
      </div>

      <div class="h-right">
        <div class="coins">
          <span class="coin">
            <span class="icon-box"><img alt="靈石" src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Crystal_128_up.png"></span>
            <span class="val" id="uiStone">0</span>
          </span>
          <span class="coin">
            <span class="icon-box"><img alt="鑽石" src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Diamond_Icon.svg"></span>
            <span class="val" id="uiDiamond">0</span>
          </span>
        </div>
        <button id="btnLogout" class="logout-btn" title="登出" aria-label="登出">登出</button>
      </div>
    </header>

    <div class="divider"></div>

    <div class="main">
      <div class="bars">
        <div class="stat-row">
          <div class="label">體力：</div>
          <div class="prog"><div class="fill sta" id="barSta"></div></div>
          <div class="num" id="txtSta">100/100</div>
        </div>
        <div class="stat-row">
          <div class="label">經驗：</div>
          <div class="prog"><div class="fill exp" id="barExp"></div></div>
          <div class="num" id="txtExp">0/100</div>
        </div>
        <div class="stat-row">
          <div class="label">氣血：</div>
          <div class="prog"><div class="fill hp" id="barHp"></div></div>
          <div class="num" id="txtHp">--/--</div>
        </div>
        <div class="stat-row">
          <div class="label">真元：</div>
          <div class="prog"><div class="fill mp" id="barMp"></div></div>
          <div class="num" id="txtMp">--/--</div>
        </div>
      </div>

    <div class="actions">
      <div class="gbtn" data-open="bag">儲物袋</div>
      <div class="gbtn" data-open="skill">技能</div>
      <div class="gbtn" data-open="equip">裝備欄</div>
      <div class="gbtn" data-open="rank">排行榜</div>
      <div class="gbtn" data-open="shop">商店</div>
      <div class="gbtn" data-open="appearance">外觀</div>
    </div>

      <div class="title">主 城</div>

      <div class="grid">
        <div class="card" data-mod="cave"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">洞府</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="map"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">野外地圖</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="library"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">藏經閣</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="tower"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">試煉塔</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="war"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">規模戰</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="collection"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">卡片收藏</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="dex"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">圖鑑</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="shop"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">商城</div><div class="csub">目前待開發中</div></div></div>
      </div>

      <div class="dock">
        <div class="chatbox">
          <div class="corner-btn top"></div>
          <div class="log" id="log"></div>
          <div class="speak">
            <input id="chatInput" type="text" placeholder="輸入文字..." />
            <button id="btnSend">送出</button>
          </div>
          <div class="corner-btn bottom"></div>
        </div>
      </div>

</div>
</div>
</div>

<!-- ★ 新增：商店介面 -->
<div id="shopModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="shop"></div>
  <div class="sheet" role="dialog" aria-labelledby="shopTitle">
    <div class="sec-title" id="shopTitle">
      商店
      <div class="close" data-close="shop">✕</div>
    </div>
    <div class="body">
      <!-- 商人清單頁 -->
      <div id="merchantList"></div>
      <!-- 商品清單頁 -->
      <div id="merchantShop" style="display:none;">
        <div class="sec-title" id="merchantName"></div>
        <div id="shopList"></div>
        <button class="opx" id="btnBackMerchants">返回商人清單</button>
      </div>
    </div>
  </div>
</div>

<!-- ★ 新增：購買介面 Modal -->
<div id="buyModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="buy"></div>
  <div class="sheet" role="dialog" aria-labelledby="buyTitle">
    <div class="sec-title" id="buyTitle">
      購買物品
      <div class="close" data-close="buy">✕</div>
    </div>
    <div class="body">
      <div id="buyItemName" style="font-weight:700; text-align:center;"></div>
      <div style="display:flex; gap:8px; align-items:center; justify-content:center;">
        <label for="buyQty">數量：</label>
        <input id="buyQty" type="number" value="1" min="1" style="width:80px; text-align:center;">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button class="opx primary" id="btnConfirmBuy">確定購買</button>
      </div>
    </div>
  </div>
</div>



<!-- Firebase（compat 版，免 ES Module） -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
(function(){
  var firebaseConfig = {
    apiKey: "AIzaSyBvKmn0jCTS_jIgEYOuQjc8vyYU40Q5F3I",
    authDomain: "stellarblue-system.firebaseapp.com",
    databaseURL: "https://stellarblue-system-default-rtdb.firebaseio.com",
    projectId: "stellarblue-system",
    storageBucket: "stellarblue-system.firebasestorage.app",
    messagingSenderId: "803212433649",
    appId: "1:803212433649:web:887080d10a51d533b23150",
    measurementId: "G-YY94484DV9"
  };
  if(!firebase.apps || !firebase.apps.length){
    firebase.initializeApp(firebaseConfig);
  }
  // 提供給 auth.js / 遊戲頁使用
  window.DB = firebase.database();
})();
</script>

<script src="stats.js"></script>
<script src="items.js"></script>
<script src="auth.js"></script>
<script src="equip.js"></script>
<script src="rank.js"></script>
<script src="appearance.js?v=dev1"></script>
<script>



/* ===== 公用 ===== */
const qs = s=>document.querySelector(s);

// ★ 改用 stats.js 提供的工具函數

const clamp = function(v,min,max){ return GameUtils.clamp(v,min,max); };
const pct = function(cur,max){ return GameUtils.pct(cur,max); };
const fmt = function(n){ return GameUtils.fmt(n); };
const fmtCompact = function(n){ return GameUtils.fmtCompact(n); };



/* ===== 屬性/定義 ===== */
// ★ 改用 stats.js 提供的基礎屬性定義
const BASE_ATTRS = window.BASE_ATTRS;



/* ===== 主程式 API ===== */
window.Game = (()=>{
  const state = { player:null };

  function render(p){
    state.player = p;

    // 頭像/名稱/等級/元素
    const fallbackAvatar = (typeof Auth!=='undefined' && Auth.defaultAvatar)
        ? (Auth.defaultAvatar() || 'https://picsum.photos/seed/xian/96')
        : 'https://picsum.photos/seed/xian/96';
    qs('#uiAvatar').src = p.avatar || fallbackAvatar;
    qs('#uiName').textContent = p.name || '無名散修';
    qs('#uiLv').textContent   = p.level ?? 1;
    const elem = (p.element || 'none').toLowerCase();
    const elemEl = qs('#uiElem');
    if (elemEl){ elemEl.className = `pill elem ${elem}`; elemEl.textContent = ELEMENT_LABEL[elem] || '無元素'; }

    // 勳章
    const slots = [qs('#medal1'), qs('#medal2'), qs('#medal3'), qs('#medal4'), qs('#medal5')];
    slots.forEach(s => s && (s.innerHTML = ''));
    (p.medals || []).slice(0, 5).forEach((m, i) => {
      if (m?.icon && slots[i]) {
        const img = new Image(); img.src = m.icon; slots[i].appendChild(img);
      }
    });

    // 貨幣
    const stone = p.currencies?.stone ?? 0;
    const diamond = p.currencies?.diamond ?? 0;
    qs('#uiStone').textContent   = stone   >= 1_000_000 ? fmtCompact(stone)   : fmt(stone);
    qs('#uiDiamond').textContent = diamond >= 1_000_000 ? fmtCompact(diamond) : fmt(diamond);

    // 狀態條：HP/EXP/STA/MP
    const S = p.sta || { cur: 100, max: 100 };
    const E = p.exp || { cur: 0,   max: 100 };

    // ★計入裝備加成
    var base  = derivedFrom(p);
    var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
    var hpMaxNow = (base['氣血上限'] || 0) + (bonus['氣血上限'] || 0);
    var mpMaxNow = (base['真元上限'] || 0) + (bonus['真元上限'] || 0);

    // 同步到玩家狀態並夾在 0~max
    if (!p.hp) { p.hp = { cur: hpMaxNow, max: hpMaxNow }; }
    else { p.hp.max = hpMaxNow; p.hp.cur = Math.max(0, Math.min(p.hp.cur ?? hpMaxNow, hpMaxNow)); }
    if (!p.mp) { p.mp = { cur: mpMaxNow, max: mpMaxNow }; }
    else { p.mp.max = mpMaxNow; p.mp.cur = Math.max(0, Math.min(p.mp.cur ?? mpMaxNow, mpMaxNow)); }

    const H = { cur: p.hp.cur, max: p.hp.max };
    const M = { cur: p.mp.cur, max: p.mp.max };

    if(qs('#barSta')){ qs('#barSta').style.width = pct(S.cur,S.max) + '%'; qs('#txtSta').textContent = `${S.cur}/${S.max}`; }
    if(qs('#barExp')){ qs('#barExp').style.width = pct(E.cur,E.max) + '%'; qs('#txtExp').textContent = `${E.cur}/${E.max}`; }
    if(qs('#barHp')) { qs('#barHp').style.width  = pct(H.cur,H.max) + '%';  qs('#txtHp').textContent  = `${H.cur}/${H.max}`; }
    if(qs('#barMp')) { qs('#barMp').style.width  = pct(M.cur,M.max) + '%';  qs('#txtMp').textContent  = `${M.cur}/${M.max}`; }


  }

  /* ===== 屬性面板 ===== */
  function openAttr(){ const m = qs('#attrModal'); if(!m) return; renderAttrPanel(); m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
  function closeAttr(){ const m = qs('#attrModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

  function renderAttrPanel(){
    const P = state.player; if(!P) return;

    const list = qs('#attrList');
    if(list){
      list.innerHTML = '';
      BASE_ATTRS.forEach(({key,name})=>{
        const val = P.attributes[key] ?? 10;
        const row = document.createElement('div'); row.className='attr-row';
        row.innerHTML = `
          <div class="attr-name">${name}</div>
          <div class="attr-val" id="val_${key}">${val}</div>
          <div class="attr-bar"><div class="attr-fill" id="bar_${key}" style="width:${Math.min(100,val)}%"></div></div>
          <div class="attr-plus" id="btn_${key}" data-key="${key}">＋</div>
        `;
        list.appendChild(row);
      });
    }

    if(qs('#ptRemain')) qs('#ptRemain').textContent = P.unspentPoints ?? 0;
    updatePlusButtons();
    renderDerived();
  }

  function renderDerived(){
    var P = state.player; if(!P) return;
    var base  = (window.derivedFrom && typeof window.derivedFrom === 'function') ? derivedFrom(P) : {};
    var bonus = (window.Equip && Equip.getBonuses) ? Equip.getBonuses() : {};
    var final = {};
    var keys = Object.keys(base);
    for(var i = 0; i < keys.length; i++){
      var k = keys[i];
      final[k] = (base[k]||0) + (bonus[k]||0);
    }

    var box = qs('#statList'); if(!box) return;
    box.innerHTML = '';
    var entries = Object.keys(final);
    for(var j = 0; j < entries.length; j++){
      var k = entries[j];
      var v = final[k];
      var item = document.createElement('div'); item.className='item';
      item.innerHTML = '<div class="k">' + k + '</div><div class="v">' + v + '</div>';
      box.appendChild(item);
    }
  }


  function updatePlusButtons(){
    const remain = state.player?.unspentPoints ?? 0;
    BASE_ATTRS.forEach(({key})=>{
      const btn = qs('#btn_'+key); if(!btn) return;
      btn.classList.toggle('hide', remain<=0);
    });
    if(qs('#ptRemain')) qs('#ptRemain').textContent = remain;
  }

function wire(){
  // 左上四顆主要按鈕：儲物袋、裝備欄、商店
  document.querySelectorAll('.gbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const txt = b.textContent?.trim();
        if (txt === '儲物袋') return openBag();
        if (txt === '裝備欄') return (window.Equip && Equip.open && Equip.open());
        if (txt === '商店') return openShop();
        if (txt === '外觀') return openAppearance();
      log(`開啟：${txt}`,'warn');
    });
  });

  // 主畫面卡片（進入地圖或其他模組）
document.querySelectorAll('.card').forEach(c=>{
  c.addEventListener('click', ()=>{
    const mod = c.dataset.mod;
    if (mod === 'map') {
      location.href = 'map.html';
      return;
    } else if (mod === 'cave') {
      location.href = 'cave.html';
      return;
    }
    log(`進入模組：${c.querySelector('.ctitle').textContent}`,'warn');
  });
});

  // 聊天：送出按鈕與 Enter 送出
  qs('#btnSend')?.addEventListener('click', sendChat);
  qs('#chatInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

  // 打開／關閉角色屬性面板
  qs('#uiAvatar')?.addEventListener('click', openAttr);
  document.querySelectorAll('[data-close="attr"]').forEach(el=> el.addEventListener('click', closeAttr));

  // 按 Escape 關閉面板
  addEventListener('keydown', e=>{
    if(e.key==='Escape'){
      closeAttr();
      closeBag();
      closeBagAction();
    }
  });

  // 關閉背包
  document.querySelectorAll('[data-close="bag"]').forEach(function(el){ el.addEventListener('click', closeBag); });
  document.querySelectorAll('[data-close="bagAction"]').forEach(function(el){ el.addEventListener('click', closeBagAction); });

  /**
   * 單一 click 監聽器整合所有常用點擊事件（移除 ?. / ?? / 箭頭函式）
   */

  document.addEventListener('click', function(e){
    var target = e.target;

    // 加屬性點
    var plus = target.closest ? target.closest('.attr-plus') : null;
    if (plus) {
      var key = plus.dataset.key;
      var P = state.player;
      if(!key || !P || ((P.unspentPoints == null ? 0 : P.unspentPoints)) <= 0) return;

      P.attributes[key] = (P.attributes[key] == null ? 10 : P.attributes[key]) + 1;
      P.unspentPoints = (P.unspentPoints == null ? 0 : P.unspentPoints) - 1;

      var elv = qs('#val_' + key); if (elv) elv.textContent = P.attributes[key];
      var bar = qs('#bar_' + key); if (bar) bar.style.width = Math.min(100, P.attributes[key]) + '%';

      updatePlusButtons();
      renderDerived();

      // 更新血量上限
      var d2 = derivedFrom(P);
      var newHpMax = d2['氣血上限'];
      P.hp = P.hp || { cur: newHpMax, max: newHpMax };
      P.hp.max = newHpMax;
      P.hp.cur = Math.min(P.hp.cur, newHpMax);
      var hpBar = qs('#barHp'); if (hpBar) { hpBar.style.width = ((P.hp.cur / P.hp.max) * 100).toFixed(1) + '%'; }
      var hpTxt = qs('#txtHp'); if (hpTxt) { hpTxt.textContent = P.hp.cur + '/' + P.hp.max; }

      if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
      return;
    }

    // 切換背包分頁
    var tab = target.closest ? target.closest('.bag-tab') : null;
    if (tab) {
      var k = tab.dataset.bagTab;
      if (!k) return;
      switchBagTab(k);
      return;
    }

    // 點擊背包物品列，開啟操作面板
    var row = target.closest ? target.closest('.item-row') : null;
    if (row && row.dataset.type) {
      openBagAction(row.dataset.type, +row.dataset.idx);
      return;
    }

    // 點擊操作面板按鈕（使用／裝備／販賣／丟棄／確認販賣／取消販賣／快速選數量）
    var btn = target.closest ? target.closest('.opx') : null;
    if (btn) {
      var opAttr = btn.getAttribute('data-op') || '';
      var quick = btn.getAttribute('data-sell-quick') || '';
      if (quick) {
        // 快速選擇數量按鈕
        var inp = document.getElementById('sellQty');
        var maxEl = document.getElementById('sellQtyMax');
        var max = maxEl ? parseInt(maxEl.value,10) : 1;
        if (inp) {
          if (quick === 'max') { inp.value = String(max); }
          else {
            var qv = parseInt(quick,10);
            if (!isNaN(qv) && qv >= 1) {
              if (qv > max) qv = max;
              inp.value = String(qv);
            }
          }
        }
        return;
      }
      if (opAttr === 'cancel-sell') {
        // 回到原本操作面板（從按鈕身上的 type/idx 回去）
        var ct = btn.getAttribute('data-type') || '';
        var ci = +(btn.getAttribute('data-idx') || '0');
        openBagAction(ct, ci);
        return;
      }
      if (opAttr === 'confirm-sell') {
        var ct2 = btn.getAttribute('data-type') || '';
        var ci2 = +(btn.getAttribute('data-idx') || '0');
        if (ct2 === 'consumable') { bagSellConsumable(ci2); }
        else if (ct2 === 'material') { bagSellMaterial(ci2); }
        else if (ct2 === 'hidden') { bagSellHidden(ci2); }
        else if (ct2 === 'weapon') { bagSellWeapon(ci2); }
        
        // ✅ 新增這一行：販賣完成後關閉操作面板
        closeBagAction();
        return;
      }

      var type = btn.dataset.type;
      var op   = btn.dataset.op;
      var idx  = +(btn.dataset.idx || 0);
      var P2   = state.player;

      if (type === 'consumable') {
        if (op === 'use') bagUseConsumable(idx);
        else if (op === 'sell') { openSellPanel('consumable', idx); return; }
        else if (op === 'throw') bagThrowConsumable(idx);

      } else if (type === 'weapon') {
        if (op === 'equip') bagEquipWeapon(idx);
        else if (op === 'repair') bagRepairWeapon(idx);
        else if (op === 'sell') { openSellPanel('weapon', idx); return; }
        else if (op === 'throw') bagThrowWeapon(idx);

      } else if (type === 'ornament') {
        if (op === 'equip') {
          if (typeof bagEquipOrnament === 'function') {
            bagEquipOrnament(idx);
          } else {
            var o = (P2 && P2.bag && P2.bag.ornaments) ? P2.bag.ornaments[idx] : null;
            if (!o) { closeBagAction(); return; }
            if (typeof o === 'string') {
              var kindsL = ['ornaments','rings','earrings','cloaks','armors','boots','medals'];
              var defL = null, iL;
              for (iL=0;iL<kindsL.length;iL++) {
                var tmp = (window.ItemDB && ItemDB.getDef) ? ItemDB.getDef(kindsL[iL], o) : null;
                if (tmp) { defL = tmp; break; }
              }
              o = defL ? { id: o, name: (defL.name || o), icon: (defL.icon || '') } : { id: o };
              if (P2 && P2.bag && P2.bag.ornaments) P2.bag.ornaments[idx] = o;
            }
            var equippedOk = false;
            if (window.Equip && Equip.equipOrnament) {
              equippedOk = !!Equip.equipOrnament(o);
            }
            if (!equippedOk) {
              P2.equip = P2.equip || { weapon:null, earrings:[null,null], rings:[null,null], cloak:null, armor:null, shoes:null, medals:[null,null,null,null,null] };
              var kind = '';
              if (window.ItemDB && ItemDB.getDef) {
                if (ItemDB.getDef('ornaments', o.id)) kind = 'rings';
                else if (ItemDB.getDef('rings', o.id)) kind = 'rings';
                else if (ItemDB.getDef('earrings', o.id)) kind = 'earrings';
                else if (ItemDB.getDef('cloaks', o.id)) kind = 'cloak';
                else if (ItemDB.getDef('armors', o.id)) kind = 'armor';
                else if (ItemDB.getDef('boots', o.id)) kind = 'shoes';
                else if (ItemDB.getDef('medals', o.id)) kind = 'medals';
              }
              if (!kind) { if (window.Game && Game.log) Game.log('無法辨識飾品種類','warn'); closeBagAction(); return; }
              var back = null, j;
              if (kind === 'rings' || kind === 'earrings' || kind === 'medals') {
                var cap = (kind === 'medals') ? 5 : 2;
                var arr = (P2.equip[kind] && P2.equip[kind].slice) ? P2.equip[kind] : new Array(cap);
                for (j=0;j<cap;j++) if (typeof arr[j] === 'undefined') arr[j] = null;
                for (j=0;j<arr.length;j++){ if (arr[j] && arr[j].id === o.id) { if(window.Game&&Game.log)Game.log('不可重複裝備相同飾品','warn'); closeBagAction(); return; } }
                var pos = -1; for (j=0;j<arr.length;j++){ if(!arr[j]){ pos=j; break; } }
                if (pos === -1) { back = arr[0]; arr[0] = JSON.parse(JSON.stringify(o)); }
                else { arr[pos] = JSON.parse(JSON.stringify(o)); }
                P2.equip[kind] = arr;
              } else {
                back = P2.equip[kind] || null;
                P2.equip[kind] = JSON.parse(JSON.stringify(o));
              }
              if (P2 && P2.bag && P2.bag.ornaments) { P2.bag.ornaments.splice(idx, 1); }
              if (back){
                P2.bag = P2.bag || {};
                P2.bag.ornaments = Array.isArray(P2.bag.ornaments) ? P2.bag.ornaments : [];
                try { P2.bag.ornaments.unshift(JSON.parse(JSON.stringify(back))); }
                catch(_){ P2.bag.ornaments.unshift(back); }
              }
              equippedOk = true;
            }
            if (equippedOk) {
              if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P2);
              render(P2); renderBag('ornament');
            }
          }
        } else if (op === 'sell') {
        // ✅ 飾品直接確認販賣（不可堆疊，像武器一樣）
        var o = (P2 && P2.bag && P2.bag.ornaments) ? P2.bag.ornaments[idx] : null;
        if (!o) { closeBagAction(); return; }
        
        // 取得飾品定義和價格
        var kindsL = ['ornaments','rings','earrings','cloaks','armors','boots','medals'];
        var defL = null, iL;
        for (iL=0;iL<kindsL.length;iL++) {
          var tmp = (window.ItemDB && ItemDB.getDef) ? ItemDB.getDef(kindsL[iL], o.id || o) : null;
          if (tmp) { defL = tmp; break; }
        }
        
        var itemName = o.name || (defL && defL.name) || '飾品';
        var price = o.price || (defL && defL.price) || 0;
        
        // 確認販賣對話框
        if (confirm('確定要販賣：「' + itemName + '」？（可得 ' + price + ' 靈石）')) {
          // 增加靈石
          P2.currencies = P2.currencies || {stone:0, diamond:0};
          P2.currencies.stone += price;
          
          // 從背包移除
          P2.bag.ornaments.splice(idx, 1);
          
          // 儲存並重新渲染
          if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P2);
          render(P2); 
          renderBag('ornament');
          
          // 顯示成功訊息
          if (window.Game && Game.log) {
            Game.log('販賣 ' + itemName + '，獲得 ' + price + ' 靈石', 'ok');
          }
        }
        closeBagAction();
        return;

        } else if (op === 'throw') {
          if (window.Game && Game.log) Game.log('飾品丟棄尚未實作。','warn');
          closeBagAction(); // ✅ 新增：保持邏輯一致性
          return;           // ✅ 新增：保持邏輯一致性
        }

      } else if (type === 'hidden') {
        if (op === 'use')  { if (window.Game && Game.log) Game.log('暗器僅能在戰鬥中使用。','info'); }
        else if (op === 'sell') { openSellPanel('hidden', idx); return; }
        else if (op === 'throw'){ 
          if (window.Game && Game.log) Game.log('暗器丟棄尚未實作。','warn'); 
          closeBagAction(); // ✅ 新增：保持邏輯一致性
          return;           // ✅ 新增：保持邏輯一致性
        }

      } else if (type === 'material') {
        if (op === 'sell')  { openSellPanel('material', idx); return; }
        else if (op === 'throw') bagThrowMaterial(idx);
      }

      closeBagAction();
      return;
    }    
  });

  // 登出按鈕
  document.getElementById('btnLogout')?.addEventListener('click', ()=>{
    if (confirm('要登出嗎？')) {
      if (window.Auth && Auth.logout) Auth.logout();
      location.href = 'index.html';
    }
  });
}

/* ===== Appearance（外觀） ===== */
function openAppearance(){
  if (window.Appearance && typeof Appearance.open === 'function'){
    Appearance.open();
  }else{
    alert('appearance.js 未載入');
  }
}


/* ===== Shop (NPC → Items) ===== */
function openShop(){
  renderMerchants();
  const m = qs('#shopModal'); if(!m) return;
  m.classList.add('show'); m.setAttribute('aria-hidden','false');
}
function closeShop(){
  const m = qs('#shopModal'); if(!m) return;
  m.classList.remove('show'); m.setAttribute('aria-hidden','true');
  const list = qs('#merchantList'); const page = qs('#merchantShop');
  if(list) list.style.display = 'block';
  if(page) page.style.display = 'none';
}

/* 商人清單頁 */
function renderMerchants(){
  const box = qs('#merchantList'); if(!box) return;
  box.innerHTML = '';

  // 1) 藥鋪小李（固定可用）
  const li = document.createElement('div');
  li.className = 'item-row';
  li.innerHTML = ''
    + '<div class="item-thumb"><img src="https://i.ibb.co/3fNzHbn/apothecary.png" alt="藥鋪小李"></div>'
    + '<div class="item-main">'
    + '  <div class="item-title"><span class="item-name">藥鋪小李</span></div>'
    + '  <div class="item-sub"><span class="sub-left">販售丹藥</span></div>'
    + '</div>';
  li.onclick = function(){ openMerchant('藥鋪小李', ItemDB.DB.consumables || []); };
  box.appendChild(li);

  // 2) 洞窟補給商（打過萊姆洞窟 BOSS 才解鎖）
var P = (window.Auth && Auth.getCharacter) ? Auth.getCharacter() : null;
var unlocked = false;
if(P && P.mapProg && P.mapProg.slime_cave && P.mapProg.slime_cave.bossReady){ unlocked = true; }

  const cave = document.createElement('div');
  cave.className = 'item-row';
  cave.style.filter = unlocked ? 'none' : 'grayscale(1) opacity(.5)';
  cave.innerHTML = ''
    + '<div class="item-thumb"><img src="https://i.ibb.co/QnLR7vN/cave-merchant.png" alt="洞窟補給商"></div>'
    + '<div class="item-main">'
    + '  <div class="item-title"><span class="item-name">洞窟補給商</span></div>'
    + '  <div class="item-sub"><span class="sub-left">' + (unlocked ? '販售特用品' : '尚未解鎖') + '</span></div>'
    + '</div>';
  if(unlocked){
    cave.onclick = function(){ 
      openMerchant('洞窟補給商', [
        { id:'antidote', name:'解毒藥', price:120, icon:'https://i.ibb.co/JxR7ZzP/antidote.png' }
      ]);
    };
  }
  box.appendChild(cave);
}

/* 進入某位商人 → 顯示商品清單 */
function openMerchant(name, items){
  const list = qs('#merchantList'); const page = qs('#merchantShop');
  if(list) list.style.display = 'none';
  if(page) page.style.display = 'block';
  const ttl = qs('#merchantName'); if(ttl) ttl.textContent = name;

  const box = qs('#shopList'); if(!box) return;
  box.innerHTML = '';
  for(var i=0;i<items.length;i++){
    var it = items[i] || {};
    var hasIcon = (typeof it.icon === 'string') && /^https?:\/\//.test(it.icon);
    var effHp = it.effect && it.effect.hp ? it.effect.hp : 0;
    var effMp = it.effect && it.effect.mp ? it.effect.mp : 0;
    var effHtml = '';
    if(effHp){ effHtml += '<span class="badge hp">氣血+' + effHp + '</span>'; }
    if(effMp){ effHtml += '<span class="badge">真元+' + effMp + '</span>'; }

    var row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = ''
      + '<div class="item-thumb">' + (hasIcon?('<img src="'+it.icon+'" alt="'+(it.name||'')+'">'):'') + '</div>'
      + '<div class="item-main">'
      + '  <div class="item-title cons">'
      + '    <span class="item-name">' + (it.name||'') + '</span>'
      + '    <span class="meta-effect">' + effHtml + '</span>'
      + '    <span class="count-slot">×1</span>'
      + '  </div>'
      + '  <div class="item-sub">'
      + '    <span class="sub-left">價格 ' + (it.price||0) + ' 靈石</span>'
      + '    <span class="sub-right"><button class="opx primary" data-shop-src="'+name+'" data-shop-buy="'+i+'">購買</button></span>'
      + '  </div>'
      + '</div>';
    box.appendChild(row);
  }
}

/* 購買按鈕 → 先開數量輸入框 */
document.addEventListener('click', function(e){
  var btn = e.target && e.target.closest ? e.target.closest('[data-shop-buy]') : null;
  if(!btn) return;

  var idx = parseInt(btn.getAttribute('data-shop-buy')||'0',10);
  var src = btn.getAttribute('data-shop-src') || '';

  var items = [];
  if(src === '藥鋪小李'){ items = ItemDB.DB.consumables || []; }
  else if(src === '洞窟補給商'){ 
    items = [{ id:'antidote', name:'解毒藥', price:120, icon:'https://i.ibb.co/JxR7ZzP/antidote.png' }];
  }
  var it = items[idx]; if(!it) return;

  // 開啟購買介面
  var m = qs('#buyModal'); if(!m) return;
  var nameEl = qs('#buyItemName'); if(nameEl) nameEl.textContent = it.name + '（單價 ' + (it.price||0) + ' 靈石）';
  m.dataset.itemIndex = idx;
  m.dataset.itemSrc = src;
  var qtyEl = qs('#buyQty'); if(qtyEl) qtyEl.value = 1;
  m.classList.add('show'); m.setAttribute('aria-hidden','false');
});


/* 確定購買 */
document.getElementById('btnConfirmBuy').addEventListener('click', function(){
  var m = qs('#buyModal'); if(!m) return;
  var idx = parseInt(m.dataset.itemIndex||'0',10);
  var src = m.dataset.itemSrc || '';

  var items = [];
  if(src === '藥鋪小李'){ items = ItemDB.DB.consumables || []; }
  else if(src === '洞窟補給商'){ 
    items = [{ id:'antidote', name:'解毒藥', price:120, icon:'https://i.ibb.co/JxR7ZzP/antidote.png' }];
  }
  var it = items[idx]; if(!it) return;

  var qtyEl = qs('#buyQty');
  var qty = parseInt((qtyEl ? qtyEl.value : '1')||'1',10);
  if(qty<1) qty=1;

  var P = Game.getPlayer(); if(!P) return;
  var stone = (P.currencies && typeof P.currencies.stone==='number') ? P.currencies.stone : 0;
  var cost = (it.price||0) * qty;
  if(stone < cost){
    Game.log('靈石不足，無法購買 ' + (it.name||'') + ' ×' + qty, 'warn');
    return;
  }

  P.currencies.stone = stone - cost;
  ItemDB.addConsumableToBag(P.bag, it.id, qty);

  if(window.Auth && Auth.saveCharacter) {
    var cleanData = JSON.parse(JSON.stringify(P));
    delete cleanData._live;
    Auth.saveCharacter(cleanData);
  }
  Game.recalc();
  Game.log('購買 ' + (it.name||'') + ' ×' + qty + ' 成功！', 'ok');

  // 關閉購買框
  m.classList.remove('show'); m.setAttribute('aria-hidden','true');
});


/* 關閉購買框 */
document.querySelectorAll('[data-close="buy"]').forEach(function(el){
  el.addEventListener('click', function(){
    var m = qs('#buyModal'); if(!m) return;
    m.classList.remove('show'); m.setAttribute('aria-hidden','true');
  });
});

/* 返回商人清單、關閉商店 */
var backBtn = document.getElementById('btnBackMerchants');
if(backBtn){
  backBtn.addEventListener('click', function(){
    var list = qs('#merchantList'); var page = qs('#merchantShop');
    if(list) list.style.display = 'block';
    if(page) page.style.display = 'none';
  });
}
document.querySelectorAll('[data-close="shop"]').forEach(function(el){
  el.addEventListener('click', closeShop);
});

  /* ===== Bag ===== */
  function openBag(){ seedBagIfMissing(); renderBag('consumable'); const m = qs('#bagModal'); if(!m) return; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
  
  function closeBag(){ const m = qs('#bagModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
  function switchBagTab(k){ document.querySelectorAll('.bag-tab').forEach(t=> t.classList.toggle('active', t.dataset.bagTab===k)); renderBag(k); }

function renderBag(k){
  const P = state.player; if(!P) return;
  const box = qs('#bagList'); if(!box) return;
  box.innerHTML = '';
  if (k === 'consumable') {
    renderConsumables(box, P);
  } else if (k === 'weapon') {
    renderWeapons(box, P);
  } else if (k === 'ornament') {
    renderOrnaments(box, P);
  } else if (k === 'hidden') {
    renderHidden(box, P);
  } else if (k === 'material') {
    renderMaterials(box, P);
  } else {
    const tip = document.createElement('div'); tip.className='item-sub';
    tip.textContent = '尚無內容';
    box.appendChild(tip);
  }
}


/* === 新增：飾品清單渲染 === */
function renderOrnaments(box, P){
  const items = (P.bag && P.bag.ornaments) ? P.bag.ornaments : [];
  const url = (s)=> typeof s==='string' && /^https?:\/\//.test(s);

  items.forEach((o,i)=>{
    // 依次在不同表格找定義，避免因分類不同取不到
    let def = ItemDB.getDef('ornaments', o.id) ||
              ItemDB.getDef('rings',     o.id) ||
              ItemDB.getDef('earrings',  o.id) ||
              ItemDB.getDef('cloaks',    o.id) ||
              ItemDB.getDef('armors',    o.id) ||
              ItemDB.getDef('boots',     o.id) ||
              ItemDB.getDef('medals',    o.id) || {};
    const iconUrl = url(o.icon) ? o.icon : (url(def.icon) ? def.icon : null);
    const name = o.name || def.name || o.id;
    // 清單列只顯示「真元／氣血」兩個主要數值
    const bonus = o.bonus || def.bonus || {};
    const effect = o.effect || def.effect || {};
    let mp = 0, hp = 0;
    if (effect.mp) mp += effect.mp;
    if (effect.hp) hp += effect.hp;
    if (bonus['真元上限']) mp += bonus['真元上限'];
    if (bonus['氣血上限']) hp += bonus['氣血上限'];
    let primary = [];
    if (mp) primary.push('真元+'+mp);
    if (hp) primary.push('氣血+'+hp);
    const subLeft  = primary.join(' ');
    const subRight = '販售價格 ' + (o.price ?? def.price ?? 0);

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'ornament';
    row.dataset.idx  = String(i);
    row.innerHTML = `
      <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${name}">`:''}</div>
      <div class="item-main">
        <div class="item-title equip">
          <span class="item-name">${name}</span>
        </div>
        <div class="item-sub">
          <span class="sub-left">${subLeft}</span>
          <span class="sub-right">${subRight}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });
  if (!items.length){
    const tip = document.createElement('div'); tip.className='item-sub';
    tip.textContent = '尚無飾品';
    box.appendChild(tip);
  }
}


/* === 新增：暗器清單渲染 === */
function renderHidden(box, P){
  const items = (P.bag && P.bag.hidden) ? P.bag.hidden : [];
  const url = function(s){ return typeof s==='string' && /^https?:\/\//.test(s); };

  items.forEach(function(h, i){
    const def = (ItemDB.getDef && ItemDB.getDef('hidden', h.id)) || {};
    const iconUrl = url(h.icon) ? h.icon : (url(def.icon) ? def.icon : null);
    const name = (h.name!=null ? h.name : (def.name!=null ? def.name : h.id));
    const cnt = Math.max(0, h.count || 0);
    var dmg = (h.effect && typeof h.effect.dmg==='number') ? h.effect.dmg
            : (def.effect && typeof def.effect.dmg==='number') ? def.effect.dmg : 0;
    var subLeft  = dmg ? ('傷害 ' + dmg) : (def.desc ? def.desc : '戰鬥中可使用以造成傷害');
    var subRight = '販售價格 ' + String(h.price!=null ? h.price : (def.price || 0));

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'hidden';
    row.dataset.idx = String(i);
    row.innerHTML = `
      <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${name}">`:''}</div>
      <div class="item-main">
        <div class="item-title cons">
          <span class="item-name">${name}</span>
          <span class="count-slot">×${cnt}</span>
        </div>
        <div class="item-sub">
          <span class="sub-left">${subLeft}</span>
          <span class="sub-right">${subRight}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });

  if (!items.length){
    const tip = document.createElement('div'); tip.className='item-sub';
    tip.textContent = '尚無暗器';
    box.appendChild(tip);
  }
}

function openBagAction(type, idx){
  const P = state.player; if(!P) return;
  const m = qs('#bagAction'); if(!m) return;

  // 工具
  const isUrl = function(s){ return typeof s === 'string' && /^https?:\/\//.test(s); };
  const clampInt = function(n, lo, hi){ n = n|0; if(n<lo) n=lo; if(n>hi) n=hi; return n; };
  const esc = function(s){ s=String(s); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); };

  // 把 bonus / effect 做成細節 HTML（所有物品共用）
  function buildDetailHTML(kind, it, def){
    var lines = [];

    function addPlus(label, v){
      if (typeof v !== 'number') return;
      if (!v) return;
      lines.push(label + (v>0 ? ('+'+v) : v));
    }
    function addRaw(label, v){
      if (typeof v !== 'number') return;
      if (!v && v!==0) return;
      lines.push(label + ' ' + v);
    }

    // 1) bonus（裝備/飾品用）
    var b = (it && it.bonus) ? it.bonus : (def && def.bonus ? def.bonus : null);
    if (b){
      for (var k in b){
        if(!Object.prototype.hasOwnProperty.call(b,k)) continue;
        var v = b[k];
        if (v===0 || v===null || v===undefined) continue;
        if (k==='真元上限') addPlus('真元上限', v);
        else if (k==='氣血上限') addPlus('氣血上限', v);
        else if (k==='物理攻擊') addPlus('物理攻擊', v);
        else if (k==='法術攻擊') addPlus('法術攻擊', v);
        else if (k==='物理防禦') addPlus('物理防禦', v);
        else if (k==='法術防禦') addPlus('法術防禦', v);
        else if (k==='命中') addPlus('命中', v);
        else if (k==='閃避') addPlus('閃避', v);
        else if (k==='暴擊') addPlus('暴擊', v);
        else if (k==='攻速') addPlus('攻速', v);
        else addPlus(k, v);
      }
    }

    // 2) effect（消耗品/暗器/部分飾品）
    var e = (it && it.effect) ? it.effect : (def && def.effect ? def.effect : null);
    if (e){
      addPlus('氣血', e.hp);
      addPlus('真元', e.mp);
      addPlus('物攻', e.atk);
      addPlus('法攻', e.matk);
      addPlus('防禦', e.def);
      addPlus('法防', e.mdef);
      addPlus('命中', (e.acc!=null?e.acc:e.hit));
      addPlus('閃避', (e.eva!=null?e.eva:e.evd));
      addPlus('暴擊', (e.crit!=null?e.crit:e.cri));
      addPlus('攻速', (e.aspd!=null?e.aspd:e.spd));
      addPlus('力', e.str);
      addPlus('體', e.vit);
      addPlus('悟', e.int);
      addPlus('敏', e.agi);
      addRaw('傷害', e.dmg);
    }

    // 3) 武器專屬資訊
    if (kind==='weapon'){
      var dmg = (it && it.dmg) ? it.dmg : (def && def.dmg ? def.dmg : null);
      var plus = (it && typeof it.plus==='number') ? it.plus : (def && def.plus ? def.plus : 0);
      if (dmg && typeof dmg.length==='number'){
        var dmin = dmg[0]||0, dmax = dmg[1]||0;
        lines.push('物攻 ' + dmin + '~' + dmax + (plus?(' +' + plus):''));
      }
      var durCur = (it && it.dur && typeof it.dur.cur==='number') ? it.dur.cur : (def && typeof def.durCur==='number' ? def.durCur : null);
      var durMax = (it && it.dur && typeof it.dur.max==='number') ? it.dur.max : (def && typeof def.durMax==='number' ? def.durMax : null);
      if (durMax!==null && durMax!==undefined){
        lines.push('耐久 ' + (durCur!==null && durCur!==undefined ? (durCur + '/' + durMax) : durMax));
      }
    }

    // 4) 材料描述
    if (kind==='material' && def && def.desc){
      lines.push('用途：' + def.desc);
    }

    // 5) 暗器描述
    if (kind==='hidden' && def && def.desc){
      lines.push('說明：' + def.desc);
    }

    if (!lines.length) lines.push('無額外屬性');
    var html = '';
    for (var i=0;i<lines.length;i++){
      html += '<div class="line">' + esc(lines[i]) + '</div>';
    }
    return html;
  }

  let name='', subRight='', iconUrl=null, btnsHtml='';

  if (type === 'consumable') {
    const it  = (P.bag.consumables || [])[idx]; if (!it) return;
    const def = ItemDB.getDef('consumables', it.id) || {};
    name     = it.name || def.name || it.id;

    const effHp  = (it.effect && typeof it.effect.hp==='number') ? it.effect.hp
                   : (def.effect && typeof def.effect.hp==='number') ? def.effect.hp : 0;
    const effTxt = effHp ? ('<span class="badge hp">氣血+' + effHp + '</span>') : '';
    subRight = '販售價格 ' + String( (it.price!=null?it.price:(def.price||0)) );
    iconUrl  = isUrl(it.icon) ? it.icon : (isUrl(def.icon) ? def.icon : null);
    const cnt = clampInt(it.count ?? 0, 0, 9999);

    qs('#actTop').className = 'item-title cons';
    qs('#actTop').innerHTML = ''
      + '<span class="item-name">' + esc(name) + '</span>'
      + '<span class="meta-effect">' + effTxt + '</span>'
      + '<span class="count-slot">×' + cnt + '</span>';

    qs('#actLeft').innerHTML   = buildDetailHTML('consumable', it, def);
    qs('#actRight').textContent = subRight;

    btnsHtml = ''
      + '<button class="opx primary" data-op="use"   data-type="consumable" data-idx="'+idx+'">使用</button>'
      + '<button class="opx"         data-op="sell"  data-type="consumable" data-idx="'+idx+'">販賣</button>'
      + '<button class="opx"         data-op="throw" data-type="consumable" data-idx="'+idx+'">丟棄</button>';



  } else if (type === 'material') {
    const mat = (P.bag.materials || [])[idx]; if (!mat) return;
    const def = ItemDB.getDef('materials', mat.id) || {};
    name     = mat.name || def.name || mat.id;
    iconUrl  = isUrl(mat.icon) ? mat.icon : (isUrl(def.icon) ? def.icon : null);
    const cnt = clampInt(mat.count ?? 0, 0, 9999);
    subRight = def.price ? ('販售價格 ' + def.price) : '';

    qs('#actTop').className = 'item-title';
    qs('#actTop').innerHTML = ''
      + '<span class="item-name">' + esc(name) + '</span>'
      + '<span class="count-slot">×' + cnt + '</span>';

    qs('#actLeft').innerHTML   = buildDetailHTML('material', mat, def);
    qs('#actRight').textContent = subRight;

    btnsHtml = ''
      + '<button class="opx"         data-op="sell"  data-type="material" data-idx="'+idx+'">販賣</button>'
      + '<button class="opx"         data-op="throw" data-type="material" data-idx="'+idx+'">丟棄</button>';



  } else if (type === 'weapon') {
    const w   = (P.bag.weapons || [])[idx]; if (!w) return;
    const def = ItemDB.getDef('weapons', w.id) || {};
    name     = w.name || def.name || w.id;
    const dmg = Array.isArray(w.dmg) ? w.dmg : (def.dmg || [0,0]);
    const dmin = dmg[0]||0, dmax = dmg[1]||0;
    const plus = (typeof w.plus==='number') ? w.plus : (def.plus||0);
    const durCur = (w.dur && typeof w.dur.cur==='number') ? w.dur.cur : (def.durCur||0);
    const durMax = (w.dur && typeof w.dur.max==='number') ? w.dur.max : (def.durMax||0);
    iconUrl  = isUrl(w.icon) ? w.icon : (isUrl(def.icon) ? def.icon : null);
    subRight = '販售價格 ' + String(w.price ?? def.price ?? 0);

    qs('#actTop').className = 'item-title wep';
    qs('#actTop').innerHTML = ''
      + '<span class="item-name">' + esc(String(name).replace(/^(普|精|稀|史|傳)的?/,'') ) + '</span>'
      + '<span class="meta-effect">' + (dmin||dmax ? ('<span class="badge atk">' + dmin + '~' + dmax + (plus?(' +' + plus):'') + '</span>') : '') + '</span>'
      + '<span class="dur-chip">' + (durMax ? (durCur + '/' + durMax) : '') + '</span>';

    qs('#actLeft').innerHTML   = buildDetailHTML('weapon', w, def);
    qs('#actRight').textContent = subRight;

  // ✅ 正確
  btnsHtml = ''
    + '<button class="opx primary" data-op="equip" data-type="weapon" data-idx="'+idx+'">裝備</button>'
    + '<button class="opx"         data-op="sell"  data-type="weapon" data-idx="'+idx+'">販賣</button>'
    + '<button class="opx"         data-op="throw" data-type="weapon" data-idx="'+idx+'">丟棄</button>';



  } else if (type === 'ornament') {
    const o = (P.bag.ornaments || [])[idx]; if(!o) return;
    // 依你的清單渲染邏輯一樣走多類別找定義，避免因分類不同取不到 def
    const def = ItemDB.getDef('ornaments', o.id)
            || ItemDB.getDef('earrings', o.id)
            || ItemDB.getDef('cloaks',   o.id)
            || ItemDB.getDef('armors',   o.id)
            || ItemDB.getDef('boots',    o.id)
            || ItemDB.getDef('medals',   o.id)
            || {};
    name    = o.name || def.name || o.id;
    iconUrl = isUrl(o.icon) ? o.icon : (isUrl(def.icon) ? def.icon : null);
    subRight = '販售價格 ' + String(o.price != null ? o.price : (def.price || 0));

    qs('#actTop').className = 'item-title equip';
    qs('#actTop').innerHTML = ''
      + '<span class="item-name">' + esc(name) + '</span>';

    // 顯示完整屬性
    qs('#actLeft').innerHTML   = buildDetailHTML('ornament', o, def);
    qs('#actRight').textContent = subRight;

    btnsHtml = ''
      + '<button class="opx primary" data-op="equip" data-type="ornament" data-idx="'+idx+'">裝備</button>'
      + '<button class="opx"         data-op="sell"  data-type="ornament" data-idx="'+idx+'">販賣</button>'
      + '<button class="opx"         data-op="throw" data-type="ornament" data-idx="'+idx+'">丟棄</button>';

  } else if (type === 'hidden') {
    const h  = (P.bag.hidden || [])[idx]; if (!h) return;
    const def = ItemDB.getDef('hidden', h.id) || {};
    name     = h.name || def.name || h.id;
    const cnt = clampInt(h.count ?? 0, 0, 9999);
    iconUrl  = isUrl(h.icon) ? h.icon : (isUrl(def.icon) ? def.icon : null);
    subRight = def.price ? ('販售價格 ' + def.price) : '';

    qs('#actTop').className = 'item-title cons';
    qs('#actTop').innerHTML = ''
      + '<span class="item-name">' + esc(name) + '</span>'
      + '<span class="count-slot">×' + cnt + '</span>';

    qs('#actLeft').innerHTML   = buildDetailHTML('hidden', h, def);
    qs('#actRight').textContent = subRight;

    btnsHtml = ''
      + '<button class="opx" data-op="sell"  data-type="hidden" data-idx="'+idx+'">販賣</button>'
      + '<button class="opx" data-op="throw" data-type="hidden" data-idx="'+idx+'">丟棄</button>';

  } else {
    return;
  }

  qs('#actIcon').innerHTML = iconUrl ? ('<img src="'+esc(iconUrl)+'" alt="">') : '';
  qs('#actBtns').innerHTML = btnsHtml;

  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
}

// 關閉背包操作面板

  function closeBagAction(){ const m = qs('#bagAction'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); qs('#actBtns').innerHTML = ''; }

// === 統一販賣面板 ===
function openSellPanel(type, idx){
  var P = state.player; if(!P) return;
  var name = '', unitPrice = 0, max = 1;

  // 根據物品類型取得物品資訊和價格
  if (type === 'consumable') {
    var it = (P.bag && P.bag.consumables) ? P.bag.consumables[idx] : null; if(!it) return;
    var def = ItemDB.getDef('consumables', it.id) || {};
    name = it.name || def.name || it.id;
    unitPrice = (it.price != null ? it.price : (def.price || 0));
    max = it.count || 0;
  } else if (type === 'material') {
    var m = (P.bag && P.bag.materials) ? P.bag.materials[idx] : null; if(!m) return;
    var d = ItemDB.getDef('materials', m.id) || {};
    name = m.name || d.name || m.id;
    unitPrice = (d.price || 0);
    max = m.count || 0;
  } else if (type === 'hidden') {
    var h = (P.bag && P.bag.hidden) ? P.bag.hidden[idx] : null; if(!h) return;
    var dh = ItemDB.getDef('hidden', h.id) || {};
    name = h.name || dh.name || h.id;
    unitPrice = (dh.price || 0);
    max = h.count || 0;
  } else if (type === 'weapon') {
    var w = (P.bag && P.bag.weapons) ? P.bag.weapons[idx] : null; if(!w) return;
    var dw = ItemDB.getDef('weapons', w.id) || {};
    name = w.name || dw.name || w.id;
    unitPrice = (w.price != null ? w.price : (dw.price || 0));
    max = 1; // 武器只能販賣一件
  } else {
    return;
  }

  // 生成販賣面板HTML
  var btns = ''
    + '<div id="sellBox" style="display:grid;gap:6px;">'
    +   '<div style="text-align:center;font-weight:700;">販賣數量</div>'
    +   '<input id="sellQtyMax" type="hidden" value="'+max+'">' // 隱藏欄位記錄最大數量
    +   '<div style="display:flex;gap:8px;align-items:center;justify-content:center;">'
    +     '<input id="sellQty" type="number" min="1" max="'+max+'" value="'+(max>0?1:0)+'" style="width:100px;text-align:center;">' // 數量輸入框
    +   '</div>'
    +   '<div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;">' // 快速選擇按鈕
    +     '<button class="opx" data-sell-quick="1">1</button>'
    +     '<button class="opx" data-sell-quick="5">5</button>'
    +     '<button class="opx" data-sell-quick="10">10</button>'
    +     '<button class="opx" data-sell-quick="100">100</button>'
    +     '<button class="opx" data-sell-quick="max">最大</button>'
    +   '</div>'
    +   '<div class="ops" style="justify-content:center;">' // 操作按鈕
    +     '<button class="opx" data-op="cancel-sell" data-type="'+type+'" data-idx="'+idx+'">取消</button>'
    +     '<button class="opx primary" data-op="confirm-sell" data-type="'+type+'" data-idx="'+idx+'">確定販賣</button>'
    +   '</div>'
    +   '<div id="sellHint" style="text-align:center;font-size:12px;color:#e2e8f0;">單價 '+unitPrice+'，最多 '+max+' 件</div>' // 價格提示
    + '</div>';

  // 將面板HTML插入到操作按鈕容器
  var box = qs('#actBtns'); if(box) box.innerHTML = btns;
}


// 供 confirm 用於暗器賣出（原本未實作）
function bagSellHidden(i){
  var P = state.player; if(!P) return;
  var h = (P.bag && P.bag.hidden) ? P.bag.hidden[i] : null; if(!h) return;
  
  // 取得暗器定義和價格資訊
  var def = ItemDB.getDef('hidden', h.id) || {};
  var price = (def.price || 0);
  var max = h.count || 0;
  
  // 從販賣面板取得要賣出的數量
  var qtyEl = document.getElementById('sellQty');
  var qty = qtyEl ? parseInt(qtyEl.value,10) : max;
  if (!qty || qty < 1 || qty > max) return;
  
  // 增加玩家貨幣（靈石）
  P.currencies = P.currencies || { stone:0, diamond:0 };
  P.currencies.stone += qty * price;
  
  // 減少物品數量，如果用完就從背包移除
  h.count = (h.count||0) - qty;
  if (h.count <= 0) { P.bag.hidden.splice(i,1); }
  
  // 儲存並重新渲染
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); renderBag('hidden');
}

// 初始化背包結構（確保所有分類都存在）
function seedBagIfMissing(){
  const P = state.player; if(!P) return;
  
  // 如果沒有背包就建立預設背包
  if (!P.bag) { P.bag = ItemDB.getDefaultBag(); return; }
  
  // 確保各個物品分類都是陣列
  P.bag.consumables = Array.isArray(P.bag.consumables) ? P.bag.consumables : [];
  P.bag.weapons     = Array.isArray(P.bag.weapons)     ? P.bag.weapons     : [];
  P.bag.ornaments   = Array.isArray(P.bag.ornaments)   ? P.bag.ornaments   : [];
  P.bag.materials   = Array.isArray(P.bag.materials)   ? P.bag.materials   : [];
  P.bag.hidden      = Array.isArray(P.bag.hidden)      ? P.bag.hidden      : [];
}

// 渲染消耗品列表
function renderConsumables(box, P){
  const items = P.bag.consumables || [];
  const isUrl = s => typeof s === 'string' && /^https?:\/\//.test(s); // 檢查是否為有效URL

  items.forEach((it, i) => {
    // 取得物品基本資訊
    const def = ItemDB.getDef('consumables', it.id) || {};
    const name  = it.name  || def.name  || it.id;
    const price = (it.price ?? def.price ?? 0);
    
    // 處理效果顯示（氣血恢復）
    const effHp = (it.effect?.hp ?? def.effect?.hp);
    const effHtml = effHp ? `<span class="badge hp">氣血+${effHp}</span>` : '';
    
    // 處理圖示URL
    const iconUrl = isUrl(it.icon) ? it.icon : (isUrl(def.icon) ? def.icon : null);
    const cnt = Math.max(0, it.count || 0);

    // 建立物品列表元素
    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'consumable'; // 標記物品類型
    row.dataset.idx  = String(i);    // 標記索引位置

    // 生成物品HTML結構
    row.innerHTML = `
      <div class="item-thumb">${iconUrl ? `<img src="${iconUrl}" alt="${name}">` : ''}</div>
      <div class="item-main">
        <div class="item-title cons">
          <span class="item-name">${name}</span>
          <span class="meta-effect">${effHtml}</span>
          <span class="count-slot">×${cnt}</span>
        </div>
        <div class="item-sub">
          <span class="sub-left"></span>
          <span class="sub-right">販售價格 ${price}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });
}


function renderWeapons(box, P){
  const items = P.bag.weapons || [];
  const url = (s)=> typeof s==='string' && /^https?:\/\//.test(s);

  items.forEach((w, i)=>{
    const def = ItemDB.getDef('weapons', w.id);
    const iconUrl = url(w.icon) ? w.icon : (url(def?.icon) ? def.icon : null);
    const name = w.name || def?.name || w.id;
    const r = (w.rarity || def?.rarity || '').trim();            // ★ 稀有度（普/精/稀/史/傳）
    const rCls = r ? `rarity-${r}` : '';
    const rBadge = r ? `<span class="rb rb-${r}" title="稀有度">${r}</span>` : '';

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'weapon';
    row.dataset.idx = String(i);

    row.innerHTML = `
      <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${name}">`:''}</div>
      <div class="item-main">
        <div class="item-title wep">
          <span class="badge-lv">LV.${w.level ?? def?.level ?? 1}</span>
          <span class="item-name ${rCls}">${rBadge}${String(name).replace(/^(普|精|稀|史|傳)的?/, '')}</span>
          <span class="right-meta">
            <span>+${w.plus || 0}</span>
            <span class="dur-chip">耐久 ${(w.dur?.cur ?? def?.durMax ?? 0)}/${(w.dur?.max ?? def?.durMax ?? 0)}</span>
          </span>
        </div>
        <div class="item-sub">
          <span class="sub-left">物理攻擊 ${(Array.isArray(w.dmg)?w.dmg[0]:(def?.dmg?.[0]??0))}-${(Array.isArray(w.dmg)?w.dmg[1]:(def?.dmg?.[1]??0))}</span>
          <span class="sub-right">販售價格 ${w.price ?? def?.price ?? 0}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });
}

/* ★ 新增：材料清單渲染 */
function renderMaterials(box, P){
  const items = P.bag.materials || [];
  const url = (s)=> typeof s==='string' && /^https?:\/\//.test(s);

  items.forEach((m, i)=>{
    const def = ItemDB.getDef('materials', m.id);
    const iconUrl = url(m.icon) ? m.icon : (url(def?.icon) ? def.icon : null);
    const cnt = Math.max(0, m.count || 0);
    const name = m.name || def?.name || m.id;
    const r = (m.rarity || def?.rarity || '').trim();            // ★ 稀有度（普/精/稀/史/傳）
    const rCls = r ? `rarity-${r}` : '';
    const rBadge = r ? `<span class="rb rb-${r}" title="稀有度">${r}</span>` : '';

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'material';
    row.dataset.idx = String(i);

    row.innerHTML = `
      <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${name}">`:''}</div>
      <div class="item-main">
        <div class="item-title">
          <span class="item-name ${rCls}">${rBadge}${name}</span>
          <span class="count-slot">×${cnt}</span>
        </div>
        <div class="item-sub">
          <span class="sub-left">${def?.desc ? def.desc : (r ? '稀有度 '+r : '')}</span>
          <span class="sub-right">${def?.price ? `販售價格 ${def.price}` : ''}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });

  if (!items.length){
    const tip = document.createElement('div'); tip.className='item-sub';
    tip.textContent = '尚無材料';
    box.appendChild(tip);
  }
}

function bagUseConsumable(i){
  const P = state.player; 
  const it = P.bag.consumables[i]; 
  if(!it || !it.effect) return;
  
  // 取得基礎屬性和裝備加成（避免重複計算）
  var base  = derivedFrom(P);
  var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
  
  // 處理各種恢復效果
  const effects = it.effect;
  
  // 氣血恢復
  if (effects.hp){
    var hpMax = (base['氣血上限'] || 0) + (bonus['氣血上限'] || 0);
    P.hp = P.hp || {cur:hpMax, max:hpMax};
    P.hp.max = hpMax;
    P.hp.cur = Math.min(P.hp.cur + effects.hp, hpMax);
  }
  
  // 真元恢復
  if (effects.mp){
    var mpMax = (base['真元上限'] || 0) + (bonus['真元上限'] || 0);
    P.mp = P.mp || {cur:mpMax, max:mpMax};
    P.mp.max = mpMax;
    P.mp.cur = Math.min(P.mp.cur + effects.mp, mpMax);
  }
  
  // 體力恢復
  if (effects.sta){
    var staMax = (base['體力上限'] || 100) + (bonus['體力上限'] || 0);
    P.sta = P.sta || {cur:staMax, max:staMax};
    P.sta.max = staMax;
    P.sta.cur = Math.min(P.sta.cur + effects.sta, staMax);
  }
  
  // 經驗值增加
  if (effects.exp){
    P.exp = (P.exp || 0) + effects.exp;
    // 如果有升級檢查函數的話
    if (typeof checkLevelUp === 'function') checkLevelUp(P);
  }
  
  // 靈石增加
  if (effects.stone){
    P.stone = (P.stone || 0) + effects.stone;
  }
  
  // 屬性點增加 暫時不要動這裡 !為定義屬性ID
  if (effects.attrPoints){
    P.attrPoints = (P.attrPoints || 0) + effects.attrPoints;
  }
  
  // 特殊效果：全恢復
  if (effects.fullRestore){
    var hpMax = (base['氣血上限'] || 0) + (bonus['氣血上限'] || 0);
    var mpMax = (base['真元上限'] || 0) + (bonus['真元上限'] || 0);
    var staMax = (base['體力上限'] || 100) + (bonus['體力上限'] || 0);
    
    P.hp = {cur:hpMax, max:hpMax};
    P.mp = {cur:mpMax, max:mpMax};
    P.sta = {cur:staMax, max:staMax};
  }
  
  // 減少物品數量
  it.count = (it.count||0) - 1;
  if (it.count <= 0) P.bag.consumables.splice(i,1);
  
  // 儲存角色資料
  if (window.Auth && Auth.saveCharacter) {
    var cleanData = JSON.parse(JSON.stringify(P));
    delete cleanData._live;
    Auth.saveCharacter(cleanData);
  }
  
  // 重新渲染介面
  render(P); renderBag('consumable');
}


// 販賣消耗品功能
function bagSellConsumable(i){
  var P = state.player; 
  var it = P.bag.consumables[i]; 
  if(!it) return;
  
  // ✅ 正確取得價格：優先用物品實例價格，再用定義價格
  var def = ItemDB.getDef('consumables', it.id) || {};
  var unitPrice = (it.price != null ? it.price : (def.price || 0));
  
  // 取得最大可販賣數量
  var max = it.count||0;
  // 從販賣面板取得要販賣的數量
  var qtyEl = document.getElementById('sellQty');
  var qty = qtyEl ? parseInt(qtyEl.value,10) : max;
  // 驗證數量範圍
  if (!qty || qty<1 || qty>max) return;
  
  // 增加玩家靈石收入
  P.currencies = P.currencies || {stone:0, diamond:0};
  P.currencies.stone += qty * unitPrice;  // ✅ 使用正確的價格
  
  // 減少物品數量
  it.count -= qty;
  // 如果賣完就從背包移除
  if (it.count <= 0) P.bag.consumables.splice(i,1);
  
  // 儲存並重新渲染
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); renderBag('consumable');
  
  // ✅ 新增：顯示販賣成功訊息
  if (window.Game && Game.log) {
    Game.log(`販賣 ${it.name || def.name || '物品'} ×${qty}，獲得 ${qty * unitPrice} 靈石`, 'ok');
  }
}


// 丟棄消耗品功能
function bagThrowConsumable(i){
  const P = state.player; 
  const it = P.bag.consumables[i]; 
  if(!it) return;
  
  // 取得最大可丟棄數量
  const max = it.count||0;
  // 彈出對話框讓玩家輸入丟棄數量
  const qty = +prompt(`輸入丟棄數量（1-${max}）`, String(max));
  // 驗證輸入的數量
  if (!qty || qty<1 || qty>max) return;
  
  // 減少物品數量（無任何補償）
  it.count -= qty;
  // 如果丟完就從背包移除
  if (it.count <= 0) P.bag.consumables.splice(i,1);
  
  // 儲存並重新渲染
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); renderBag('consumable');
}

function bagEquipWeapon(i){
  const P = state.player; if(!P) return;
  P.bag = P.bag || {}; 
  P.bag.weapons = Array.isArray(P.bag.weapons) ? P.bag.weapons : [];

  const w = P.bag.weapons[i]; 
  if(!w) return;

  // 先記住舊武器（避免被覆蓋後消失）
  const prev = (P.equip && P.equip.weapon) ? P.equip.weapon : null;

  // 裝備新武器（有 Equip 模組就用它，否則直接寫入）
  if (window.Equip && Equip.equipWeapon) {
    Equip.equipWeapon(w);
  } else {
    P.equip = P.equip || {};
    try{
      P.equip.weapon = JSON.parse(JSON.stringify(w));
    }catch(_){
      P.equip.weapon = w;
    }
    renderDerived();
  }

  // 從背包移除已裝備的那把
  P.bag.weapons.splice(i, 1);

  // 若原本有裝備，丟回背包前端避免遺失
  if (prev){
    try{
      P.bag.weapons.unshift(JSON.parse(JSON.stringify(prev)));
    }catch(_){
      P.bag.weapons.unshift(prev);
    }
  }

  // 存檔 + 重繪
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); 
  renderBag('weapon');

  log('已裝備：' + (w.name || '武器'), 'ok');
}


// 武器販賣功能
function bagSellWeapon(i){
  var P = state.player; 
  var w = (P.bag && P.bag.weapons) ? P.bag.weapons[i] : null; 
  if(!w) return;
  
  // 統一走數量面板，但武器只能賣 1 件
  var qtyEl = document.getElementById('sellQty');
  var qty = qtyEl ? parseInt(qtyEl.value,10) : 1;
  if (!qty || qty < 1) qty = 1; // 確保至少為 1
  
  // 確認販賣對話框
  if (!confirm('確定要販賣：「' + (w.name || '武器') + '」？（可得 ' + (w.price||0) + ' 靈石）')) return;
  
  // 增加玩家靈石
  P.currencies = P.currencies || {stone:0, diamond:0};
  P.currencies.stone += (w.price||0);
  
  // 從背包移除武器（武器販賣後直接刪除）
  P.bag.weapons.splice(i,1);
  
  // 儲存並重新渲染
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); renderBag('weapon');
}

// 武器丟棄功能
function bagThrowWeapon(i){
  const P = state.player; 
  const w = P.bag.weapons[i]; 
  if(!w) return;
  
  // 確認丟棄對話框（強調不可回收）
  if (!confirm(`確定要丟棄：「${w.name}」？（不可回收）`)) return;
  
  // 從背包移除武器（無任何補償）
  P.bag.weapons.splice(i,1);
  
  // 儲存並重新渲染
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); renderBag('weapon');
}

// === 飾品：裝備（含回收被頂替者） ===
function bagEquipOrnament(i){
  var P = state.player; if(!P) return;
  P.bag = P.bag || {};
  var list = P.bag.ornaments || [];
  var o = list[i]; if(!o) return;
  
// 此處應該繼續飾品裝備的邏輯.


 // 判定飾品種類
 var kind = '';
 if (window.ItemDB && ItemDB.getDef){
   if (ItemDB.getDef('ornaments', o.id)) kind = 'rings'; // ornaments 視為「戒指」
   else if (ItemDB.getDef('rings',    o.id)) kind = 'rings';
   else if (ItemDB.getDef('earrings', o.id)) kind = 'earrings';
   else if (ItemDB.getDef('cloaks',   o.id)) kind = 'cloak';
   else if (ItemDB.getDef('armors',   o.id)) kind = 'armor';
   else if (ItemDB.getDef('boots',    o.id)) kind = 'shoes';
   else if (ItemDB.getDef('medals',   o.id)) kind = 'medals';
 }
 if (!kind) { log('無法辨識飾品種類'); return; }


    // 裝備欄保底初始化
    P.equip = P.equip || { weapon:null, earrings:[null,null], rings:[null,null], cloak:null, armor:null, shoes:null, medals:[null,null,null,null,null] };

    var copy = JSON.parse(JSON.stringify(o));
    var back = null;

    if (kind==='rings' || kind==='earrings' || kind==='medals'){
      var cap = (kind==='medals') ? 5 : 2;

      // ★ 關鍵修正：不論舊存檔內容如何，都先正規化到固定長度並填 null
      var arr = Array.isArray(P.equip[kind]) ? P.equip[kind] : (P.equip[kind] = new Array(cap));
      for (var j2=0;j2<cap;j2++){ if (typeof arr[j2] === 'undefined') arr[j2] = null; }
      if (arr.length > cap) arr.length = cap;

      // 不允許同 ID 重複裝備
      for (var t=0;t<arr.length;t++){ if(arr[t] && arr[t].id===copy.id){ log('不可重複裝備相同飾品'); return; } }

      // 找空位；沒有就覆蓋第 1 格並回收被覆蓋者
      var pos = -1; for (var j=0;j<arr.length;j++){ if(!arr[j]){ pos=j; break; } }
      if (pos===-1){ back = arr[0]; arr[0] = copy; } else { arr[pos] = copy; }
    } else {
      back = P.equip[kind] || null;
      P.equip[kind] = copy;
    }

    // 從背包移除本件
    list.splice(i,1);

    // 將被頂替者回收回儲物袋（回到 ornaments）
    if (back){
      P.bag.ornaments = Array.isArray(P.bag.ornaments) ? P.bag.ornaments : [];
      try { P.bag.ornaments.unshift(JSON.parse(JSON.stringify(back))); }
      catch(_){ P.bag.ornaments.unshift(back); }
    }

    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('ornament');
  }


  // === 材料：販賣 / 丟棄 ===


  function bagSellMaterial(i){
    var P = state.player; var it = (P.bag && P.bag.materials) ? P.bag.materials[i] : null; if(!it) return;
    var def = ItemDB.getDef('materials', it.id) || {};
    var price = def.price || 0;
    var max = it.count || 0;
    var qtyEl = document.getElementById('sellQty');
    var qty = qtyEl ? parseInt(qtyEl.value,10) : max;
    if (!qty || qty < 1 || qty > max) return;

    P.currencies = P.currencies || { stone: 0, diamond: 0 };
    P.currencies.stone += qty * price;

    it.count = (it.count||0) - qty;
    if (it.count <= 0) P.bag.materials.splice(i, 1);

    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('material');
  }


  function bagThrowMaterial(i){
    const P = state.player; const it = P.bag.materials?.[i]; if(!it) return;
    const max = it.count || 0;
    const qty = +prompt(`輸入丟棄數量（1-${max}）`, String(max));
    if (!qty || qty < 1 || qty > max) return;

    it.count -= qty;
    if (it.count <= 0) P.bag.materials.splice(i, 1);

    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('material');
  }

  function log(txt, cls=''){ const el=document.createElement('div'); el.className = `item ${cls}`; el.textContent = txt; const box=qs('#log'); if(!box) return; box.appendChild(el); box.scrollTop = box.scrollHeight; }
  function sendChat(){ const inp = qs('#chatInput'); const msg = (inp?.value||'').trim(); if(!msg) return; log(`你：${msg}`,'ok'); inp.value=''; }

  return {
    start(player){
    const defaults = {
      level: 1,
      attributes: { str:0, vit:0, dex:0, int:0, wis:0, luk:0 },
      unspentPoints: 0,
      medals: [],
      equip: { weapon: null, earrings: [null,null], rings: [null,null], cloak: null, armor: null, shoes: null, medals: [null,null,null,null,null] },
      sta: { cur: 100, max: 100 },
      exp: { cur: 0,   max: 100 },
      hp:  { cur: 0,   max: 0 },
      currencies: { stone: 0, diamond: 0 },
    };


    const p = Object.assign({}, defaults, player || {});  // 玩家資料優先，避免蓋掉等級


      // ★ 關鍵：把玩家寫回 state，後面所有功能才能正常讀到
      state.player = p;

      // ★計入裝備加成的上限（初始化用）
      var base  = derivedFrom(p);
      var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
      var hpMax = (base['氣血上限'] || 0) + (bonus['氣血上限'] || 0);

      // HP：若沒有就建立；若已有就只更新上限並夾在 0 ~ max 之間，不回滿
      if (!p.hp) {
        p.hp = { cur: hpMax, max: hpMax };
      } else {
        p.hp.max = hpMax;
        var cur = (p.hp.cur ?? hpMax);
        p.hp.cur = Math.max(0, Math.min(cur, hpMax));
      }

      // MP（真元）：同樣處理（計入裝備加成）
      var mpMax = (base['真元上限'] || 0) + (bonus['真元上限'] || 0);
      if (!p.mp) {
        p.mp = { cur: mpMax, max: mpMax };
      } else {
        p.mp.max = mpMax;
        var curM = (p.mp.cur ?? mpMax);
        p.mp.cur = Math.max(0, Math.min(curM, mpMax));
      }


      // 體力：同理，不強制回滿；沒有才給預設
      if (!p.sta) {
        p.sta = { cur: 100, max: 100 };
      } else {
        p.sta.max = p.sta.max ?? 100;
        const curSta = (p.sta.cur ?? p.sta.max);
        p.sta.cur = Math.max(0, Math.min(curSta, p.sta.max));
      }

      // 經驗：保留原本 cur，若越界就夾回範圍；沒有就用預設
      if (!p.exp) { p.exp = { cur:0, max:100 }; }
      else {
        p.exp.max = p.exp.max ?? 100;
        p.exp.cur = Math.max(0, Math.min(p.exp.cur ?? 0, p.exp.max));
      }


      wire();
      render(p);
    },
    getPlayer(){ return state.player; },
    save(){ if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(state.player); },
    recalc(){ render(state.player); renderDerived(); },
    log(txt, cls=''){ log(txt, cls); }
  };
})();

// ===== 只保留這一段啟動流程（等雲端載入完再進主城）=====
window.addEventListener('DOMContentLoaded', async () => {
  // 先檢查是否已登入
  var user = (window.Auth && Auth.currentUser) ? Auth.currentUser() : null;
  if(!user){ window.location.href = 'index.html'; return; }

  // 讀雲端角色
  var char = null;
  try{
    char = (window.Auth && Auth.loadCharacter) ? (await Auth.loadCharacter()) : null;
  }catch(e){
    char = null;
  }

  // 若本地快取較新，優先用快取（避免剛存檔未同步）
  var cached = (window.Auth && Auth.getCharacter) ? Auth.getCharacter() : null;
  if (cached) {
    var useCached = false;
    if (!char) { useCached = true; }
    else {
      var t1 = cached && cached._updatedAt ? cached._updatedAt : 0;
      var t2 = char && char._updatedAt ? char._updatedAt : 0;
      if (t1 > t2) { useCached = true; }
    }
    if (useCached) { char = cached; }
  }

  // 沒有角色 → 回登入頁的創角頁
  if (!char){ window.location.href = 'index.html#create'; return; }

  // 先掛上裝備模組（讓初始化就能正確拿到裝備加成）
  if (window.Equip && Equip.mount) {
    Equip.mount({
      getPlayer: function(){ return Game.getPlayer(); },
      save:      function(){ return Game.save && Game.save(); },
      recalc:    function(){ return Game.recalc && Game.recalc(); },
      log:       function(t){ return Game.log ? Game.log(t) : console.log(t); }
    });
  }

  // 先啟動遊戲（使 Game.getPlayer() 有值）
  if (window.Game && Game.start) { Game.start(char); }

  // 再初始化外觀系統（此時 mount 內的 render() 才拿得到玩家）
  if (window.Appearance && Appearance.mount) {
    Appearance.mount({
      getPlayer: function(){ return Game.getPlayer(); },
      save:      function(){ return Game.save && Game.save(); },
      recalc:    function(){ return Game.recalc && Game.recalc(); },
      log:       function(t){ return Game.log ? Game.log(t) : console.log(t); }
    });
  }


  // 啟動自動回復系統
  if (window.AutoRecovery) {
    AutoRecovery.start({
      getPlayer: function(){ return Game.getPlayer(); },
      getBonuses: function(){ return window.Equip ? Equip.getBonuses() : {}; },
      save: function(){ Game.save(); },
      log: function(txt, cls){ Game.log(txt, cls); },
      updateUI: function(){ Game.recalc(); }
    });
  }

  // 頁面關閉時清理
  window.addEventListener('beforeunload', function(){
    if (window.AutoRecovery) AutoRecovery.stop();
  });


  
});

</script>
</body>
</html>

