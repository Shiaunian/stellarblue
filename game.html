<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>ä¿®ä»™RPGï½œä¸»åŸï¼ˆæ‰‹æ©Ÿå°ˆç”¨ v5ï¼‰</title>
<style>
  :root{
    --bg:#0b1024; --bg2:#0e1536; --panel:#131a3f; --panel-2:#0f1534; --muted:#9aa3b2; --text:#eaf2ff;
    --accent:#8b5cf6; --accent2:#22d3ee; --hp:#ef4444; --mp:#3b82f6; --bar:#334155; --ok:#22c55e; --warn:#f59e0b;
    --gold:#b98c4b; --gold-2:#7a5b31; --radius:16px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
    --elem-none:#64748b; --elem-water:#38bdf8; --elem-fire:#f97316;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:"Microsoft JhengHei",system-ui,Segoe UI,Roboto,sans-serif; color:var(--text); background:var(--bg);}

  /* èˆå°ï¼šæ‰€æœ‰è£ç½®ä¸€å¾‹ä»¥ã€Œæ‰‹æ©Ÿç•«é¢ã€é¡¯ç¤º */
  .stage{
    position:fixed; inset:0; display:grid; justify-items:center; align-items:start; overflow:auto;
    padding-top:max(6px, env(safe-area-inset-top));
  }
  /* æ‰‹æ©Ÿå›ºå®šå¯¬åº¦ï¼ˆæœ€å¤§ 420pxï¼‰ï¼Œé›»è…¦/å¹³æ¿ä¹Ÿä½¿ç”¨åŒä¸€å¯¬åº¦ï¼Œé¿å…ç‰ˆé¢è·‘æ‰ */
  .app{
    width:min(420px, 100svw);
    max-height:100svh;
    background:linear-gradient(180deg, var(--bg2), var(--panel));
    border-radius:var(--radius); box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
  }

  /* ===== Headerï¼ˆå…©åˆ—ï¼‰ ===== */
  header{
    padding:10px 12px; background:rgba(255,255,255,.06);
    border-bottom:1px solid rgba(255,255,255,.08);
    display:grid;
    grid-template-columns:1fr auto;
    grid-template-areas:
      "left right"
      "medals right";
    gap:8px 10px; align-items:center;
  }
  .h-left{grid-area:left; display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; min-width:0;}
  .avatar{width:44px; height:44px; border-radius:50%; object-fit:cover; background:#222; border:2px solid rgba(255,255,255,.15);}
  .pinfo{display:flex; flex-direction:column; min-width:0;}
  .prow{display:flex; align-items:center; gap:6px; flex-wrap:nowrap; min-width:0;}
  .pname{font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .plv{font-size:12px; opacity:.9;}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px;
        background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
        white-space:nowrap;}
  .elem{font-weight:700;}
  .elem.none{background:var(--elem-none); color:#0b1024;}
  .elem.water{background:var(--elem-water); color:#07223a;}
  .elem.fire{background:var(--elem-fire); color:#2b0a00;}

  /* å‹³ç« ï¼šç¢ºä¿ç‚ºå®Œæ•´åœ“å½¢ä¸”ä¸æœƒè¢«æ“ å£“ */
  .medals{grid-area:medals; display:flex; gap:6px; min-width:0;}
  .medal-slot{
    width:30px; aspect-ratio:1/1; border-radius:50%;
    border:2px solid rgba(255,255,255,.25);
    display:flex; align-items:center; justify-content:center;
    font-size:12px; color:#cbd5e1; background:rgba(255,255,255,.06);
    overflow:hidden; flex:0 0 auto;
  }
  .medal-slot img{width:100%; height:100%; object-fit:cover; display:block;}

  /* å³å´ï¼šè²¨å¹£ + ç™»å‡ºï¼ˆæ”¹æˆç›´å‘æ’åˆ—ï¼Œç™»å‡ºåœ¨è²¨å¹£ä¸‹æ–¹ï¼‰ */
  .h-right{grid-area:right; display:flex; flex-direction:column; align-items:flex-end; gap:8px; min-width:0;}
  .coins{display:flex; gap:8px; white-space:nowrap; min-width:0; flex-wrap:nowrap;}
  .coin{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-size:10px;}
  .icon-box{ width:18px; height:18px; border-radius:4px; overflow:hidden; display:grid; place-items:center; }
  .icon-box img{ width:100%; height:100%; object-fit:cover; display:block; }
  /* é•·æ•¸å­—æ”¯æ´ï¼ˆ999,999+ï¼‰ï¼Œä»ä¿æŒå–®è¡Œ */
  .val{max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

  /* ===== ç™»å‡ºæŒ‰éˆ•æ¡†ç·šèª¿æ•´ - åŠ å¤§å¯¬é«˜ ===== */
  .logout-btn{
  padding: 12px 20px;  /* åŸæœ¬ 7px 14pxï¼Œç¾åœ¨åŠ å¤§ */
  min-width: 83px;    /* åŸæœ¬ 90pxï¼Œç¾åœ¨åŠ å¯¬ */
  height: 32px;        /* æ–°å¢å›ºå®šé«˜åº¦ */
  border-radius:999px; 
  border:3px solid rgba(255,255,255,.4);  /* æ¡†ç·šåŠ ç²— + å¢åŠ é€æ˜åº¦ */
  background:#ef4444; color:#fff; font-weight:900; cursor:pointer; letter-spacing:1px;
  display: flex;       /* è®“æ–‡å­—å‚ç›´ç½®ä¸­ */
  align-items: center;
  justify-content: center;
  }
  .logout-btn:active{ transform: translateY(1px); }

  @media (max-width:420px){
    .avatar{width:40px; height:40px}
    .coin{padding:5px 8px}
    .val{max-width:100px}
    .medal-slot{width:28px}
    header{gap:6px 8px; padding:8px 8px}
  }

  .divider{height:1px; background:rgba(255,255,255,.08); margin:6px 0;}
  .main{flex:1; display:flex; flex-direction:column; gap:10px; padding:8px 12px 0; overflow:auto;}
  .bars{display:grid; gap:0px;}
  .stat-row{display:grid; grid-template-columns:48px 1fr 56px; align-items:center; gap:8px;}
  .label{font-size:14px; color:#e2e8f0; text-align:right;}
  .num{font-size:10px; color:#e2e8f0; text-align:right;}
    /* ===== é«”åŠ›ç¶“é©—çœŸæ°£çœŸå…ƒæ¡†ç·šèª¿æ•´ - åŠ å¤§é«˜åº¦ ===== */
  .prog{
  height: 13px;        /* åŸæœ¬ 14pxï¼Œç¾åœ¨åŠ é«˜ */
  background:#1f273a; border-radius:999px; position:relative; overflow:hidden; 
  box-shadow: inset 0 2px 0 rgba(255,255,255,.06), inset 0 -2px 0 rgba(0,0,0,.25);
  border: 2px solid rgba(255,255,255,.25);  /* æ–°å¢å¤–æ¡†ç·š */
  }
  .fill{height:100%; width:0%;} .fill.sta{background:linear-gradient(90deg,#eab308,#f59e0b);} .fill.exp{background:linear-gradient(90deg,#16a34a,#4ade80);} .fill.hp{background:linear-gradient(90deg,#ef4444,#b91c1c);} .fill.mp{background:linear-gradient(90deg,#3b82f6,#1d4ed8);}
  .actions{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding-top:6px;}
  .gbtn{padding:5px 0; text-align:center; border-radius:10px; font-size: 12px;  font-weight:800; letter-spacing:2px; color:#fff; background:linear-gradient(#a6783e,#7f5626); border:1px solid #5e3d1a; box-shadow: inset 0 2px 0 rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);}
  .title{text-align:center; color:#c7d2fe; font-weight:900; letter-spacing:6px; padding-top:4px;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; padding-bottom:6px;}
  .card{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:2px; display:grid; grid-template-columns:52px 1fr; gap:10px; align-items:center;}
  .thumb{width:40px; height:40px; border-radius:10px; overflow:hidden; display:grid; place-items:center; background:#1e293b;}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .ctitle{font-weight:800; font-size: 12px; letter-spacing:1px;} .csub{font-size:9px; color:var(--muted);}
  .dock{padding:0 12px 10px;}
  .chatbox{background:#060a1a; border:1px solid rgba(255,255,255,.2); border-radius:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(0,0,0,.4);}
  .corner-btn{position:absolute; width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-top:12px solid #fff; right:10px;}
  .corner-btn.top{top:-6px;} .corner-btn.bottom{bottom:-6px; transform:rotate(180deg);}
  .log{height:92px; overflow:auto; padding:8px 10px; font-size:12px;} .log .item{line-height:1.5} .log .ok{color:var(--ok)} .log .warn{color:var(--warn)} .log .muted{color:var(--muted)}
  .speak{display:flex; gap:8px; border-top:1px solid rgba(255,255,255,.1); padding:8px; background:#0a1024; border-radius:0 0 10px 10px;}
  .speak input{flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#fff; color:#111;}
  .speak button{padding:10px 14px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; font-weight:700;}

  /* Modalã€Bag èˆ‡é‚è¼¯ç›¸é—œæ¨£å¼ä¿æŒåŸæ¨£ï¼ˆå¾ v4 å®Œæ•´ç‰ˆæ²¿ç”¨ï¼‰ */
  .stage, .log { overscroll-behavior: contain; }
  .dock { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
  .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:999; }
  .modal.show{ display:grid; }
  .modal .mask{ position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px); }
  .sheet{ position:relative; width:min(92vw, 520px); border-radius:16px; overflow:hidden; background:var(--panel-2); border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); color:var(--text); }
  .sheet .sec-title{ background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.08); text-align:center; font-weight:900; letter-spacing:4px; padding:8px 12px; position:relative; }
  .sheet .close{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:24px; height:24px; border-radius:999px; display:grid; place-items:center; background:#ef4444; color:#fff; font-weight:900; cursor:pointer; user-select:none; }
  .sheet .body{ padding:12px; display:grid; gap:12px; }
  .attr-list{ display:grid; gap:8px; }
  .attr-row{ display:grid; grid-template-columns:76px 56px 1fr 40px; align-items:center; gap:8px;  background: rgb(30 31 61);; border:1px solid rgba(255,255,255,1); border-radius:10px; padding:0px 8px; }
  .attr-name {
    font-weight: 70;
    font-size: 11px;  /* åŠ ä¸Šé€™è¡Œä¾†è¨­å®šå­—é«”å¤§å° */
    white-space: nowrap;
  }
  .attr-val{ font-variant-numeric: tabular-nums; text-align:right; white-space:nowrap; min-width:56px; }
  .attr-bar {
    height: 10px;
    background: #818181;
    border-radius: 999px;
    overflow: hidden;
    box-shadow: inset 0 1px 0 rgba(255,255,255,08), inset 0 -1px 0 rgba(0,0,0,3);
  }
  .attr-fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); }
  .attr-plus {
    width: 20px;
    height: 19px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,18);
    background: linear-gradient(180deg, #ad2e2e, #7d090e);
    color: #fff;
    font-weight: 900;
    cursor: pointer;
    display: grid;
    place-items: center;
    user-select: none;
    align-content: center;
  }
  .attr-plus.hide{ display:none; }
  .remain{ text-align:right; font-size:12px; color:#e2e8f0; }
  .kv{ display:grid; grid-template-columns:1fr 1fr; gap:6px 16px; }
  .kv .item {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    padding: 2px 8px;
    background: rgb(53 51 51);
    border: 1px solid rgba(255,255,255,06);
    border-radius: 8px;
  }
  .kv .k{ opacity:.85; font-size:12px; }
  .kv .v{ font-variant-numeric: tabular-nums; font-size:12px; }
  /* ğŸŸ¢ å½±éŸ¿èƒ½åŠ›å€¼é«˜äº®ï¼šä¸­æ–‡èˆ‡æ•¸å­—ä¸€èµ·è®Šç¶  */
  .kv .item.aff .k,
  .kv .item.aff .v { color:#22c55e; }



  /* ç¦æ­¢å±¬æ€§é¢æ¿å…§å®¹è¢«é¸å–ï¼šé¿å…ã€Œæ•´å¡Šåç™½ã€ */
  #attrModal .sheet, #attrModal .sheet *{ user-select:none; -webkit-user-select:none; }


  .bag-tabs{display:flex; gap:6px; padding:6px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.08);}
  .bag-tab{padding:4px 8px; border-radius:8px; font-weight:700; font-size:11px; cursor:pointer; user-select:none; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);}
  .bag-tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff;}
  /* âš  åŸæœ¬å¯« .bag-body ä½†ä½ çš„ HTML ç”¨çš„æ˜¯ .bag-listï¼Œé€™è£¡æ”¹æˆ .bag-list æ‰æœƒç”Ÿæ•ˆ */
  .bag-list{padding:8px; display:grid; gap:6px; max-height:65vh; overflow:auto;}


  .item-row{ display:grid; grid-template-columns:36px 1fr; gap:6px; align-items:center; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:5px 8px; min-height:48px; cursor:pointer; }
  .item-thumb{width:36px; height:36px; border-radius:8px; background:#1e293b; display:grid; place-items:center; font-weight:900;}
  .item-thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .item-main{display:grid; gap:2px;}
  /* æ”¹æˆè‡ªé©æ‡‰å¯¬åº¦ï¼Œå³å´æ¬„ä½ç¸®çª„ï¼›åç¨±å¯å¤šè¡Œ */
  .item-title.cons{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:4px;}
  .item-title.wep {display:grid; grid-template-columns: 46px 1fr auto; align-items:center; column-gap:6px;}
  /* åç¨±å¯æ›è¡Œï¼Œé¿å…è¢« â€¦ æˆªæ–·ï¼›æ•´é«”å­—å†å°ä¸€é» */
  .item-name{
    font-weight:800; font-size:10px; line-height:1.25;
    overflow:visible; white-space:normal; text-overflow:clip; word-break:break-word;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    border-radius:10px; padding:2px 8px; text-align:center;
  }
  .count-slot{
    justify-self:end; min-width:56px; text-align:right; font-variant-numeric: tabular-nums;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    border-radius:9999px; padding:2px 6px; font-size:11px;
  }
  .meta-effect{justify-self:end;}
  .badge{display:inline-block; padding:1px 6px; font-size:9px; border-radius:9999px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10);}
  .badge.hp{background:#7f1d1d; border-color:#ef4444; color:#fff;}
  .badge-lv{background:rgba(255,255,255,.85); color:#0b1024; font-weight:900; border-radius:8px; padding:1px 6px; font-size:11px;}
  .right-meta{display:flex; align-items:center; gap:8px;}
  .dur-chip{background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); border-radius:9999px; padding:1px 6px; font-size:11px; color:#e2e8f0;}
  .item-sub{display:flex; justify-content:space-between; gap:8px; font-size:9px; color:var(--muted); line-height:1.15;}
  /* å…è¨±å·¦å³èªªæ˜ä¹Ÿè‡ªå‹•æ›è¡Œï¼Œé¿å…æ“ åˆ°å†’è™Ÿæˆ–å‡ºç¾ â€¦ */
  .sub-left{white-space:normal;}
  .sub-right{white-space:normal; color:#93c5fd;}
  .price{font-size:11px; color:#e2e8f0;}

  /* â˜… ç¨€æœ‰åº¦é¡è‰²ï¼šä½¿ç”¨ã€Œæ™®/ç²¾/ç¨€/å²/å‚³ã€äº”ç´šï¼Œå°æ‡‰ items.js çš„ RARITY */
  :root{
    --rar-æ™®:#e5e7eb; --rar-ç²¾:#22c55e; --rar-ç¨€:#38bdf8; --rar-å²:#a78bfa; --rar-å‚³:#f59e0b;
  }
  .rarity-æ™®{color:var(--rar-æ™®);}
  .rarity-ç²¾{color:var(--rar-ç²¾);}
  .rarity-ç¨€{color:var(--rar-ç¨€);}
  .rarity-å²{color:var(--rar-å²);}
  .rarity-å‚³{color:var(--rar-å‚³);}

  /* å°æ–¹å¡Šç¨€æœ‰åº¦å¾½ç« ï¼ˆé¡¯ç¤ºã€Œæ™®/ç²¾/ç¨€/å²/å‚³ã€ï¼‰ */
  .rb{display:inline-grid; place-items:center; width:16px; height:16px; font-size:10px; font-weight:900;
      border-radius:4px; margin-right:4px; line-height:1; border:1px solid rgba(255,255,255,.25);}
  .rb-æ™®{background:var(--rar-æ™®); color:#0b1024;}
  .rb-ç²¾{background:var(--rar-ç²¾); color:#052411;}
  .rb-ç¨€{background:var(--rar-ç¨€); color:#041621;}
  .rb-å²{background:var(--rar-å²); color:#1a0b2c;}
  .rb-å‚³{background:var(--rar-å‚³); color:#231400;}

  /* æ—¢æœ‰è€ä¹…å­—æ¨£ç¶­æŒ */
  .dur{font-size:10px; color:#e2e8f0;}

  #bagAction{position:fixed; inset:0; display:none; place-items:center; z-index:1000;}
  #bagAction.show{display:grid;}
  #bagAction .mask{position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px);}
  #bagAction .sheet{position:relative; width:min(92vw, 380px);} #bagAction .ops{display:flex; justify-content:flex-end; gap:6px;}
  .opx{padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#fff; font-weight:700; font-size:12px; cursor:pointer;}
  .opx.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));}


  /* è®“å±¬æ€§é¢æ¿çš„å¤–å±¤å½ˆçª—é™åˆ¶é«˜åº¦ï¼Œé¿å…è¶…å‡ºè¦–å£ */
#attrModal .sheet{
  /* åŸæœ¬å°±æœ‰ width/minâ€¦ å¯ä¿ç•™ */
  max-height: min(86svh, 640px);      /* æ‰‹æ©Ÿå„ªå…ˆï¼šæœ€é«˜åªåˆ° 86% è¦–å£é«˜ */
  display: grid;
  grid-template-rows: auto 1fr;       /* ä¸Šï¼šæ¨™é¡Œåˆ—ï¼›ä¸‹ï¼šå…§å®¹å¯æ²å‹• */
  overflow: hidden;                    /* æ²å‹•äº¤çµ¦ body */
}

/* æ¨™é¡Œåˆ—å›ºå®šåœ¨æœ€ä¸Šæ–¹ï¼Œæ°¸é çœ‹å¾—åˆ° âœ• */
#attrModal .sheet .sec-title{
  position: sticky;
  top: 0;                              /* é»åˆ°é ‚ç«¯ */
  z-index: 1;
  padding-top: calc(8px + env(safe-area-inset-top, 0px));
  background: rgba(255,255,255,.06);   /* ä¿ç•™åŸåº•è‰² */
  backdrop-filter: blur(2px);
}

/* å…§å®¹å€åŸŸå¯ç¨ç«‹æ²å‹•ï¼›å¤šåˆ°è¶…éå°±å‡ºç¾æ»¾å‹•æ¢ */
#attrModal .sheet .body{
  overflow: auto;
  /* é ç•™åº•éƒ¨å®‰å…¨å€ï¼Œé¿å… iPhone åº•éƒ¨æŒ‡ç¤ºæ¢å£“åˆ° */
  padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
}

/* è®“å±¬æ€§æ¸…å–®åœ¨çª„æ‰‹æ©Ÿä¹Ÿå¥½æ²å‹•ï¼ˆå¯é¸ï¼‰ */
#attrModal .attr-list{
  min-height: 0;   /* æ­é… grid æ‰èƒ½æ­£ç¢ºå£“ç¸®è®“çˆ¶å±¤æ²å‹• */
}
#attrModal .kv{
  min-height: 0;
}

/* æå‡é—œé–‰éˆ•é»æ“Šé¢ç©ï¼ˆä¸æ”¹è¦‹åˆ°çš„å¤§å°ï¼Œåªå¢å¤§å¯é»å€åŸŸï¼‰ */
#attrModal .close{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px; height: 28px;          /* ç¨å¾®æ”¾å¤§ */
  touch-action: manipulation;
}
#attrModal .close::before{
  content: "";
  position: absolute;
  inset: -8px;                         /* å¤–æ“´ 8px çš„éš±å½¢ç†±å€ */
}
/* ========== Dexï¼ˆåœ–é‘‘ï¼‰ ========== */
.dex-row{
  display:grid; grid-template-columns:44px 1fr auto; gap:8px; align-items:center;
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
  border-radius:10px; padding:6px 8px; cursor:pointer;
}
.dex-thumb{ width:44px; height:44px; border-radius:10px; overflow:hidden; background:#1e293b; display:grid; place-items:center; }
.dex-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
.dex-main{ display:grid; gap:2px; }
.dex-name{ font-weight:800; font-size:12px; letter-spacing:1px; }
.dex-sub{ font-size:10px; color:#cbd5e1; }
.dex-lv{ font-size:11px; padding:2px 6px; border-radius:999px; background:rgba(255,255,255,.85); color:#0b1024; font-weight:900; }

.dex-detail{
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
  border-radius:12px; padding:8px; display:grid; gap:8px;
}
.dex-hero{ display:grid; grid-template-columns:96px 1fr; gap:10px; align-items:center; }
.dex-hero .img{ width:96px; height:96px; border-radius:12px; overflow:hidden; background:#111; }
.dex-hero img{ width:100%; height:100%; object-fit:cover; display:block; }
.dex-kv{ display:grid; grid-template-columns:repeat(2,1fr); gap:6px 12px; }
.dex-kv .item{ display:flex; justify-content:space-between; gap:8px; padding:2px 8px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:8px; font-size:12px; }
.dex-locs{ display:grid; gap:6px; }
.dex-loc{ font-size:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:2px 10px; display:inline-block; }
.dex-loc .tag{ margin-left:6px; font-size:11px; color:#fca5a5; }
</style>

</head>
<body>

<!-- ===== åŸæœ‰ UI/Modal çµæ§‹ï¼šä¸æ”¹ç©æ³•ã€åªå‹•æ’ç‰ˆ ===== -->
<div id="attrModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="attr"></div>
  <div class="sheet" role="dialog" aria-labelledby="attrTitle">
    <div class="sec-title" id="attrTitle">
      åŸºæœ¬å±¬æ€§
      <div class="close" data-close="attr">âœ•</div>
    </div>
    <div class="body">
      <div class="remain">æœªåˆ†é…å±¬æ€§é»ï¼š<b id="ptRemain">0</b></div>
      <div class="attr-list" id="attrList"></div>
      <div class="sec-title">èƒ½åŠ›å€¼</div>
      <div class="kv" id="statList"></div>
    </div>
  </div>
</div>

<div id="bagModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="bag"></div>
  <div class="sheet" role="dialog" aria-labelledby="bagTitle">
    <div class="sec-title" id="bagTitle">
      å„²ç‰©è¢‹
      <div class="close" data-close="bag">âœ•</div>
    </div>

    <div class="body">
      <div class="bag-tabs">
        <span class="bag-tab active" data-bag-tab="consumable">æ¶ˆè€—å“</span>
        <span class="bag-tab" data-bag-tab="weapon">æ­¦å™¨</span>
        <span class="bag-tab" data-bag-tab="equip">è£å‚™</span>
        <span class="bag-tab" data-bag-tab="ornament">é£¾å“</span>
        <span class="bag-tab" data-bag-tab="hidden">æš—å™¨</span>
        <span class="bag-tab" data-bag-tab="material">ææ–™</span>
        <span class="bag-tab" data-bag-tab="medal">å‹³ç« </span>
      </div>
      <div id="bagList" class="bag-list"></div>
    </div>
  </div>
</div>


<!-- åœ–é‘‘ï¼ˆDexï¼‰ -->
<div id="dexModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="dex"></div>
  <div class="sheet" role="dialog" aria-labelledby="dexTitle" style="width:min(96vw, 420px); max-height:90svh; display:grid; grid-template-rows:auto 1fr; overflow:hidden;">
    <div class="sec-title" id="dexTitle">
      åœ– é‘‘
      <div class="close" data-close="dex">âœ•</div>
    </div>
    <div class="body" style="display:grid; gap:8px; overflow:auto; padding-bottom:calc(12px + env(safe-area-inset-bottom,0px));">
      <div class="bag-tabs" id="dexTabs">
        <span class="bag-tab active" data-dex-tab="mob">å°æ€ª</span>
        <span class="bag-tab" data-dex-tab="boss">BOSS</span>
      </div>
      <div id="dexList" class="bag-list" style="max-height:unset;"></div>
      <div id="dexDetail" style="display:none;"></div>
    </div>
  </div>
</div>


<div id="bagAction" aria-hidden="true">
  <div class="mask" data-close="bagAction"></div>
  <div class="sheet action" role="dialog" aria-labelledby="bagActionTitle">
    <div class="sec-title" id="bagActionTitle">
      ç‰©å“æ“ä½œ
      <div class="close" data-close="bagAction">âœ•</div>
    </div>
    <div class="body">
      <div class="item-row" style="cursor:default">
        <div class="item-thumb" id="actIcon"></div>
        <div class="item-main">
          <div class="item-title cons" id="actTop"></div>
          <div class="item-sub"><span class="sub-left" id="actLeft"></span><span class="sub-right" id="actRight"></span></div>
        </div>
      </div>
      <div class="ops" id="actBtns"></div>
    </div>
  </div>
</div>

<div class="stage">
  <div class="app">
    <header>
      <div class="h-left">
        <img id="uiAvatar" class="avatar" alt="avatar" />
        <div class="pinfo">
          <div class="prow">
            <div class="pname" id="uiName"></div>
            <div class="plv">LV.<span id="uiLv"></span></div>
            <span id="uiElem" class="pill elem none"></span>
          </div>
        </div>
      </div>

      <div class="medals">
        <div class="medal-slot" id="medal1"></div>
        <div class="medal-slot" id="medal2"></div>
        <div class="medal-slot" id="medal3"></div>
        <div class="medal-slot" id="medal4"></div>
        <div class="medal-slot" id="medal5"></div>
      </div>

      <div class="h-right">
        <div class="coins">
          <span class="coin">
            <span class="icon-box"><img alt="éˆçŸ³" src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Crystal_128_up.png"></span>
            <span class="val" id="uiStone">0</span>
          </span>
          <span class="coin">
            <span class="icon-box"><img alt="é‘½çŸ³" src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Diamond_Icon.svg"></span>
            <span class="val" id="uiDiamond">0</span>
          </span>
        </div>
        <button id="btnLogout" class="logout-btn" title="ç™»å‡º" aria-label="ç™»å‡º">ç™»å‡º</button>
      </div>
    </header>

    <div class="divider"></div>

    <div class="main">
      <div class="bars">
        <div class="stat-row">
          <div class="label">é«”åŠ›ï¼š</div>
          <div class="prog"><div class="fill sta" id="barSta"></div></div>
          <div class="num" id="txtSta">100/100</div>
        </div>
        <div class="stat-row">
          <div class="label">ç¶“é©—ï¼š</div>
          <div class="prog"><div class="fill exp" id="barExp"></div></div>
          <div class="num" id="txtExp">0/100</div>
        </div>
        <div class="stat-row">
          <div class="label">æ°£è¡€ï¼š</div>
          <div class="prog"><div class="fill hp" id="barHp"></div></div>
          <div class="num" id="txtHp">--/--</div>
        </div>
        <div class="stat-row">
          <div class="label">çœŸå…ƒï¼š</div>
          <div class="prog"><div class="fill mp" id="barMp"></div></div>
          <div class="num" id="txtMp">--/--</div>
        </div>
      </div>

    <div class="actions">
      <div class="gbtn" data-open="bag">å„²ç‰©è¢‹</div>
      <div class="gbtn" data-open="skill">æŠ€èƒ½</div>
      <div class="gbtn" data-open="equip">è£å‚™æ¬„</div>
      <div class="gbtn" data-open="rank">æ’è¡Œæ¦œ</div>
      <div class="gbtn" data-open="shop">å•†åº—</div>
      <div class="gbtn" data-open="friends">å¥½å‹<span id="friendBadge" style="display:none;margin-left:6px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-weight:900; font-size:11px;">!</span></div>
      <div class="gbtn" data-open="appearance">å¤–è§€</div>
    </div>

      <div class="title">ä¸» åŸ</div>

      <div class="grid">
        <div class="card" data-mod="cave"><div class="thumb"><img src="https://res.cloudinary.com/dzj7ghbf6/image/upload/v1758672981/%E6%B4%9E%E5%BA%9C_uwdego.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">æ´åºœ</div><div class="csub">ç›®å‰å¾…é–‹ç™¼ä¸­</div></div></div>
        <div class="card" data-mod="map"><div class="thumb"><img src="https://res.cloudinary.com/dzj7ghbf6/image/upload/v1757814967/%E9%87%8E%E5%A4%96%E5%9C%B0%E5%9C%96_hwvssk.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">é‡å¤–åœ°åœ–</div><div class="csub">å……æ»¿è‘—æœªçŸ¥å€‹äººå†’éšª</div></div></div>
        <div class="card" data-mod="library"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">è—ç¶“é–£</div><div class="csub">ç›®å‰å¾…é–‹ç™¼ä¸­</div></div></div>
        <div class="card" data-mod="tower"><div class="thumb"><img src="https://res.cloudinary.com/dzj7ghbf6/image/upload/v1758292339/%E8%A9%A6%E7%85%89%E5%A1%94_ojkzmo.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">è©¦ç…‰å¡”</div><div class="csub">ç›®å‰å¾…é–‹ç™¼ä¸­</div></div></div>
        <div class="card" data-mod="war"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">è¦æ¨¡æˆ°</div><div class="csub">ç›®å‰å¾…é–‹ç™¼ä¸­</div></div></div>
        <div class="card" data-mod="collection"><div class="thumb"><img src="https://res.cloudinary.com/dzj7ghbf6/image/upload/v1758257795/%E5%8D%A1%E7%89%87%E8%92%90%E8%97%8F_ivhky7.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">å¡ç‰‡æ”¶è—</div><div class="csub">ç›®å‰å¾…é–‹ç™¼ä¸­</div></div></div>
        <div class="card" data-mod="dex"><div class="thumb"><img src="https://res.cloudinary.com/dzj7ghbf6/image/upload/v1758292339/%E5%9C%96%E9%91%91_adcdkl.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">åœ–é‘‘</div><div class="csub">é»æ“Šé–‹å•Ÿåœ–é‘‘</div></div></div>
        <div class="card" data-mod="shop"><div class="thumb"><img src="https://res.cloudinary.com/dzj7ghbf6/image/upload/v1758292339/%E5%95%86%E5%9F%8E_efzk1i.png" alt="æ–½å·¥ä¸­"></div><div><div class="ctitle">å•†åŸ</div><div class="csub">ç›®å‰å¾…é–‹ç™¼ä¸­</div></div></div>
      </div>

      <div class="dock">
        <div class="chatbox">
          <div class="corner-btn top"></div>
          <div class="log" id="log"></div>
          <div class="speak">
            <input id="chatInput" type="text" placeholder="è¼¸å…¥æ–‡å­—..." />
            <button id="btnSend">é€å‡º</button>
          </div>
          <div class="corner-btn bottom"></div>
        </div>
      </div>

</div>
</div>
</div>



<!-- Firebaseï¼ˆcompat ç‰ˆï¼Œå… ES Moduleï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
(function(){
  var firebaseConfig = {
    apiKey: "AIzaSyBvKmn0jCTS_jIgEYOuQjc8vyYU40Q5F3I",
    authDomain: "stellarblue-system.firebaseapp.com",
    databaseURL: "https://stellarblue-system-default-rtdb.firebaseio.com",
    projectId: "stellarblue-system",
    storageBucket: "stellarblue-system.firebasestorage.app",
    messagingSenderId: "803212433649",
    appId: "1:803212433649:web:887080d10a51d533b23150",
    measurementId: "G-YY94484DV9"
  };
  if(!firebase.apps || !firebase.apps.length){
    firebase.initializeApp(firebaseConfig);
  }
  // æä¾›çµ¦ auth.js / éŠæˆ²é ä½¿ç”¨
  window.DB = firebase.database();
})();
</script>

<script src="stats.js"></script>
<script src="items.js"></script>
<script src="auth.js"></script>
<script src="equip.js"></script>
<script src="rank.js"></script>
<script src="friends.js"></script>
<script src="appearance.js?v=dev1"></script>
<script src="collection.js?v=dev1"></script>
<script src="monsters.js"></script>
<script src="map-data.js"></script>
<script src="dex.js"></script>
<script src="bag.js"></script>
<script src="shop.js"></script>

</body>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var dexCard = document.querySelector('.card[data-mod="dex"]');
  if (dexCard) dexCard.addEventListener('click', openDex);
  var btns = document.querySelectorAll('[data-open="dex"]');
  for (var i=0;i<btns.length;i++){ btns[i].addEventListener('click', openDex); }
});
</script>
<script>




/* ===== å…¬ç”¨ ===== */
const qs = s=>document.querySelector(s);

// â˜… æ”¹ç”¨ stats.js æä¾›çš„å·¥å…·å‡½æ•¸

const clamp = function(v,min,max){ return GameUtils.clamp(v,min,max); };
const pct = function(cur,max){ return GameUtils.pct(cur,max); };
const fmt = function(n){ return GameUtils.fmt(n); };
const fmtCompact = function(n){ return GameUtils.fmtCompact(n); };



/* ===== å±¬æ€§/å®šç¾© ===== */
// â˜… æ”¹ç”¨ stats.js æä¾›çš„åŸºç¤å±¬æ€§å®šç¾©
const BASE_ATTRS = window.BASE_ATTRS;



/* ===== ä¸»ç¨‹å¼ API ===== */
window.Game = (()=>{
  var state = window.state || { player: null };
  window.state = state;


  function render(p){
    state.player = p;

    // é ­åƒ/åç¨±/ç­‰ç´š/å…ƒç´ 
    const fallbackAvatar = (typeof Auth!=='undefined' && Auth.defaultAvatar)
        ? (Auth.defaultAvatar() || 'https://picsum.photos/seed/xian/96')
        : 'https://picsum.photos/seed/xian/96';
    qs('#uiAvatar').src = p.avatar || fallbackAvatar;
    qs('#uiName').textContent = p.name || 'ç„¡åæ•£ä¿®';
    qs('#uiLv').textContent   = p.level ?? 1;
    const elem = (p.element || 'none').toLowerCase();
    const elemEl = qs('#uiElem');
    if (elemEl){ elemEl.className = `pill elem ${elem}`; elemEl.textContent = ELEMENT_LABEL[elem] || 'ç„¡å…ƒç´ '; }

    // å‹³ç« 
    const slots = [qs('#medal1'), qs('#medal2'), qs('#medal3'), qs('#medal4'), qs('#medal5')];
    slots.forEach(s => s && (s.innerHTML = ''));
    (p.medals || []).slice(0, 5).forEach((m, i) => {
      if (m?.icon && slots[i]) {
        const img = new Image(); img.src = m.icon; slots[i].appendChild(img);
      }
    });

    // è²¨å¹£
    const stone = p.currencies?.stone ?? 0;
    const diamond = p.currencies?.diamond ?? 0;
    qs('#uiStone').textContent   = stone   >= 1_000_000 ? fmtCompact(stone)   : fmt(stone);
    qs('#uiDiamond').textContent = diamond >= 1_000_000 ? fmtCompact(diamond) : fmt(diamond);

    // ç‹€æ…‹æ¢ï¼šHP/EXP/STA/MP
    const S = p.sta || { cur: 100, max: 100 };
    const E = p.exp || { cur: 0,   max: 100 };

    // â˜…è¨ˆå…¥è£å‚™åŠ æˆ
    var base  = derivedFrom(p);
    var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
    var hpMaxNow = (base['æ°£è¡€ä¸Šé™'] || 0) + (bonus['æ°£è¡€ä¸Šé™'] || 0);
    var mpMaxNow = (base['çœŸå…ƒä¸Šé™'] || 0) + (bonus['çœŸå…ƒä¸Šé™'] || 0);

    // åŒæ­¥åˆ°ç©å®¶ç‹€æ…‹ä¸¦å¤¾åœ¨ 0~max
    if (!p.hp) { p.hp = { cur: hpMaxNow, max: hpMaxNow }; }
    else { p.hp.max = hpMaxNow; p.hp.cur = Math.max(0, Math.min(p.hp.cur ?? hpMaxNow, hpMaxNow)); }
    if (!p.mp) { p.mp = { cur: mpMaxNow, max: mpMaxNow }; }
    else { p.mp.max = mpMaxNow; p.mp.cur = Math.max(0, Math.min(p.mp.cur ?? mpMaxNow, mpMaxNow)); }

    const H = { cur: p.hp.cur, max: p.hp.max };
    const M = { cur: p.mp.cur, max: p.mp.max };

    if(qs('#barSta')){ qs('#barSta').style.width = pct(S.cur,S.max) + '%'; qs('#txtSta').textContent = `${S.cur}/${S.max}`; }
    if(qs('#barExp')){ qs('#barExp').style.width = pct(E.cur,E.max) + '%'; qs('#txtExp').textContent = `${E.cur}/${E.max}`; }
    if(qs('#barHp')) { qs('#barHp').style.width  = pct(H.cur,H.max) + '%';  qs('#txtHp').textContent  = `${H.cur}/${H.max}`; }
    if(qs('#barMp')) { qs('#barMp').style.width  = pct(M.cur,M.max) + '%';  qs('#txtMp').textContent  = `${M.cur}/${M.max}`; }


  }

  /* ===== å±¬æ€§é¢æ¿ ===== */
    function openAttr(){
    var m = qs('#attrModal'); if(!m) return;
    renderAttrPanel();
    m.classList.add('show'); m.setAttribute('aria-hidden','false');
    /* æ¸…é™¤ä»»ä½•æ—¢æœ‰çš„æ–‡å­—é¸å–ï¼Œé¿å…æ•´å¡Šåç™½ */
    if (window.getSelection) {
      try {
        var sel = window.getSelection();
        if (sel && sel.removeAllRanges) sel.removeAllRanges();
      } catch(_){}
    }
  }

  function closeAttr(){ const m = qs('#attrModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

  function renderAttrPanel(){
    const P = state.player; if(!P) return;

    const list = qs('#attrList');
    if(list){
      list.innerHTML = '';
      BASE_ATTRS.forEach(({key,name})=>{
        const val = P.attributes[key] ?? 10;
        const row = document.createElement('div'); row.className='attr-row';
        row.innerHTML = `
          <div class="attr-name" data-key="${key}">${name}</div>
          <div class="attr-val" id="val_${key}">${val}</div>
          <div class="attr-bar"><div class="attr-fill" id="bar_${key}" style="width:${Math.min(100,val)}%"></div></div>
          <div class="attr-plus" id="btn_${key}" data-key="${key}">ï¼‹</div>
        `;
        list.appendChild(row);
      });

      // ğŸŸ¢ æ‡¸æµ®/é»æ“ŠåŸºæœ¬å±¬æ€§åç¨± â†’ é«˜äº®å°æ‡‰èƒ½åŠ›å€¼
      var nameEls = list.querySelectorAll('.attr-name');
      for (var i=0; i<nameEls.length; i++){
        (function(el){
          var baseKey = el.getAttribute('data-key');
          el.addEventListener('mouseenter', function(){ applyAttrHighlight(baseKey); });
          el.addEventListener('click', function(){
            window.__attrHighlightKey = baseKey;
            applyAttrHighlight(baseKey);
          });
        })(nameEls[i]);
      }
      // æ»‘å‡ºé¢æ¿æ™‚æ¢å¾©ç‚ºæœ€å¾Œä¸€æ¬¡é»æ“Šçš„é«˜äº®ï¼ˆæˆ–æ¸…é™¤ï¼‰
      var panel = document.getElementById('attrModal');
      if (panel && !panel.dataset.attrHoverBound){
        panel.addEventListener('mouseleave', function(){
          if (window.__attrHighlightKey) applyAttrHighlight(window.__attrHighlightKey);
          else clearAttrHighlight();
        });
        panel.dataset.attrHoverBound = '1';
      }
    }

    if(qs('#ptRemain')) qs('#ptRemain').textContent = P.unspentPoints ?? 0;
    updatePlusButtons();
    renderDerived();
  }


  function renderDerived(){
    var P = state.player; if(!P) return;
    var base  = (window.derivedFrom && typeof window.derivedFrom === 'function') ? derivedFrom(P) : {};
    var bonus = (window.Equip && Equip.getBonuses) ? Equip.getBonuses() : {};
    var final = {};
    var keys = Object.keys(base);
    for(var i = 0; i < keys.length; i++){
      var k = keys[i];
      final[k] = (base[k]||0) + (bonus[k]||0);
    }

    var box = qs('#statList'); if(!box) return;
    box.innerHTML = '';
    var entries = Object.keys(final);
    for(var j = 0; j < entries.length; j++){
      var k = entries[j];
      var v = final[k];
      var item = document.createElement('div'); item.className='item';
      item.innerHTML = '<div class="k">' + k + '</div><div class="v">' + v + '</div>';
      box.appendChild(item);
    }

    // é‡æ–°å¥—ç”¨ç›®å‰çš„é«˜äº®ç‹€æ…‹ï¼ˆè‹¥æœ‰ï¼‰
    if (window.__attrHighlightKey) { applyAttrHighlight(window.__attrHighlightKey); }
  }

  // ===== ğŸŸ¢ åŸºæœ¬å±¬æ€§ â†’ å½±éŸ¿èƒ½åŠ›å€¼ä¹‹é«˜äº® =====
  var AFFECT_BY_BASE = {
    str: ['ç‰©ç†æ”»æ“Š','ç ´ç”²'],
    vit: ['æ°£è¡€ä¸Šé™','ç‰©ç†é˜²ç¦¦','å›è¡€/å›åˆ'],
    dex: ['ç‰©ç†é˜²ç¦¦','å‘½ä¸­ç‡','é–ƒé¿','è¡Œå‹•æ¢é€Ÿåº¦'],
    int: ['æ³•è¡“æ”»æ“Š','çœŸå…ƒä¸Šé™','æ³•è¡“é˜²ç¦¦','æ³•ç©¿'],
    wis: ['æ³•è¡“æ”»æ“Š','çœŸå…ƒä¸Šé™','æ³•è¡“é˜²ç¦¦','å›æ°£/å›åˆ'],
    luk: ['æš´æ“Šç‡','æš´æ“Šå‚·å®³']
  };

  window.__attrHighlightKey = '';

  function clearAttrHighlight(){
    var items = document.querySelectorAll('#statList .item');
    for (var i=0;i<items.length;i++){ items[i].classList.remove('aff'); }
  }

  function applyAttrHighlight(baseKey){
    clearAttrHighlight();
    if (!baseKey) return;
    var list = AFFECT_BY_BASE[baseKey] || [];
    var items = document.querySelectorAll('#statList .item');
    for (var i=0;i<items.length;i++){
      var it = items[i];
      var kEl = it.querySelector ? it.querySelector('.k') : null;
      var name = kEl ? (kEl.textContent || '').trim() : '';
      for (var j=0;j<list.length;j++){
        if (name === list[j]) { it.classList.add('aff'); break; }
      }
    }
  }



  function updatePlusButtons(){
    const remain = state.player?.unspentPoints ?? 0;
    BASE_ATTRS.forEach(({key})=>{
      const btn = qs('#btn_'+key); if(!btn) return;
      btn.classList.toggle('hide', remain<=0);
    });
    if(qs('#ptRemain')) qs('#ptRemain').textContent = remain;
  }

function wire(){
  // å·¦ä¸Šå››é¡†ä¸»è¦æŒ‰éˆ•ï¼šå„²ç‰©è¢‹ã€è£å‚™æ¬„ã€å•†åº—
  document.querySelectorAll('.gbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const txt = b.textContent?.trim();
        if (txt === 'å„²ç‰©è¢‹') return openBag();
        if (txt === 'è£å‚™æ¬„') return (window.Equip && Equip.open && Equip.open());
        if (txt === 'å•†åº—') return openShop();
        if (txt === 'å¤–è§€') return openAppearance();
      log(`é–‹å•Ÿï¼š${txt}`,'warn');
    });
  });

  // ä¸»ç•«é¢å¡ç‰‡ï¼ˆé€²å…¥åœ°åœ–æˆ–å…¶ä»–æ¨¡çµ„ï¼‰
document.querySelectorAll('.card').forEach(c=>{
  c.addEventListener('click', ()=>{
    const mod = c.dataset.mod;
    if (mod === 'map') {
      location.href = 'map.html';
      return;
    } else if (mod === 'cave') {
      location.href = 'cave.html';
      return;
    } else if (mod === 'collection') {
      if (window.Collection && typeof Collection.open === 'function') {
        Collection.open({
          getPlayer: ()=> (window.Game && typeof Game.getPlayer==='function') ? Game.getPlayer() : null,
          save:      ()=> (window.Game && typeof Game.save==='function') ? Game.save() : null,
          log:       (t)=> (window.Game && typeof Game.log==='function') ? Game.log(t) : console.log(t)
        });
      } else {
        log('å¡ç‰‡æ”¶è—æ¨¡çµ„æœªè¼‰å…¥ã€‚','warn');
      }
      return;
    }
    log(`é€²å…¥æ¨¡çµ„ï¼š${c.querySelector('.ctitle').textContent}`,'warn');
  });
});


  // èŠå¤©ï¼šé€å‡ºæŒ‰éˆ•èˆ‡ Enter é€å‡º
  qs('#btnSend')?.addEventListener('click', sendChat);
  qs('#chatInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

  // æ‰“é–‹ï¼é—œé–‰è§’è‰²å±¬æ€§é¢æ¿
  qs('#uiAvatar')?.addEventListener('click', openAttr);
  document.querySelectorAll('[data-close="attr"]').forEach(el=> el.addEventListener('click', closeAttr));

  // æŒ‰ Escape é—œé–‰é¢æ¿
  addEventListener('keydown', e=>{
    if(e.key==='Escape'){
      closeAttr();
      closeBag();
      closeBagAction();
    }
  });

  // é—œé–‰èƒŒåŒ…
  document.querySelectorAll('[data-close="bag"]').forEach(function(el){ el.addEventListener('click', closeBag); });
  document.querySelectorAll('[data-close="bagAction"]').forEach(function(el){ el.addEventListener('click', closeBagAction); });

  /**
   * å–®ä¸€ click ç›£è½å™¨æ•´åˆæ‰€æœ‰å¸¸ç”¨é»æ“Šäº‹ä»¶ï¼ˆç§»é™¤ ?. / ?? / ç®­é ­å‡½å¼ï¼‰
   */

  document.addEventListener('click', function(e){
    var target = e.target;

    // åŠ å±¬æ€§é»
    var plus = target.closest ? target.closest('.attr-plus') : null;
    if (plus) {
      var key = plus.dataset.key;
      var P = state.player;
      if(!key || !P || ((P.unspentPoints == null ? 0 : P.unspentPoints)) <= 0) return;

      P.attributes[key] = (P.attributes[key] == null ? 10 : P.attributes[key]) + 1;
      P.unspentPoints = (P.unspentPoints == null ? 0 : P.unspentPoints) - 1;

      var elv = qs('#val_' + key); if (elv) elv.textContent = P.attributes[key];
      var bar = qs('#bar_' + key); if (bar) bar.style.width = Math.min(100, P.attributes[key]) + '%';

      updatePlusButtons();
      renderDerived();

      // æ›´æ–°è¡€é‡ä¸Šé™
      var d2 = derivedFrom(P);
      var newHpMax = d2['æ°£è¡€ä¸Šé™'];
      P.hp = P.hp || { cur: newHpMax, max: newHpMax };
      P.hp.max = newHpMax;
      P.hp.cur = Math.min(P.hp.cur, newHpMax);
      var hpBar = qs('#barHp'); if (hpBar) { hpBar.style.width = ((P.hp.cur / P.hp.max) * 100).toFixed(1) + '%'; }
      var hpTxt = qs('#txtHp'); if (hpTxt) { hpTxt.textContent = P.hp.cur + '/' + P.hp.max; }

      if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
      return;
    }

    // åˆ‡æ›èƒŒåŒ…åˆ†é 
    var tab = target.closest ? target.closest('.bag-tab') : null;
    if (tab) {
      var k = tab.dataset.bagTab;
      if (!k) return;
      switchBagTab(k);
      return;
    }

    // é»æ“ŠèƒŒåŒ…ç‰©å“åˆ—ï¼Œé–‹å•Ÿæ“ä½œé¢æ¿
    var row = target.closest ? target.closest('.item-row') : null;
    if (row && row.dataset.type) {
      openBagAction(row.dataset.type, +row.dataset.idx);
      return;
    }

    // é»æ“Šæ“ä½œé¢æ¿æŒ‰éˆ•ï¼ˆä½¿ç”¨ï¼è£å‚™ï¼è²©è³£ï¼ä¸Ÿæ£„ï¼ç¢ºèªè²©è³£ï¼å–æ¶ˆè²©è³£ï¼å¿«é€Ÿé¸æ•¸é‡ï¼‰
    var btn = target.closest ? target.closest('.opx') : null;
    if (btn) {
      var opAttr = btn.getAttribute('data-op') || '';
      var quick = btn.getAttribute('data-sell-quick') || '';
      if (quick) {
        // å¿«é€Ÿé¸æ“‡æ•¸é‡æŒ‰éˆ•
        var inp = document.getElementById('sellQty');
        var maxEl = document.getElementById('sellQtyMax');
        var max = maxEl ? parseInt(maxEl.value,10) : 1;
        if (inp) {
          if (quick === 'max') { inp.value = String(max); }
          else {
            var qv = parseInt(quick,10);
            if (!isNaN(qv) && qv >= 1) {
              if (qv > max) qv = max;
              inp.value = String(qv);
            }
          }
        }
        return;
      }
      if (opAttr === 'cancel-sell') {
        // å›åˆ°åŸæœ¬æ“ä½œé¢æ¿ï¼ˆå¾æŒ‰éˆ•èº«ä¸Šçš„ type/idx å›å»ï¼‰
        var ct = btn.getAttribute('data-type') || '';
        var ci = +(btn.getAttribute('data-idx') || '0');
        openBagAction(ct, ci);
        return;
      }
      if (opAttr === 'confirm-sell') {
        var ct2 = btn.getAttribute('data-type') || '';
        var ci2 = +(btn.getAttribute('data-idx') || '0');
        if (ct2 === 'consumable') { bagSellConsumable(ci2); }
        else if (ct2 === 'material') { bagSellMaterial(ci2); }
        else if (ct2 === 'hidden') { bagSellHidden(ci2); }
        else if (ct2 === 'weapon') { bagSellWeapon(ci2); }
        
        // âœ… æ–°å¢é€™ä¸€è¡Œï¼šè²©è³£å®Œæˆå¾Œé—œé–‰æ“ä½œé¢æ¿
        closeBagAction();
        return;
      }

      var type = btn.dataset.type;
      var op   = btn.dataset.op;
      var idx  = +(btn.dataset.idx || 0);
      var P2   = state.player;

      if (type === 'consumable') {
        if (op === 'use') bagUseConsumable(idx);
        else if (op === 'sell') { openSellPanel('consumable', idx); return; }
        else if (op === 'throw') bagThrowConsumable(idx);

      } else if (type === 'weapon') {
        if (op === 'equip') bagEquipWeapon(idx);
        else if (op === 'repair') bagRepairWeapon(idx);
        else if (op === 'sell') { openSellPanel('weapon', idx); return; }
        else if (op === 'throw') bagThrowWeapon(idx);

      } else if (type === 'ornament') {
        if (op === 'equip') {
          if (typeof bagEquipOrnament === 'function') {
            bagEquipOrnament(idx);
          } else {
            var o = (P2 && P2.bag && P2.bag.ornaments) ? P2.bag.ornaments[idx] : null;
            if (!o) { closeBagAction(); return; }
            if (typeof o === 'string') {
              var kindsL = ['ornaments','rings','earrings','cloaks','armors','boots','medals'];
              var defL = null, iL;
              for (iL=0;iL<kindsL.length;iL++) {
                var tmp = (window.ItemDB && ItemDB.getDef) ? ItemDB.getDef(kindsL[iL], o) : null;
                if (tmp) { defL = tmp; break; }
              }
              o = defL ? { id: o, name: (defL.name || o), icon: (defL.icon || '') } : { id: o };
              if (P2 && P2.bag && P2.bag.ornaments) P2.bag.ornaments[idx] = o;
            }
            var equippedOk = false;
            if (window.Equip && Equip.equipOrnament) {
              equippedOk = !!Equip.equipOrnament(o);
            }
            if (!equippedOk) {
              P2.equip = P2.equip || { weapon:null, earrings:[null,null], rings:[null,null], cloak:null, armor:null, shoes:null, medals:[null,null,null,null,null] };
              var kind = '';
              if (window.ItemDB && ItemDB.getDef) {
                if (ItemDB.getDef('ornaments', o.id)) kind = 'rings';
                else if (ItemDB.getDef('rings', o.id)) kind = 'rings';
                else if (ItemDB.getDef('earrings', o.id)) kind = 'earrings';
                else if (ItemDB.getDef('cloaks', o.id)) kind = 'cloak';
                else if (ItemDB.getDef('armors', o.id)) kind = 'armor';
                else if (ItemDB.getDef('boots', o.id)) kind = 'shoes';
                else if (ItemDB.getDef('medals', o.id)) kind = 'medals';
              }
              if (!kind) { if (window.Game && Game.log) Game.log('ç„¡æ³•è¾¨è­˜é£¾å“ç¨®é¡','warn'); closeBagAction(); return; }
              var back = null, j;
              if (kind === 'rings' || kind === 'earrings' || kind === 'medals') {
                var cap = (kind === 'medals') ? 5 : 2;
                var arr = (P2.equip[kind] && P2.equip[kind].slice) ? P2.equip[kind] : new Array(cap);
                for (j=0;j<cap;j++) if (typeof arr[j] === 'undefined') arr[j] = null;
                for (j=0;j<arr.length;j++){ if (arr[j] && arr[j].id === o.id) { if(window.Game&&Game.log)Game.log('ä¸å¯é‡è¤‡è£å‚™ç›¸åŒé£¾å“','warn'); closeBagAction(); return; } }
                var pos = -1; for (j=0;j<arr.length;j++){ if(!arr[j]){ pos=j; break; } }
                if (pos === -1) { back = arr[0]; arr[0] = JSON.parse(JSON.stringify(o)); }
                else { arr[pos] = JSON.parse(JSON.stringify(o)); }
                P2.equip[kind] = arr;
              } else {
                back = P2.equip[kind] || null;
                P2.equip[kind] = JSON.parse(JSON.stringify(o));
              }
              if (P2 && P2.bag && P2.bag.ornaments) { P2.bag.ornaments.splice(idx, 1); }
              if (back){
                P2.bag = P2.bag || {};
                P2.bag.ornaments = Array.isArray(P2.bag.ornaments) ? P2.bag.ornaments : [];
                try { P2.bag.ornaments.unshift(JSON.parse(JSON.stringify(back))); }
                catch(_){ P2.bag.ornaments.unshift(back); }
              }
              equippedOk = true;
            }
            if (equippedOk) {
              if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P2);
              render(P2); renderBag('ornament');
            }
          }
        } else if (op === 'sell') {
        // âœ… é£¾å“ç›´æ¥ç¢ºèªè²©è³£ï¼ˆä¸å¯å †ç–Šï¼Œåƒæ­¦å™¨ä¸€æ¨£ï¼‰
        var o = (P2 && P2.bag && P2.bag.ornaments) ? P2.bag.ornaments[idx] : null;
        if (!o) { closeBagAction(); return; }
        
        // å–å¾—é£¾å“å®šç¾©å’Œåƒ¹æ ¼
        var kindsL = ['ornaments','rings','earrings','cloaks','armors','boots','medals'];
        var defL = null, iL;
        for (iL=0;iL<kindsL.length;iL++) {
          var tmp = (window.ItemDB && ItemDB.getDef) ? ItemDB.getDef(kindsL[iL], o.id || o) : null;
          if (tmp) { defL = tmp; break; }
        }
        
        var itemName = o.name || (defL && defL.name) || 'é£¾å“';
        var price = o.price || (defL && defL.price) || 0;
        
        // ç¢ºèªè²©è³£å°è©±æ¡†
        if (confirm('ç¢ºå®šè¦è²©è³£ï¼šã€Œ' + itemName + 'ã€ï¼Ÿï¼ˆå¯å¾— ' + price + ' éˆçŸ³ï¼‰')) {
          // å¢åŠ éˆçŸ³
          P2.currencies = P2.currencies || {stone:0, diamond:0};
          P2.currencies.stone += price;
          
          // å¾èƒŒåŒ…ç§»é™¤
          P2.bag.ornaments.splice(idx, 1);
          
          // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
          if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P2);
          render(P2); 
          renderBag('ornament');
          
          // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
          if (window.Game && Game.log) {
            Game.log('è²©è³£ ' + itemName + 'ï¼Œç²å¾— ' + price + ' éˆçŸ³', 'ok');
          }
        }
        closeBagAction();
        return;

        } else if (op === 'throw') {
          if (window.Game && Game.log) Game.log('é£¾å“ä¸Ÿæ£„å°šæœªå¯¦ä½œã€‚','warn');
          closeBagAction(); // âœ… æ–°å¢ï¼šä¿æŒé‚è¼¯ä¸€è‡´æ€§
          return;           // âœ… æ–°å¢ï¼šä¿æŒé‚è¼¯ä¸€è‡´æ€§
        }

      } else if (type === 'hidden') {
        if (op === 'use')  { if (window.Game && Game.log) Game.log('æš—å™¨åƒ…èƒ½åœ¨æˆ°é¬¥ä¸­ä½¿ç”¨ã€‚','info'); }
        else if (op === 'sell') { openSellPanel('hidden', idx); return; }
        else if (op === 'throw'){ 
          if (window.Game && Game.log) Game.log('æš—å™¨ä¸Ÿæ£„å°šæœªå¯¦ä½œã€‚','warn'); 
          closeBagAction(); // âœ… æ–°å¢ï¼šä¿æŒé‚è¼¯ä¸€è‡´æ€§
          return;           // âœ… æ–°å¢ï¼šä¿æŒé‚è¼¯ä¸€è‡´æ€§
        }

      } else if (type === 'material') {
        if (op === 'sell')  { openSellPanel('material', idx); return; }
        else if (op === 'throw') bagThrowMaterial(idx);
      }

      closeBagAction();
      return;
    }    
  });

  // ç™»å‡ºæŒ‰éˆ•
  document.getElementById('btnLogout')?.addEventListener('click', ()=>{
    if (confirm('è¦ç™»å‡ºå—ï¼Ÿ')) {
      if (window.Auth && Auth.logout) Auth.logout();
      location.href = 'index.html';
    }
  });
}

/* ===== Appearanceï¼ˆå¤–è§€ï¼‰ ===== */
function openAppearance(){
  if (window.Appearance && typeof Appearance.open === 'function'){
    Appearance.open();
  }else{
    alert('appearance.js æœªè¼‰å…¥');
  }
}


/* ===== Shop (module proxy) ===== */
function openShop(){ if (window.Shop && Shop.open) Shop.open(); }
function closeShop(){ if (window.Shop && Shop.close) Shop.close(); }

/* å•†äººæ¸…å–®é  */
function renderMerchants(){ /* moved to shop.js */ }





/* === æ–°å¢ï¼šè£å‚™ï¼ˆæŠ«é¢¨/è¡£æœ/é‹å­ï¼‰æ¸…å–®æ¸²æŸ“ === */
function renderEquip(box, P){
  const isUrl = s => typeof s==='string' && /^https?:\/\//.test(s);

  // å¾ã€Œå–®ä¸€æ± ã€ ornaments éæ¿¾å‡ºæŠ«é¢¨/è­·ç”²/é‹ï¼›ä¹Ÿå®¹å¿èˆŠå­˜æª”å¦‚æœæœ‰åˆ†è¡¨
  const pool = [];
  const list = (P.bag && P.bag.ornaments) ? P.bag.ornaments : [];
  for (let o of list){
    const def = ItemDB.getDef('cloaks', o.id)
            || ItemDB.getDef('armors', o.id)
            || ItemDB.getDef('boots',  o.id);
    if (def) pool.push({ inst:o, def });
  }
  // èˆŠå­˜æª”å®¹éŒ¯ï¼ˆè‹¥æ›¾æœ‰åˆ†è¡¨ï¼‰
  ['cloaks','armors','boots'].forEach(kind=>{
    const arr = P?.bag?.[kind];
    if (Array.isArray(arr)) arr.forEach(o=>{
      const def = ItemDB.getDef(kind, o.id) || {};
      pool.push({ inst:o, def });
    });
  });

  if (!pool.length){
    const tip = document.createElement('div');
    tip.className='item-sub';
    tip.textContent = 'å°šç„¡è£å‚™';
    box.appendChild(tip);
    return;
  }

  // åˆ—è¡¨è¼¸å‡ºï¼ˆæ²¿ç”¨ ornament çš„æ¨£å¼èˆ‡æ“ä½œï¼šä»ç”¨ dataset.type="ornament"ï¼‰
  pool.forEach(({inst:o, def})=>{
    const name = o.name || def.name || o.id;
    const iconUrl = isUrl(o.icon) ? o.icon : (isUrl(def.icon) ? def.icon : '');
    // é¡¯ç¤ºä¸»è¦å±¬æ€§ï¼ˆå¸¸è¦‹ï¼šæ°£è¡€/çœŸå…ƒ/é˜²ç¦¦ç­‰ï¼‰
    const bonus = o.bonus || def.bonus || {};
    let lines = [];
    if (bonus['æ°£è¡€ä¸Šé™']) lines.push('æ°£è¡€+'+bonus['æ°£è¡€ä¸Šé™']);
    if (bonus['çœŸå…ƒä¸Šé™']) lines.push('çœŸå…ƒ+'+bonus['çœŸå…ƒä¸Šé™']);
    if (bonus['ç‰©ç†é˜²ç¦¦']) lines.push('ç‰©é˜²+'+bonus['ç‰©ç†é˜²ç¦¦']);
    if (bonus['æ³•è¡“é˜²ç¦¦']) lines.push('æ³•é˜²+'+bonus['æ³•è¡“é˜²ç¦¦']);
    const subLeft = lines.join(' ');
    const price = o.price ?? def.price ?? 0;

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'ornament'; // â† ä¿æŒå…±ç”¨æ“ä½œé¢æ¿ï¼ˆè£å‚™/è²©è³£/ä¸Ÿæ£„ï¼‰
    row.dataset.idx  = String((P.bag.ornaments || []).indexOf(o)); // ä»¥ä¸»æ± ç´¢å¼•ç‚ºæº–
    row.innerHTML = `
      <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${name}">`:''}</div>
      <div class="item-main">
        <div class="item-title equip">
          <span class="item-name">${name}</span>
        </div>
        <div class="item-sub">
          <span class="sub-left">${subLeft}</span>
          <span class="sub-right">è²©å”®åƒ¹æ ¼ ${price}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });
}


function bagUseConsumable(i){
  const P = state.player; 
  const it = P.bag.consumables[i]; 
  if(!it || !it.effect) return;
  
  // å–å¾—åŸºç¤å±¬æ€§å’Œè£å‚™åŠ æˆï¼ˆé¿å…é‡è¤‡è¨ˆç®—ï¼‰
  var base  = derivedFrom(P);
  var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
  
  // è™•ç†å„ç¨®æ¢å¾©æ•ˆæœ
  const effects = it.effect;
  
  // æ°£è¡€æ¢å¾©
  if (effects.hp){
    var hpMax = (base['æ°£è¡€ä¸Šé™'] || 0) + (bonus['æ°£è¡€ä¸Šé™'] || 0);
    P.hp = P.hp || {cur:hpMax, max:hpMax};
    P.hp.max = hpMax;
    P.hp.cur = Math.min(P.hp.cur + effects.hp, hpMax);
  }
  
  // çœŸå…ƒæ¢å¾©
  if (effects.mp){
    var mpMax = (base['çœŸå…ƒä¸Šé™'] || 0) + (bonus['çœŸå…ƒä¸Šé™'] || 0);
    P.mp = P.mp || {cur:mpMax, max:mpMax};
    P.mp.max = mpMax;
    P.mp.cur = Math.min(P.mp.cur + effects.mp, mpMax);
  }
  
  // é«”åŠ›æ¢å¾©
  if (effects.sta){
    var staMax = (base['é«”åŠ›ä¸Šé™'] || 100) + (bonus['é«”åŠ›ä¸Šé™'] || 0);
    P.sta = P.sta || {cur:staMax, max:staMax};
    P.sta.max = staMax;
    P.sta.cur = Math.min(P.sta.cur + effects.sta, staMax);
  }
  
  // ç¶“é©—å€¼å¢åŠ 
  if (effects.exp){
    P.exp = (P.exp || 0) + effects.exp;
    // å¦‚æœæœ‰å‡ç´šæª¢æŸ¥å‡½æ•¸çš„è©±
    if (typeof checkLevelUp === 'function') checkLevelUp(P);
  }
  
  // éˆçŸ³å¢åŠ 
  if (effects.stone){
    P.stone = (P.stone || 0) + effects.stone;
  }
  
  // å±¬æ€§é»å¢åŠ  æš«æ™‚ä¸è¦å‹•é€™è£¡ !ç‚ºå®šç¾©å±¬æ€§ID
  if (effects.attrPoints){
    P.attrPoints = (P.attrPoints || 0) + effects.attrPoints;
  }
  
  // ç‰¹æ®Šæ•ˆæœï¼šå…¨æ¢å¾©
  if (effects.fullRestore){
    var hpMax = (base['æ°£è¡€ä¸Šé™'] || 0) + (bonus['æ°£è¡€ä¸Šé™'] || 0);
    var mpMax = (base['çœŸå…ƒä¸Šé™'] || 0) + (bonus['çœŸå…ƒä¸Šé™'] || 0);
    var staMax = (base['é«”åŠ›ä¸Šé™'] || 100) + (bonus['é«”åŠ›ä¸Šé™'] || 0);
    
    P.hp = {cur:hpMax, max:hpMax};
    P.mp = {cur:mpMax, max:mpMax};
    P.sta = {cur:staMax, max:staMax};
  }
  
  // æ¸›å°‘ç‰©å“æ•¸é‡
  it.count = (it.count||0) - 1;
  if (it.count <= 0) P.bag.consumables.splice(i,1);
  
  // å„²å­˜è§’è‰²è³‡æ–™
  if (window.Auth && Auth.saveCharacter) {
    var cleanData = JSON.parse(JSON.stringify(P));
    delete cleanData._live;
    Auth.saveCharacter(cleanData);
  }
  
  // é‡æ–°æ¸²æŸ“ä»‹é¢
  render(P); renderBag('consumable');
}



// æ­¦å™¨è²©è³£åŠŸèƒ½
function bagSellWeapon(i){
  var P = state.player; 
  var w = (P.bag && P.bag.weapons) ? P.bag.weapons[i] : null; 
  if(!w) return;
  
  // çµ±ä¸€èµ°æ•¸é‡é¢æ¿ï¼Œä½†æ­¦å™¨åªèƒ½è³£ 1 ä»¶
  var qtyEl = document.getElementById('sellQty');
  var qty = qtyEl ? parseInt(qtyEl.value,10) : 1;
  if (!qty || qty < 1) qty = 1; // ç¢ºä¿è‡³å°‘ç‚º 1
  
  // ç¢ºèªè²©è³£å°è©±æ¡†
  if (!confirm('ç¢ºå®šè¦è²©è³£ï¼šã€Œ' + (w.name || 'æ­¦å™¨') + 'ã€ï¼Ÿï¼ˆå¯å¾— ' + (w.price||0) + ' éˆçŸ³ï¼‰')) return;
  
  // å¢åŠ ç©å®¶éˆçŸ³
  P.currencies = P.currencies || {stone:0, diamond:0};
  P.currencies.stone += (w.price||0);
  
  // å¾èƒŒåŒ…ç§»é™¤æ­¦å™¨ï¼ˆæ­¦å™¨è²©è³£å¾Œç›´æ¥åˆªé™¤ï¼‰
  P.bag.weapons.splice(i,1);
  
  // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); renderBag('weapon');
}

// æ­¦å™¨ä¸Ÿæ£„åŠŸèƒ½
function bagThrowWeapon(i){
  const P = state.player; 
  const w = P.bag.weapons[i]; 
  if(!w) return;
  
  // ç¢ºèªä¸Ÿæ£„å°è©±æ¡†ï¼ˆå¼·èª¿ä¸å¯å›æ”¶ï¼‰
  if (!confirm(`ç¢ºå®šè¦ä¸Ÿæ£„ï¼šã€Œ${w.name}ã€ï¼Ÿï¼ˆä¸å¯å›æ”¶ï¼‰`)) return;
  
  // å¾èƒŒåŒ…ç§»é™¤æ­¦å™¨ï¼ˆç„¡ä»»ä½•è£œå„Ÿï¼‰
  P.bag.weapons.splice(i,1);
  
  // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
  if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  render(P); renderBag('weapon');
}

// === é£¾å“ï¼šè£å‚™ï¼ˆå«å›æ”¶è¢«é ‚æ›¿è€…ï¼‰ ===
function bagEquipOrnament(i){
  var P = state.player; if(!P) return;
  P.bag = P.bag || {};
  var list = P.bag.ornaments || [];
  var o = list[i]; if(!o) return;
  
// æ­¤è™•æ‡‰è©²ç¹¼çºŒé£¾å“è£å‚™çš„é‚è¼¯.


 // åˆ¤å®šé£¾å“ç¨®é¡
 var kind = '';
 if (window.ItemDB && ItemDB.getDef){
   if (ItemDB.getDef('ornaments', o.id)) kind = 'rings'; // ornaments è¦–ç‚ºã€Œæˆ’æŒ‡ã€
   else if (ItemDB.getDef('rings',    o.id)) kind = 'rings';
   else if (ItemDB.getDef('earrings', o.id)) kind = 'earrings';
   else if (ItemDB.getDef('cloaks',   o.id)) kind = 'cloak';
   else if (ItemDB.getDef('armors',   o.id)) kind = 'armor';
   else if (ItemDB.getDef('boots',    o.id)) kind = 'shoes';
   else if (ItemDB.getDef('medals',   o.id)) kind = 'medals';
 }
 if (!kind) { log('ç„¡æ³•è¾¨è­˜é£¾å“ç¨®é¡'); return; }


    // è£å‚™æ¬„ä¿åº•åˆå§‹åŒ–
    P.equip = P.equip || { weapon:null, earrings:[null,null], rings:[null,null], cloak:null, armor:null, shoes:null, medals:[null,null,null,null,null] };

    var copy = JSON.parse(JSON.stringify(o));
    var back = null;

    if (kind==='rings' || kind==='earrings' || kind==='medals'){
      var cap = (kind==='medals') ? 5 : 2;

      // â˜… é—œéµä¿®æ­£ï¼šä¸è«–èˆŠå­˜æª”å…§å®¹å¦‚ä½•ï¼Œéƒ½å…ˆæ­£è¦åŒ–åˆ°å›ºå®šé•·åº¦ä¸¦å¡« null
      var arr = Array.isArray(P.equip[kind]) ? P.equip[kind] : (P.equip[kind] = new Array(cap));
      for (var j2=0;j2<cap;j2++){ if (typeof arr[j2] === 'undefined') arr[j2] = null; }
      if (arr.length > cap) arr.length = cap;

      // ä¸å…è¨±åŒ ID é‡è¤‡è£å‚™
      for (var t=0;t<arr.length;t++){ if(arr[t] && arr[t].id===copy.id){ log('ä¸å¯é‡è¤‡è£å‚™ç›¸åŒé£¾å“'); return; } }

      // æ‰¾ç©ºä½ï¼›æ²’æœ‰å°±è¦†è“‹ç¬¬ 1 æ ¼ä¸¦å›æ”¶è¢«è¦†è“‹è€…
      var pos = -1; for (var j=0;j<arr.length;j++){ if(!arr[j]){ pos=j; break; } }
      if (pos===-1){ back = arr[0]; arr[0] = copy; } else { arr[pos] = copy; }
    } else {
      back = P.equip[kind] || null;
      P.equip[kind] = copy;
    }

    // å¾èƒŒåŒ…ç§»é™¤æœ¬ä»¶
    list.splice(i,1);

    // å°‡è¢«é ‚æ›¿è€…å›æ”¶å›å„²ç‰©è¢‹ï¼ˆå›åˆ° ornamentsï¼‰
    if (back){
      P.bag.ornaments = Array.isArray(P.bag.ornaments) ? P.bag.ornaments : [];
      try { P.bag.ornaments.unshift(JSON.parse(JSON.stringify(back))); }
      catch(_){ P.bag.ornaments.unshift(back); }
    }

    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('ornament');
  }


  // === ææ–™ï¼šè²©è³£ / ä¸Ÿæ£„ ===


  function bagSellMaterial(i){
    var P = state.player; var it = (P.bag && P.bag.materials) ? P.bag.materials[i] : null; if(!it) return;
    var def = ItemDB.getDef('materials', it.id) || {};
    var price = def.price || 0;
    var max = it.count || 0;
    var qtyEl = document.getElementById('sellQty');
    var qty = qtyEl ? parseInt(qtyEl.value,10) : max;
    if (!qty || qty < 1 || qty > max) return;

    P.currencies = P.currencies || { stone: 0, diamond: 0 };
    P.currencies.stone += qty * price;

    it.count = (it.count||0) - qty;
    if (it.count <= 0) P.bag.materials.splice(i, 1);

    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('material');
  }




  function log(txt, cls=''){ const el=document.createElement('div'); el.className = `item ${cls}`; el.textContent = txt; const box=qs('#log'); if(!box) return; box.appendChild(el); box.scrollTop = box.scrollHeight; }
  function sendChat(){ const inp = qs('#chatInput'); const msg = (inp?.value||'').trim(); if(!msg) return; log(`ä½ ï¼š${msg}`,'ok'); inp.value=''; }

  return {
    start(player){
    const defaults = {
      level: 1,
      attributes: { str:0, vit:0, dex:0, int:0, wis:0, luk:0 },
      unspentPoints: 0,
      medals: [],
      equip: { weapon: null, earrings: [null,null], rings: [null,null], cloak: null, armor: null, shoes: null, medals: [null,null,null,null,null] },
      sta: { cur: 100, max: 100 },
      exp: { cur: 0,   max: 100 },
      hp:  { cur: 0,   max: 0 },
      currencies: { stone: 0, diamond: 0 },
    };


    const p = Object.assign({}, defaults, player || {});  // ç©å®¶è³‡æ–™å„ªå…ˆï¼Œé¿å…è“‹æ‰ç­‰ç´š


      // â˜… é—œéµï¼šæŠŠç©å®¶å¯«å› stateï¼Œå¾Œé¢æ‰€æœ‰åŠŸèƒ½æ‰èƒ½æ­£å¸¸è®€åˆ°
      state.player = p;

      // â˜…è¨ˆå…¥è£å‚™åŠ æˆçš„ä¸Šé™ï¼ˆåˆå§‹åŒ–ç”¨ï¼‰
      var base  = derivedFrom(p);
      var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
      var hpMax = (base['æ°£è¡€ä¸Šé™'] || 0) + (bonus['æ°£è¡€ä¸Šé™'] || 0);

      // HPï¼šè‹¥æ²’æœ‰å°±å»ºç«‹ï¼›è‹¥å·²æœ‰å°±åªæ›´æ–°ä¸Šé™ä¸¦å¤¾åœ¨ 0 ~ max ä¹‹é–“ï¼Œä¸å›æ»¿
      if (!p.hp) {
        p.hp = { cur: hpMax, max: hpMax };
      } else {
        p.hp.max = hpMax;
        var cur = (p.hp.cur ?? hpMax);
        p.hp.cur = Math.max(0, Math.min(cur, hpMax));
      }

      // MPï¼ˆçœŸå…ƒï¼‰ï¼šåŒæ¨£è™•ç†ï¼ˆè¨ˆå…¥è£å‚™åŠ æˆï¼‰
      var mpMax = (base['çœŸå…ƒä¸Šé™'] || 0) + (bonus['çœŸå…ƒä¸Šé™'] || 0);
      if (!p.mp) {
        p.mp = { cur: mpMax, max: mpMax };
      } else {
        p.mp.max = mpMax;
        var curM = (p.mp.cur ?? mpMax);
        p.mp.cur = Math.max(0, Math.min(curM, mpMax));
      }


      // é«”åŠ›ï¼šåŒç†ï¼Œä¸å¼·åˆ¶å›æ»¿ï¼›æ²’æœ‰æ‰çµ¦é è¨­
      if (!p.sta) {
        p.sta = { cur: 100, max: 100 };
      } else {
        p.sta.max = p.sta.max ?? 100;
        const curSta = (p.sta.cur ?? p.sta.max);
        p.sta.cur = Math.max(0, Math.min(curSta, p.sta.max));
      }

      // ç¶“é©—ï¼šä¿ç•™åŸæœ¬ curï¼Œè‹¥è¶Šç•Œå°±å¤¾å›ç¯„åœï¼›æ²’æœ‰å°±ç”¨é è¨­
      if (!p.exp) { p.exp = { cur:0, max:100 }; }
      else {
        p.exp.max = p.exp.max ?? 100;
        p.exp.cur = Math.max(0, Math.min(p.exp.cur ?? 0, p.exp.max));
      }


      wire();
      render(p);
    },
    getPlayer(){ return state.player; },
    save(){ if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(state.player); },
    recalc(){ render(state.player); renderDerived(); },
    log(txt, cls=''){ log(txt, cls); }
  };
})();

// ===== åªä¿ç•™é€™ä¸€æ®µå•Ÿå‹•æµç¨‹ï¼ˆç­‰é›²ç«¯è¼‰å…¥å®Œå†é€²ä¸»åŸï¼‰=====
window.addEventListener('DOMContentLoaded', async () => {
  // å…ˆæª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
  var user = (window.Auth && Auth.currentUser) ? Auth.currentUser() : null;
  if(!user){ window.location.href = 'index.html'; return; }

  // è®€é›²ç«¯è§’è‰²
  var char = null;
  try{
    char = (window.Auth && Auth.loadCharacter) ? (await Auth.loadCharacter()) : null;
  }catch(e){
    char = null;
  }

  // è‹¥æœ¬åœ°å¿«å–è¼ƒæ–°ï¼Œå„ªå…ˆç”¨å¿«å–ï¼ˆé¿å…å‰›å­˜æª”æœªåŒæ­¥ï¼‰
  var cached = (window.Auth && Auth.getCharacter) ? Auth.getCharacter() : null;
  if (cached) {
    var useCached = false;
    if (!char) { useCached = true; }
    else {
      var t1 = cached && cached._updatedAt ? cached._updatedAt : 0;
      var t2 = char && char._updatedAt ? char._updatedAt : 0;
      if (t1 > t2) { useCached = true; }
    }
    if (useCached) { char = cached; }
  }

  // æ²’æœ‰è§’è‰² â†’ å›ç™»å…¥é çš„å‰µè§’é 
  if (!char){ window.location.href = 'index.html#create'; return; }

  // å…ˆæ›ä¸Šè£å‚™æ¨¡çµ„ï¼ˆè®“åˆå§‹åŒ–å°±èƒ½æ­£ç¢ºæ‹¿åˆ°è£å‚™åŠ æˆï¼‰
  if (window.Equip && Equip.mount) {
    Equip.mount({
      getPlayer: function(){ return Game.getPlayer(); },
      save:      function(){ return Game.save && Game.save(); },
      recalc:    function(){ return Game.recalc && Game.recalc(); },
      log:       function(t){ return Game.log ? Game.log(t) : console.log(t); }
    });
  }

  // å…ˆå•Ÿå‹•éŠæˆ²ï¼ˆä½¿ Game.getPlayer() æœ‰å€¼ï¼‰
  if (window.Game && Game.start) { Game.start(char); }

  // å†åˆå§‹åŒ–å¤–è§€ç³»çµ±ï¼ˆæ­¤æ™‚ mount å…§çš„ render() æ‰æ‹¿å¾—åˆ°ç©å®¶ï¼‰
  if (window.Appearance && Appearance.mount) {
    Appearance.mount({
      getPlayer: function(){ return Game.getPlayer(); },
      save:      function(){ return Game.save && Game.save(); },
      recalc:    function(){ return Game.recalc && Game.recalc(); },
      log:       function(t){ return Game.log ? Game.log(t) : console.log(t); }
    });
  }


  // å•Ÿå‹•è‡ªå‹•å›å¾©ç³»çµ±
  if (window.AutoRecovery) {
    AutoRecovery.start({
      getPlayer: function(){ return Game.getPlayer(); },
      getBonuses: function(){ return window.Equip ? Equip.getBonuses() : {}; },
      save: function(){ Game.save(); },
      log: function(txt, cls){ Game.log(txt, cls); },
      updateUI: function(){ Game.recalc(); }
    });
  }

  // é é¢é—œé–‰æ™‚æ¸…ç†
  window.addEventListener('beforeunload', function(){
    if (window.AutoRecovery) AutoRecovery.stop();
  });


  
});

</script>
</body>
</html>

