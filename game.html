<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ä¿®ä»™RPGï¼ˆæ‰‹æ©Ÿç›´å‘ãƒ»å–®æª”ï¼‰</title>
  <style>
    :root{
      --bg:#0b1024;--bg2:#0e1536;--panel:#131a3f;--panel-2:#0f1534;--muted:#9aa3b2;--text:#eaf2ff;
      --accent:#8b5cf6;--accent2:#22d3ee;--hp:#ef4444;--mp:#3b82f6;--bar:#334155;--ok:#22c55e;--warn:#f59e0b;
      --radius:16px;--gap:12px;--shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100%;background:linear-gradient(135deg,var(--bg) 0%, var(--bg2) 100%);color:var(--text);font-family: system-ui,-apple-system,"Microsoft JhengHei",Segoe UI,Roboto,Inter,sans-serif}
    button{border:none;background:none;color:inherit}

    .app{display:flex;flex-direction:column;min-height:100svh}
    .topbar{position:sticky;top:0;z-index:20;backdrop-filter: blur(8px);background:rgba(15,16,42,.5);padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .topbar .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);display:flex;gap:6px;align-items:center;font-size:12px}
    .chip .val{font-weight:700}
    .bar{height:8px;background:var(--bar);border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%}

    .content{flex:1;display:flex;flex-direction:column;gap:var(--gap);padding:12px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel .hd{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between}
    .panel .bd{padding:12px}
    .grid{display:grid;gap:var(--gap)}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}

    .stat{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:rgba(255,255,255,.04);border-radius:12px}
    .stat small{opacity:.7; font-variant-numeric: tabular-nums;}
    .stat .add{margin-left:8px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);font-weight:800}
    /* å±¬æ€§æ•¸å­—å›ºå®šå¯¬åº¦ï¼‹å³å°é½Šï¼Œé¿å…ä½æ•¸ä¸åŒé€ æˆæŠ–å‹• */
    .stat small.val{
      display:inline-block;
      min-width:3ch;        /* 0~999 å¤ ç”¨ï¼Œå¾ŒæœŸæ•¸å­—æ›´å¤§å¯æ”¹ 4ch */
      text-align:right;
    }
    /* å±¬æ€§å³å´ï¼šæ•¸å€¼ + èªªæ˜æ©«å‘æ’åˆ— */
    .attr-right{ display:flex; align-items:center; gap:8px }
    .attr-desc{ opacity:.75; font-size:11px; white-space:nowrap }
    /* Shop å…§åˆ†é¡æŒ‰éˆ• active æ¨£å¼ */
    [data-page="shop"] [data-shop].active{
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      color:#0b1024;
      font-weight:800;
    }
    .tabs{display:flex;gap:8px;overflow:auto;padding:0 12px 12px}
    .tabs button{flex:0 0 auto;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.08)}
    .tabs button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1024;font-weight:800}

    .nav{position:sticky;bottom:0;z-index:20;background:rgba(15,16,42,.65);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.06)}
    .nav .row{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;padding:6px}
    .nav button{padding:8px;border-radius:10px;background:rgba(255,255,255,.06);font-size:12px}

    .btn{padding:10px 12px;border-radius:12px;background:linear-gradient(90deg,var(--accent2),var(--accent));color:#0b1024;font-weight:800}
    .btn.ghost{background:rgba(255,255,255,.08);color:var(--text);font-weight:600}
    .btn.warn{background:linear-gradient(90deg,#fb7185,#f59e0b);color:#0b1024}
    .btn.ok{background:linear-gradient(90deg,#34d399,#22d3ee);color:#0b1024}
    .btn.small{font-size:12px;padding:8px 10px}

    .list{display:grid;gap:8px}
    .card{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.06)}
    .card .grow{flex:1}
    .tag{font-size:10px;padding:3px 6px;border-radius:999px;background:rgba(255,255,255,.1)}

    .face{display:flex;align-items:center;gap:10px}
    .ava{width:64px;height:64px;border-radius:12px;overflow:hidden;background:rgba(255,255,255,.06);flex:0 0 64px;border:1px solid rgba(255,255,255,.08)}
    .ava img{width:100%;height:100%;object-fit:cover;display:block}
    .icon{width:40px;height:40px;flex:0 0 40px;border-radius:10px;background:rgba(255,255,255,.06);display:grid;place-items:center;border:1px solid rgba(255,255,255,.08);overflow:hidden}
    .icon img{width:100%;height:100%;object-fit:contain;display:block}

    .hpbar,.mpbar{position:relative;height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.08)}
    .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#ef4444,#f97316)}
    .mpbar>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee)}
    .bar-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6);pointer-events:none}

    .actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .actions .btn{padding:12px}
    /* æˆ°é¬¥é æŒ‰éˆ•æ›´ç·Šæ¹Šï¼ˆæ‰‹æ©Ÿå„ªå…ˆï¼‰ */
    [data-page="battle"] .actions .btn,
    [data-page="battle"] .grid .btn{
      padding:8px 10px;    /* é«˜åº¦ä¸‹é™ï¼Œæ¥è¿‘ä¸»é å±¬æ€§å¡ç‰‡ */
      font-size:13px;
    }

    .toast{position:fixed;inset:auto 12px 88px 12px;z-index:50;display:none}
    .toast .inner{padding:10px 12px;border-radius:12px;background:#111827;color:#f9fafb;border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow)}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);z-index:60}
    .modal .box{width:min(640px,92vw);max-height:80vh;overflow:auto}

    .muted{color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .small{font-size:12px}
    .equip-name{font-weight:800}
    .title-center{ width:100%; text-align:center; }
    .title-xl{ font-size:18px; font-weight:800; letter-spacing:.5px }

    /* å…©æ¬„å±¬æ€§åˆ—è¡¨ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ */
    .attrs-compact{display:grid;grid-template-columns:1fr;gap:8px}
    .attrs-compact .stat{padding:4px 8px; font-size:12px; line-height:1.15}
    .attrs-compact .stat small{ opacity:.8 }

    /* ç¨€æœ‰åº¦æ¨£å¼ï¼ˆç”¨æ–¼å¡ç‰‡èˆ‡æ§½ä½ï¼‰ */
    .rarity-common{ color:#fff; border-color:rgba(255,255,255,.18) }
    .rarity-rare{ color:#34d399; border-color:#34d39988; box-shadow:0 0 0 1px #34d39944 inset }
    .rarity-epic{ color:#60a5fa; border-color:#60a5fa88; box-shadow:0 0 0 1px #60a5fa44 inset }
    .rarity-legend{ color:#a78bfa; border-color:#a78bfaaa; box-shadow:0 0 0 1px #a78bfa55 inset }
    .rarity-mythic{ color:#fb923c; border-color:#fb923caa; box-shadow:0 0 0 1px #fb923c55 inset }
    .rarity-relic{ color:#ef4444; border-color:#ef4444aa; animation:glow 2s ease-in-out infinite }
    @keyframes glow {
      0%,100%{ box-shadow:0 0 0 1px #ef444455 inset, 0 0 12px 2px #ef444422 }
      50%    { box-shadow:0 0 0 1px #ef4444aa inset, 0 0 18px 4px #ef444433 }
    }

    /* è£å‚™æ§½ä½ï¼ˆæ¥“ä¹‹è°·é¢¨æ ¼ï¼‰ */
    .slot{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);cursor:pointer}
    .slot .meta{display:flex;flex-direction:column;gap:4px}
    .slot .label{font-size:12px;opacity:.8}
    .slot .name{font-weight:800}
    /* æ‰‹æ©Ÿè£å‚™æ§½ä½å›ºå®šé«˜åº¦ï¼Œé¿å…æ›è£é€ æˆè·³å‹• */
    .slot { min-height: 64px; }
    .slot .meta .name { max-width: 100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* å‚·å®³é£„å­— */
    .floating-dmg{
      position: absolute; pointer-events:none;
      font-weight:800; text-shadow:0 1px 2px rgba(0,0,0,.6);
      animation: dmgUp .8s ease-out forwards;
    }
    .floating-dmg.red{ color:#f87171; }  /* çµ¦æ•µäººå—å‚· */
    .floating-dmg.blue{ color:#60a5fa; } /* çµ¦ç©å®¶å—å‚· */
    @keyframes dmgUp{
      0%{ transform:translateY(0); opacity:1 }
      100%{ transform:translateY(-18px); opacity:0 }
    }

    /* è¡Œå‹•ä¸å¯ç”¨æ™‚è®“æŒ‰éˆ•é¡¯è‘—è®Šæš— */
    .actions .btn:disabled{
      opacity:.5; filter:grayscale(0.3);
    }

/* ä»¥æ‰‹æ©Ÿç‚ºä¸»ï¼šç•¶å¯¬åº¦è¼ƒçª„æˆ–è¦–çª—æ¯”ä¾‹å°æ–¼ 128:93 æ™‚ï¼Œå£“ç¸®æ¬„æ•¸ */
@media (max-width: 420px), (max-aspect-ratio: 128/93) {
  .grid.cols-2 { grid-template-columns: 1fr; }
  .grid.cols-3 { grid-template-columns: 1fr; }

  /* è£å‚™æ¬„åœ¨æ‰‹æ©Ÿæ”¹ç‚ºå…©æ¬„ï¼ˆåƒ…å½±éŸ¿è£å‚™é ï¼‰ */
  #equipSlots { grid-template-columns: 1fr 1fr !important; }

  .topbar .row { flex-wrap: wrap; }
  .ava { width:56px; height:56px; }
  .icon { width:36px; height:36px; }
  .btn.small { padding:7px 9px; font-size:11px; }
  .panel .bd { padding:10px; }
  .tabs { padding:0 10px 10px; }

  /* å°è¢å¹•ä¾ä½ çš„ 128:93 æ¯”ä¾‹åšä¿å®ˆç¸®æ’ï¼ˆå±¬æ€§å¡ç‰‡æ›´ç·Šæ¹Šï¼‰ */
.attrs-compact .stat { min-height: 26px; }
}

/* è®“ä¸»è¦å…§å®¹ä¸è¶…å‡ºå¯¬åº¦ï¼ˆä¿éšªï¼‰ */
.content { overflow-x: hidden; }

/* â˜… å›ºå®šå±¬æ€§å¡ç‰‡é«˜åº¦ï¼ˆå†ç¸®ï¼‰ */
.attrs-compact { grid-auto-rows: 1fr; gap:6px; }
.attrs-compact .stat{
  padding:2px 8px;
  font-size:11px;
  line-height:1.1;
  min-height: 30px;
  display: grid;
  align-content: center;
}

/* å±¬æ€§å³å´ï¼šæ•¸å€¼ + èªªæ˜æ©«å‘æ’åˆ—ï¼ˆè¡Œå…§é¡¯ç¤ºèªªæ˜ï¼‰ */
.attr-right{ display:flex; align-items:center; gap:8px; }
.attr-desc{ opacity:.75; font-size:11px; white-space:nowrap; }

  </style>
  <!-- åœ¨ </style> æ¨™ç±¤å¾Œï¼Œ</head> æ¨™ç±¤å‰åŠ å…¥ -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

</head>
<body>
<div class="app" id="app">
  <!-- Topbar -->
  <div class="topbar">
    <div class="row">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="chip">Lv.<span class="val" id="uiLevel">1</span></span>
        <span class="chip">EXP <span class="val" id="uiExp">0/100</span></span>
        <span class="chip">é»æ•¸ <span class="val" id="uiPts">0</span></span>
        <span class="chip">â¤ éˆçŸ³ <span class="val" id="uiStone">0</span></span>
        <span class="chip">ğŸ’ é‘½çŸ³ <span class="val" id="uiDiamond">0</span></span>
        <span class="chip">ğŸª™ é‡‘å¹£ <span class="val" id="uiGold">0</span></span>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost small" id="btnSave">å„²å­˜</button>
        <button class="btn ghost small" id="btnLoad">è®€å–</button>
        <button class="btn warn small" id="btnReset">é‡ç½®</button>
      </div>
    </div>
    <div class="bar" style="margin-top:8px"><span id="uiExpBar"></span></div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabbar">
    <button data-tab="home" class="active">ä¸»é </button>
    <button data-tab="cultivate">ä¿®ç…‰</button>
    <button data-tab="bag">èƒŒåŒ…</button>
    <button data-tab="equip">è£å‚™</button>
    <button data-tab="shop">å•†åº—</button>
    <button data-tab="battle">æˆ°é¬¥</button>
    <button data-tab="more">æ›´å¤šï¼ˆ6å€‹å¾…é–‹ç™¼ï¼‰</button>
  </div>

  <main class="content">
    <!-- Home -->
    <section class="panel" data-page="home">
      <div class="hd" style="justify-content:center"><strong>å°‘ä¿ è³‡è¨Š</strong></div>
      <div class="bd">
        <div class="grid cols-2">
          <div class="panel">
            <div class="hd"><strong>åŸºæœ¬å±¬æ€§</strong></div>
            <div class="bd">
              <div class="face" style="margin-bottom:8px">
                <div class="ava" style="width:72px;height:72px"><img id="homeAvatar" alt="ç©å®¶é ­åƒ"/></div>
                <div style="flex:1">
                  <div class="small muted" style="line-height:1.4">
                    <div><strong id="homePlayerName">ç„¡åæ•£ä¿®</strong></div>
                    <div>ç­‰ç´š <span id="homePlayerLv">1</span></div>
                  </div>
                  <!-- ä¸»é  HP/MP with numbers -->
                  <div class="hpbar" style="margin-top:6px">
                    <span id="homeHpBar" style="width:100%"></span>
                    <div class="bar-label" id="homeHpText">HP 0/0</div>
                  </div>
                  <div class="mpbar" style="margin-top:6px">
                    <span id="homeMpBar" style="width:100%"></span>
                    <div class="bar-label" id="homeMpText">MP 0/0</div>
                  </div>
                </div>
              </div>
              <!-- å…©æ¬„å±¬æ€§ -->
              <div class="attrs-compact" id="attrList"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cultivate -->
    <section class="panel" data-page="cultivate" hidden>
      <div class="hd"><strong>ä¿®ç…‰ï¼ˆæ‰“åï¼‰</strong><small class="muted">éœåå¯ç²å¾—å°‘é‡ç¶“é©—</small></div>
      <div class="bd">
        <div class="grid cols-3">
          <button class="btn ok" id="btnMeditate">æ‰“å +5 EXP</button>
          <button class="btn ghost" id="btnReadBook">ç ”è®€ç¶“æ›¸ï¼ˆæ¶ˆè€—ï¼šä¿®ç…‰ç¶“æ›¸ï¼‰</button>
          <button class="btn ghost" id="btnUseTown">ä½¿ç”¨å›åŸç¬¦ï¼ˆéæˆ°é¬¥ï¼‰</button>
        </div>
        <p class="muted small" style="margin-top:10px">æç¤ºï¼šç¶“é©—å€¼é”åˆ°ä¸Šé™å¾Œè‡ªå‹•å‡ç´šã€‚å‡ç´šæœƒå›æ»¿æ°£è¡€èˆ‡çœŸå…ƒï¼ˆHP/MPï¼‰ï¼Œä¸¦æå‡å±¬æ€§ï¼Œå¦ç²å¾—å¯åˆ†é…èƒ½åŠ›é»ã€‚</p>
      </div>
    </section>

    <!-- Bag -->
    <section class="panel" data-page="bag" hidden>
      <div class="hd"><strong>èƒŒåŒ…</strong><small class="muted">åˆ†é¡èˆ‡ä½¿ç”¨é™åˆ¶</small></div>
      <div class="bd">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn ghost small" data-filter="all">å…¨éƒ¨</button>
          <button class="btn ghost small" data-filter="consumable">æ¶ˆè€—å“</button>
          <button class="btn ghost small" data-filter="potion">æ¢å¾©ä¸¹è—¥</button>
          <button class="btn ghost small" data-filter="equip">è£å‚™/æ­¦å™¨</button>
          <button class="btn ghost small" data-filter="material">ææ–™</button>
          <button class="btn ghost small" data-filter="quest">ä»»å‹™</button>
          <button class="btn ghost small" data-filter="other">å…¶ä»–</button>
        </div>
        <div id="bagList" class="list"></div>
      </div>
    </section>

    <!-- Equip -->
    <section class="panel" data-page="equip" hidden>
      <div class="hd"><strong>è£å‚™æ¬„ä½</strong><small class="muted">æ­¦å™¨1ã€æŠ«é¢¨1ã€é‹å­1ã€å‹³ç« 3ã€æˆ’æŒ‡2ã€å¾…é–‹ç™¼3</small></div>
      <div class="bd">
        <div class="grid cols-3" id="equipSlots"></div>
        <hr style="border-color:rgba(255,255,255,.06);margin:12px 0"/>
        <div class="list" id="equipInventory"></div>
      </div>
    </section>

    <!-- Shop -->
    <section class="panel" data-page="shop" hidden>
      <div class="hd"><strong>é›œè²¨é‹ª</strong><small class="muted">ä½¿ç”¨éˆçŸ³æˆ–é‘½çŸ³è³¼è²·</small></div>
      <div class="bd">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn ghost small" data-shop="consumable">æ¶ˆè€—å“</button>
        <button class="btn ghost small" data-shop="potion">æ¢å¾©ä¸¹è—¥</button>
        <button class="btn ghost small" data-shop="equip">è£å‚™/æ­¦å™¨</button>
        <button class="btn ghost small" data-shop="material">ææ–™</button>
        <button class="btn ghost small" data-shop="other">å…¶ä»–</button>
      </div>
      <div class="list" id="shopList"></div>
    </div>
    </section>

    <!-- Battle -->
    <section class="panel" data-page="battle" hidden>
      <div class="hd"><strong>æ­·ç·´ï¼ˆå›åˆåˆ¶æˆ°é¬¥ï¼‰</strong><small class="muted">å…©æ–¹è¡Œå‹•æ¢ã€HP èˆ‡ MP</small></div>
      <div class="bd">
        <div class="panel">
          <div class="hd" style="flex-direction:column;gap:4px">
          <strong id="enemyHeaderTitle" class="title-center title-xl">ç›®å‰æ²’æœ‰æ•µäºº</strong>
          <div class="small muted title-center" id="currentMapLabel" style="opacity:.9">åœ°åœ–ï¼šæœªé¸æ“‡</div>
        </div>
          <div class="bd">
            <div class="face">
              <div class="ava"><img id="enemyAvatar" alt="æ•µäºº"/></div>
              <div style="flex:1">
                <div class="hpbar" title="HP"><span id="enemyHpBar" style="width:100%"></span></div>
                <div class="mpbar" title="MP" style="margin-top:6px"><span id="enemyMpBar" style="width:100%"></span></div>
                <div class="bar" style="margin-top:8px"><span id="enemyActBar"></span></div>
              </div>
              <div class="chip">Lv.<span id="enemyLv">1</span></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="hd"><strong id="playerHeaderTitle" class="title-center">å°‘ä¿ </strong></div>
          <div class="bd">
            <div class="face">
              <div class="ava"><img id="playerAvatar" alt="ç©å®¶"/></div>
              <div style="flex:1">
                <div class="hpbar"><span id="playerHpBar" style="width:100%"></span></div>
                <div class="mpbar" style="margin-top:6px"><span id="playerMpBar" style="width:100%"></span></div>
                <div class="bar" style="margin-top:8px"><span id="playerActBar"></span></div>
              </div>
              <div class="chip">Lv.<span id="playerLv2">1</span></div>
            </div>
          </div>
        </div>

        <div class="panel" id="battleLogPanel">
          <div class="hd"><strong>æˆ°å ±</strong><small class="muted">è¡Œå‹•èˆ‡çµæœ</small></div>
          <div class="bd" id="battleLog" style="min-height:80px;max-height:180px;overflow:auto"></div>
        </div>

        <div class="actions" id="battleActions">
          <button class="btn" id="actAttack">æ”»æ“Š</button>
          <button class="btn" id="actSkill">æŠ€èƒ½</button>
          <button class="btn" id="actItem">é“å…·</button>
          <button class="btn ghost" id="actDefend">é˜²ç¦¦/èª¿æ¯</button>
        </div>
        <div class="center small muted" id="turnHint">ç­‰å¾…è¡Œå‹•æ¢å¡«æ»¿...</div>

        <div class="grid cols-3">
          <button class="btn ok" id="btnStartBattle">é–‹å§‹/ä¸‹ä¸€å ´</button>
          <button class="btn ghost" id="btnFlee">é€ƒè·‘</button>
          <button class="btn ghost" id="btnChooseMap">é¸åœ°åœ–</button>
        </div>
      </div>
    </section>

    <!-- More -->
    <section class="panel" data-page="more" hidden>
      <div class="hd"><strong>æ›´å¤šç³»çµ±</strong><small class="muted">ä»¥ä¸‹ 6 å€‹æŒ‰éˆ•ç‚ºå¾…é–‹ç™¼</small></div>
      <div class="bd grid cols-3">
        <button class="btn ghost" data-soon>å®—é–€</button>
        <button class="btn ghost" data-soon>ç§˜å¢ƒ</button>
        <button class="btn ghost" data-soon>é›é€ </button>
        <button class="btn ghost" data-soon>å¯µç‰©</button>
        <button class="btn ghost" data-soon>ç¤¾äº¤</button>
        <button class="btn ghost" data-soon>æ’è¡Œæ¦œ</button>
      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="nav">
    <div class="row">
      <button data-tab="home">ä¸»é </button>
      <button data-tab="cultivate">ä¿®ç…‰</button>
      <button data-tab="bag">èƒŒåŒ…</button>
      <button data-tab="equip">è£å‚™</button>
      <button data-tab="shop">å•†åº—</button>
      <button data-tab="battle">æˆ°é¬¥</button>
    </div>
  </nav>
</div>

<!-- Skill Modal -->
<div class="modal" id="skillModal">
  <div class="box panel">
    <div class="hd"><strong>é¸æ“‡æŠ€èƒ½</strong><button class="btn ghost small" id="closeSkillModal">é—œé–‰</button></div>
    <div class="bd list" id="skillList"></div>
  </div>
</div>

<!-- Map Modal -->
<div class="modal" id="mapModal">
  <div class="box panel">
    <div class="hd"><strong>é¸æ“‡åœ°åœ–</strong><button class="btn ghost small" id="closeMapModal">é—œé–‰</button></div>
    <div class="bd list" id="mapList"></div>
  </div>
</div>

<!-- Item Modal -->
<div class="modal" id="itemModal">
  <div class="box panel">
    <div class="hd"><strong>é¸æ“‡é“å…·</strong><button class="btn ghost small" id="closeItemModal">é—œé–‰</button></div>
    <div class="bd list" id="battleItemList"></div>
  </div>
</div>

<!-- Win Modal -->
<div class="modal" id="winModal">
  <div class="box panel">
    <div class="hd"><strong>æˆ°é¬¥å‹åˆ©</strong><button class="btn ghost small" id="closeWinModal">é—œé–‰</button></div>
    <div class="bd list" id="winBody"></div>
  </div>
</div>

<!-- Equip Detail Modalï¼ˆæ¥“ä¹‹è°·é¢¨ï¼‰ -->
<div class="modal" id="equipInfoModal">
  <div class="box panel">
    <div class="hd">
      <strong id="equipInfoTitle">è£å‚™è©³æƒ…</strong>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn ghost small" id="equipInfoUnequip" style="display:none">å¸ä¸‹</button>
        <button class="btn ghost small" id="closeEquipInfoModal">é—œé–‰</button>
      </div>
    </div>
    <div class="bd" id="equipInfoBody"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"><div class="inner" id="toastMsg">è¨Šæ¯</div></div>

<script>
(function(){
  const $ = (sel, par=document) => par.querySelector(sel);
  const $$ = (sel, par=document) => [...par.querySelectorAll(sel)];
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const fmt = (n)=> new Intl.NumberFormat('zh-Hant').format(n);
  const nowMs = ()=>Date.now();

  // === Firebase åˆå§‹åŒ–ï¼ˆå®Œæ•´ config + åŒ¿åç™»å…¥ï¼‰ ===
  const firebaseConfig = {
    apiKey: "ä½ çš„ apiKey",
    authDomain: "ä½ çš„å°ˆæ¡ˆID.firebaseapp.com",
    databaseURL: "https://fir-config-1215d-default-rtdb.firebaseio.com",
    projectId: "ä½ çš„å°ˆæ¡ˆID",
    storageBucket: "ä½ çš„å°ˆæ¡ˆID.appspot.com",
    messagingSenderId: "XXXXXXXXXXXX",
    appId: "1:XXXXXXXXXXXX:web:YYYYYYYYYYYYYYYY"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let userId = null;

  // è‹¥æœªç™»å…¥å°±å…ˆåŒ¿åç™»å…¥
  function loginFirst(next) {
    const go = () => typeof next === 'function' && next();
    const u = firebase.auth().currentUser;
    if (u) { userId = u.uid; go(); return; }
    firebase.auth().signInAnonymously()
      .then(cred => { userId = cred.user.uid; go(); })
      .catch(err => toast('ç™»å…¥å¤±æ•—ï¼š' + err.message));
  }

  // ç›£è½ç™»å…¥ç‹€æ…‹ï¼Œé¦–æ¬¡ç™»å…¥æ™‚è‡ªå‹•å˜—è©¦é›²ç«¯è®€æª”
  firebase.auth().onAuthStateChanged(u => {
    if (!u) return;
    userId = u.uid;
    db.ref(`users/${userId}/gameState`).once('value').then(snap => {
      if (snap.exists()) {
        try {
        state = snap.val();
        renderAll();
        persistLocal();
        toast('å·²å¾é›²ç«¯è®€å–');
        } catch {}
      }
    });
  });

  // === Icon URLsï¼ˆå¯è‡ªè¡Œæ›¿æ›ï¼‰ ===
  const ICON = {
    sword:'https://api.iconify.design/mdi:sword.svg',
    dagger:'https://api.iconify.design/mdi:knife.svg',
    cloak:'https://api.iconify.design/game-icons:hood.svg',
    boots:'https://api.iconify.design/mdi:shoe-sneaker.svg',
    medal:'https://api.iconify.design/mdi:medal.svg',
    ring:'https://api.iconify.design/mdi:ring.svg',
    potion:'https://api.iconify.design/mdi:bottle-tonic-plus-outline.svg',
    book:'https://api.iconify.design/mdi:book-open-variant.svg',
    scroll:'https://api.iconify.design/mdi:scroll.svg',
    bone:'https://api.iconify.design/mdi:bone.svg',
    chest:'https://api.iconify.design/mdi:treasure-chest.svg',
    enemy_bandit:'https://api.iconify.design/mdi:sword-cross.svg',
    enemy_wood:'https://api.iconify.design/game-icons:treant.svg',
    enemy_fire:'https://api.iconify.design/mdi:fire.svg',
    enemy_water:'https://api.iconify.design/mdi:water.svg',
    enemy_bug:'https://api.iconify.design/game-icons:beetle-shell.svg',
    slot:'https://api.iconify.design/mdi:checkbox-blank-circle-outline.svg'
  };
  const slotIconByKey = {
    weapon: ICON.sword, cloak: ICON.cloak, shoes: ICON.boots,
    medal: ICON.medal, ring: ICON.ring, reserved: ICON.chest
  };

  // === Elements (å…­è¼ª + è–æš— + æ™®é€š) ===
  const ELEM = {
    NEUTRAL:'NEUTRAL',
    WATER:'WATER', FIRE:'FIRE', GRASS:'GRASS', EARTH:'EARTH', ICE:'ICE', THUNDER:'THUNDER',
    LIGHT:'LIGHT', DARK:'DARK'
  };
  const ELEM_ADV = { WATER:'FIRE', FIRE:'GRASS', GRASS:'EARTH', EARTH:'ICE', ICE:'THUNDER', THUNDER:'WATER' };
  const ELEM_LIGHT_DARK = { LIGHT:'DARK', DARK:'LIGHT' };
  function elementMultiplier(attackerElem, defenderElem){
    if(!attackerElem || attackerElem===ELEM.NEUTRAL || !defenderElem || defenderElem===ELEM.NEUTRAL) return 1.0;
    if(ELEM_ADV[attackerElem] === defenderElem) return 1.5;
    if(ELEM_ADV[defenderElem] === attackerElem) return 0.75;
    if(ELEM_LIGHT_DARK[attackerElem] === defenderElem) return 1.5;
    if(ELEM_LIGHT_DARK[defenderElem] === attackerElem) return 0.75;
    return 1.0;
  }

  const DEFAULT = {
    player:{
      name:'ç„¡åæ•£ä¿®', level:1, exp:0, nextExp:100,
      hp:120, mp:60, element:ELEM.NEUTRAL,
      currencies:{stone:200, diamond:10, gold:0},
      statPoints:0,
      attrs:{ STR:5, AGI:5, VIT:6, INT:5, PER:5, WIL:5, LUK:5, SPD:5, MET:3, WOO:3, WAT:3, FIR:3,
        ELG:1, ELW:1, ELF:1, ELE:1, ELI:1, ELT:1 },
      equip:{weapon:null, cloak:null, shoes:null, medals:[null,null,null], rings:[null,null], reserved:[null,null,null]},
      avatar:'', effects:{guard:false}
    },
    inventory:[],
    shop:[],
    meta:{version:'1.3.0'}
  };

  // ===== è£å‚™å®šç¾© =====
  function equipItem({ id, slot, atk=0, wil=0, spd=0, luk=0, all=0, desc='', rarity='common', elem=ELEM.NEUTRAL, hit=95, crit=0, speedMul=1.0, dur=999, icon=null }){
    return {id,type:'equip',slot,atk,wil,spd,luk,all,desc,rarity, elem, hit, crit, speedMul, dur, price:{stone:120}, icon};
  }
  function elemLabel(e){
    return {NEUTRAL:'ç„¡', WATER:'æ°´', FIRE:'ç«', GRASS:'æœ¨', EARTH:'åœŸ', ICE:'å†°', THUNDER:'é›·', LIGHT:'è–', DARK:'æš—'}[e]||'ç„¡';
  }
  function rarityLabel(r){ return {common:'æ™®é€š',rare:'ç¨€æœ‰',epic:'ç½•è¦‹',legend:'å‚³èªª',mythic:'ç¥è©±',relic:'éºç‰©'}[r]||'æ™®é€š'; }
  function rarityClass(r){ return 'rarity-'+(r||'common'); }
  function equipStatsText(def){
    if(!def || def.type!=='equip') return '';
    const parts=[];
    if(def.atk) parts.push(`æ”»æ“Š+${def.atk}`);
    if(def.wil) parts.push(`æ„å¿—+${def.wil}`);
    if(def.spd) parts.push(`é€Ÿåº¦+${def.spd}`);
    if(def.luk) parts.push(`å¹¸é‹+${def.luk}`);
    if(def.all) parts.push(`å…¨å±¬æ€§+${def.all}`);
    if(def.hit!=null) parts.push(`å‘½ä¸­${def.hit}%`);
    if(def.crit) parts.push(`çˆ†æ“Š+${def.crit}%`);
    if(def.speedMul && def.speedMul!==1.0) parts.push(`è¡Œå‹•æ¢x${def.speedMul}`);
    parts.push(`å…ƒç´ ï¼š${elemLabel(def.elem||ELEM.NEUTRAL)}`);
    parts.push(`ç¨€æœ‰åº¦ï¼š${rarityLabel(def.rarity||'common')}`);
    return parts.join('ï½œ');
  }

  // ---------------- Items & Shop Seedsï¼ˆå«åœ–ç¤ºï¼‰ ----------------
  const ITEMS = {
    // æˆ°é¬¥ä¸¹è—¥
    'å°è¡€ä¸¹': {id:'A001', type:'potion', icon:"https://i.ibb.co/Hfxz9394/image.png", desc:'æ°£è¡€å›å¾©60é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 15s', useInCombat:true, useOutCombat:false, cd:15,
      effect:(ctx)=>healFlat(ctx,'hp',20), price:{stone:50}},
    'åˆè¡€ä¸¹': {id:'A002', type:'potion', icon:"https://i.ibb.co/Nd71zTVQ/image.png", desc:'æ°£è¡€å›å¾©120é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 13s', useInCombat:true, useOutCombat:false, cd:13,
      effect:(ctx)=>healFlat(ctx,'hp',40), price:{stone:120}},
    'ä¸­è¡€ä¸¹': {id:'A003', type:'potion', icon:"https://i.ibb.co/hxqHhB8M/image.png", desc:'æ°£è¡€å›å¾©180é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 13s', useInCombat:true, useOutCombat:false, cd:13,
      effect:(ctx)=>healFlat(ctx,'hp',60), price:{stone:260}},
    'å¤§è¡€ä¸¹': {id:'A004', type:'potion', icon:"https://i.ibb.co/TMsHqmNX/image.png", desc:'æ°£è¡€å›å¾©240é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 13s', useInCombat:true, useOutCombat:false, cd:13,
      effect:(ctx)=>healFlat(ctx,'hp',80), price:{stone:550}},
    'æ°£è¡€ä¸¹': {id:'A005', type:'potion', icon:ICON.potion, desc:'æ°£è¡€å›å¾©100é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 11s', useInCombat:true, useOutCombat:false, cd:11,
      effect:(ctx)=>healFlat(ctx,'hp',100), price:{stone:300}},
    'è£œè¡€ä¸¹': {id:'A006', type:'potion', icon:ICON.potion, desc:'æ°£è¡€å›å¾©120é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 11s', useInCombat:true, useOutCombat:false, cd:11,
      effect:(ctx)=>healFlat(ctx,'hp',120), price:{stone:350}},
    'å›è¡€ä¸¹': {id:'A007', type:'potion', icon:ICON.potion, desc:'æ°£è¡€å›å¾©140é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 10s', useInCombat:true, useOutCombat:false, cd:10,
      effect:(ctx)=>healFlat(ctx,'hp',140), price:{stone:400}},
    'å¾©è¡€ä¸¹': {id:'A008', type:'potion', icon:ICON.potion, desc:'æ°£è¡€å›å¾©160é»ï¼ˆæˆ°é¬¥é™å®šï¼‰CD 10s', useInCombat:true, useOutCombat:false, cd:10,
      effect:(ctx)=>healFlat(ctx,'hp',160), price:{stone:450}},

    // éæˆ°é¬¥å›å¾©
    'è¡€ç“¶':   {id:'AA01', type:'consumable', icon:ICON.potion, desc:'æ°£è¡€å›å¾©40é»ï¼ˆéæˆ°é¬¥é™å®šï¼‰', useInCombat:false, useOutCombat:true,
      effect:(ctx)=>healFlat(ctx,'hp',40), price:{stone:50}},
    'è—¥è†':   {id:'AA02', type:'consumable', icon:ICON.potion, desc:'æ°£è¡€å›å¾©80é»ï¼ˆéæˆ°é¬¥é™å®šï¼‰', useInCombat:false, useOutCombat:true,
      effect:(ctx)=>healFlat(ctx,'hp',80), price:{stone:100}},
    'è¶…ç´šè¡€ç“¶': {id:'AA03', type:'consumable', icon:ICON.potion, desc:'æ°£è¡€å›å¾©120é»ï¼ˆéæˆ°é¬¥é™å®šï¼‰', useInCombat:false, useOutCombat:true,
      effect:(ctx)=>healFlat(ctx,'hp',120), price:{stone:150}},
    'æ¥µæ•ˆè¡€ç“¶': {id:'AA04', type:'consumable', icon:ICON.potion, desc:'æ°£è¡€å›å¾©160é»ï¼ˆéæˆ°é¬¥é™å®šï¼‰', useInCombat:false, useOutCombat:true,
      effect:(ctx)=>healFlat(ctx,'hp',160), price:{stone:200}},
    'è‡³å°Šè¡€ç“¶': {id:'AA05', type:'consumable', icon:ICON.potion, desc:'æ°£è¡€å›å¾©200é»ï¼ˆéæˆ°é¬¥é™å®šï¼‰', useInCombat:false, useOutCombat:true,
      effect:(ctx)=>healFlat(ctx,'hp',200), price:{stone:250}},

    // è£å‚™ï¼ˆåœ–ç¤º + æ•¸å€¼ï¼‰
    'æ™®é€šçš„æœ¨åŠ': equipItem({ id:'BA001',  slot:'weapon', icon:ICON.sword, atk:5,  desc:'æ™®é€šç™½å­—', rarity:'common', elem:ELEM.NEUTRAL, hit:85, crit:5,  speedMul:0.8, dur:50 }),
    'ç¨€æœ‰çš„æœ¨åŠ': equipItem({ id:'BA0011', slot:'weapon', icon:ICON.sword, atk:8,  desc:'ç¨€æœ‰ç¶ å­—', rarity:'rare',   elem:ELEM.NEUTRAL, hit:85, crit:5,  speedMul:0.8, dur:60 }),
    'ç½•è¦‹çš„æœ¨åŠ': equipItem({ id:'BA0012', slot:'weapon', icon:ICON.sword, atk:10, desc:'ç½•è¦‹è—å­—ï½œåœŸå±¬æ€§æ”»æ“Š+5', rarity:'epic', elem:ELEM.EARTH, hit:85, crit:5, speedMul:0.8, dur:80 }),
    'æ™®é€šæœ¨åŒ•é¦–': equipItem({ id:'BA002',  slot:'weapon', icon:ICON.dagger, atk:2,  desc:'æ™®é€šç™½å­—', rarity:'common', elem:ELEM.NEUTRAL, hit:70, crit:15, speedMul:1.0, dur:50 }),
    'ç¨€æœ‰æœ¨åŒ•é¦–': equipItem({ id:'BA0021', slot:'weapon', icon:ICON.dagger, atk:2,  desc:'ç¨€æœ‰ç¶ å­—', rarity:'rare',   elem:ELEM.NEUTRAL, hit:70, crit:15, speedMul:1.0, dur:60 }),
    'ç½•è¦‹æœ¨åŒ•é¦–': equipItem({ id:'BA0022', slot:'weapon', icon:ICON.dagger, atk:2,  desc:'ç½•è¦‹è—å­—ï½œæœ¨å±¬æ€§æ”»æ“Š+5', rarity:'epic', elem:ELEM.GRASS,  hit:80, crit:15, speedMul:1.0, dur:85 }),
    'é›²æŠ«é¢¨':   equipItem({id:'cl_cloud', slot:'cloak', icon:ICON.cloak, wil:4, desc:'æ„å¿—+4',  rarity:'rare'}),
    'æœ¨é´':     equipItem({id:'sh_wood',  slot:'shoes', icon:ICON.boots, spd:4, desc:'é€Ÿåº¦+4',  rarity:'common'}),
    'é’éŠ…å‹³ç« ': equipItem({id:'md_bronze',slot:'medal', icon:ICON.medal, all:2, desc:'å…¨å±¬æ€§+2',rarity:'rare'}),
    'éŠ€æˆ’':     equipItem({id:'rg_silver',slot:'ring',  icon:ICON.ring,  luk:3, desc:'å¹¸é‹+3',  rarity:'epic'}),

    // åŠŸèƒ½/ä»»å‹™/ææ–™
    'ä¿®ç…‰ç¶“æ›¸': {id:'exp_book', type:'consumable', icon:ICON.book, desc:'ç«‹å³ç²å¾— 50 EXPï¼ˆéæˆ°é¬¥ï¼‰',
      useInCombat:false, useOutCombat:true, effect:(ctx)=>addExp(50), price:{stone:120}},
    'å›åŸç¬¦': {id:'town_scroll', type:'other', icon:ICON.scroll, desc:'é›¢é–‹å±éšªåœ°å¸¶å›åˆ°ä¸»é ï¼ˆéæˆ°é¬¥ï¼‰',
      useInCombat:false, useOutCombat:true, effect:(ctx)=>goto('home'), price:{diamond:1}},
    'ç¸éª¨': {id:'mat_bone', type:'material', icon:ICON.bone, desc:'å¸¸è¦‹ææ–™ï¼Œå¯ç”¨æ–¼é›é€ æˆ–è²©å”®',
      useInCombat:false, useOutCombat:false, price:{stone:0}},
    'å²èŠå§†è† è³ª':     {id:'mat_slime',      type:'material', icon:ICON.potion, desc:'é»ç¨ çš„å²èŠå§†ç´ æ', useInCombat:false, useOutCombat:false, price:{stone:0}},
    'ç¶ å²èŠå§†è† è³ª':   {id:'mat_gslime',     type:'material', icon:ICON.potion, desc:'å¸¶æœ¨éˆæ°£æ¯çš„è† è³ª', useInCombat:false, useOutCombat:false, price:{stone:0}},
    'å“¥å¸ƒæ—è€³æœµ':     {id:'mat_gob_ear',    type:'material', icon:ICON.bone,   desc:'å¸¸è¦‹çš„è¨ä¼ç´ æ',   useInCombat:false, useOutCombat:false, price:{stone:0}},
    'éª¨é ­ç¢ç‰‡':       {id:'mat_bone_frag',  type:'material', icon:ICON.bone,   desc:'éª·é«èº«ä¸Šæ‰è½çš„ç¢ç‰‡', useInCombat:false, useOutCombat:false, price:{stone:0}},
    'é£Ÿäººé­”ç‰™':       {id:'mat_ogre_tooth', type:'material', icon:ICON.bone,   desc:'éŠ³åˆ©çš„ç‰™é½’',       useInCombat:false, useOutCombat:false, price:{stone:0}},
    'å·¨é­”çš®':         {id:'mat_troll_hide', type:'material', icon:ICON.chest,  desc:'åšå¯¦çš„çš®é©',       useInCombat:false, useOutCombat:false, price:{stone:0}},
    'è›‡é±—':           {id:'mat_snake_scale',type:'material', icon:ICON.chest,  desc:'é£›è›‡çš„é±—ç‰‡',       useInCombat:false, useOutCombat:false, price:{stone:0}},
    'çŸ³åƒä¹‹ç¿¼':       {id:'mat_garg_wing',  type:'material', icon:ICON.chest,  desc:'æ²‰é‡çš„çŸ³ç¿¼',       useInCombat:false, useOutCombat:false, price:{stone:0}},
    'ç«é¾é±—ç‰‡':       {id:'mat_dragon_scale',type:'material',icon:ICON.chest,  desc:'å¸¶ç«æ°£çš„é±—ç‰‡',     useInCombat:false, useOutCombat:false, price:{stone:0}},
    // æ‰è½è£å‚™
    'é‡è »äººä¹‹æ–§': equipItem({
      id:'axe_barbarian', slot:'weapon', icon:ICON.sword,
      atk:14, desc:'æ²‰é‡çš„å¤§æ–§', rarity:'epic',
      elem:ELEM.NEUTRAL, hit:80, crit:8, speedMul:0.9, dur:120
    }),

  };

  const SHOP_STOCK = [
    {name:'å°è¡€ä¸¹', qty:10},{name:'åˆè¡€ä¸¹', qty:10},{name:'ä¸­è¡€ä¸¹', qty:10},{name:'å¤§è¡€ä¸¹', qty:8},
    {name:'æ°£è¡€ä¸¹', qty:6},{name:'è£œè¡€ä¸¹', qty:6},{name:'å›è¡€ä¸¹', qty:4},{name:'å¾©è¡€ä¸¹', qty:4},
    {name:'è¡€ç“¶', qty:10},{name:'è—¥è†', qty:8},{name:'è¶…ç´šè¡€ç“¶', qty:6},{name:'æ¥µæ•ˆè¡€ç“¶', qty:6},{name:'è‡³å°Šè¡€ç“¶', qty:4},
    {name:'æ™®é€šçš„æœ¨åŠ', qty:2},{name:'ç¨€æœ‰çš„æœ¨åŠ', qty:2},{name:'ç½•è¦‹çš„æœ¨åŠ', qty:1},
    {name:'æ™®é€šæœ¨åŒ•é¦–', qty:2},{name:'ç¨€æœ‰æœ¨åŒ•é¦–', qty:2},{name:'ç½•è¦‹æœ¨åŒ•é¦–', qty:1},
    {name:'é›²æŠ«é¢¨', qty:1},{name:'æœ¨é´', qty:1},{name:'é’éŠ…å‹³ç« ', qty:2},{name:'éŠ€æˆ’', qty:2}
  ];

  // ---------------- State ----------------
  let state = null;
  const KEY='xiuxianRPG_v1';
  function persistLocal(){
  try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch{}
  }


  function init(){
    const saved = localStorage.getItem(KEY);
    if(saved){
      try{ state = JSON.parse(saved); }catch{ state = structuredClone(DEFAULT); }
    } else { state = structuredClone(DEFAULT); }
    if(!state.shop || !state.shop.length){ state.shop = SHOP_STOCK.map(s=>({...s})); }
    if(!state.inventory || !state.inventory.length){
      addItem('å°è¡€ä¸¹',3); addItem('è¡€ç“¶',2); addItem('ä¿®ç…‰ç¶“æ›¸',1);
    }
    renderAll(); bindUI();
  }

  // å„²å­˜éŠæˆ²ç‹€æ…‹åˆ° Firebase
function save() {
  if (!userId) {
    loginFirst(() => save());
    return;
  }
  
  db.ref(`users/${userId}/gameState`).set(state)
    .then(() => { persistLocal(); toast('å·²å„²å­˜åˆ°é›²ç«¯'); })
    .catch(error => toast('å„²å­˜å¤±æ•—: ' + error.message));
}

// å¾ Firebase è®€å–éŠæˆ²ç‹€æ…‹
function load() {
  if (!userId) {
    loginFirst(() => load());
    return;
  }
  
  db.ref(`users/${userId}/gameState`).once('value')
    .then(snapshot => {
      if (snapshot.exists()) {
        state = snapshot.val();
        renderAll();
        persistLocal();
        toast('å·²å¾é›²ç«¯è®€å–');
      } else {
        toast('æ‰¾ä¸åˆ°å­˜æª”');
      }
    })
    .catch(error => toast('è®€å–å¤±æ•—: ' + error.message));
}

// é‡ç½®éŠæˆ²ç‹€æ…‹ä¸¦æ¸…é™¤ Firebase å­˜æª”
function reset() {
  if (confirm('ç¢ºå®šè¦é‡ç½®ï¼Ÿå°‡æ¸…ç©ºå­˜æª”ã€‚')) {
    if (!userId) {
      loginFirst(() => reset());
      return;
    }
    
    state = structuredClone(DEFAULT);
    state.shop = SHOP_STOCK.map(s => ({ ...s }));
    state.inventory = [];
    addItem('å°è¡€ä¸¹', 3);
    addItem('è¡€ç“¶', 2);
    addItem('ä¿®ç…‰ç¶“æ›¸', 1);
    
    db.ref(`users/${userId}/gameState`).remove()
      .then(() => {
        renderAll();
        persistLocal();
        toast('å·²é‡ç½®ä¸¦æ¸…é™¤é›²ç«¯å­˜æª”');
      })
      .catch(error => toast('é‡ç½®å¤±æ•—: ' + error.message));
  }
}

  // --- è‡ªå‹•å­˜æª”æ ¸å¿ƒï¼ˆå»æŠ– + é›¢é–‹å‰å¼·åˆ¶ï¼‰ ---
  let dirty = false;
  let lastSavedHash = '';

  function markDirty(){ dirty = true; persistLocal(); }
  markDirty();


  function stateHash(){
    try { return JSON.stringify(state); } catch { return String(Math.random()); }
  }

  function saveDebounced(force=false){
    if (!userId) { loginFirst(() => saveDebounced(force)); return; }
    if (!force && !dirty) return;

    const h = stateHash();
    if (!force && h === lastSavedHash) { dirty = false; return; }

    db.ref(`users/${userId}/gameState`).set(state)
      .then(() => { lastSavedHash = h; dirty = false; })
      .catch(err => toast('è‡ªå‹•å­˜æª”å¤±æ•—ï¼š' + err.message));
  }

  // æ¯ 8 ç§’è©¦ä¸€æ¬¡ï¼ˆæœ‰è®Šæ›´æ‰æœƒå¯«ï¼‰
  setInterval(() => {
    if (navigator.onLine) saveDebounced(false);
  }, 8000);

  // è¦–çª—è¢«éš±è—/é—œé–‰æ™‚å¼·åˆ¶å­˜
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') saveDebounced(true);
  });
  window.addEventListener('beforeunload', () => { saveDebounced(true); });



  // ---------------- Attr & Derived ----------------
  function sumEquip(){
    const e = state.player.equip;
    const pack = [e.weapon,e.cloak,e.shoes, ...e.medals, ...e.rings, ...e.reserved].filter(Boolean);
    const add = {STR:0,AGI:0,VIT:0,INT:0,PER:0,WIL:0,LUK:0,SPD:0,MET:0,WOO:0,WAT:0,FIR:0, ELG:0,ELW:0,ELF:0,ELE:0,ELI:0,ELT:0};
    let w = e.weapon || null;
    let weapon = { elem: ELEM.NEUTRAL, hit:95, crit:0, speedMul:1.0, atkFlat:0, rarity:'common' };

    pack.forEach(it=>{
      if(it.all){Object.keys(add).forEach(k=>add[k]+=it.all)}
      if(it.atk) add.STR += Math.floor(it.atk/2);
      if(it.wil) add.WIL += it.wil;
      if(it.spd) add.SPD += it.spd;
      if(it.luk) add.LUK += it.luk;
    });

    if(w){
      weapon.elem = w.elem ?? ELEM.NEUTRAL;
      weapon.hit  = w.hit  ?? 95;
      weapon.crit = w.crit ?? 0;
      weapon.speedMul = w.speedMul ?? 1.0;
      weapon.atkFlat  = w.atk ?? 0;
      weapon.rarity   = w.rarity ?? 'common';
      weapon.icon     = w.icon ?? slotIconByKey.weapon;
    }
    return { ...add, weapon };
  }

  function derived(){
    const P = state.player;
    const A = P.attrs;
    const eq = sumEquip();
    const STR=A.STR+eq.STR, AGI=A.AGI+eq.AGI, VIT=A.VIT+eq.VIT, INT=A.INT+eq.INT,
          PER=A.PER+eq.PER, WIL=A.WIL+eq.WIL, LUK=A.LUK+eq.LUK, SPD=A.SPD+eq.SPD,
          MET=A.MET+eq.MET, WOO=A.WOO+eq.WOO, WAT=A.WAT+eq.WAT, FIR=A.FIR+eq.FIR,
          ELG=A.ELG+eq.ELG, ELW=A.ELW+eq.ELW, ELF=A.ELF+eq.ELF, ELE=A.ELE+eq.ELE, ELI=A.ELI+eq.ELI, ELT=A.ELT+eq.ELT;

    const hpMax = 100 + VIT*12 + WIL*2;
    const mpMax =  50 + INT*10 + WIL*4;

    const atk = 8 + STR*2 + Math.floor(MET*0.5) + (eq.weapon?.atkFlat || 0);
    const spdBase = 40 + SPD*3 + Math.floor(AGI*1.2);
    const spd = Math.max(10, Math.floor(spdBase * (eq.weapon?.speedMul || 1.0)));
    const crit = Math.min(70, (5 + Math.floor((PER+LUK)/3)) + (eq.weapon?.crit || 0));
    const def  = 4 + Math.floor(VIT*1.2) + Math.floor(WOO*0.5);
    const res  = Math.min(60, Math.floor((WIL+WAT)/2));

    return {hpMax, mpMax, atk, def, spd, crit, res,
      A:{STR,AGI,VIT,INT,PER,WIL,LUK,SPD,MET,WOO,WAT,FIR,ELG,ELW,ELF,ELE,ELI,ELT},
      weapon:eq.weapon
    };
  }

  function levelUp(){
  const P = state.player;
  while(P.exp >= P.nextExp){
    P.exp -= P.nextExp;
    P.level++;
    P.nextExp = Math.floor(P.nextExp*1.25)+25;

    P.attrs.STR+=1; P.attrs.AGI+=1; P.attrs.VIT+=2; P.attrs.INT+=1; P.attrs.WIL+=1; P.attrs.SPD+=1;

    const D2 = derived();
    P.statPoints = (P.statPoints||0) + 5;
    P.hp = D2.hpMax;
    P.mp = D2.mpMax;

    toast(`å‡ç´šè‡³ Lv.${P.level}ï¼ç²å¾—èƒ½åŠ›é» +5`);
    log(`å‡ç´šè‡³ Lv.${P.level}ï¼å±¬æ€§æå‡ï¼Œç²å¾—èƒ½åŠ›é»+5ï¼Œæ°£è¡€èˆ‡çœŸå…ƒå›æ»¿ã€‚`);

    markDirty();
    renderTop(); renderAttrs(); renderBattleBars();
  }
}

  function addExp(v){
  state.player.exp += v;
  levelUp();
  markDirty();
  renderTop(); renderAttrs();
}

  function healFlat(ctx, key, v){
    const D=derived();
    const max = key==='hp'?D.hpMax:D.mpMax;
    ctx[key] = clamp(ctx[key] + v, 0, max);
    renderBattleBars(); renderTop();
  }

  function normalizeHPMP(){
  const D = derived();
  state.player.hp = clamp(state.player.hp, 0, D.hpMax);
  state.player.mp = clamp(state.player.mp, 0, D.mpMax);
  }


  // ---------------- Inventory ----------------
  function addItem(name, qty=1, payload){
  const it = state.inventory.find(i=>i.name===name && (!payload || JSON.stringify(i.payload)===JSON.stringify(payload)) );
  if(it){ it.qty+=qty; }
  else{ state.inventory.push({name, qty, payload:null}); }
  markDirty();
  }
  function removeItem(name, qty=1){
  const idx = state.inventory.findIndex(i=>i.name===name);
  if(idx>=0){
    state.inventory[idx].qty -= qty;
    if(state.inventory[idx].qty<=0) state.inventory.splice(idx,1);
    markDirty();
  }
}
  function findItemDef(name){ return ITEMS[name]; }

  // ---------------- å±¬æ€§/åŠ é»ï¼ˆå…©æ¬„é¡¯ç¤ºï¼Œå»é™¤é‡‘æœ¨æ°´ç«ï¼‰ ----------------
  function attrTips(key){
    const map={
      STR:'åŠ›é‡ï¼šæå‡æ”»æ“ŠåŠ›', AGI:'æ•æ·ï¼šæå‡è¡Œå‹•æ•ˆç‡', VIT:'é«”è³ªï¼šæå‡æœ€å¤§HPèˆ‡é˜²ç¦¦', INT:'æ™ºæ…§ï¼šæå‡æœ€å¤§MPèˆ‡è¡“æ³•æ•ˆæœ',
      PER:'æ„ŸçŸ¥ï¼šæå‡æš´æ“Šèˆ‡å‘½ä¸­', WIL:'æ„å¿—ï¼šæå‡æŠ—æ€§èˆ‡MPå›å¾©', LUK:'å¹¸é‹ï¼šæå‡æ‰è½èˆ‡æš´æ“Š', SPD:'é€Ÿåº¦ï¼šæ±ºå®šè¡Œå‹•æ¢å……èƒ½',
      ELG:'æœ¨éˆï¼šå…ƒç´ è¦ªå’Œï¼ˆæœ¨ï¼‰', ELW:'æ°´éˆï¼šå…ƒç´ è¦ªå’Œï¼ˆæ°´ï¼‰', ELF:'ç«éˆï¼šå…ƒç´ è¦ªå’Œï¼ˆç«ï¼‰',
      ELE:'åœŸéˆï¼šå…ƒç´ è¦ªå’Œï¼ˆåœŸï¼‰', ELI:'å†°éˆï¼šå…ƒç´ è¦ªå’Œï¼ˆå†°ï¼‰', ELT:'é›·éˆï¼šå…ƒç´ è¦ªå’Œï¼ˆé›·ï¼‰'
    };
    return map[key]||key;
  }
  function attrLabel(k){
    return {
      STR:'åŠ›é‡',AGI:'æ•æ·',VIT:'é«”è³ª',INT:'æ™ºæ…§',PER:'æ„ŸçŸ¥',WIL:'æ„å¿—',LUK:'å¹¸é‹',SPD:'é€Ÿåº¦',
      ELG:'æœ¨éˆ',ELW:'æ°´éˆ',ELF:'ç«éˆ',ELE:'åœŸéˆ',ELI:'å†°éˆ',ELT:'é›·éˆ'
    }[k]||k;
  }
  const DISPLAY_ATTRS_ORDER=['STR','AGI','VIT','INT','PER','WIL','LUK','SPD','ELG','ELW','ELF','ELE','ELI','ELT'];

  function addPoint(k){
  const P=state.player;
  if((P.statPoints||0)<=0) return toast('æ²’æœ‰å¯åˆ†é…é»æ•¸');
  P.attrs[k] = (P.attrs[k]||0)+1;
  P.statPoints-=1;
  normalizeHPMP();
  markDirty();
  renderTop(); renderAttrs(); renderBattleBars();
  }


  function renderAttrs(){
  const box = $('#attrList'); box.innerHTML='';
  const D=derived(); const A=D.A;
  DISPLAY_ATTRS_ORDER.forEach(k=>{
    const row=document.createElement('div');
    row.className='stat';
    row.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <span>${attrLabel(k)}</span>
      <span class="attr-right">
        <small class="val">${Number.isFinite(A[k]) ? A[k] : 0}</small>
        <small class="attr-desc muted">${attrTips(k)}</small>
        ${(state.player.statPoints>0)?`<button class="add" data-add="${k}">ï¼‹</button>`:''}
      </span>
    </div>
  `;

    box.appendChild(row);
  });
  $$('#attrList .add').forEach(btn=>{ btn.onclick = ()=> addPoint(btn.dataset.add); });
}

  // ---------------- UI Renders ----------------
  function setAvatar(imgEl, url){ if(!imgEl) return; if(url){ imgEl.src=url; } else { imgEl.removeAttribute('src'); } }

  function renderTop(){
    const P = state.player, D=derived();
    $('#uiLevel').textContent = P.level;
    $('#uiExp').textContent = `${fmt(P.exp)}/${fmt(P.nextExp)}`;
    $('#uiStone').textContent = fmt(P.currencies.stone);
    $('#uiDiamond').textContent = fmt(P.currencies.diamond);
    $('#uiGold').textContent = fmt(P.currencies.gold||0);
    $('#uiPts').textContent = fmt(P.statPoints||0);
    $('#uiExpBar').style.width = clamp(P.exp / P.nextExp * 100,0,100) + '%';
    $('#playerLv2').textContent = P.level;

    setAvatar($('#homeAvatar'), state.player.avatar);
    $('#homePlayerName').textContent = state.player.name || 'ç„¡åæ•£ä¿®';
    $('#homePlayerLv').textContent = P.level;

    const hpRatio = clamp(state.player.hp / D.hpMax * 100, 0, 100);
    const mpRatio = clamp(state.player.mp / D.mpMax * 100, 0, 100);
    $('#homeHpBar').style.width = hpRatio+'%';
    $('#homeMpBar').style.width = mpRatio+'%';
    const _hpMax = Number.isFinite(D.hpMax) ? D.hpMax : 0;
    const _mpMax = Number.isFinite(D.mpMax) ? D.mpMax : 0;
    const _hpCur = Number.isFinite(state.player.hp) ? state.player.hp : 0;
    const _mpCur = Number.isFinite(state.player.mp) ? state.player.mp : 0;
    $('#homeHpText').textContent = `HP ${fmt(_hpCur)}/${fmt(_hpMax)}`;
    $('#homeMpText').textContent = `MP ${fmt(_mpCur)}/${fmt(_mpMax)}`;
  }

  function cardIconHTML(src){ return `<div class="icon"><img src="${src||ICON.slot}" alt="icon"/></div>`; }

  function renderBag(filter='all'){
    const list = $('#bagList'); list.innerHTML='';
    state.inventory.forEach(it=>{
      const def=findItemDef(it.name); if(!def) return;
      if(filter!=='all' && def.type!==filter) return;
      const card=document.createElement('div'); card.className='card';
      if(def.type==='equip'){ card.classList.add(rarityClass(def.rarity)); }
      const detail = def.type==='equip' ? equipStatsText(def) : def.desc;
      card.innerHTML=`${cardIconHTML(def.icon || slotIconByKey[def.slot] || ICON.potion)}
        <div class="grow">
          <div><strong class="equip-name">${it.name}</strong> <span class="tag">x${it.qty}</span></div>
          <div class="small muted">${detail}${def.desc && def.type==='equip'?'ï½œ'+def.desc:''}</div>
        </div>
        <div style="display:flex;gap:6px">
          ${def.type==='equip'?'<button class="btn small" data-equip>è£å‚™</button>':''}
          ${(def.useInCombat||def.useOutCombat)?'<button class="btn ghost small" data-use>ä½¿ç”¨</button>':''}
          <button class="btn ghost small" data-drop>ä¸Ÿæ£„</button>
        </div>`;
      card.querySelector('[data-drop]').onclick=()=>{ if(confirm('ä¸Ÿæ£„ 1 å€‹ï¼Ÿ')){ removeItem(it.name,1); renderBag(filter);} };
      if(card.querySelector('[data-use]')) card.querySelector('[data-use]').onclick=()=>useItemFromBag(it.name);
      if(card.querySelector('[data-equip]')) card.querySelector('[data-equip]').onclick=()=>equipFromBag(it.name);
      list.appendChild(card);
    });
  }

  function equipFromBag(name){
  const def = findItemDef(name); if(!def || def.type!=='equip') return;
  const slot = def.slot;
  const eq = state.player.equip;

  const getOld = ()=>{
    if(slot==='weapon') return eq.weapon;
    if(slot==='cloak')  return eq.cloak;
    if(slot==='shoes')  return eq.shoes;
    if(slot==='ring'){
      const i = eq.rings.findIndex(x=>!x);
      return i>=0 ? null : eq.rings[0];
    }
    if(slot==='medal'){
      const i = eq.medals.findIndex(x=>!x);
      return i>=0 ? null : eq.medals[0];
    }
    return null;
  };

  const put = (item)=>{
    if(slot==='weapon'){ eq.weapon = item; }
    else if(slot==='cloak'){ eq.cloak = item; }
    else if(slot==='shoes'){ eq.shoes = item; }
    else if(slot==='ring'){
      const i = eq.rings.findIndex(x=>!x);
      if(i>=0) eq.rings[i] = item;
      else { addItem(eq.rings[0].name,1); eq.rings[0] = item; }
    } else if(slot==='medal'){
      const i = eq.medals.findIndex(x=>!x);
      if(i>=0) eq.medals[i] = item;
      else { addItem(eq.medals[0].name,1); eq.medals[0] = item; }
    }
  };

  const oldItem = getOld();
  if(oldItem && (slot==='weapon' || slot==='cloak' || slot==='shoes')){
    addItem(oldItem.name, 1);
  }

  removeItem(name,1);
  put({name, ...def});

  toast('å·²è£å‚™ï¼š'+name);
  normalizeHPMP();
  markDirty();
  renderEquip(); renderTop(); renderAttrs(); renderBattleBars(); renderBag(currentFilter);
}

  function openEquipInfoModal(slotKey, slotIdx){
  const e=state.player.equip;
  let val=null;
  if(slotKey==='weapon') val=e.weapon;
  else if(slotKey==='cloak') val=e.cloak;
  else if(slotKey==='shoes') val=e.shoes;
  else if(slotKey==='ring') val=e.rings[slotIdx];
  else if(slotKey==='medal') val=e.medals[slotIdx];
  else if(slotKey==='reserved') val=e.reserved[slotIdx];

  const body=$('#equipInfoBody');
  const title=$('#equipInfoTitle');
  const btnUn=$('#equipInfoUnequip');

  if(val){
    title.textContent = val.name+'ï½œ'+(rarityLabel(val.rarity||'common'));
    btnUn.style.display='inline-block';
    btnUn.onclick=()=>{
      addItem(val.name,1);
      if(slotKey==='weapon') e.weapon=null;
      else if(slotKey==='cloak') e.cloak=null;
      else if(slotKey==='shoes') e.shoes=null;
      else if(slotKey==='ring') e.rings[slotIdx]=null;
      else if(slotKey==='medal') e.medals[slotIdx]=null;
      else if(slotKey==='reserved') e.reserved[slotIdx]=null;
      normalizeHPMP();
      markDirty();
      closeEquipInfoModal();
      renderEquip(); renderTop(); renderAttrs(); renderBattleBars();
      renderBag(currentFilter);
    };
    body.innerHTML = `
      <div class="card ${rarityClass(val.rarity)}" style="align-items:flex-start">
        ${cardIconHTML(val.icon || slotIconByKey[val.slot])}
        <div class="grow">
          <div><strong class="equip-name">${val.name}</strong></div>
          <div class="small muted" style="margin-top:4px">${val.desc||''}</div>
          <hr style="border-color:rgba(255,255,255,.06);margin:8px 0"/>
          <div class="small">
            <div>${equipStatsText(val)}</div>
          </div>
        </div>
      </div>`;
  }else{
    title.textContent='è£å‚™è©³æƒ…';
    btnUn.style.display='none';
    body.innerHTML = `<div class="center muted small" style="padding:12px">æ­¤æ§½ä½ç›®å‰æœªè£å‚™</div>`;
  }
  $('#equipInfoModal').style.display='grid';
}

  function closeEquipInfoModal(){ $('#equipInfoModal').style.display='none'; }

  function renderEquip(){
    const box=$('#equipSlots'); box.innerHTML='';
    const e=state.player.equip;
    const slots=[
      {key:'weapon', label:'æ­¦å™¨', val:e.weapon},
      {key:'cloak', label:'æŠ«é¢¨', val:e.cloak},
      {key:'shoes', label:'é‹å­', val:e.shoes},
      {key:'medal', label:'å‹³ç« 1', val:e.medals[0], idx:0},
      {key:'medal', label:'å‹³ç« 2', val:e.medals[1], idx:1},
      {key:'medal', label:'å‹³ç« 3', val:e.medals[2], idx:2},
      {key:'ring', label:'æˆ’æŒ‡1', val:e.rings[0], idx:0},
      {key:'ring', label:'æˆ’æŒ‡2', val:e.rings[1], idx:1},
      {key:'reserved', label:'å¾…é–‹ç™¼1', val:e.reserved[0], idx:0},
      {key:'reserved', label:'å¾…é–‹ç™¼2', val:e.reserved[1], idx:1},
      {key:'reserved', label:'å¾…é–‹ç™¼3', val:e.reserved[2], idx:2}
    ];
    slots.forEach(s=>{
      const card=document.createElement('div'); card.className='slot';
      if(s.val && s.val.type==='equip'){ card.classList.add(rarityClass(s.val.rarity)); }
      const iconSrc = (s.val && (s.val.icon || slotIconByKey[s.val.slot])) || slotIconByKey[s.key] || ICON.slot;
      card.innerHTML=`
        ${cardIconHTML(iconSrc)}
        <div class="meta">
          <div class="label">${s.label}</div>
          <div class="name">${s.val? `<span class="equip-name">${s.val.name}</span>` : 'â€”'}</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:6px">
          ${s.val?'<button class="btn ghost small" data-unequip>å¸ä¸‹</button>':''}
        </div>`;
      card.onclick=()=>openEquipInfoModal(s.key, s.idx??0);
      if(s.val) card.querySelector('[data-unequip]').onclick=(ev)=>{
      ev.stopPropagation();
      addItem(s.val.name,1);
      if(s.key==='weapon') e.weapon=null;
      else if(s.key==='cloak') e.cloak=null;
      else if(s.key==='shoes') e.shoes=null;
      else if(s.key==='ring') e.rings[s.idx]=null;
      else if(s.key==='medal') e.medals[s.idx]=null;
      else if(s.key==='reserved') e.reserved[s.idx]=null;
      normalizeHPMP();
      markDirty();
      renderEquip(); renderTop(); renderAttrs(); renderBattleBars();
      renderBag(currentFilter);
    };

      box.appendChild(card);
    });

    // å¯è£å‚™åˆ—è¡¨
    const inv=$('#equipInventory'); inv.innerHTML='';
    state.inventory.filter(i=>findItemDef(i.name)?.type==='equip').forEach(it=>{
      const def=findItemDef(it.name);
      const card=document.createElement('div'); card.className='card '+rarityClass(def.rarity);
      card.innerHTML=`
        ${cardIconHTML(def.icon || slotIconByKey[def.slot])}
        <div class="grow">
          <div><strong class="equip-name">${it.name}</strong> <span class="tag">x${it.qty}</span></div>
          <div class="small muted">${equipStatsText(def)}${def.desc?'ï½œ'+def.desc:''}</div>
        </div>
        <button class="btn small">è£å‚™</button>`;
      card.querySelector('button').onclick=()=>equipFromBag(it.name);
      inv.appendChild(card);
    });
  }

  function renderShop(){
  const list=$('#shopList'); list.innerHTML='';
  state.shop.forEach(item=>{
    const def=findItemDef(item.name); if(!def) return;
    if(shopFilter!=='all' && def.type!==shopFilter) return; // ä¾åˆ†é¡éæ¿¾
    const price = def.price?.diamond? `ğŸ’${def.price.diamond}` : `â¤${def.price?.stone||0}`;
    const card=document.createElement('div'); card.className='card';
    if(def.type==='equip'){ card.classList.add(rarityClass(def.rarity)); }
    card.innerHTML=`
      ${cardIconHTML(def.icon || slotIconByKey[def.slot] || ICON.potion)}
      <div class="grow">
        <div><strong class="equip-name">${item.name}</strong> <span class="tag">å‰©é¤˜ ${item.qty}</span></div>
        <div class="small muted">${def.type==='equip'?equipStatsText(def):def.desc}</div>
      </div>
      <div style="display:flex;gap:6px"><div class="chip">${price}</div><button class="btn small">è³¼è²·</button></div>`;
    card.querySelector('button').onclick=()=>buy(item.name);
    list.appendChild(card);
  });

  // æ›´æ–° active æ¨£å¼
  $$('[data-page="shop"] [data-shop]').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.shop===shopFilter);
  });
}

  function buy(name){
  const stock = state.shop.find(s=>s.name===name && s.qty>0); if(!stock) return toast('ç¼ºè²¨');
  const def=findItemDef(name); if(!def) return;
  const P=state.player;
  if(def.price?.diamond){
    if(P.currencies.diamond<def.price.diamond) return toast('é‘½çŸ³ä¸è¶³');
    P.currencies.diamond -= def.price.diamond;
  } else {
    const c = def.price?.stone||0; if(P.currencies.stone<c) return toast('éˆçŸ³ä¸è¶³');
    P.currencies.stone -= c;
  }
  stock.qty--; addItem(name,1);
  markDirty();
  renderTop(); renderBag(currentFilter); renderShop();
  toast('å·²è³¼è²·ï¼š'+name);
}

  // ---------------- Battle ----------------
  let battle = {
    in:false, enemy:null, timer:null, turn:'none', map:null,
    bars:{player:0, enemy:0}, startedAt:0, cooldowns:{}
  };

// === æ€ªç‰©è³‡æ–™åº«ï¼ˆå®Œå…¨ç”±æ•¸æ“šæ±ºå®šï¼Œä¸ä»¥ç©å®¶ç­‰ç´šç¸®æ”¾ï¼‰ ===
const MONSTER_DB = {
  slime: {
    id: 'slime', level: 1, name: 'æ°´èŠå§†', element: ELEM.WATER,
    base: {
      HP: 137, MP: 80,
      STR: 4,  AGI: 4,  VIT: 4,
      INT: 4,  PER: 4,  WIL: 4,
      LUK: 4,  SPD: 4
    },
    drops: [
      { item: 'å²èŠå§†è† è³ª', chance: 0.80, qty: [1, 1] },
      { stone: 10, chance: 1.0 }
    ],
    avatar: "https://i.ibb.co/qLL9g3w5/image.png"
  },
  g_slime: {
    id: 'g_slime', level: 2, name: 'ç¶ å²èŠå§†', element: ELEM.GRASS,
    base: {
      HP: 156, MP: 96,
      STR: 5,  AGI: 5,  VIT: 6,
      INT: 5,  PER: 4,  WIL: 5,
      LUK: 4,  SPD: 5
    },
    drops: [
      { item: 'ç¶ å²èŠå§†è† è³ª', chance: 0.70, qty: [1, 1] },
      { stone: 20, chance: 1.0 }
    ],
    avatar: ICON.enemy_wood
  },
  goblin: {
    id: 'goblin', level: 3, name: 'å“¥å¸ƒæ—', element: ELEM.NEUTRAL,
    base: {
      HP: 176, MP: 112,
      STR: 5,  AGI: 5,  VIT: 8,
      INT: 5,  PER: 4,  WIL: 5,
      LUK: 4,  SPD: 5
    },
    drops: [
      { item: 'å“¥å¸ƒæ—è€³æœµ', chance: 0.60, qty: [1, 1] },
      { stone: 30, chance: 1.0 }
    ],
    avatar: ICON.enemy_bandit
  },
  skeleton: {
    id: 'skeleton', level: 4, name: 'éª·é«', element: ELEM.NEUTRAL,
    base: {
      HP: 195, MP: 128,
      STR: 6,  AGI: 6,  VIT: 9,
      INT: 6,  PER: 4,  WIL: 6,
      LUK: 4,  SPD: 6
    },
    drops: [
      { item: 'éª¨é ­ç¢ç‰‡', chance: 0.60, qty: [1, 1] },
      { stone: 40, chance: 1.0 }
    ],
    avatar: ICON.enemy_bandit
  },
  orc: {
    id: 'orc', level: 5, name: 'åŠç¸äºº', element: ELEM.NEUTRAL,
    base: {
      HP: 214, MP: 144,
      STR: 7,  AGI: 7,  VIT: 11,
      INT: 7,  PER: 4,  WIL: 7,
      LUK: 4,  SPD: 7
    },
    drops: [
      { item: 'é‡è »äººä¹‹æ–§', chance: 0.50, qty: [1, 1] },
      { stone: 50, chance: 1.0 }
    ],
    avatar: ICON.enemy_bandit
  },
  ogre: {
    id: 'ogre', level: 6, name: 'é£Ÿäººé­”', element: ELEM.NEUTRAL,
    base: {
      HP: 233, MP: 160,
      STR: 8,  AGI: 8,  VIT: 12,
      INT: 8,  PER: 4,  WIL: 8,
      LUK: 4,  SPD: 8
    },
    drops: [
      { item: 'é£Ÿäººé­”ç‰™', chance: 0.50, qty: [1, 1] },
      { stone: 60, chance: 1.0 }
    ],
    avatar: ICON.enemy_bandit
  },
  troll: {
    id: 'troll', level: 7, name: 'å·¨é­”', element: ELEM.NEUTRAL,
    base: {
      HP: 252, MP: 176,
      STR: 8,  AGI: 8,  VIT: 14,
      INT: 8,  PER: 4,  WIL: 8,
      LUK: 4,  SPD: 8
    },
    drops: [
      { item: 'å·¨é­”çš®', chance: 0.40, qty: [1, 1] },
      { stone: 70, chance: 1.0 }
    ],
    avatar: ICON.enemy_bandit
  },
  wyvern: {
    id: 'wyvern', level: 8, name: 'é£›è›‡', element: ELEM.GRASS,
    base: {
      HP: 272, MP: 192,
      STR: 9,  AGI: 9,  VIT: 16,
      INT: 9,  PER: 4,  WIL: 9,
      LUK: 4,  SPD: 9
    },
    drops: [
      { item: 'è›‡é±—', chance: 0.40, qty: [1, 1] },
      { stone: 80, chance: 1.0 }
    ],
    avatar: ICON.enemy_wood
  },
  gargoyle: {
    id: 'gargoyle', level: 9, name: 'çŸ³åƒé¬¼', element: ELEM.EARTH,
    base: {
      HP: 291, MP: 208,
      STR: 10, AGI: 10, VIT: 17,
      INT: 10, PER: 4,  WIL: 10,
      LUK: 4,  SPD: 10
    },
    drops: [
      { item: 'çŸ³åƒä¹‹ç¿¼', chance: 0.30, qty: [1, 1] },
      { stone: 90, chance: 1.0 }
    ],
    avatar: ICON.enemy_bug
  },
  baby_dragon: {
    id: 'baby_dragon', level: 10, name: 'å°ç«é¾', element: ELEM.FIRE,
    base: {
      HP: 310, MP: 224,
      STR: 11, AGI: 11, VIT: 19,
      INT: 11, PER: 4,  WIL: 11,
      LUK: 4,  SPD: 11
    },
    drops: [
      { item: 'ç«é¾é±—ç‰‡', chance: 0.20, qty: [1, 1] },
      { stone: 100, chance: 1.0 }
    ],
    avatar: ICON.enemy_fire
  },
};

// ï¼ˆå¯èª¿ï¼‰å°‡ä½ å¡«çš„åŸå§‹æ•¸å­—è½‰ç‚ºæˆ°é¬¥ç”¨æ•¸å€¼çš„å€ç‡
const MONSTER_SCALER = { HP:1, MP:1, ATK:1, DEF:1, SPD:1 };

function makeEnemyFromTemplate(tpl){
  const hpMax = Math.floor(tpl.base.HP * MONSTER_SCALER.HP);
  const mpMax = Math.floor(tpl.base.MP * MONSTER_SCALER.MP);
  const atk   = Math.floor((tpl.base.STR) * MONSTER_SCALER.ATK);
  const def   = Math.floor((tpl.base.VIT) * MONSTER_SCALER.DEF);
  const spd   = Math.max(8, Math.floor(tpl.base.SPD * MONSTER_SCALER.SPD));
  return {
    id: tpl.id, name: tpl.name, level: tpl.level, element: tpl.element,
    hp:hpMax, hpMax, mp:mpMax, mpMax, atk, def, spd,
    avatar: tpl.avatar, drops: tpl.drops
  };
}

// åœ°åœ– â†’ æŒ‡å®šæœƒå‡ºç¾çš„ã€Œæ€ªç‰© IDã€
const MAPS = [
  {id:'forest', name:'é’æœ¨æ—', level:[1,6], enemies:['slime','g_slime','goblin','wyvern']},
  {id:'ember',  name:'çƒˆç„°ä¸˜', level:[3,9], enemies:['orc','ogre','skeleton','baby_dragon']},
  {id:'marsh',  name:'éœæ°´æ¾¤', level:[4,10], enemies:['g_slime','goblin','gargoyle','ogre']}
];

// ä¾åœ°åœ–éš¨æ©ŸæŒ‘é¸æ¨¡æ¿ â†’ å»ºç«‹æœ¬å ´æˆ°é¬¥ç”¨çš„æ•µäºº
function makeEnemy(){
  const pool = (battle.map ? MAPS.find(m=>m.id===battle.map)?.enemies : null) || Object.keys(MONSTER_DB);
  const id   = pool[rnd(0, pool.length-1)];
  return makeEnemyFromTemplate(MONSTER_DB[id]);
}

  function startBattle(){
    if(!battle.map){ openMapModal(); return; }
    battle.in = true;
    battle.enemy = makeEnemy();
    battle.bars.player = 0;
    battle.bars.enemy = rnd(0,40);
    battle.turn = 'none';
    battle.startedAt = nowMs();
    battle.cooldowns = {};

    $('#enemyLv').textContent = battle.enemy.level;
    setAvatar($('#enemyAvatar'), battle.enemy.avatar);
    setAvatar($('#playerAvatar'), state.player.avatar);

    $('#enemyHeaderTitle').textContent = battle.enemy.name;
    $('#enemyHeaderTitle').classList.add('title-xl');
    $('#turnHint').textContent = 'ç­‰å¾…è¡Œå‹•æ¢å¡«æ»¿...';

    toast('é­é‡ã€'+battle.enemy.name+'ã€ï¼');
    log('æ–¼ã€'+ (MAPS.find(m=>m.id===battle.map)?.name||'æœªçŸ¥åœ°å€') +'ã€é­é‡ '+battle.enemy.name+'ï¼');
    renderBattleBars();

    if(battle.timer) clearInterval(battle.timer);
    battle.timer = setInterval(tick, 120);
    showActions(false); // ä¸€é–‹å§‹å…ˆé–ä½ï¼Œç­‰è¡Œå‹•æ¢æ»¿æ‰è§£é–
  }

function endBattle(result){
  if(result === 'win'){
    const exp = 8 + (battle.enemy.level || 1) * 6;
    addExp(exp);
    const got = [];
    (battle.enemy.drops || []).forEach(d => {
      if(Math.random() <= (d.chance || 0)){
        const qty = Array.isArray(d.qty) ? rnd(d.qty[0], d.qty[1]) : (d.qty || 1);
        if(d.item){ addItem(d.item, qty); got.push(`${d.item} x${qty}`); }
        if(d.stone){
          state.player.currencies.stone = (state.player.currencies.stone || 0) + d.stone;
          got.push(`éˆçŸ³ ${d.stone}`);
        }
      }
    });
    log(`å‹åˆ©ï¼ç²å¾— EXP ${exp}${got.length ? 'ã€' + got.join('ã€') : ''}`);
    toast('å‹åˆ©ï¼' + (got.length ? 'ç²å¾— ' + got.join('ã€') : ''));
    const sum = `
      <div class="list">
        <div>ç²å¾— EXP ${exp}</div>
        ${got.map(g=>`<div>${g}</div>`).join('')}
      </div>`;
    openWinModal(sum);
    $('#enemyHeaderTitle').textContent = 'å·²æ‰“æ•—æ•µäºº';

  } else if(result === 'lose'){
    log('ä½ è¢«æ“Šæ•—äº†â€¦â€¦');
    toast('ä½ è¢«æ“Šæ•—äº†');
    $('#enemyHeaderTitle').textContent = 'æˆ°é¬¥å¤±æ•—';
    state.player.hp = Math.max(1, state.player.hp);
    renderTop();

  } else if(result === 'flee'){
    log('ä½ æˆåŠŸè„«æˆ°ã€‚');
    toast('å·²é€ƒé›¢æˆ°é¬¥');
    $('#enemyHeaderTitle').textContent = 'å·²è„«é›¢æˆ°é¬¥';
  }

  // çµ±ä¸€æ”¶å°¾
  battle.in = false;
  battle.turn = 'none';
  battle.enemy = null;

  if(battle.timer){
    clearInterval(battle.timer);
    battle.timer = null;
  }

  showActions(false);
  $('#turnHint').textContent = 'æˆ°é¬¥å·²çµæŸ';

  battle.bars.player = 0;
  battle.bars.enemy  = 0;
  renderActBars();

  setAvatar($('#enemyAvatar'), '');
  renderBattleBars();

  state.player.effects.guard = false;

  // â˜… ä»»ä½•çµç®—éƒ½æ¨™è¨˜å­˜æª”
  markDirty();
}


  function tick(){
    if(!battle.in) return;
    const D=derived();
    const pRate = D.spd/50;
    const eRate = battle.enemy.spd/60;
    if(battle.turn==='none'){
      battle.bars.player = clamp(battle.bars.player + pRate, 0, 100);
      battle.bars.enemy  = clamp(battle.bars.enemy + eRate, 0, 100);
      renderActBars();
      if(battle.bars.player>=100){ battle.turn='player'; $('#turnHint').textContent='è¼ªåˆ°ä½ è¡Œå‹•'; showActions(true); }
      else if(battle.bars.enemy>=100){ battle.turn='enemy'; $('#turnHint').textContent='æ•µäººè¡Œå‹•ä¸­'; showActions(false); enemyAct(); }
    }
  }

  function showActions(on){
    $('#battleActions').style.opacity = on?1:.5;
    Array.from($('#battleActions').children).forEach(b=>b.disabled=!on);
  }

  function rollHit(attacker){
    const D=derived();
    const acc = attacker===state.player ? (D.weapon?.hit ?? 95) : 90;
    return Math.random()*100 < acc;
  }

  function damage(from, to, attackerElem=ELEM.NEUTRAL, defenderElem=ELEM.NEUTRAL, toIsPlayer=false){
  const base = Math.max(1, from.atk - Math.floor(to.def*0.6));
  const variance = rnd(-2, 2);
  const D = derived();
  const critChance = (from===state.player) ? D.crit : 8;
  const crit = Math.random()*100 < critChance ? 1.6 : 1.0;

  let val = Math.max(1, Math.floor((base+variance)*crit));
  const mult = elementMultiplier(attackerElem, defenderElem);
  val = Math.max(1, Math.floor(val * mult));

  // ç”¨åƒæ•¸åˆ¤æ–·æ˜¯å¦å°ç©å®¶ç”Ÿæ•ˆï¼ˆä¸è¦ç”¨ç‰©ä»¶å…¨ç­‰ï¼‰
  if(toIsPlayer && state.player.effects.guard){
    val = Math.floor(val * 0.6);
    state.player.effects.guard = false;
  }

  return {val, crit:crit>1.0, mult};
}

  function endPlayerTurn(){ battle.bars.player=0; battle.turn='none'; $('#turnHint').textContent='ç­‰å¾…è¡Œå‹•æ¢å¡«æ»¿...'; }
  function endEnemyTurn(){ battle.bars.enemy=0; battle.turn='none'; $('#turnHint').textContent='ç­‰å¾…è¡Œå‹•æ¢å¡«æ»¿...'; }

  function playerStatsObj(){
    const D=derived();
    return {name:'å°‘ä¿ ', atk:D.atk, def:D.def, hp:state.player.hp, hpMax:D.hpMax, mp:state.player.mp, mpMax:D.mpMax};
  }

  function attackPlayer(){
    const foe = battle.enemy; const p=state.player; const D=derived();
    // å‘½ä¸­åˆ¤å®š
    if(Math.random()*100 >= 90){
      log(`${foe.name} æ”»æ“Šè½ç©ºï¼`);
      endEnemyTurn();
      return;
    }
    // è¨ˆç®—å‚·å®³
    const {val, crit, mult} = damage(foe, playerStatsObj(), foe.element, state.player.element, true);

    // æ‰£è¡€ã€æ›´æ–° UIã€é£„å­—
    p.hp = clamp(p.hp - val, 0, D.hpMax);
    renderBattleBars();
    floatText($('#playerAvatar'), `-${val}`, 'blue');

    // æˆ°å ±
    log(`${foe.name} å°ä½ é€ æˆ ${val} å‚·å®³${crit?'ï¼ˆæš´æ“Šï¼‰':''}${mult!==1?`ï¼ˆå…ƒç´ x${mult}ï¼‰`:''}`);

    // æ­»äº¡ or çµæŸæ•µæ–¹å›åˆ
    if(p.hp <= 0){
      endBattle('lose');
    }else{
      endEnemyTurn();
    }
  }

  function enemyAct(){ setTimeout(()=>{ if(!battle.in) return; attackPlayer(); }, 400); }

  function playerAttack(){
    if(battle.turn!=='player') return;
    const D=derived(), me=playerStatsObj(), foe=battle.enemy;
    if(!rollHit(state.player)){ log('ä½ æ”»æ“Šè½ç©ºï¼'); endPlayerTurn(); return; }
    const atkElem = D.weapon?.elem || ELEM.NEUTRAL;
    const {val, crit, mult} = damage(me, foe, atkElem, foe.element);
    foe.hp = clamp(foe.hp - val, 0, foe.hpMax);
    renderBattleBars();
    log(`ä½ é€ æˆ ${val} å‚·å®³${crit?'ï¼ˆæš´æ“Šï¼‰':''}${mult!==1?`ï¼ˆå…ƒç´ x${mult}ï¼‰`:''}`);
    floatText($('#enemyAvatar'), `-${val}`, 'red');
    if(foe.hp<=0){ endBattle('win'); } else { endPlayerTurn(); }
  }

  function openWinModal(summaryHTML){
  $('#winBody').innerHTML = summaryHTML || '<div class="small">å·²ç²å‹ã€‚</div>';
  $('#winModal').style.display='grid';
  }
  $('#closeWinModal').onclick=()=>$('#winModal').style.display='none';

  // åœ¨æŸå€‹å®¹å™¨ä¸Šå™´ä¸€å€‹é£„å­—ï¼ˆtargetEl: ç›®æ¨™DOMï¼Œtext: æ–‡å­—ï¼Œcls: é¡è‰²é¡ï¼‰
  function floatText(targetEl, text, cls='red'){
    if(!targetEl) return;
    const r = targetEl.getBoundingClientRect();
    const host = document.body;
    const span = document.createElement('div');
    span.className = `floating-dmg ${cls}`;
    span.textContent = text;
    span.style.left = (r.left + r.width/2 - 8) + 'px';
    span.style.top  = (r.top  - 6) + 'px';
    host.appendChild(span);
    setTimeout(()=> span.remove(), 900);
  }


  // æŠ€èƒ½ï¼ˆåˆ—è¡¨ + Modalï¼‰
  const SKILLS = [
    {id:'slash', name:'åŠæ°£æ–¬', mp:10, desc:'ä»¥åŠæ°£é€ æˆä¸­é‡å‚·å®³', power:1.5, elem:ELEM.NEUTRAL,
      cast:(me, foe)=> Math.floor(derived().atk*1.5 + rnd(2,6)), type:'dmg'},
    {id:'fireç¬¦', name:'ç«ç„°ç¬¦', mp:14, desc:'ä»¥ç«éˆä¹‹åŠ›ç¼å‚·æ•µäºº', power:1.8, elem:ELEM.FIRE,
      cast:(me, foe)=> Math.floor(derived().atk*1.2 + 8 + rnd(4,10)), type:'dmg'},
    {id:'taiching', name:'å¤ªæ¸…è­·èº«', mp:8, desc:'æœ¬å›åˆå—åˆ°å‚·å®³é™ä½', type:'buff', elem:ELEM.NEUTRAL,
      cast:(me, foe)=>{ state.player.effects.guard=true; return 0; }}
  ];


  function openSkillModal(){
    const list=$('#skillList'); list.innerHTML='';
    SKILLS.forEach(sk=>{
      const row=document.createElement('div'); row.className='card';
      row.innerHTML=`<div class="grow"><div><strong>${sk.name}</strong></div><div class="small muted">${sk.desc}ï½œæ¶ˆè€— ${sk.mp} MP</div></div><button class="btn small">æ–½æ”¾</button>`;
      row.querySelector('button').onclick=()=>{ castSkill(sk); closeSkillModal(); };
      list.appendChild(row);
    });
    $('#skillModal').style.display='grid';
  }
  function closeSkillModal(){ $('#skillModal').style.display='none'; }
  function castSkill(sk){
    if(battle.turn!=='player') return;
    if(state.player.mp < sk.mp){ toast('çœŸå…ƒä¸è¶³'); return; }
    state.player.mp -= sk.mp;
    if(sk.type==='dmg'){
      const base = sk.cast(playerStatsObj(), battle.enemy);
      const mult = elementMultiplier(sk.elem || ELEM.NEUTRAL, battle.enemy.element);
      const real = Math.max(1, Math.floor(base * mult));
      battle.enemy.hp = clamp(battle.enemy.hp - real, 0, battle.enemy.hpMax);
      renderBattleBars();floatText($('#enemyAvatar'), `-${real}`, 'red');
      log(`æ–½å±•ã€${sk.name}ã€‘ï¼Œé€ æˆ ${real} å‚·å®³ï¼${mult!==1?`ï¼ˆå…ƒç´ x${mult}ï¼‰`:''}`);
      if(battle.enemy.hp<=0){ endBattle('win'); return; }
    } else if(sk.type==='buff'){
      sk.cast(playerStatsObj(), battle.enemy);
      renderBattleBars();
      log(`æ–½å±•ã€${sk.name}ã€‘ï¼Œç²å¾—è­·èº«æ•ˆæœã€‚`);
    }
    endPlayerTurn();
  }

  function renderBattleBars(){
    const D=derived(); const p=state.player;
    $('#playerHpBar').style.width = clamp(p.hp/D.hpMax*100,0,100)+'%';
    $('#playerMpBar').style.width = clamp(p.mp/D.mpMax*100,0,100)+'%';
    if(battle.enemy){
      const e=battle.enemy;
      $('#enemyHpBar').style.width = clamp(e.hp/e.hpMax*100,0,100)+'%';
      $('#enemyMpBar').style.width = clamp(e.mp/e.mpMax*100,0,100)+'%';
      $('#enemyHeaderTitle').textContent = e.name;
      $('#enemyHeaderTitle').classList.add('title-xl');
    }else{
      $('#enemyHpBar').style.width = '0%';
      $('#enemyMpBar').style.width = '0%';
      $('#enemyHeaderTitle').textContent = 'ç›®å‰æ²’æœ‰æ•µäºº';
      $('#enemyHeaderTitle').classList.add('title-xl');
    }
    renderTop();
  }
  function renderActBars(){ $('#playerActBar').style.width = battle.bars.player+'%'; $('#enemyActBar').style.width  = battle.bars.enemy+'%'; }
  function log(msg){ const el=$('#battleLog'); const line=document.createElement('div'); line.className='small'; line.textContent=msg; el.appendChild(line); el.scrollTop = el.scrollHeight; }

  // ---- Map / Item Modals ----
  function openMapModal(){
  const list=$('#mapList'); list.innerHTML='';
  MAPS.forEach(m=>{
    const enemyNames = (m.enemies||[]).map(id => (MONSTER_DB[id]?.name || id)).join('ã€');
    const row=document.createElement('div'); row.className='card';
    row.innerHTML=`
      <div class="grow">
        <div><strong>${m.name}</strong></div>
        <div class="small muted">å»ºè­°ç­‰ç´š ${m.level[0]}-${m.level[1]} ï½œ å¯èƒ½æ•µäººï¼š${enemyNames}</div>
      </div>
      <button class="btn small">é¸æ“‡</button>`;
    row.querySelector('button').onclick=()=>{ chooseMap(m.id); };
    list.appendChild(row);
  });
  $('#mapModal').style.display='grid';
}
  function closeMapModal(){ $('#mapModal').style.display='none'; }
  function chooseMap(id){
    battle.map=id; closeMapModal();
    const m = MAPS.find(m=>m.id===id);
    $('#currentMapLabel').textContent = 'åœ°åœ–ï¼š' + (m?.name || 'æœªçŸ¥');
    toast('å·²é¸æ“‡åœ°åœ–ï¼š' + (m?.name || 'æœªçŸ¥'));
  }
  function useItemFromBag(name){
  const def=findItemDef(name); if(!def) return;
  const inBattle = battle.in && battle.turn==='player';
  if(inBattle){
    if(!def.useInCombat) return toast('æ­¤é“å…·éæˆ°é¬¥å¯ç”¨');
    if(def.cd){
      const now = nowMs();
      const next = battle.cooldowns[name] || 0;
      if(now < next){
        const left = Math.ceil((next - now)/1000);
        return toast(`å†·å»ä¸­ï¼ˆ${left}sï¼‰`);
      }
    }
    def.effect(state.player);
    removeItem(name,1);
    markDirty();
    renderBag(currentFilter);
    log('ä½¿ç”¨ï¼š'+name);
    if(def.cd){ battle.cooldowns[name] = nowMs() + def.cd*1000; }
    endPlayerTurn();
  } else {
    if(!def.useOutCombat) return toast('æ­¤é“å…·åƒ…å¯æ–¼æˆ°é¬¥ä¸­ä½¿ç”¨');
    def.effect(state.player);
    removeItem(name,1);
    markDirty();
    renderBag(currentFilter);
    toast('å·²ä½¿ç”¨ï¼š'+name);
  }
}

  function openItemModal(){
    const list=$('#battleItemList'); list.innerHTML='';
    state.inventory.forEach(it=>{
      const def=findItemDef(it.name); if(!def || !def.useInCombat) return;
      const next = battle.cooldowns[it.name] || 0;
      const left = Math.max(0, Math.ceil((next - nowMs())/1000));
      const cdText = def.cd ? (left>0?`CD ${left}s`:`CD ${def.cd}s`) : '';
      const row=document.createElement('div'); row.className='card';
      row.innerHTML=`<div class="grow">
        <div><strong>${it.name}</strong> <span class="tag">x${it.qty}</span></div>
        <div class="small muted">${def.desc} ${cdText?`ï½œ${cdText}`:''}</div>
      </div>
      <button class="btn small" ${left>0?'disabled':''}>ä½¿ç”¨</button>`;
      row.querySelector('button').onclick=()=>{ useItemFromBag(it.name); closeItemModal(); };
      list.appendChild(row);
    });
    $('#itemModal').style.display='grid';
  }
  function closeItemModal(){ $('#itemModal').style.display='none'; }

  // ---------------- Navigation ----------------
  let currentFilter='all'; let shopFilter='consumable';
  function goto(tab){
    if(battle.in && tab!=='battle'){
      toast('æˆ°é¬¥ä¸­ä¸å¯åˆ‡æ›é é¢');
      tab = 'battle';
    }
    $$('#tabbar button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    $$('section[data-page]').forEach(s=>s.hidden = s.dataset.page!==tab);
    if(tab==='bag') renderBag(currentFilter);
    if(tab==='equip') renderEquip();
    if(tab==='shop') renderShop();
    if(tab==='battle') renderBattleBars();
  }

  function bindUI(){
    $$('#tabbar button, .nav button').forEach(b=> b.onclick=()=>{ const target=b.dataset.tab; if(battle.in && target!=='battle'){ toast('æˆ°é¬¥ä¸­ä¸å¯åˆ‡æ›é é¢'); goto('battle'); return; } goto(target); });
    $$('[data-goto]').forEach(b=> b.onclick=()=>goto(b.dataset.goto));
    $('#btnSave').onclick=save; $('#btnLoad').onclick=load; $('#btnReset').onclick=reset;

    $$('#bag button[data-filter], [data-page="bag"] button[data-filter]').forEach(b=> b.onclick=()=>{ currentFilter=b.dataset.filter; renderBag(currentFilter); });
    // å•†åº—åˆ†é åˆ‡æ›
    $$('[data-page="shop"] [data-shop]').forEach(b=>{
      b.onclick = () => { shopFilter = b.dataset.shop; renderShop(); };
    });
    renderEquip(); renderTop(); renderAttrs(); renderBattleBars(); renderBag(currentFilter);

    $('#btnMeditate').onclick=()=>{ addExp(5); toast('å¿ƒå¦‚æ­¢æ°´ï¼Œç²å¾— 5 EXP'); };
    $('#btnReadBook').onclick=()=>{ const it=state.inventory.find(i=>i.name==='ä¿®ç…‰ç¶“æ›¸'); if(!it) return toast('æ²’æœ‰ç¶“æ›¸'); useItemFromBag('ä¿®ç…‰ç¶“æ›¸'); };
    $('#btnUseTown').onclick=()=>{ const it=state.inventory.find(i=>i.name==='å›åŸç¬¦'); if(!it) return toast('æ²’æœ‰å›åŸç¬¦'); useItemFromBag('å›åŸç¬¦'); };

    // battle
    $('#btnStartBattle').onclick=()=>{ $('#battleLog').innerHTML=''; startBattle(); };
    $('#btnFlee').onclick=()=>{ if(battle.in){ endBattle('flee'); } };
    $('#btnChooseMap').onclick=openMapModal;
    $('#actAttack').onclick=playerAttack;
    $('#actSkill').onclick=()=>{ if(battle.turn==='player') openSkillModal(); else toast('å°šæœªè¼ªåˆ°ä½ '); };
    $('#closeSkillModal').onclick=closeSkillModal;
    $('#closeMapModal').onclick=closeMapModal;
    $('#actItem').onclick=()=>{ if(battle.turn==='player') openItemModal(); else toast('å°šæœªè¼ªåˆ°ä½ '); };
    $('#actDefend').onclick=()=>{ if(battle.turn!=='player') return; state.player.effects.guard = true; log('ä½ èª¿æ¯é˜²ç¦¦ï¼Œæœ¬å›åˆå—åˆ°å‚·å®³é™ä½'); endPlayerTurn(); };
    $('#closeItemModal').onclick=closeItemModal;

    // equip detail
    $('#closeEquipInfoModal').onclick=closeEquipInfoModal;

    $$('[data-soon]').forEach(b=> b.onclick=()=>toast('æ­¤åŠŸèƒ½å¾…é–‹ç™¼'));
  }

  function renderAll(){ renderTop(); renderAttrs(); renderBag('all'); renderEquip(); renderShop(); goto('home'); }

  // ---------------- Toast ----------------
  let toastTimer=null;
  function toast(msg){
    const t=$('#toast'); $('#toastMsg').textContent=msg; t.style.display='block';
    clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.style.display='none', 1600);
  }

  // boot
  init();
})();
</script>
</body>
</html>
