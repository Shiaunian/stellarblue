<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>修仙RPG｜主城（手機專用 v5）</title>
<style>
  :root{
    --bg:#0b1024; --bg2:#0e1536; --panel:#131a3f; --panel-2:#0f1534; --muted:#9aa3b2; --text:#eaf2ff;
    --accent:#8b5cf6; --accent2:#22d3ee; --hp:#ef4444; --mp:#3b82f6; --bar:#334155; --ok:#22c55e; --warn:#f59e0b;
    --gold:#b98c4b; --gold-2:#7a5b31; --radius:16px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
    --elem-none:#64748b; --elem-water:#38bdf8; --elem-fire:#f97316;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:"Microsoft JhengHei",system-ui,Segoe UI,Roboto,sans-serif; color:var(--text); background:var(--bg);}

  /* 舞台：所有裝置一律以「手機畫面」顯示 */
  .stage{
    position:fixed; inset:0; display:grid; justify-items:center; align-items:start; overflow:auto;
    padding-top:max(6px, env(safe-area-inset-top));
  }
  /* 手機固定寬度（最大 420px），電腦/平板也使用同一寬度，避免版面跑掉 */
  .app{
    width:min(420px, 100svw);
    max-height:100svh;
    background:linear-gradient(180deg, var(--bg2), var(--panel));
    border-radius:var(--radius); box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
  }

  /* ===== Header（兩列） ===== */
  header{
    padding:10px 12px; background:rgba(255,255,255,.06);
    border-bottom:1px solid rgba(255,255,255,.08);
    display:grid;
    grid-template-columns:1fr auto;
    grid-template-areas:
      "left right"
      "medals right";
    gap:8px 10px; align-items:center;
  }
  .h-left{grid-area:left; display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; min-width:0;}
  .avatar{width:44px; height:44px; border-radius:50%; object-fit:cover; background:#222; border:2px solid rgba(255,255,255,.15);}
  .pinfo{display:flex; flex-direction:column; min-width:0;}
  .prow{display:flex; align-items:center; gap:6px; flex-wrap:nowrap; min-width:0;}
  .pname{font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .plv{font-size:12px; opacity:.9;}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px;
        background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
        white-space:nowrap;}
  .elem{font-weight:700;}
  .elem.none{background:var(--elem-none); color:#0b1024;}
  .elem.water{background:var(--elem-water); color:#07223a;}
  .elem.fire{background:var(--elem-fire); color:#2b0a00;}

  /* 勳章：確保為完整圓形且不會被擠壓 */
  .medals{grid-area:medals; display:flex; gap:6px; min-width:0;}
  .medal-slot{
    width:30px; aspect-ratio:1/1; border-radius:50%;
    border:2px solid rgba(255,255,255,.25);
    display:flex; align-items:center; justify-content:center;
    font-size:12px; color:#cbd5e1; background:rgba(255,255,255,.06);
    overflow:hidden; flex:0 0 auto;
  }
  .medal-slot img{width:100%; height:100%; object-fit:cover; display:block;}

  /* 右側：貨幣 + 登出（改成直向排列，登出在貨幣下方） */
  .h-right{grid-area:right; display:flex; flex-direction:column; align-items:flex-end; gap:8px; min-width:0;}
  .coins{display:flex; gap:8px; white-space:nowrap; min-width:0; flex-wrap:nowrap;}
  .coin{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-size:12px;}
  .icon-box{ width:18px; height:18px; border-radius:4px; overflow:hidden; display:grid; place-items:center; }
  .icon-box img{ width:100%; height:100%; object-fit:cover; display:block; }
  /* 長數字支援（999,999+），仍保持單行 */
  .val{max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

  .logout-btn{
    padding:7px 14px; min-width:90px;
    border-radius:999px; border:1px solid rgba(255,255,255,.2);
    background:#ef4444; color:#fff; font-weight:900; cursor:pointer; letter-spacing:1px;
  }
  .logout-btn:active{ transform: translateY(1px); }

  @media (max-width:420px){
    .avatar{width:40px; height:40px}
    .coin{padding:5px 8px}
    .val{max-width:100px}
    .medal-slot{width:28px}
    header{gap:6px 8px; padding:8px 8px}
  }

  .divider{height:1px; background:rgba(255,255,255,.08); margin:6px 0;}
  .main{flex:1; display:flex; flex-direction:column; gap:10px; padding:8px 12px 0; overflow:auto;}
  .bars{display:grid; gap:8px;}
  .stat-row{display:grid; grid-template-columns:48px 1fr 56px; align-items:center; gap:8px;}
  .label{font-size:14px; color:#e2e8f0; text-align:right;}
  .num{font-size:12px; color:#e2e8f0; text-align:right;}
  .prog{height:14px; background:#1f273a; border-radius:999px; position:relative; overflow:hidden; box-shadow: inset 0 2px 0 rgba(255,255,255,.06), inset 0 -2px 0 rgba(0,0,0,.25);}
  .fill{height:100%; width:0%;} .fill.sta{background:linear-gradient(90deg,#eab308,#f59e0b);} .fill.exp{background:linear-gradient(90deg,#16a34a,#4ade80);} .fill.hp{background:linear-gradient(90deg,#ef4444,#b91c1c);} .fill.mp{background:linear-gradient(90deg,#3b82f6,#1d4ed8);}
  .actions{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding-top:6px;}
  .gbtn{padding:5px 0; text-align:center; border-radius:10px; font-size: 12px;  font-weight:800; letter-spacing:2px; color:#fff; background:linear-gradient(#a6783e,#7f5626); border:1px solid #5e3d1a; box-shadow: inset 0 2px 0 rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);}
  .title{text-align:center; color:#c7d2fe; font-weight:900; letter-spacing:6px; padding-top:4px;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; padding-bottom:6px;}
  .card{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:6px; display:grid; grid-template-columns:52px 1fr; gap:10px; align-items:center;}
  .thumb{width:40px; height:40px; border-radius:10px; overflow:hidden; display:grid; place-items:center; background:#1e293b;}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .ctitle{font-weight:800; font-size: 12px; letter-spacing:1px;} .csub{font-size:12px; color:var(--muted);}
  .dock{padding:0 12px 10px;}
  .chatbox{background:#060a1a; border:1px solid rgba(255,255,255,.2); border-radius:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(0,0,0,.4);}
  .corner-btn{position:absolute; width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-top:12px solid #fff; right:10px;}
  .corner-btn.top{top:-6px;} .corner-btn.bottom{bottom:-6px; transform:rotate(180deg);}
  .log{height:92px; overflow:auto; padding:8px 10px; font-size:12px;} .log .item{line-height:1.5} .log .ok{color:var(--ok)} .log .warn{color:var(--warn)} .log .muted{color:var(--muted)}
  .speak{display:flex; gap:8px; border-top:1px solid rgba(255,255,255,.1); padding:8px; background:#0a1024; border-radius:0 0 10px 10px;}
  .speak input{flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#fff; color:#111;}
  .speak button{padding:10px 14px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; font-weight:700;}

  /* Modal、Bag 與邏輯相關樣式保持原樣（從 v4 完整版沿用） */
  .stage, .log { overscroll-behavior: contain; }
  .dock { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
  .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:999; }
  .modal.show{ display:grid; }
  .modal .mask{ position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px); }
  .sheet{ position:relative; width:min(92vw, 520px); border-radius:16px; overflow:hidden; background:var(--panel-2); border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); color:var(--text); }
  .sheet .sec-title{ background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.08); text-align:center; font-weight:900; letter-spacing:4px; padding:8px 12px; position:relative; }
  .sheet .close{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:24px; height:24px; border-radius:999px; display:grid; place-items:center; background:#ef4444; color:#fff; font-weight:900; cursor:pointer; user-select:none; }
  .sheet .body{ padding:12px; display:grid; gap:12px; }
  .attr-list{ display:grid; gap:8px; }
  .attr-row{ display:grid; grid-template-columns:70px 42px 1fr 40px; align-items:center; gap:8px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:6px 8px; }
  .attr-name{ font-weight:700; }
  .attr-val{ font-variant-numeric: tabular-nums; text-align:right; }
  .attr-bar{ height:12px; background:#1f273a; border-radius:999px; overflow:hidden; box-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.3); }
  .attr-fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); }
  .attr-plus{ width:32px; height:26px; border-radius:8px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,#22c55e,#16a34a); color:#fff; font-weight:900; cursor:pointer; display:grid; place-items:center; user-select:none; }
  .attr-plus.hide{ display:none; }
  .remain{ text-align:right; font-size:12px; color:#e2e8f0; }
  .kv{ display:grid; grid-template-columns:1fr 1fr; gap:6px 16px; }
  .kv .item{ display:flex; justify-content:space-between; gap:8px; padding:6px 8px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:8px; }
  .kv .k{ opacity:.85; font-size:12px; }
  .kv .v{ font-variant-numeric: tabular-nums; font-size:12px; }

  .bag-tabs{display:flex; gap:6px; padding:6px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.08);}
  .bag-tab{padding:4px 8px; border-radius:8px; font-weight:700; font-size:11px; cursor:pointer; user-select:none; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);}
  .bag-tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff;}
  /* ⚠ 原本寫 .bag-body 但你的 HTML 用的是 .bag-list，這裡改成 .bag-list 才會生效 */
  .bag-list{padding:8px; display:grid; gap:6px; max-height:65vh; overflow:auto;}


  .item-row{ display:grid; grid-template-columns:36px 1fr; gap:6px; align-items:center; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:5px 8px; min-height:48px; cursor:pointer; }
  .item-thumb{width:36px; height:36px; border-radius:8px; background:#1e293b; display:grid; place-items:center; font-weight:900;}
  .item-thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .item-main{display:grid; gap:2px;}
  /* 改成自適應寬度，右側欄位縮窄；名稱可多行 */
  .item-title.cons{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:4px;}
  .item-title.wep {display:grid; grid-template-columns: 46px 1fr auto; align-items:center; column-gap:6px;}
  /* 名稱可換行，避免被 … 截斷；整體字再小一點 */
  .item-name{
    font-weight:800; font-size:12px; line-height:1.25;
    overflow:visible; white-space:normal; text-overflow:clip; word-break:break-word;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    border-radius:10px; padding:2px 8px; text-align:center;
  }
  .count-slot{
    justify-self:end; min-width:56px; text-align:right; font-variant-numeric: tabular-nums;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
    border-radius:9999px; padding:2px 6px; font-size:11px;
  }
  .meta-effect{justify-self:end;}
  .badge{display:inline-block; padding:1px 6px; font-size:11px; border-radius:9999px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10);}
  .badge.hp{background:#7f1d1d; border-color:#ef4444; color:#fff;}
  .badge-lv{background:rgba(255,255,255,.85); color:#0b1024; font-weight:900; border-radius:8px; padding:1px 6px; font-size:11px;}
  .right-meta{display:flex; align-items:center; gap:8px;}
  .dur-chip{background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); border-radius:9999px; padding:1px 6px; font-size:11px; color:#e2e8f0;}
  .item-sub{display:flex; justify-content:space-between; gap:8px; font-size:11px; color:var(--muted); line-height:1.15;}
  /* 允許左右說明也自動換行，避免擠到冒號或出現 … */
  .sub-left{white-space:normal;}
  .sub-right{white-space:normal; color:#93c5fd;}
  .price{font-size:11px; color:#e2e8f0;}

  /* ★ 稀有度顏色：使用「普/精/稀/史/傳」五級，對應 items.js 的 RARITY */
  :root{
    --rar-普:#e5e7eb; --rar-精:#22c55e; --rar-稀:#38bdf8; --rar-史:#a78bfa; --rar-傳:#f59e0b;
  }
  .rarity-普{color:var(--rar-普);}
  .rarity-精{color:var(--rar-精);}
  .rarity-稀{color:var(--rar-稀);}
  .rarity-史{color:var(--rar-史);}
  .rarity-傳{color:var(--rar-傳);}

  /* 小方塊稀有度徽章（顯示「普/精/稀/史/傳」） */
  .rb{display:inline-grid; place-items:center; width:16px; height:16px; font-size:10px; font-weight:900;
      border-radius:4px; margin-right:4px; line-height:1; border:1px solid rgba(255,255,255,.25);}
  .rb-普{background:var(--rar-普); color:#0b1024;}
  .rb-精{background:var(--rar-精); color:#052411;}
  .rb-稀{background:var(--rar-稀); color:#041621;}
  .rb-史{background:var(--rar-史); color:#1a0b2c;}
  .rb-傳{background:var(--rar-傳); color:#231400;}

  /* 既有耐久字樣維持 */
  .dur{font-size:10px; color:#e2e8f0;}

  #bagAction{position:fixed; inset:0; display:none; place-items:center; z-index:1000;}
  #bagAction.show{display:grid;}
  #bagAction .mask{position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px);}
  #bagAction .sheet{position:relative; width:min(92vw, 380px);} #bagAction .ops{display:flex; justify-content:flex-end; gap:6px;}
  .opx{padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#fff; font-weight:700; font-size:12px; cursor:pointer;}
  .opx.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));}


  /* 讓屬性面板的外層彈窗限制高度，避免超出視口 */
#attrModal .sheet{
  /* 原本就有 width/min… 可保留 */
  max-height: min(86svh, 640px);      /* 手機優先：最高只到 86% 視口高 */
  display: grid;
  grid-template-rows: auto 1fr;       /* 上：標題列；下：內容可捲動 */
  overflow: hidden;                    /* 捲動交給 body */
}

/* 標題列固定在最上方，永遠看得到 ✕ */
#attrModal .sheet .sec-title{
  position: sticky;
  top: 0;                              /* 黏到頂端 */
  z-index: 1;
  padding-top: calc(8px + env(safe-area-inset-top, 0px));
  background: rgba(255,255,255,.06);   /* 保留原底色 */
  backdrop-filter: blur(2px);
}

/* 內容區域可獨立捲動；多到超過就出現滾動條 */
#attrModal .sheet .body{
  overflow: auto;
  /* 預留底部安全區，避免 iPhone 底部指示條壓到 */
  padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
}

/* 讓屬性清單在窄手機也好捲動（可選） */
#attrModal .attr-list{
  min-height: 0;   /* 搭配 grid 才能正確壓縮讓父層捲動 */
}
#attrModal .kv{
  min-height: 0;
}

/* 提升關閉鈕點擊面積（不改見到的大小，只增大可點區域） */
#attrModal .close{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px; height: 28px;          /* 稍微放大 */
  touch-action: manipulation;
}
#attrModal .close::before{
  content: "";
  position: absolute;
  inset: -8px;                         /* 外擴 8px 的隱形熱區 */
}
</style>
</head>
<body>

<!-- ===== 原有 UI/Modal 結構：不改玩法、只動排版 ===== -->
<div id="attrModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="attr"></div>
  <div class="sheet" role="dialog" aria-labelledby="attrTitle">
    <div class="sec-title" id="attrTitle">
      基本屬性
      <div class="close" data-close="attr">✕</div>
    </div>
    <div class="body">
      <div class="remain">未分配屬性點：<b id="ptRemain">0</b></div>
      <div class="attr-list" id="attrList"></div>
      <div class="sec-title">能力值</div>
      <div class="kv" id="statList"></div>
    </div>
  </div>
</div>

<div id="bagModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="bag"></div>
  <div class="sheet" role="dialog" aria-labelledby="bagTitle">
    <div class="sec-title" id="bagTitle">
      儲物袋
      <div class="close" data-close="bag">✕</div>
    </div>

    <div class="body">
      <div class="bag-tabs">
        <span class="bag-tab active" data-bag-tab="consumable">消耗品</span>
        <span class="bag-tab" data-bag-tab="weapon">裝備</span>
        <div class="bag-tab" data-bag-tab="ornament" title="尚未開放">飾品</div>
        <div class="bag-tab" data-bag-tab="hidden"   title="尚未開放">暗器</div>
        <span class="bag-tab" data-bag-tab="material">材料</span>
      </div>
      <div id="bagList" class="bag-list"></div>
    </div>
  </div>
</div>

<div id="bagAction" aria-hidden="true">
  <div class="mask" data-close="bagAction"></div>
  <div class="sheet action" role="dialog" aria-labelledby="bagActionTitle">
    <div class="sec-title" id="bagActionTitle">
      物品操作
      <div class="close" data-close="bagAction">✕</div>
    </div>
    <div class="body">
      <div class="item-row" style="cursor:default">
        <div class="item-thumb" id="actIcon"></div>
        <div class="item-main">
          <div class="item-title cons" id="actTop"></div>
          <div class="item-sub"><span class="sub-left" id="actLeft"></span><span class="sub-right" id="actRight"></span></div>
        </div>
      </div>
      <div class="ops" id="actBtns"></div>
    </div>
  </div>
</div>

<div class="stage">
  <div class="app">
    <header>
      <div class="h-left">
        <img id="uiAvatar" class="avatar" alt="avatar" />
        <div class="pinfo">
          <div class="prow">
            <div class="pname" id="uiName"></div>
            <div class="plv">LV.<span id="uiLv"></span></div>
            <span id="uiElem" class="pill elem none"></span>
          </div>
        </div>
      </div>

      <div class="medals">
        <div class="medal-slot" id="medal1"></div>
        <div class="medal-slot" id="medal2"></div>
        <div class="medal-slot" id="medal3"></div>
        <div class="medal-slot" id="medal4"></div>
        <div class="medal-slot" id="medal5"></div>
      </div>

      <div class="h-right">
        <div class="coins">
          <span class="coin">
            <span class="icon-box"><img alt="靈石" src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Crystal_128_up.png"></span>
            <span class="val" id="uiStone">0</span>
          </span>
          <span class="coin">
            <span class="icon-box"><img alt="鑽石" src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Diamond_Icon.svg"></span>
            <span class="val" id="uiDiamond">0</span>
          </span>
        </div>
        <button id="btnLogout" class="logout-btn" title="登出" aria-label="登出">登出</button>
      </div>
    </header>

    <div class="divider"></div>

    <div class="main">
      <div class="bars">
        <div class="stat-row">
          <div class="label">體力：</div>
          <div class="prog"><div class="fill sta" id="barSta"></div></div>
          <div class="num" id="txtSta">100/100</div>
        </div>
        <div class="stat-row">
          <div class="label">經驗：</div>
          <div class="prog"><div class="fill exp" id="barExp"></div></div>
          <div class="num" id="txtExp">0/100</div>
        </div>
        <div class="stat-row">
          <div class="label">氣血：</div>
          <div class="prog"><div class="fill hp" id="barHp"></div></div>
          <div class="num" id="txtHp">--/--</div>
        </div>
        <div class="stat-row">
          <div class="label">真元：</div>
          <div class="prog"><div class="fill mp" id="barMp"></div></div>
          <div class="num" id="txtMp">--/--</div>
        </div>
      </div>

    <div class="actions">
      <div class="gbtn" data-open="bag">儲物袋</div>
      <div class="gbtn" data-open="skill">技能</div>
      <div class="gbtn" data-open="equip">裝備欄</div>
      <div class="gbtn" data-open="rank">排行榜</div>
      <div class="gbtn" data-open="shop">商店</div>
    </div>

      <div class="title">主 城</div>

      <div class="grid">
        <div class="card" data-mod="cave"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">洞府</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="map"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">野外地圖</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="library"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">藏經閣</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="tower"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">試煉塔</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="war"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">規模戰</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="collection"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">卡片收藏</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="dex"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">圖鑑</div><div class="csub">目前待開發中</div></div></div>
        <div class="card" data-mod="shop"><div class="thumb"><img src="https://i.ibb.co/C5FsQQSq/2025.png" alt="施工中"></div><div><div class="ctitle">商城</div><div class="csub">目前待開發中</div></div></div>
      </div>

      <div class="dock">
        <div class="chatbox">
          <div class="corner-btn top"></div>
          <div class="log" id="log"></div>
          <div class="speak">
            <input id="chatInput" type="text" placeholder="輸入文字..." />
            <button id="btnSend">送出</button>
          </div>
          <div class="corner-btn bottom"></div>
        </div>
      </div>

</div>
</div>
</div>

<!-- ★ 新增：商店介面 -->
<div id="shopModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="shop"></div>
  <div class="sheet" role="dialog" aria-labelledby="shopTitle">
    <div class="sec-title" id="shopTitle">
      商店
      <div class="close" data-close="shop">✕</div>
    </div>
    <div class="body">
      <!-- 商人清單頁 -->
      <div id="merchantList"></div>
      <!-- 商品清單頁 -->
      <div id="merchantShop" style="display:none;">
        <div class="sec-title" id="merchantName"></div>
        <div id="shopList"></div>
        <button class="opx" id="btnBackMerchants">返回商人清單</button>
      </div>
    </div>
  </div>
</div>

<!-- ★ 新增：購買介面 Modal -->
<div id="buyModal" class="modal" aria-hidden="true">
  <div class="mask" data-close="buy"></div>
  <div class="sheet" role="dialog" aria-labelledby="buyTitle">
    <div class="sec-title" id="buyTitle">
      購買物品
      <div class="close" data-close="buy">✕</div>
    </div>
    <div class="body">
      <div id="buyItemName" style="font-weight:700; text-align:center;"></div>
      <div style="display:flex; gap:8px; align-items:center; justify-content:center;">
        <label for="buyQty">數量：</label>
        <input id="buyQty" type="number" value="1" min="1" style="width:80px; text-align:center;">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button class="opx primary" id="btnConfirmBuy">確定購買</button>
      </div>
    </div>
  </div>
</div>



<script src="items.js"></script>
<script src="auth.js"></script>
<script src="equip.js"></script>
<script>
/* ===== 公用 ===== */
const qs = s=>document.querySelector(s);
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const pct=(cur,max)=>clamp(Math.round(cur/max*100),0,100);
const fmt = (n)=> new Intl.NumberFormat('zh-Hant').format(n);
const fmtCompact = (n)=> new Intl.NumberFormat('en', { notation:'compact', maximumFractionDigits:1 }).format(n);

const ELEMENT_LABEL = {
  none:'無元素',
  gold:'金元素',
  wood:'木元素',
  water:'水元素',
  fire:'火元素',
  earth:'土元素',
  spirit:'靈元素',
  dark:'暗元素',
};

/* ===== 屬性/能力定義 ===== */
const BASE_ATTRS = [
  {key:'str', name:'力道'},
  {key:'vit', name:'體魄'},
  {key:'dex', name:'身法'},
  {key:'int', name:'悟性'},
  {key:'wis', name:'心神'},
  {key:'luk', name:'氣運'},
];

function derivedFrom(P){
  const A = P.attributes, level = P.level ?? 1;
  return {
    '物理攻擊': A.str*2 + level,
    '法術攻擊': A.int*2 + Math.floor(A.wis*0.5),
    '氣血上限': 80 + A.vit*12 + level*6,
    '真元上限': 40 + A.wis*10 + Math.floor(A.int*6/5),
    '物理防禦': Math.floor(A.vit*1.2) + Math.floor(A.dex*0.6),
    '法術防禦': Math.floor(A.wis*1.3) + Math.floor(A.int*0.5),
    '命中率': 60 + A.dex*2,
    '閃避': 5 + Math.floor(A.dex*1.2),
    '暴擊率': Math.min(50, 3 + Math.floor(A.luk*0.8)),
    '暴擊傷害': 50 + Math.floor(A.luk*1.5),
    '行動條速度': 100 + Math.floor(A.dex*2.2),
    '回氣/回合': 2 + Math.floor(A.wis*0.4),
    '回血/回合': 1 + Math.floor(A.vit*0.5),
    '破甲': Math.floor(A.str*0.6),
    '法穿': Math.floor(A.int*0.6),
  };
}

/* ===== 主程式 API ===== */
window.Game = (()=>{
  const state = { player:null };

  function render(p){
    state.player = p;

    // 頭像/名稱/等級/元素
    const fallbackAvatar = (typeof Auth!=='undefined' && Auth.defaultAvatar)
        ? (Auth.defaultAvatar() || 'https://picsum.photos/seed/xian/96')
        : 'https://picsum.photos/seed/xian/96';
    qs('#uiAvatar').src = p.avatar || fallbackAvatar;
    qs('#uiName').textContent = p.name || '無名散修';
    qs('#uiLv').textContent   = p.level ?? 1;
    const elem = (p.element || 'none').toLowerCase();
    const elemEl = qs('#uiElem');
    if (elemEl){ elemEl.className = `pill elem ${elem}`; elemEl.textContent = ELEMENT_LABEL[elem] || '無元素'; }

    // 勳章
    const slots = [qs('#medal1'), qs('#medal2'), qs('#medal3'), qs('#medal4'), qs('#medal5')];
    slots.forEach(s => s && (s.innerHTML = ''));
    (p.medals || []).slice(0, 5).forEach((m, i) => {
      if (m?.icon && slots[i]) {
        const img = new Image(); img.src = m.icon; slots[i].appendChild(img);
      }
    });

    // 貨幣
    const stone = p.currencies?.stone ?? 0;
    const diamond = p.currencies?.diamond ?? 0;
    qs('#uiStone').textContent   = stone   >= 1_000_000 ? fmtCompact(stone)   : fmt(stone);
    qs('#uiDiamond').textContent = diamond >= 1_000_000 ? fmtCompact(diamond) : fmt(diamond);

    // 狀態條：HP/EXP/STA/MP
    const S = p.sta || { cur: 100, max: 100 };
    const E = p.exp || { cur: 0,   max: 100 };

    const hpMaxNow = derivedFrom(p)['氣血上限'];
    const H = { cur: Math.min(p.hp?.cur ?? hpMaxNow, hpMaxNow), max: hpMaxNow };

    const mpMaxNow = derivedFrom(p)['真元上限'];
    if (!p.mp) { p.mp = { cur: mpMaxNow, max: mpMaxNow }; }
    else { p.mp.max = mpMaxNow; p.mp.cur = Math.max(0, Math.min(p.mp.cur ?? mpMaxNow, mpMaxNow)); }
    const M = { cur: p.mp.cur, max: p.mp.max };

    if(qs('#barSta')){ qs('#barSta').style.width = pct(S.cur,S.max) + '%'; qs('#txtSta').textContent = `${S.cur}/${S.max}`; }
    if(qs('#barExp')){ qs('#barExp').style.width = pct(E.cur,E.max) + '%'; qs('#txtExp').textContent = `${E.cur}/${E.max}`; }
    if(qs('#barHp')) { qs('#barHp').style.width  = pct(H.cur,H.max) + '%';  qs('#txtHp').textContent  = `${H.cur}/${H.max}`; }
    if(qs('#barMp')) { qs('#barMp').style.width  = pct(M.cur,M.max) + '%';  qs('#txtMp').textContent  = `${M.cur}/${M.max}`; }
  }

  /* ===== 屬性面板 ===== */
  function openAttr(){ const m = qs('#attrModal'); if(!m) return; renderAttrPanel(); m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
  function closeAttr(){ const m = qs('#attrModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

  function renderAttrPanel(){
    const P = state.player; if(!P) return;

    const list = qs('#attrList');
    if(list){
      list.innerHTML = '';
      BASE_ATTRS.forEach(({key,name})=>{
        const val = P.attributes[key] ?? 10;
        const row = document.createElement('div'); row.className='attr-row';
        row.innerHTML = `
          <div class="attr-name">${name}</div>
          <div class="attr-val" id="val_${key}">${val}</div>
          <div class="attr-bar"><div class="attr-fill" id="bar_${key}" style="width:${Math.min(100,val)}%"></div></div>
          <div class="attr-plus" id="btn_${key}" data-key="${key}">＋</div>
        `;
        list.appendChild(row);
      });
    }

    if(qs('#ptRemain')) qs('#ptRemain').textContent = P.unspentPoints ?? 0;
    updatePlusButtons();
    renderDerived();
  }

  function renderDerived(){
    const P = state.player; if(!P) return;
    const base  = derivedFrom(P);
    const bonus = (window.Equip && Equip.getBonuses) ? Equip.getBonuses() : {};
    const final = {};
    for(const k of Object.keys(base)) final[k] = (base[k]||0) + (bonus[k]||0);

    const box = qs('#statList'); if(!box) return;
    box.innerHTML = '';
    for(const [k,v] of Object.entries(final)){
      const item = document.createElement('div'); item.className='item';
      item.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div>`;
      box.appendChild(item);
    }
  }

  function updatePlusButtons(){
    const remain = state.player?.unspentPoints ?? 0;
    BASE_ATTRS.forEach(({key})=>{
      const btn = qs('#btn_'+key); if(!btn) return;
      btn.classList.toggle('hide', remain<=0);
    });
    if(qs('#ptRemain')) qs('#ptRemain').textContent = remain;
  }

  function wire(){
    document.querySelectorAll('.gbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const txt = b.textContent?.trim();
        if (txt === '儲物袋') return openBag();
        if (txt === '裝備欄') return (window.Equip && Equip.open && Equip.open());
        if (txt === '商店') return openShop();
        log(`開啟：${txt}`,'warn');
      });
    });

    document.querySelectorAll('.card').forEach(c => 
  c.addEventListener('click', () => {
    const mod = c.dataset.mod;
    if (mod === 'map') {
      location.href = 'map.html';
      return;
    }
    // 其他模組先保留原本行為
    log(`進入模組：${c.querySelector('.ctitle').textContent}`, 'warn');
  })
);

    qs('#btnSend')?.addEventListener('click', sendChat);
    qs('#chatInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

    qs('#uiAvatar')?.addEventListener('click', openAttr);
    document.querySelectorAll('[data-close="attr"]').forEach(el=> el.addEventListener('click', closeAttr));
    addEventListener('keydown', e=>{ if(e.key==='Escape') { closeAttr(); closeBag(); closeBagAction(); } });

    document.querySelectorAll('[data-close="bag"]').forEach(el=> el.addEventListener('click', closeBag));

    document.addEventListener('click', (e)=>{
      const el = e.target.closest?.('[data-close="bagAction"]');
      if(el) closeBagAction();
    });

    document.addEventListener('click', (e)=>{
      const plus = e.target.closest?.('.attr-plus');
      if (!plus) return;
      const key = plus.dataset.key;
      const P = state.player;
      if(!key || !P || (P.unspentPoints ?? 0) <= 0) return;

      P.attributes[key] = (P.attributes[key] ?? 10) + 1;
      P.unspentPoints -= 1;

      qs('#val_' + key).textContent = P.attributes[key];
      const bar = qs('#bar_' + key);
      if (bar) bar.style.width = Math.min(100, P.attributes[key]) + '%';

      updatePlusButtons();
      renderDerived();

      const d2 = derivedFrom(P);
      const newHpMax = d2['氣血上限'];
      P.hp = P.hp || { cur: newHpMax, max: newHpMax };
      P.hp.max = newHpMax;
      P.hp.cur = Math.min(P.hp.cur, newHpMax);
      if (qs('#barHp')) {
        qs('#barHp').style.width = ((P.hp.cur / P.hp.max) * 100).toFixed(1) + '%';
        qs('#txtHp').textContent = `${P.hp.cur}/${P.hp.max}`;
      }

      if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    });

    document.addEventListener('click', (e)=>{
      const tab = e.target.closest?.('.bag-tab');
      if (!tab) return;
      const k = tab.dataset.bagTab;
      if (!k) return;
      switchBagTab(k);
    });

    document.addEventListener('click', (e)=>{
      const row = e.target.closest?.('.item-row');
      if(!row || !row.dataset.type) return;
      openBagAction(row.dataset.type, +row.dataset.idx);
    });

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest?.('.opx'); if(!btn) return;
      const type = btn.dataset.type, op = btn.dataset.op, idx = +btn.dataset.idx;

      if(type==='consumable'){
        if(op==='use')  bagUseConsumable(idx);
        if(op==='sell') bagSellConsumable(idx);
        if(op==='throw')bagThrowConsumable(idx);
        renderBag('consumable');
      }else if(type==='weapon'){
        if(op==='equip') bagEquipWeapon(idx);
        if(op==='sell')  bagSellWeapon(idx);
        if(op==='throw') bagThrowWeapon(idx);
        renderBag('weapon');
      }else if(type==='material'){
        if(op==='sell')  bagSellMaterial(idx);
        if(op==='throw') bagThrowMaterial(idx);
        renderBag('material');
      }
      closeBagAction();
    });

    // 登出
    document.getElementById('btnLogout')?.addEventListener('click', ()=>{
      if (confirm('要登出嗎？')) {
        if (window.Auth && Auth.logout) Auth.logout();
        location.href = 'index.html';
      }
    });
  }

/* ===== Shop (NPC → Items) ===== */
function openShop(){
  renderMerchants();
  const m = qs('#shopModal'); if(!m) return;
  m.classList.add('show'); m.setAttribute('aria-hidden','false');
}
function closeShop(){
  const m = qs('#shopModal'); if(!m) return;
  m.classList.remove('show'); m.setAttribute('aria-hidden','true');
  const list = qs('#merchantList'); const page = qs('#merchantShop');
  if(list) list.style.display = 'block';
  if(page) page.style.display = 'none';
}

/* 商人清單頁 */
function renderMerchants(){
  const box = qs('#merchantList'); if(!box) return;
  box.innerHTML = '';

  // 1) 藥鋪小李（固定可用）
  const li = document.createElement('div');
  li.className = 'item-row';
  li.innerHTML = ''
    + '<div class="item-thumb"><img src="https://i.ibb.co/3fNzHbn/apothecary.png" alt="藥鋪小李"></div>'
    + '<div class="item-main">'
    + '  <div class="item-title"><span class="item-name">藥鋪小李</span></div>'
    + '  <div class="item-sub"><span class="sub-left">販售丹藥</span></div>'
    + '</div>';
  li.onclick = function(){ openMerchant('藥鋪小李', ItemDB.DB.consumables || []); };
  box.appendChild(li);

  // 2) 洞窟補給商（打過萊姆洞窟 BOSS 才解鎖）
  var P = Game.getPlayer(); 
  var unlocked = false;
  if(P && P.mapProg && P.mapProg.slime_cave && P.mapProg.slime_cave.bossReady){ unlocked = true; }

  const cave = document.createElement('div');
  cave.className = 'item-row';
  cave.style.filter = unlocked ? 'none' : 'grayscale(1) opacity(.5)';
  cave.innerHTML = ''
    + '<div class="item-thumb"><img src="https://i.ibb.co/QnLR7vN/cave-merchant.png" alt="洞窟補給商"></div>'
    + '<div class="item-main">'
    + '  <div class="item-title"><span class="item-name">洞窟補給商</span></div>'
    + '  <div class="item-sub"><span class="sub-left">' + (unlocked ? '販售特用品' : '尚未解鎖') + '</span></div>'
    + '</div>';
  if(unlocked){
    cave.onclick = function(){ 
      openMerchant('洞窟補給商', [
        { id:'antidote', name:'解毒藥', price:120, icon:'https://i.ibb.co/JxR7ZzP/antidote.png' }
      ]);
    };
  }
  box.appendChild(cave);
}

/* 進入某位商人 → 顯示商品清單 */
function openMerchant(name, items){
  const list = qs('#merchantList'); const page = qs('#merchantShop');
  if(list) list.style.display = 'none';
  if(page) page.style.display = 'block';
  const ttl = qs('#merchantName'); if(ttl) ttl.textContent = name;

  const box = qs('#shopList'); if(!box) return;
  box.innerHTML = '';
  for(var i=0;i<items.length;i++){
    var it = items[i] || {};
    var hasIcon = (typeof it.icon === 'string') && /^https?:\/\//.test(it.icon);
    var effHp = it.effect && it.effect.hp ? it.effect.hp : 0;
    var effMp = it.effect && it.effect.mp ? it.effect.mp : 0;
    var effHtml = '';
    if(effHp){ effHtml += '<span class="badge hp">氣血+' + effHp + '</span>'; }
    if(effMp){ effHtml += '<span class="badge">真元+' + effMp + '</span>'; }

    var row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = ''
      + '<div class="item-thumb">' + (hasIcon?('<img src="'+it.icon+'" alt="'+(it.name||'')+'">'):'') + '</div>'
      + '<div class="item-main">'
      + '  <div class="item-title cons">'
      + '    <span class="item-name">' + (it.name||'') + '</span>'
      + '    <span class="meta-effect">' + effHtml + '</span>'
      + '    <span class="count-slot">×1</span>'
      + '  </div>'
      + '  <div class="item-sub">'
      + '    <span class="sub-left">價格 ' + (it.price||0) + ' 靈石</span>'
      + '    <span class="sub-right"><button class="opx primary" data-shop-src="'+name+'" data-shop-buy="'+i+'">購買</button></span>'
      + '  </div>'
      + '</div>';
    box.appendChild(row);
  }
}

/* 購買按鈕 → 先開數量輸入框 */
document.addEventListener('click', function(e){
  var btn = e.target && e.target.closest ? e.target.closest('[data-shop-buy]') : null;
  if(!btn) return;

  var idx = parseInt(btn.getAttribute('data-shop-buy')||'0',10);
  var src = btn.getAttribute('data-shop-src') || '';

  var items = [];
  if(src === '藥鋪小李'){ items = ItemDB.DB.consumables || []; }
  else if(src === '洞窟補給商'){ 
    items = [{ id:'antidote', name:'解毒藥', price:120, icon:'https://i.ibb.co/JxR7ZzP/antidote.png' }];
  }
  var it = items[idx]; if(!it) return;

  // 開啟購買介面
  var m = qs('#buyModal'); if(!m) return;
  qs('#buyItemName').textContent = it.name + '（單價 ' + (it.price||0) + ' 靈石）';
  m.dataset.itemIndex = idx;
  m.dataset.itemSrc = src;
  qs('#buyQty').value = 1;
  m.classList.add('show'); m.setAttribute('aria-hidden','false');
});

/* 確定購買 */
document.getElementById('btnConfirmBuy').addEventListener('click', function(){
  var m = qs('#buyModal'); if(!m) return;
  var idx = parseInt(m.dataset.itemIndex||'0',10);
  var src = m.dataset.itemSrc || '';

  var items = [];
  if(src === '藥鋪小李'){ items = ItemDB.DB.consumables || []; }
  else if(src === '洞窟補給商'){ 
    items = [{ id:'antidote', name:'解毒藥', price:120, icon:'https://i.ibb.co/JxR7ZzP/antidote.png' }];
  }
  var it = items[idx]; if(!it) return;

  var qty = parseInt(qs('#buyQty').value||'1',10);
  if(qty<1) qty=1;

  var P = Game.getPlayer(); if(!P) return;
  var stone = (P.currencies && typeof P.currencies.stone==='number') ? P.currencies.stone : 0;
  var cost = (it.price||0) * qty;
  if(stone < cost){
    Game.log('靈石不足，無法購買 ' + (it.name||'') + ' ×' + qty, 'warn');
    return;
  }

  P.currencies.stone = stone - cost;
  ItemDB.addConsumableToBag(P.bag, it.id, qty);

  if(window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
  Game.recalc();
  Game.log('購買 ' + (it.name||'') + ' ×' + qty + ' 成功！', 'ok');

  // 關閉購買框
  m.classList.remove('show'); m.setAttribute('aria-hidden','true');
});

/* 關閉購買框 */
document.querySelectorAll('[data-close="buy"]').forEach(function(el){
  el.addEventListener('click', function(){
    var m = qs('#buyModal'); if(!m) return;
    m.classList.remove('show'); m.setAttribute('aria-hidden','true');
  });
});

/* 返回商人清單、關閉商店 */
var backBtn = document.getElementById('btnBackMerchants');
if(backBtn){
  backBtn.addEventListener('click', function(){
    var list = qs('#merchantList'); var page = qs('#merchantShop');
    if(list) list.style.display = 'block';
    if(page) page.style.display = 'none';
  });
}
document.querySelectorAll('[data-close="shop"]').forEach(function(el){
  el.addEventListener('click', closeShop);
});

  /* ===== Bag ===== */
  function openBag(){ seedBagIfMissing(); renderBag('consumable'); const m = qs('#bagModal'); if(!m) return; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
  function closeBag(){ const m = qs('#bagModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
  function switchBagTab(k){ document.querySelectorAll('.bag-tab').forEach(t=> t.classList.toggle('active', t.dataset.bagTab===k)); renderBag(k); }

function renderBag(k){
  const P = state.player; if(!P) return;
  const box = qs('#bagList'); if(!box) return;
  box.innerHTML = '';
  if (k === 'consumable') {
    renderConsumables(box, P);
  } else if (k === 'weapon') {
    renderWeapons(box, P);
  } else if (k === 'material') {
    renderMaterials(box, P);
  } else {
    const tip = document.createElement('div'); tip.className='item-sub';
    tip.textContent = '此分頁尚未開放';
    box.appendChild(tip);
  }
}

function openBagAction(type, idx){
  const P = state.player; if(!P) return;
  const m = qs('#bagAction'); if(!m) return;

  const isUrl = s => typeof s === 'string' && /^https?:\/\//.test(s);
  const clampInt = (n, lo, hi)=> Math.max(lo, Math.min(hi, (n|0)));

  let name='', subLeft='', subRight='', iconUrl=null, btnsHtml='';

  if (type === 'consumable') {
    const it  = (P.bag.consumables || [])[idx]; if (!it) return;
    const def = ItemDB.getDef('consumables', it.id) || {};
    name     = it.name || def.name || it.id;
    const effHp  = it.effect?.hp ?? def.effect?.hp;
    const effTxt = effHp ? `氣血+${effHp}` : '';
    subRight = `販售價格 ${it.price ?? def.price ?? 0}`;
    iconUrl  = isUrl(it.icon) ? it.icon : (isUrl(def.icon) ? def.icon : null);
    const cnt = clampInt(it.count ?? 0, 0, 9999);

qs('#actTop').className = 'item-title cons';
qs('#actTop').innerHTML = ''
  + '<span class="item-name">' + String(name) + '</span>'
  + '<span class="meta-effect">' + (effTxt ? ('<span class="badge hp">'+ effTxt +'</span>') : '') + '</span>'
  + '<span class="count-slot">×' + cnt + '</span>';

    qs('#actLeft').textContent  = '';
    qs('#actRight').textContent = subRight;

    btnsHtml = `
      <button class="opx primary" data-op="use"  data-type="consumable" data-idx="${idx}">使用</button>
      <button class="opx"         data-op="sell" data-type="consumable" data-idx="${idx}">販賣</button>
      <button class="opx"         data-op="throw"data-type="consumable" data-idx="${idx}">丟棄</button>
    `;

  } else if (type === 'material') {
  const mat = (P.bag.materials || [])[idx]; if (!mat) return;
  const def = ItemDB.getDef('materials', mat.id) || {};
  name     = mat.name || def.name || mat.id;
  iconUrl  = isUrl(mat.icon) ? mat.icon : (isUrl(def.icon) ? def.icon : null);
  const cnt = clampInt(mat.count ?? 0, 0, 9999);
  const r   = (mat.rarity || def.rarity || '').trim();             // ★ 稀有度
  const rCls = r ? `rarity-${r}` : '';
  const rBadge = r ? `<span class="rb rb-${r}" title="稀有度">${r}</span>` : '';
  subLeft  = def.desc ? def.desc : (r ? `稀有度 ${r}` : '');
  subRight = `販售價格 ${def.price ?? 0}`;

  qs('#actTop').className = 'item-title';
  qs('#actTop').innerHTML = `
    <span class="item-name ${rCls}">${rBadge}${name}</span>
    <span class="count-slot">×${cnt}</span>
  `;
  qs('#actLeft').textContent  = subLeft;
  qs('#actRight').textContent = subRight;

  btnsHtml = `
    <button class="opx" data-op="sell"  data-type="material" data-idx="${idx}">販賣</button>
    <button class="opx" data-op="throw" data-type="material" data-idx="${idx}">丟棄</button>
  `;


  } else if (type === 'weapon') {
  const w   = (P.bag.weapons || [])[idx]; if (!w) return;
  const def = ItemDB.getDef('weapons', w.id) || {};
  const d0  = Array.isArray(w.dmg) ? w.dmg : (def.dmg || [0,0]);
  name     = w.name || def.name || w.id;
  iconUrl  = isUrl(w.icon) ? w.icon : (isUrl(def.icon) ? def.icon : null);
   // ★ 稀有度（長字→單字＋對應 class）
  const r0 = (w.rarity || def.rarity || '').trim();                 // 可能是「普通/精良/稀有/史詩/傳說」
  const rS = ({'普':'普','精':'精','稀':'稀','史':'史','傳':'傳'})[r0] || (r0 ? r0[0] : '');
  const rCls = rS ? `rarity-${rS}` : '';
  const rBadge = rS ? `<span class="rb rb-${rS}" title="稀有度">${rS}</span>` : '';

  subLeft  = `物理攻擊 ${d0[0]}-${d0[1]}`;
  subRight = `販售價格 ${w.price ?? def.price ?? 0}`;

  qs('#actTop').className = 'item-title wep';
  qs('#actTop').innerHTML = `
    <span class="badge-lv">LV.${w.level ?? def.level ?? 1}</span>
    <span class="item-name ${rCls}">${rBadge}${String(name).replace(/^(普|精|稀|史|傳)的?/, '')}</span>
    <span class="right-meta">
      <span>+${w.plus || 0}</span>
      <span class="dur-chip">耐久 ${(w.dur?.cur ?? def.durMax ?? 0)}/${(w.dur?.max ?? def.durMax ?? 0)}</span>
    </span>
  `;
  qs('#actLeft').textContent  = subLeft;
  qs('#actRight').textContent = subRight;

  btnsHtml = `
    <button class="opx primary" data-op="equip" data-type="weapon" data-idx="${idx}">裝備</button>
    <button class="opx"         data-op="sell"  data-type="weapon" data-idx="${idx}">販賣</button>
    <button class="opx"         data-op="throw" data-type="weapon" data-idx="${idx}">丟棄</button>
  `;
  } else {
    return;
  }

  qs('#actIcon').innerHTML = iconUrl ? `<img src="${iconUrl}" alt="">` : '';
  qs('#actBtns').innerHTML = btnsHtml;

  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
}

  function closeBagAction(){ const m = qs('#bagAction'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); qs('#actBtns').innerHTML = ''; }

  function seedBagIfMissing(){
    const P = state.player; if(!P) return;
    if (!P.bag) { P.bag = ItemDB.getDefaultBag(); return; }
    P.bag.consumables = Array.isArray(P.bag.consumables) ? P.bag.consumables : [];
    P.bag.weapons     = Array.isArray(P.bag.weapons)     ? P.bag.weapons     : [];
    P.bag.ornaments   = Array.isArray(P.bag.ornaments)   ? P.bag.ornaments   : [];
    P.bag.materials   = Array.isArray(P.bag.materials)   ? P.bag.materials   : [];
    P.bag.hidden      = Array.isArray(P.bag.hidden)      ? P.bag.hidden      : [];
  }


  function renderConsumables(box, P){
  const items = P.bag.consumables || [];
  const isUrl = s => typeof s === 'string' && /^https?:\/\//.test(s);

  items.forEach((it, i) => {
    const def = ItemDB.getDef('consumables', it.id) || {};
    const name  = it.name  || def.name  || it.id;
    const price = (it.price ?? def.price ?? 0);
    const effHp = (it.effect?.hp ?? def.effect?.hp);
    const effHtml = effHp ? `<span class="badge hp">氣血+${effHp}</span>` : '';
    const iconUrl = isUrl(it.icon) ? it.icon : (isUrl(def.icon) ? def.icon : null);
    const cnt = Math.max(0, it.count || 0);

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'consumable';
    row.dataset.idx  = String(i);

    row.innerHTML = `
      <div class="item-thumb">${iconUrl ? `<img src="${iconUrl}" alt="${name}">` : ''}</div>
      <div class="item-main">
        <div class="item-title cons">
          <span class="item-name">${name}</span>
          <span class="meta-effect">${effHtml}</span>
          <span class="count-slot">×${cnt}</span>
        </div>
        <div class="item-sub">
          <span class="sub-left"></span>
          <span class="sub-right">販售價格 ${price}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });
}


function renderWeapons(box, P){
  const items = P.bag.weapons || [];
  const url = (s)=> typeof s==='string' && /^https?:\/\//.test(s);

  items.forEach((w, i)=>{
    const def = ItemDB.getDef('weapons', w.id);
    const iconUrl = url(w.icon) ? w.icon : (url(def?.icon) ? def.icon : null);
    const name = w.name || def?.name || w.id;
    const r = (w.rarity || def?.rarity || '').trim();            // ★ 稀有度（普/精/稀/史/傳）
    const rCls = r ? `rarity-${r}` : '';
    const rBadge = r ? `<span class="rb rb-${r}" title="稀有度">${r}</span>` : '';

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'weapon';
    row.dataset.idx = String(i);

    row.innerHTML = `
      <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${name}">`:''}</div>
      <div class="item-main">
        <div class="item-title wep">
          <span class="badge-lv">LV.${w.level ?? def?.level ?? 1}</span>
          <span class="item-name ${rCls}">${rBadge}${String(name).replace(/^(普|精|稀|史|傳)的?/, '')}</span>
          <span class="right-meta">
            <span>+${w.plus || 0}</span>
            <span class="dur-chip">耐久 ${(w.dur?.cur ?? def?.durMax ?? 0)}/${(w.dur?.max ?? def?.durMax ?? 0)}</span>
          </span>
        </div>
        <div class="item-sub">
          <span class="sub-left">物理攻擊 ${(Array.isArray(w.dmg)?w.dmg[0]:(def?.dmg?.[0]??0))}-${(Array.isArray(w.dmg)?w.dmg[1]:(def?.dmg?.[1]??0))}</span>
          <span class="sub-right">販售價格 ${w.price ?? def?.price ?? 0}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });
}

/* ★ 新增：材料清單渲染 */
function renderMaterials(box, P){
  const items = P.bag.materials || [];
  const url = (s)=> typeof s==='string' && /^https?:\/\//.test(s);

  items.forEach((m, i)=>{
    const def = ItemDB.getDef('materials', m.id);
    const iconUrl = url(m.icon) ? m.icon : (url(def?.icon) ? def.icon : null);
    const cnt = Math.max(0, m.count || 0);
    const name = m.name || def?.name || m.id;
    const r = (m.rarity || def?.rarity || '').trim();            // ★ 稀有度（普/精/稀/史/傳）
    const rCls = r ? `rarity-${r}` : '';
    const rBadge = r ? `<span class="rb rb-${r}" title="稀有度">${r}</span>` : '';

    const row = document.createElement('div');
    row.className = 'item-row';
    row.dataset.type = 'material';
    row.dataset.idx = String(i);

    row.innerHTML = `
      <div class="item-thumb">${iconUrl?`<img src="${iconUrl}" alt="${name}">`:''}</div>
      <div class="item-main">
        <div class="item-title">
          <span class="item-name ${rCls}">${rBadge}${name}</span>
          <span class="count-slot">×${cnt}</span>
        </div>
        <div class="item-sub">
          <span class="sub-left">${def?.desc ? def.desc : (r ? '稀有度 '+r : '')}</span>
          <span class="sub-right">${def?.price ? `販售價格 ${def.price}` : ''}</span>
        </div>
      </div>
    `;
    box.appendChild(row);
  });

  if (!items.length){
    const tip = document.createElement('div'); tip.className='item-sub';
    tip.textContent = '尚無材料';
    box.appendChild(tip);
  }
}


  function bagUseConsumable(i){
    const P = state.player; const it = P.bag.consumables[i]; if(!it) return;
    if (it.effect?.hp){
      const hpMax = derivedFrom(P)['氣血上限'];
      P.hp = P.hp || {cur:hpMax,max:hpMax};
      P.hp.cur = Math.min(P.hp.cur + it.effect.hp, hpMax);
    }
    it.count = (it.count||0) - 1;
    if (it.count <= 0) P.bag.consumables.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('consumable');
  }
  function bagSellConsumable(i){
    const P = state.player; const it = P.bag.consumables[i]; if(!it) return;
    const max = it.count||0;
    const qty = +prompt(`輸入販賣數量（1-${max}）`, String(max));
    if (!qty || qty<1 || qty>max) return;
    P.currencies = P.currencies || {stone:0, diamond:0};
    P.currencies.stone += qty * (it.price||0);
    it.count -= qty;
    if (it.count <= 0) P.bag.consumables.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('consumable');
  }
  function bagThrowConsumable(i){
    const P = state.player; const it = P.bag.consumables[i]; if(!it) return;
    const max = it.count||0;
    const qty = +prompt(`輸入丟棄數量（1-${max}）`, String(max));
    if (!qty || qty<1 || qty>max) return;
    it.count -= qty;
    if (it.count <= 0) P.bag.consumables.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('consumable');
  }

  function bagEquipWeapon(i){
    const P = state.player; const w = P.bag.weapons[i]; if(!w) return;
    if (window.Equip && Equip.equipWeapon) {
      Equip.equipWeapon(w);
    } else {
      P.equip = P.equip || {}; P.equip.weapon = { ...w };
      if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
      renderDerived();
    }
    log(`已裝備：${w.name}`,'ok');
  }
  function bagSellWeapon(i){
    const P = state.player; const w = P.bag.weapons[i]; if(!w) return;
    if (!confirm(`確定要販賣：「${w.name}」？（可得 ${w.price} 靈石）`)) return;
    P.currencies = P.currencies || {stone:0, diamond:0};
    P.currencies.stone += (w.price||0);
    P.bag.weapons.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('weapon');
  }
  function bagThrowWeapon(i){
    const P = state.player; const w = P.bag.weapons[i]; if(!w) return;
    if (!confirm(`確定要丟棄：「${w.name}」？（不可回收）`)) return;
    P.bag.weapons.splice(i,1);
    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('weapon');
  }

  // === 材料：販賣 / 丟棄 ===
  function bagSellMaterial(i){
    const P = state.player; const it = P.bag.materials?.[i]; if(!it) return;
    const def = ItemDB.getDef('materials', it.id);
    const price = def?.price || 0;
    const max = it.count || 0;
    const qty = +prompt(`輸入販賣數量（1-${max}）`, String(max));
    if (!qty || qty < 1 || qty > max) return;

    P.currencies = P.currencies || { stone: 0, diamond: 0 };
    P.currencies.stone += qty * price;

    it.count -= qty;
    if (it.count <= 0) P.bag.materials.splice(i, 1);

    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('material');
  }

  function bagThrowMaterial(i){
    const P = state.player; const it = P.bag.materials?.[i]; if(!it) return;
    const max = it.count || 0;
    const qty = +prompt(`輸入丟棄數量（1-${max}）`, String(max));
    if (!qty || qty < 1 || qty > max) return;

    it.count -= qty;
    if (it.count <= 0) P.bag.materials.splice(i, 1);

    if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(P);
    render(P); renderBag('material');
  }

  function log(txt, cls=''){ const el=document.createElement('div'); el.className = `item ${cls}`; el.textContent = txt; const box=qs('#log'); if(!box) return; box.appendChild(el); box.scrollTop = box.scrollHeight; }
  function sendChat(){ const inp = qs('#chatInput'); const msg = (inp?.value||'').trim(); if(!msg) return; log(`你：${msg}`,'ok'); inp.value=''; }

  return {
    start(player){
      const p = Object.assign({
        level: 1,
        attributes: { str:10, vit:10, dex:10, int:10, wis:10, luk:10 },
        unspentPoints: 5,
        medals: [],
        equip: { weapon: null, earrings: [null,null], rings: [null,null], cloak: null, armor: null, shoes: null, medals: [null,null,null,null,null] },
        sta: { cur: 100, max: 100 },
        exp: { cur: 0,   max: 100 },
        hp:  { cur: 0,   max: 0 },
        currencies: { stone: 0, diamond: 0 },
      }, player || {});

    const hpMax = derivedFrom(p)['氣血上限'];

    // HP：若沒有就建立；若已有就只更新上限並夾在 0 ~ max 之間，不回滿
    if (!p.hp) {
      p.hp = { cur: hpMax, max: hpMax };
    } else {
      p.hp.max = hpMax;
      const cur = (p.hp.cur ?? hpMax);
      p.hp.cur = Math.max(0, Math.min(cur, hpMax));
    }

    // MP（真元）：同樣處理
    const mpMax = derivedFrom(p)['真元上限'];
    if (!p.mp) {
      p.mp = { cur: mpMax, max: mpMax };
    } else {
      p.mp.max = mpMax;
      const curM = (p.mp.cur ?? mpMax);
      p.mp.cur = Math.max(0, Math.min(curM, mpMax));
    }


    // 體力：同理，不強制回滿；沒有才給預設
    if (!p.sta) {
      p.sta = { cur: 100, max: 100 };
    } else {
      p.sta.max = p.sta.max ?? 100;
      const curSta = (p.sta.cur ?? p.sta.max);
      p.sta.cur = Math.max(0, Math.min(curSta, p.sta.max));
    }

    // 經驗：保留原本 cur，若越界就夾回範圍；沒有就用預設
    p.exp = {
      cur: Math.max(0, Math.min(p.exp?.cur ?? 0, p.exp?.max ?? 100)),
      max: p.exp?.max ?? 100
    };


      wire();
      render(p);
    },
    getPlayer(){ return state.player; },
    save(){ if (window.Auth && Auth.saveCharacter) Auth.saveCharacter(state.player); },
    recalc(){ render(state.player); renderDerived(); },
    log(txt, cls=''){ log(txt, cls); }
  };
})();

window.addEventListener('DOMContentLoaded', () => {
  const char = (window.Auth && Auth.getCharacter && Auth.getCharacter()) || null;
  if (!char) { window.location.href = 'index.html'; return; }

  Game.start(char);

  if (window.Equip && Equip.mount) {
    Equip.mount({
      getPlayer: () => Game.getPlayer(),
      save:      () => Game.save && Game.save(),
      recalc:    () => Game.recalc && Game.recalc(),
      log:       (t)=> Game.log ? Game.log(t) : console.log(t),
    });
  }
});
</script>
</body>
</html>
