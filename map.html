<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ä¿®ä»™RPGï½œé‡å¤–åœ°åœ–ï¼†æˆ°é¬¥</title>
  <style>
    :root{
      --bg:#0b1024; --bg2:#0e1536; --panel:#131a3f; --panel-2:#0f1534; --muted:#9aa3b2; --text:#eaf2ff;
      --accent:#8b5cf6; --accent2:#22d3ee; --hp:#ef4444; --mp:#3b82f6; --bar:#334155; --ok:#22c55e; --warn:#f59e0b;
      --gold:#b98c4b; --gold-2:#7a5b31; --radius:16px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
      --elem-none:#64748b; --elem-gold:#f59e0b; --elem-wood:#22c55e; --elem-water:#38bdf8;
      --elem-fire:#f97316; --elem-earth:#a16207; --elem-spirit:#a78bfa; --elem-dark:#0f172a;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%; margin:0; font-family:"Microsoft JhengHei",system-ui,Segoe UI,Roboto,sans-serif; color:var(--text); background:var(--bg);}

    .stage{
      position:fixed; inset:0;
      display:grid;
      align-items:start;            /* è®“ç•«é¢è²¼é½Šé ‚éƒ¨*/
      justify-items:center;
      overflow:auto;
      padding-top:env(safe-area-inset-top); /* ä¿ç•™ç€æµ·å®‰å…¨å€ */
    }

    .app{
      aspect-ratio: 93/150;
      width: min(100svw, calc(100svh * 93/150));
      max-height: 100svh;
      background: linear-gradient(180deg, var(--bg2), var(--panel));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex; flex-direction:column; overflow:hidden;
    }
    /* æ‰‹æ©Ÿç›´ç«‹å„ªåŒ–ï¼šè®“ App ç›´æ¥å¡«æ»¿è¦–çª—ï¼Œå»æ‰ä¸Šä¸‹é»‘é‚Š */
    @media (max-width: 480px){
      .app{
        width: 100svw;
        height: 100svh;       /* ç›´æ¥åƒæ»¿å¯è¦–é«˜åº¦ */
        max-height: none;
        aspect-ratio: auto;   /* å–æ¶ˆå›ºå®šæ¯”ä¾‹ */
        border-radius: 0;     /* è¦–è¦ºè²¼é½Šè¢å¹•é‚Šç·£ï¼ˆå¯ç§»é™¤ï¼‰ */
      }
    }

    /* Header */
    header{
      padding:10px 12px; background:rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:grid; grid-template-columns:1fr auto; grid-template-areas: "left right" "medals right";
      gap:8px 10px; align-items:center;
    }
    .h-left{grid-area:left; display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; min-width:0;}
    .avatar{width:44px; height:44px; border-radius:50%; object-fit:cover; background:#222; border:2px solid rgba(255,255,255,.15);}
    .pinfo{display:flex; flex-direction:column; min-width:0;}
    .prow{display:flex; align-items:center; gap:6px; flex-wrap:nowrap; min-width:0;}
    .pname{font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .plv{font-size:12px; opacity:.9;}
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 2px;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(255,255,255,0.08);
    }
    .pill.elem{ color:#fff; font-weight:600; }
    .pill.elem.none{  background:var(--elem-none);  }
    .pill.elem.gold{  background:var(--elem-gold);  }
    .pill.elem.wood{  background:var(--elem-wood);  }
    .pill.elem.water{ background:var(--elem-water); }
    .pill.elem.fire{  background:var(--elem-fire);  }
    .pill.elem.earth{ background:var(--elem-earth); }
    .pill.elem.spirit{background:var(--elem-spirit);}
    .pill.elem.dark{  background:var(--elem-dark);  }

    .medals{grid-area:medals; display:flex; gap:6px; min-width:0;}
    .medal-slot{width:30px; aspect-ratio:1/1; border-radius:50%; border:2px solid rgba(255,255,255,.25);
      display:flex; align-items:center; justify-content:center; font-size:12px; color:#cbd5e1; background:rgba(255,255,255,.06);
      overflow:hidden; flex:0 0 auto;}
    .h-right{grid-area:right; display:flex; flex-direction:column; align-items:flex-end; gap:8px; min-width:0;}
    .coins{display:flex; gap:8px; white-space:nowrap; min-width:0; flex-wrap:nowrap;}
    .coin{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-size:12px;}
    .icon-box{ width:18px; height:18px; border-radius:4px; overflow:hidden; display:grid; place-items:center; }
    .icon-box img{ width:100%; height:100%; object-fit:cover; display:block; }
    .val{max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .back-btn{padding:5px 10px; min-width:76px; font-size:12px; border-radius:999px; border:1px solid rgba(255,255,255,.2); background:#111827; color:#fff; font-weight:800; cursor:pointer; letter-spacing:.5px;}
    .logout-btn{padding:5px 10px; min-width:76px; font-size:12px; border-radius:999px; border:1px solid rgba(255,255,255,.2); background:#ef4444; color:#fff; font-weight:800; cursor:pointer; letter-spacing:.5px;}

    .divider{height:1px; background:rgba(255,255,255,.08); margin:1px 0;}
    .main{flex:1; display:flex; flex-direction:column; gap:10px; padding:8px 12px 10px; overflow:auto;}

    /* Barsï¼ˆç¸®å°å­—ç´šï¼‹æ›´ç´°èƒ½é‡æ¢ï¼‰ */
    .bars{
      display: grid;
      gap: 2px;
    }
    .stat-row{display:grid; grid-template-columns:48px 1fr 56px; align-items:center; gap:6px;}
    .label{font-size:12px; color:#e2e8f0; text-align:right;}
    .num{font-size:11px; color:#e2e8f0; text-align:right;}
    .prog{height:8px; background:#1f273a; border-radius:999px; position:relative; overflow:hidden; box-shadow: inset 0 1px 0 rgba(255,255,255,.06), inset 0 -1px 0 rgba(0,0,0,.25);}
    .fill{height:100%; width:0%;}
      .fill.sta{background:linear-gradient(90deg,#eab308,#f59e0b);}
      .fill.exp{background:linear-gradient(90deg,#16a34a,#4ade80);}
      .fill.hp{background:linear-gradient(90deg,#ef4444,#b91c1c);}
      .fill.mp{background:linear-gradient(90deg,#3b82f6,#1d4ed8);}

    /* Map selection */
    .map-wrap{display:grid; gap:10px;}
    .title{text-align:center; color:#c7d2fe; font-weight:900; letter-spacing:4px; padding-top:2px; font-size:14px;}

    /* å…©åˆ—é¸å–®ï¼šå·¦ï¼å¤§åœ°åœ–ï¼ˆæ¸…å–®ï¼‰ï¼å³ï¼å‰¯åœ°åœ–ï¼ˆæ¸…å–®ï¼‰ */
    .map-select{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .col{
      background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:8px; display:grid; grid-template-rows:auto 1fr;
      gap:8px; min-height:160px;
    }
    .col .clabel{font-size:12px; color:#a5b4fc; letter-spacing:2px;}
    .col .opts{
      display:flex; flex-direction:column; gap:6px; overflow:auto; padding-right:2px;
      -webkit-overflow-scrolling:touch;
    }
    /* æ¸…å–®æ¢ç›®ï¼ˆå­—å°ã€æ•´è¡Œå¯é»ï¼‰ */
    .tag{
      display:flex; align-items:center; justify-content:space-between; width:100%;
      padding:6px 10px; font-size:12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06);
      cursor:pointer; user-select:none;
    }
    .tag .name{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .tag .lv{margin-left:8px; font-size:11px; color:#93c5fd; opacity:.95; white-space:nowrap;}
    .tag{padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10); cursor:pointer; user-select:none; font-size:11px; line-height:1.1;}
    .tag.active{background:linear-gradient(135deg,var(--accent),var(--accent2));}

    /* é€²å…¥/å‹•ä½œå€ */
    .panel{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:8px; display:grid; gap:8px;}
    .btn {
      padding: 3px 7px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg,var(--accent),var(--accent2));
      color: #fff;
      font-weight: 500;
      font-size: 11px;  /* æ–°å¢å­—é«”å¤§å° */
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .btn.ghost{background:transparent; color:#fff; border:1px solid rgba(255,255,255,.2);}
    .btn[disabled]{opacity:.5; filter:grayscale(1); cursor:not-allowed;}

    .row{display:flex; gap:8px; flex-wrap:wrap;}
    .hint{font-size:9px; color:#93c5fd; text-align:center;}

   /* === åœ°å€æƒ…å ±ï¼ˆå›ºå®šæ¬„ä½ãƒ»é›™æ¬„ï¼‰ === */
    .panel.info{ padding:6px 8px; }
    .info-title{
      font-size:11px; color:#a5b4fc; letter-spacing:1.5px;
      margin-bottom:4px; opacity:.95;
    }
    /* å›ºå®šé›™æ¬„ï¼šå·¦æ¬„è¼ƒå¯¬ï¼ˆæ€ªç‰©ï¼‰ï¼Œå³æ¬„ç¨çª„ï¼ˆäº‹ä»¶ï¼‰ */
    .info-grid{
      display:grid; grid-template-columns: minmax(0,1.35fr) minmax(0,.85fr);
      gap:6px 10px; align-items:start;
    }
    .info-col{ display:grid; gap:4px; min-width:0; }
    .info-label{ font-size:11px; color:#e2e8f0; opacity:.8; }

    /* æ€ªç‰©è† å›Šï¼ˆæ›´ç·Šæ¹Šï¼‰ */
    .chip-list{ display:flex; flex-wrap:wrap; gap:6px; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 6px; border-radius:8px;
      border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08);
      font-size:11px; line-height:1.1; white-space:nowrap;
      max-width:100%;
    }
    .chip .mname{
      max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .chip .mlv{ font-size:10px; opacity:.75; }

    /* åœ°å€æƒ…å ±ä¸­çš„å…ƒç´ è† å›Šç¸®å°ä¸€è™Ÿ */
    .info .pill.elem{
      padding:0 6px; border-radius:8px;
      font-size:10px; line-height:1.1;
    }

    /* äº‹ä»¶åˆ—è¡¨ï¼ˆçœŸæ­£é½Šé ­ï¼šæŠŠåˆ†éš”é»æ”¾åœ¨å‰ä¸€å€‹é …ç›®çš„å°¾ç«¯ï¼‰ */
    .event-list{
      display:flex; flex-wrap:wrap; gap:6px 10px;
      margin:0; padding:0; list-style:none; font-size:11px; color:#cbd5e1;
    }
    .event-list li{
      display:flex; align-items:center;
    }
    .event-list li::before{ content:''; } /* æ¸…ç©ºä¸Šä¸€ç‰ˆçš„å‰ç½®é»ï¼ˆé¿å…å¿«å–é€ æˆæ®˜ç•™ï¼‰ */
    .event-list li:not(:last-child)::after{
      content:'ãƒ»'; margin-left:6px; opacity:.55;
    }


    /* Battle UI */
    .battle{display:none; grid-template-rows:auto 1fr auto; gap:10px; min-height:340px;}
    .battle.show{display:grid;}
    .arena{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3px;
      align-items: end;
      padding: 8px;
      border-radius: 25px;
      background: rgb(206 224 231 / 23%);
      border: 1px solid rgba(255,255,255,.12);
    }
    .box{
      background: rgba(0,0,0,.3);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      padding: 3px;
      display: grid;
      gap: 2px;
    }
    /* ç«‹ç¹ªå®¹å™¨ï¼ˆä¿ç•™ä¸€é»é‚Šè·ï¼‰ */
    .art{
      width: 100%;
      height: 125px;
      border-radius: 10px;
      background: linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.15));
      display: grid;
      place-items: center;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      position: relative;
    }

    /* 100Ã—100 é ­åƒæ¡†ï¼šç©å®¶åœ“å½¢ã€æ•µäººæ–¹å½¢ */
    .frame{
      width: 140px;
      height: 120px;
      display: grid;
      place-items: center;
      overflow: hidden;
      background: rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      align-items: stretch;
    }
    .p-frame{ border-radius:8px; }        /* ç©å®¶åœ“å½¢ */
    .e-frame{ border-radius:8px; }       /* æ•µäººæ–¹å½¢ï¼Œå¸¶ä¸€é»åœ“è§’ */

    /* å…§éƒ¨åœ–ç‰‡ï¼šä»¥ 100Ã—100 ç´ æç‚ºä¸»ï¼Œä¿æŒå®Œæ•´é¡¯ç¤º */
    .portrait{
      width: 130px;
      height: 110px;
      object-fit: contain;
      display: block;
      image-rendering: auto;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.35));
      transition: opacity 600ms ease, transform 600ms ease;
    }
    .portrait.mirror{ transform: scaleX(-1); }
    .portrait.fade-out{ opacity:0; transform: scale(0.96); }

    /* â˜… æ–°å¢ï¼šæ¯æ¬¡é­é‡æ€ªç‰©çš„ç¿»è½‰é€²å ´å‹•ç•«ï¼ˆæ›åœ¨æ•µäººæ¡† .e-frame ä¸Šï¼Œä¸å½±éŸ¿ .mirrorï¼‰ */
    @keyframes flipIn {
      0%   { transform: perspective(600px) rotateY(90deg) scale(0.95); opacity:0; }
      50%  { transform: perspective(600px) rotateY(10deg) scale(1.02); opacity:1; }
      100% { transform: perspective(600px) rotateY(0deg)  scale(1.00); opacity:1; }
    }
    .e-frame.flip-in{
      animation: flipIn 520ms ease;
    }



    .who{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .name {
    font-weight: 900;
    font-size: 8pt;
    }

    .hpbar{height:6px; background:#1f273a; border-radius:999px; overflow:hidden;}
    .hpfill{height:100%; width:0%; background:linear-gradient(90deg,#ef4444,#b91c1c);}
    .atb{height:6px; background:#0b122b; border-radius:999px; overflow:hidden;}
    .atbfill{height:100%; width:0%; background:linear-gradient(90deg,#22d3ee,#8b5cf6);}
    .srow{display:flex; gap:10px; font-size:12px; color:#cbd5e1;}
    .cmd{display:grid; grid-template-columns:repeat(4,1fr); gap:8px;}
    .cbtn{
    padding: 4px 6px;
    text-align: center;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.2);
    background: linear-gradient(#a6783e,#7f5626);
    box-shadow: inset 0 2px 0 rgba(255,255,255,.15), 0 2px 0 rgba(0,0,0,.2);
    font-weight: 800;
    letter-spacing: 2px;
    color: #fff;
    cursor: pointer;
    user-select: none;
    }
    .cbtn[disabled]{opacity:.5; filter:grayscale(1); cursor:not-allowed;}
    /* â˜… æ”¹å–„æˆ°é¬¥ï¼åœ°åœ–æ—¥èªŒï¼šåŠ å¤§ã€åŠ è¡Œè·ã€èƒŒæ™¯é€é»‘ï¼Œä¸¦åŠ å…¥åˆ†é¡è‰² */
    .log{
      height: 100px;
      overflow: auto;
      padding: 10px 12px;
      font-size: 10px;
      line-height: 1.35;
      background: rgba(6,10,26,0.8);
      border: 1px solid rgba(255,255,255,.3);
      border-radius: 8px;
    }

    /* æ”»æ“ŠæŒ‰éˆ• */
    #actAttack {
    background: linear-gradient(45deg, #8b0000, #dc143c);
    color: #ffd700;
    border: 2px solid #4b0000;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }   


    /* æ¯æ¢è¨Šæ¯åº•ä¸‹ç•™ä¸€é»é–“è· */
    .log > div{ margin-bottom:4px; }
    /* æ—¥èªŒåˆ†é¡é¡è‰²ï¼šå‘¼æ‡‰å…¨åŸŸè®Šæ•¸ ok/warn/hp ç­‰ */
    .log .ok  { color: var(--ok);   }
    .log .warn{ color: var(--warn); }
    .log .hit { color: var(--hp);   }
    .log .crit{ color:#ffd166;     }
    .log .heal{ color:#34d399;     }


    .footrow{display:flex; gap:8px; justify-content:space-between; align-items:center;}
    .locBadge{font-size:10px; color:#e2e8f0;}

    /* ===== å—æ“Š/æµ®å­—ç‰¹æ•ˆ ===== */
    .art{ position:relative; }            /* è®“ fx å¯ä»¥çµ•å°å®šä½åœ¨ç«‹ç¹ªä¸Š */
    .fx{ position:absolute; inset:0; pointer-events:none; overflow:visible; }
    .dmg-float{
      position:absolute; left:50%; top:45%;
      transform: translate(-50%,-50%);
      font-weight:900; font-size:22px; letter-spacing:1px;
      text-shadow:0 2px 0 rgba(0,0,0,.35), 0 0 12px rgba(255,255,255,.2);
      animation: rise 900ms ease-out forwards;
      user-select:none; white-space:nowrap;
    }
    .dmg-float.crit{ font-size:26px; filter: drop-shadow(0 0 8px rgba(255,215,0,.55)); }
    .dmg{ color:#ff6b6b; }
    .heal{ color:#34d399; }
    .crit{ color:#ffd166; }

    .flash{
      position:absolute; inset:0;
      background: radial-gradient( circle at 50% 45%, rgba(255,80,80,.55), rgba(255,0,0,.15) 60%, transparent 70% );
      mix-blend-mode: screen;
      border-radius:10px;
      animation: flash 220ms ease-out forwards;
    }

    .portrait.shake{ animation: shake .28s cubic-bezier(.36,.07,.19,.97) 2; transform-origin:center; }

    @keyframes flash{
      0%{ opacity:0; }
      10%{ opacity:.95; }
      100%{ opacity:0; }
    }
    @keyframes rise{
      0%{ transform:translate(-50%,-20%) scale(.9); opacity:0; }
      15%{ transform:translate(-50%,-40%) scale(1.05); opacity:1; }
      100%{ transform:translate(-50%,-110%) scale(1.0); opacity:0; }
    }
    @keyframes shake{
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-4px); }
      40%, 60% { transform: translateX(4px); }
    } 

    /* === æŠ€èƒ½æ©«å¹… & æ–½æ”¾æ™‚çš„ç•«é¢æ»‘å‹• === */
    .skill-banner{
      position: fixed; inset: 0; z-index: 9999; pointer-events: none;
      display: grid; place-items: center;
    }
    .skill-banner::before{
      content:''; position:absolute; inset:-10%;
      background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,.08) 50%, transparent 70%);
      transform: translateX(-60%);
      animation: skillSweep 900ms ease-out forwards;
      mix-blend-mode: screen;
    }
    .skill-banner .wrap{
      padding: 8px 14px; border-radius: 12px;
      background: rgba(14,21,54,.45);
      border: 1px solid rgba(255,255,255,.25);
      backdrop-filter: blur(2px);
      text-align: center; letter-spacing: .2em;
      text-shadow: 0 1px 0 rgba(0,0,0,.6), 0 0 10px rgba(255,255,255,.15);
      font-weight: 900; color: #eaf2ff;
      opacity: 0; transform: translateY(-12px) scale(.98);
      animation: bannerIn 900ms ease-out forwards;
    }
    .skill-banner .title{ font-size: 12px; opacity:.85; margin-bottom: 4px; }
    .skill-banner .name{ font-size: 22px; }
    .skill-banner .elem-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px; margin-top:6px; border-radius:999px; font-size:12px;
      border:1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.08);
    }
    .skill-banner .elem-pill.wind{ background: var(--elem-water); color:#0b1024; } /* é¢¨è‰²ç³»ä½ å¯è‡ªè¡Œæ”¹ */

    @keyframes bannerIn{
      0%{ opacity:0; transform: translateY(-14px) scale(.98); }
      40%{ opacity:1; transform: translateY(0) scale(1.02); }
      100%{ opacity:1; transform: translateY(0) scale(1.0); }
    }
    @keyframes skillSweep{
      to{ transform: translateX(60%); }
    }
    /* æ–½æ”¾ç¬é–“è®“æ•´å€‹ App æœ‰é»ä½ç§»ï¼ˆç›¸æ©Ÿå¹³ç§»æ„Ÿï¼‰ */
    .app.pan{
      animation: camPan 420ms cubic-bezier(.2,.8,.2,1);
    }
    @keyframes camPan{
      0%{ transform: translateX(0); }
      35%{ transform: translateX(-10px); }
      100%{ transform: translateX(0); }
    }

  </style>
</head>
<body>
<div class="stage">
  <div class="app">
    <header>
      <div class="h-left">
        <img id="uiAvatar" class="avatar" alt="avatar" />
        <div class="pinfo">
          <div class="prow">
            <div class="pname" id="uiName"></div>
            <div class="plv">LV.<span id="uiLv"></span></div>
            <span id="uiElem" class="pill elem none"></span>
          </div>
        </div>
      </div>
      <div class="medals">
        <div class="medal-slot" id="medal1"></div>
        <div class="medal-slot" id="medal2"></div>
        <div class="medal-slot" id="medal3"></div>
        <div class="medal-slot" id="medal4"></div>
        <div class="medal-slot" id="medal5"></div>
      </div>
      <div class="h-right">
        <div class="coins">
          <span class="coin">
            <span class="icon-box"><img alt="éˆçŸ³" src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Crystal_128_up.png"></span>
            <span class="val" id="uiStone">0</span>
          </span>
          <span class="coin">
            <span class="icon-box"><img alt="é‘½çŸ³" src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Diamond_Icon.svg"></span>
            <span class="val" id="uiDiamond">0</span>
          </span>
        </div>
        <div class="row">
          <button id="btnBackHome" class="back-btn" title="è¿”å›ä¸»åŸ">è¿”å›ä¸»åŸ</button>
          <button id="btnLogout" class="logout-btn" title="ç™»å‡º" aria-label="ç™»å‡º">ç™»å‡º</button>
        </div>
      </div>
    </header>

    <div class="divider"></div>

    <div class="main">
      <!-- é¡¯ç¤ºé«”åŠ›/ç¶“é©—/æ°£è¡€ -->
    <div class="bars">
      <div class="stat-row">
        <div class="label">é«”åŠ›ï¼š</div>
        <div class="prog"><div class="fill sta" id="barSta"></div></div>
        <div class="num" id="txtSta">100/100</div>
      </div>
      <div class="stat-row">
        <div class="label">ç¶“é©—ï¼š</div>
        <div class="prog"><div class="fill exp" id="barExp"></div></div>
        <div class="num" id="txtExp">0/100</div>
      </div>
      <div class="stat-row">
        <div class="label">æ°£è¡€ï¼š</div>
        <div class="prog"><div class="fill hp" id="barHp"></div></div>
        <div class="num" id="txtHp">--/--</div>
      </div>
      <div class="stat-row">
        <div class="label">çœŸå…ƒï¼š</div>
        <div class="prog"><div class="fill mp" id="barMp"></div></div>
        <div class="num" id="txtMp">--/--</div>
      </div>
    </div>

<!-- åœ°åœ–é¸æ“‡ -->
      <div id="mapSection" class="map-wrap">
        <div class="title">é‡ å¤– åœ° åœ–</div>

        <!-- å…©åˆ—é¸å–®ï¼šå·¦å¤§åœ°åœ–ã€å³å‰¯åœ°åœ–ï¼ˆä¾å·¦å´é¸æ“‡å‹•æ…‹è®ŠåŒ–ï¼‰ -->
        <div class="map-select">
          <div class="col">
            <div class="clabel">å¤§åœ°åœ–</div>
            <div class="opts" id="bigMapCol"></div>
          </div>
          <div class="col">
            <div class="clabel">å‰¯åœ°åœ–</div>
            <div class="opts" id="smallMapCol"></div>
          </div>
        </div>

        <!-- å…ˆæŒ‰ã€Œé€²å…¥ã€æ‰æœƒé¡¯ç¤ºæ¢éšª/æˆ°é¬¥ -->
      <div class="panel">
        <div class="locBadge" id="locBadge">å°šæœªé¸æ“‡åœ°é»</div>
        <div class="row">
          <button id="btnEnter"   class="btn" disabled>é€² å…¥</button>
          <button id="btnExplore" class="btn" style="display:none;">æ¢éšªï¼ˆé«”åŠ›-2ï¼‰</button>
          <button id="btnFight"   class="btn" style="display:none;">æˆ° é¬¥</button>
          <!-- â˜… æ–°å¢ï¼šæŒ‘æˆ° BOSSï¼ˆç´…è‰²ï¼‰ -->
          <button id="btnBoss"    class="btn" style="display:none; background:#b91c1c; border:1px solid #dc2626;">æŒ‘æˆ° BOSS</button>
        </div>
        <div class="hint">è«‹å…ˆé¸æ“‡ã€Œå¤§åœ°åœ– â†’ å‰¯åœ°åœ–ã€ä¸¦æŒ‰ä¸‹ã€Œé€²å…¥ã€ã€‚é€²å…¥å¾Œæ‰æœƒé¡¯ç¤ºã€Œæ¢éšª / æˆ°é¬¥ã€ã€‚</div>
        <!-- â˜… æ–°å¢ï¼šèŠå§†æ´çªŸé€²åº¦æç¤º -->
        <div id="slimeQuestHint" class="hint" style="display:none;"></div>
      </div>

        <!-- â˜… åœ°å€æƒ…å ±ï¼ˆå›ºå®šæ¬„ä½ï½œé›™æ¬„ï¼šå·¦=æ€ªç‰©ï¼Œå³=äº‹ä»¶ï¼‰ -->
        <div class="panel info" id="areaInfo">
          <div class="info-title">åœ° å€ æƒ… å ±</div>
          <div class="info-grid">
            <div class="info-col info-left">
              <div class="info-label">å¯èƒ½å‡ºç¾çš„æ€ªç‰©</div>
              <div id="infoMonsters" class="chip-list"><span class="chip">â€”</span></div>
            </div>
            <div class="info-col info-right">
              <div class="info-label">æ¢éšªå¯èƒ½äº‹ä»¶</div>
              <ul id="infoEvents" class="event-list">
                <li>æ’¿åˆ°éˆçŸ³ï¼ˆç´„ 50%ï¼‰</li>
                <li>ç™¼ç¾ç´ æï¼ˆç´„ 30%ï¼‰</li>
                <li>ç²å¾—ä¸¹è—¥ï¼ˆç´„ 20%ï¼‰</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- â˜… äº‹ä»¶ï¼æˆ°é¬¥æ—¥èªŒï¼ˆèˆ‡æˆ°é¬¥å…±ç”¨åŒä¸€å€‹ #logï¼‰ -->
        <div class="panel">
          <div class="log" id="logMap"></div>
        </div>
      </div>

      <!-- æˆ°é¬¥å ´æ™¯ -->
      <div id="battleSection" class="battle">
        <div class="arena">
        <div class="box">
          <div class="who">
          <div class="name">ä½ </div>
          <div class="srow">
            <span>LV.<span id="pLv"></span></span>
            <span id="pElem" class="pill elem">â€”</span>
          </div>
        </div>
          <div class="art">
            <div class="frame p-frame">
              <img id="pImg" class="portrait" alt="player portrait">
            </div>
            <div class="fx" id="pFx"></div>
          </div>
          <div class="hpbar"><div id="pHp" class="hpfill"></div></div>
          <div class="atb"><div id="pATB" class="atbfill"></div></div>
        </div>
        <div class="box">
          <div class="who">
          <div class="name" id="eName">æ•µäºº</div>
          <div class="srow">
            <span>LV.<span id="eLv"></span></span>
            <span id="eElem" class="pill elem">â€”</span>
          </div>
        </div>
          <div class="art">
            <div class="frame e-frame">
              <img id="eImg" class="portrait mirror" alt="enemy portrait">
            </div>
            <div class="fx" id="eFx"></div>
          </div>
          <div class="hpbar"><div id="eHp" class="hpfill"></div></div>
          <div class="atb"><div id="eATB" class="atbfill"></div></div>
        </div>
        </div>
        <div class="cmd">
          <button id="actAttack" class="cbtn" disabled>æ”» æ“Š</button>
          <button id="actSkill"  class="cbtn" disabled title="é ç•™">æŠ€ èƒ½</button>
          <button id="actItem"   class="cbtn" disabled>é“ å…·</button>
          <button id="actRun"    class="cbtn" disabled>é€ƒ è·‘</button>
        </div>
        <div class="log" id="logBattle"></div>
        <div class="footrow">
          <div id="btState" class="locBadge"></div>
          <div class="row">
            <button id="btnLeaveBattle" class="btn ghost" style="display:none;">è¿”å›å°åœ°åœ–</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebaseï¼ˆcompat ç‰ˆï¼Œå… ES Moduleï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  (function(){
    var firebaseConfig = {
      apiKey: "AIzaSyBvKmn0jCTS_jIgEYOuQjc8vyYU40Q5F3I",
      authDomain: "stellarblue-system.firebaseapp.com",
      databaseURL: "https://stellarblue-system-default-rtdb.firebaseio.com",
      projectId: "stellarblue-system",
      storageBucket: "stellarblue-system.firebasestorage.app",
      messagingSenderId: "803212433649",
      appId: "1:803212433649:web:887080d10a51d533b23150",
      measurementId: "G-YY94484DV9"
    };
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(firebaseConfig);
    }
    // æä¾›çµ¦ auth.js ä½¿ç”¨
    window.DB = firebase.database();
  })();
</script>
<!-- è³‡æ–™åº«/å¸³è™Ÿ -->
<script src="stats.js"></script>
<script src="items.js"></script>
<script src="skills.js"></script>
<script src="monsters.js"></script>
<script src="equip.js"></script><!-- â˜…æ–°å¢ï¼šè£å‚™æ¨¡çµ„ï¼Œç¢ºä¿ getBonuses ä¸€è‡´ -->
<script src="auth.js"></script>


<script>
/* ===== å·¥å…· ===== */
const qs = (s, p=document)=>p.querySelector(s);
const qsa = function(s, p){
  p = p || document;
  return Array.prototype.slice.call(p.querySelectorAll(s));
};
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const pct=(cur,max)=> (max>0? clamp(Math.round(cur/max*100),0,100) : 0);
const fmt=(n)=> new Intl.NumberFormat('zh-Hant').format(n);

/* ===== å…ƒç´ ç³»çµ±ï¼ˆå·²ç§»è‡³ stats.jsï¼‰ ===== */
// æ‰€æœ‰å…ƒç´ ç›¸é—œå‡½æ•¸éƒ½åœ¨ stats.js ä¸­å®šç¾©
// é€™è£¡åªéœ€è¦ç¢ºä¿èƒ½æ­£å¸¸ä½¿ç”¨å³å¯



// ç©å®¶é è¨­ç«‹ç¹ªï¼ˆè‹¥æ²’æœ‰ avatar æ‰ç”¨é€™å¼µï¼‰
const PLAYER_IMG_URL = 'https://picsum.photos/seed/xian-hero/400/600';



/* ===== åœ°åœ–è³‡æ–™ï¼ˆå¤§åœ°åœ– -> å°åœ°åœ–ï¼‰ ===== */
const MAPS = [
{ id:'forest', name:'é’æœ¨å±±è„ˆ', lv:'1-10', small:[
  { id:'slime_cave',  name:'èŠå§†æ´çªŸ', lv:'1-3',
    monsters:['slime_young','slime','slime_king'], 
    boss:'slime_boss', killsRequired: 8 },
  { id:'woodland',    name:'ç«æ—æ´',   lv:'4-7',
    monsters:['wood_wisp','Fire_Spirit','laily',"fire_orb"], 
    boss:'flame_master', killsRequired: 12 },
  { id:'moss_vale',   name:'è‹”çŸ³è°·',   lv:'2-4',
    monsters:['slime','stone_golem'],  
    boss:'stone_golem_boss', killsRequired: 10 },
]},
{ id:'tundra', name:'é›ªåŸå°åœ°', lv:'3-5', small:[
  { id:'snowfield',   name:'é›ªåŸç‹©å ´', lv:'3-4',
    monsters:['snow_wolf','ice_thorn'], 
    boss:'ice_bear_boss', killsRequired: 10 },
  { id:'ice_cave',    name:'å¯’æ™¶æ´ç©´', lv:'4-5',
    monsters:['ice_bear','ice_thorn'], 
    boss:'ice_cave_boss', killsRequired: 12 },  // â˜… åŠ ä¸Š boss
]},
{ id:'ruins', name:'å¹½æ€¨éºè·¡', lv:'5-7', small:[
  { id:'spirit_hall', name:'éˆä¾å¤§æ®¿', lv:'4-6',
    monsters:['spirit_acolyte','wraith'], 
    boss:'spirit_acolyte_boss', killsRequired: 15 },
  { id:'shadow_pit',  name:'å½±ç¿¼æ·±å‘', lv:'4-6',
    monsters:['shadow_bat','wraith'],     
    boss:'shadow_bat_boss', killsRequired: 15 },
]},
{ id:'canyon', name:'ç£çŸ³å³½è°·', lv:'3-6', small:[
  { id:'beetle_ridge', name:'é›·è§’å¶º',  lv:'5-6',
    monsters:['brass_beetle','thunder_beetle'], 
    boss:'thunder_beetle_boss', killsRequired: 18 },
  { id:'bog',          name:'æ³¥æ½­çªªåœ°',lv:'3-5',
    monsters:['bog_tortoise','stone_golem'],    
    boss:'ancient_tortoise_boss', killsRequired: 14 },
]},
];



/* ===== ç©å®¶/å°å…¥è§’è‰² ===== */
let P = null;           // ç©å®¶è§’è‰²
let curBig = null;      // ç¾åœ¨é¸çš„å¤§åœ°åœ– id
let curSmall = null;    // ç¾åœ¨é¸çš„å°åœ°åœ– id
let entered = false;    // æ˜¯å¦å·²æŒ‰ã€Œé€²å…¥ã€ï¼Œæœªé€²å…¥å‰ä¸é¡¯ç¤ºæ¢éšª/æˆ°é¬¥

// å–å¾—ç©å®¶ï¼ˆå¾ Auth / localStorageï¼‰
function loadPlayer(){
  if(!window.Auth || !Auth.getCharacter){ alert('æ‰¾ä¸åˆ°å¸³è™Ÿç³»çµ±'); return null; }
  const c = Auth.getCharacter();
  if(!c){ location.href = 'index.html#create'; return null; }

  // ç¢ºä¿èƒŒåŒ…å­˜åœ¨ & çµæ§‹é½Šå…¨
  if(!c.bag){
    c.bag = (window.ItemDB && ItemDB.getDefaultBag) ? ItemDB.getDefaultBag() 
      : { consumables:[], weapons:[], ornaments:[], materials:[], hidden:[] };
  }else{
    c.bag.consumables = Array.isArray(c.bag.consumables) ? c.bag.consumables : [];
    c.bag.weapons     = Array.isArray(c.bag.weapons)     ? c.bag.weapons     : [];
    c.bag.ornaments   = Array.isArray(c.bag.ornaments)   ? c.bag.ornaments   : [];
    c.bag.materials   = Array.isArray(c.bag.materials)   ? c.bag.materials   : [];
    c.bag.hidden      = Array.isArray(c.bag.hidden)      ? c.bag.hidden      : [];
  }

  // HP æ¬„ä½è‹¥ä¸å­˜åœ¨ï¼Œå»ºç«‹ï¼ˆæ²¿ç”¨ä½ çš„è¡ç”Ÿè¦å‰‡ï¼‰
  if(!c.hp){ 
    const d=derivedFrom(c); 
    c.hp = { cur:d['æ°£è¡€ä¸Šé™'], max:d['æ°£è¡€ä¸Šé™'] }; 
  }
}

async function savePlayer(){
  try{
    if (typeof P !== 'undefined' && P){
      // æ¨™è¨˜æœ¬åœ°æ™‚é–“æˆ³ï¼Œä¸»åŸ/å…¶ä»–é æ¯”å°å¿«å–èˆ‡é›²ç«¯æ™‚æœƒé¸ç”¨è¼ƒæ–°ç‰ˆæœ¬
      P._updatedAt = Date.now();

      if (window.Auth){
        // â˜… Firebase å®‰å…¨è™•ç†ï¼šç§»é™¤ _live é¿å…ç‰¹æ®Šå­—ç¬¦å•é¡Œ
        var saveData = JSON.parse(JSON.stringify(P)); // æ·±æ‹·è²
        delete saveData._live; // ç§»é™¤åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„ _live ç‰©ä»¶
        
        // â˜… å¼·åˆ¶åŒæ­¥ï¼šå…ˆæ›´æ–°æœ¬åœ°å¿«å–
        if (Auth.setCharacter) {
          try{ 
            Auth.setCharacter(saveData); 
            console.log('âœ… æœ¬åœ°å¿«å–å·²æ›´æ–°:', saveData.level, saveData.exp, saveData.hp, saveData.sta);
          }catch(_e){
            console.error('âŒ æœ¬åœ°å¿«å–æ›´æ–°å¤±æ•—:', _e);
          }
        }
        
        // â˜… å¼·åˆ¶åŒæ­¥ï¼šå†å¯«é›²ç«¯ï¼ˆåŠ é‡è©¦æ©Ÿåˆ¶ï¼‰
        if (Auth.saveCharacter) {
          var retries = 3;
          while(retries > 0){
            try{
              await Auth.saveCharacter(saveData);
              console.log('âœ… é›²ç«¯å­˜æª”æˆåŠŸ:', saveData.level, saveData.exp);
              break;
            }catch(saveErr){
              retries--;
              console.warn('âš ï¸ é›²ç«¯å­˜æª”å¤±æ•—ï¼Œå‰©é¤˜é‡è©¦æ¬¡æ•¸:', retries, saveErr);
              if(retries > 0) await new Promise(r => setTimeout(r, 500)); // ç­‰å¾… 500ms é‡è©¦
            }
          }
        }
      }
    }
  }catch(e){
    console.error('âŒ savePlayer æ•´é«”å¤±æ•—:', e);
  }
}








// === åªç®—ä¸€æ¬¡çš„ã€Œæœ€çµ‚èƒ½åŠ›å¿«ç…§ã€ï¼šåŸºç¤è¡ç”Ÿ + è£å‚™åŠ æˆ ===
function finalDerived(player){
  var base  = (typeof derivedFrom==='function') ? (derivedFrom(player)||{}) : {};
  var bonus = (window.Equip && typeof Equip.getBonuses==='function') ? (Equip.getBonuses()||{}) : {};
  var out = {};
  // ç›¸ç•¶æ–¼ { ...base }
  for (var k in base) {
    if (Object.prototype.hasOwnProperty.call(base, k)) out[k] = base[k];
  }
  // ç–ŠåŠ è£å‚™åŠ æˆ
  for (var k2 in bonus) {
    if (Object.prototype.hasOwnProperty.call(bonus, k2)) {
      out[k2] = (out[k2]||0) + (bonus[k2]||0);
    }
  }
  return out;
}



// é‡æ–°æ•´ç†å¿«ç…§ï¼ˆé€²åœ°åœ–ã€é–‹å§‹æˆ°é¬¥ã€å‡ç´šå¾Œéƒ½å¯å‘¼å«ï¼‰
function refreshLive(){
  if(!P) return;
  P._live = finalDerived(P);
}

/* ===== UI Render ===== */
function renderHeader(){
  const fallbackAvatar = (typeof Auth!=='undefined' && Auth.defaultAvatar)
    ? (Auth.defaultAvatar() || 'https://picsum.photos/seed/xian/96')
    : 'https://picsum.photos/seed/xian/96';
  qs('#uiAvatar').src = P.avatar || fallbackAvatar;
  qs('#uiName').textContent = P.name || 'ç„¡åæ•£ä¿®';
  qs('#uiLv').textContent   = P.level ?? 1;
  const elem = (P.element || 'none').toLowerCase();
  const elemEl = qs('#uiElem'); elemEl.className = `pill elem ${elem}`; elemEl.textContent = ELEMENT_LABEL[elem] || 'ç„¡å…ƒç´ ';

  qs('#uiStone').textContent   = fmt(P.currencies?.stone || 0);
  qs('#uiDiamond').textContent = fmt(P.currencies?.diamond || 0);
}

 // ç©å®¶é€²å…¥å¾Œé€£å‹•çš„èƒ½é‡æ¢

function renderBars(){
  if (!P) return;
  if (!P._live) refreshLive();

  // â€”â€” ä»¥ API ç‹€æ…‹ç‚ºä¸»ï¼šåƒ…è£œé è¨­ã€é™åˆ¶ç¯„åœï¼Œä¸è‡ªè¡Œå›æ»¿ â€”â€” //
  if (!P.sta){ P.sta = { cur:100, max:100 }; }
  else{
    if (typeof P.sta.max !== 'number' || P.sta.max <= 0) P.sta.max = 100;
    if (typeof P.sta.cur !== 'number') P.sta.cur = P.sta.max;
    if (P.sta.cur > P.sta.max) P.sta.cur = P.sta.max;
    if (P.sta.cur < 0) P.sta.cur = 0;
  }

  if (!P.exp){ P.exp = { cur:0, max:100 }; }
  else{
    if (typeof P.exp.max !== 'number' || P.exp.max <= 0) P.exp.max = 100;
    if (typeof P.exp.cur !== 'number') P.exp.cur = 0;
    if (P.exp.cur > P.exp.max) P.exp.cur = P.exp.max;
    if (P.exp.cur < 0) P.exp.cur = 0;
  }

  // ä¸Šé™çµ±ä¸€ï¼šåŸºç¤ + è£å‚™åŠ æˆï¼ˆèˆ‡ä¸»åŸç›¸åŒè¨ˆç®—ï¼‰
  var base  = derivedFrom(P);
  var bonus = (window.Equip && typeof Equip.getBonuses === 'function') ? (Equip.getBonuses() || {}) : {};
  var hpMax = (base['æ°£è¡€ä¸Šé™'] || 0) + (bonus['æ°£è¡€ä¸Šé™'] || 0);
  var mpMax = (base['çœŸå…ƒä¸Šé™'] || 0) + (bonus['çœŸå…ƒä¸Šé™'] || 0);

  if (!P.hp){ P.hp = { cur: hpMax, max: hpMax }; }
  else{
    P.hp.max = hpMax;
    if (typeof P.hp.cur !== 'number') P.hp.cur = hpMax;
    if (P.hp.cur > P.hp.max) P.hp.cur = P.hp.max;
    if (P.hp.cur < 0) P.hp.cur = 0;
  }

  if (!P.mp){ P.mp = { cur: mpMax, max: mpMax }; }
  else{
    P.mp.max = mpMax;
    if (typeof P.mp.cur !== 'number') P.mp.cur = mpMax;
    if (P.mp.cur > P.mp.max) P.mp.cur = P.mp.max;
    if (P.mp.cur < 0) P.mp.cur = 0;
  }

  // â€”â€” ç•«é¢æ›´æ–°ï¼ˆç´”è®€ Pï¼‰ â€”â€” //
  var staBar = qs('#barSta'); if (staBar){ staBar.style.width = (P.sta.cur / P.sta.max * 100) + '%'; }
  var staTxt = qs('#txtSta'); if (staTxt){ staTxt.textContent = P.sta.cur + '/' + P.sta.max; }

  var expBar = qs('#barExp'); if (expBar){ expBar.style.width = (P.exp.cur / P.exp.max * 100) + '%'; }
  var expTxt = qs('#txtExp'); if (expTxt){ expTxt.textContent = P.exp.cur + '/' + P.exp.max; }

  var hpBar = qs('#barHp'); if (hpBar){ hpBar.style.width = (P.hp.cur / P.hp.max * 100) + '%'; }
  var hpTxt = qs('#txtHp'); if (hpTxt){ hpTxt.textContent = P.hp.cur + '/' + P.hp.max; }

  var mpBar = qs('#barMp'); if (mpBar){ mpBar.style.width = (P.mp.cur / P.mp.max * 100) + '%'; }
  var mpTxt = qs('#txtMp'); if (mpTxt){ mpTxt.textContent = P.mp.cur + '/' + P.mp.max; }
}



function buildMapUI(){
  const bigCol   = qs('#bigMapCol');
  const smallCol = qs('#smallMapCol');
  bigCol.innerHTML=''; smallCol.innerHTML='';

  // å·¦åˆ—ï¼šå¤§åœ°åœ–ï¼ˆæ¸…å–®ï¼‹å»ºè­°ç­‰ç´šï¼‰
  MAPS.forEach(m=>{
    const btn = document.createElement('div');
    btn.className = 'tag' + (m.id===curBig?' active':'');
    btn.innerHTML = `<span class="name">${m.name}</span><span class="lv">å»ºè­° ${m.lv||'â€”'}</span>`;
    btn.onclick = ()=>{
      curBig = m.id;
      curSmall = null;      // åˆ‡æ›å¤§åœ°åœ–æ™‚æ¸…ç©ºå‰¯åœ°åœ–é¸æ“‡
      entered = false;      // å¿…é ˆé‡æ–°é€²å…¥
      buildMapUI();
      setLocBadge();
      updateActionPanel();
    };
    bigCol.appendChild(btn);
  });

  // è‹¥å°šæœªé¸æ“‡ï¼Œé è¨­é¸ç¬¬ä¸€å€‹å¤§åœ°åœ–
  const big = MAPS.find(x=>x.id===curBig) || MAPS[0];
  if(!curBig && big){ curBig = big.id; }

  // å³åˆ—ï¼šä¾ç›®å‰å¤§åœ°åœ–é¡¯ç¤ºå‰¯åœ°åœ–ï¼ˆæ¸…å–®ï¼‹å»ºè­°ç­‰ç´šï¼‰
  (big?.small||[]).forEach(s=>{
    const btn = document.createElement('div');
    btn.className = 'tag' + (s.id===curSmall?' active':'');
    btn.innerHTML = `<span class="name">${s.name}</span><span class="lv">å»ºè­° ${s.lv||'â€”'}</span>`;
    btn.onclick = ()=>{
      curSmall = s.id;
      entered = false;    // é¸äº†å‰¯åœ°åœ–å¾Œï¼Œä»éœ€æŒ‰ã€Œé€²å…¥ã€
      setLocBadge();
      updateActionPanel();

      // æ¨™è¨˜ active
      Array.prototype.slice.call(smallCol.children).forEach(function(x){
      x.classList.remove('active');
    });
      btn.classList.add('active');

      // æ›´æ–°åœ°å€æƒ…å ±
      renderAreaInfo();
    };
    smallCol.appendChild(btn);
  });

  setLocBadge();
  updateActionPanel();
  renderAreaInfo(); // åˆå§‹ä¹Ÿæ¸²æŸ“ä¸€æ¬¡
}

/* å›ºå®šæ¬„ä½ï¼šåœ°å€æƒ…å ± */
/* å›ºå®šæ¬„ä½ï¼šåœ°å€æƒ…å ±ï¼ˆä¸ç”¨å¯é¸éˆ/æœªå®£å‘Šè®Šæ•¸ï¼‰ */
function renderAreaInfo(){
  var box = qs('#infoMonsters');

  // ä¾ curBig / curSmall æ‰¾åˆ°ç›®å‰çš„å°åœ°åœ–
  var big = null, s = null;
  for (var i=0;i<MAPS.length;i++){
    if (MAPS[i].id === curBig){ big = MAPS[i]; break; }
  }
  if (big && big.small){
    for (var j=0;j<big.small.length;j++){
      if (big.small[j].id === curSmall){ s = big.small[j]; break; }
    }
  }
  if (!s){
    box.innerHTML = '<span class="chip">â€”</span>';
    return;
  }

  var chips = [];
  var list = s.monsters || [];
  for (var k=0;k<list.length;k++){
    var id = list[k];
    var m = (window.MonsterDB && MonsterDB.get) ? MonsterDB.get(id) : null;
    if(!m){
      chips.push('<span class="chip"><span class="mname">'+id+'</span></span>');
    }else{
      var el = (window.ELEMENT_LABEL && ELEMENT_LABEL[m.element]) || 'ç„¡';
      chips.push(
        '<span class="chip">' +
          '<span class="pill elem '+(m.element||'none')+'">'+ el +'</span>' +
          '<span class="mname">'+ m.name +'</span><span class="mlv">LV.'+(m.level||1)+'</span>' +
        '</span>'
      );
    }
  }

  if (s.boss){
    var b = (window.MonsterDB && MonsterDB.get) ? MonsterDB.get(s.boss) : null;
    if (b){
      var elb = (window.ELEMENT_LABEL && ELEMENT_LABEL[b.element]) || 'ç„¡';
      chips.push(
        '<span class="chip" style="border-color:#dc2626;background:rgba(220,38,38,.12)">' +
          '<strong>BOSS</strong>' +
          '<span class="pill elem '+(b.element||'none')+'">'+ elb +'</span>' +
          '<span class="mname">'+ b.name +'</span><span class="mlv">LV.'+(b.level||1)+'</span>' +
        '</span>'
      );
    }
  }

  box.innerHTML = chips.join('');
}


function setLocBadge(){
  const big = MAPS.find(x=>x.id===curBig);
  const small = big?.small?.find(x=>x.id===curSmall);
  const locTxt = small ? `ç›®å‰ä½ç½®ï¼š${big.name} ï¼ ${small.name}` : 'å°šæœªé¸æ“‡åœ°é»';
  qs('#locBadge').textContent = entered ? `${locTxt}ï¼ˆå·²é€²å…¥ï¼‰` : locTxt;
}



function updateBossUI(){
  const hint = qs('#slimeQuestHint');
  const btnBoss = qs('#btnBoss');
  if(!hint || !btnBoss) return;

  // æ‰¾åˆ°ç•¶å‰å°åœ°åœ–
  var big = null, area = null, i, j;
  for (i = 0; i < MAPS.length; i++){
    if (MAPS[i].id === curBig){ big = MAPS[i]; break; }
  }
  if (big && big.small){
    for (j = 0; j < big.small.length; j++){
      if (big.small[j].id === curSmall){ area = big.small[j]; break; }
    }
  }

  if(!area || !area.boss || !entered){
    hint.style.display = 'none';
    btnBoss.style.display = 'none';
    return;
  }

  P.mapProg = P.mapProg || {};
  var progKey = area.id;
  var prog = P.mapProg[progKey] || { kills:0, bossReady:false, bossDefeated:false };
  var requiredKills = area.killsRequired || 10;

  // â˜… ä¿®æ­£ï¼šç•¶æ“Šæ®ºæ•¸é”æ¨™æ™‚ï¼Œé‡æ–°å•Ÿç”¨ BOSSï¼ˆä¸ç®¡ä¹‹å‰æ˜¯å¦æ“Šæ•—éï¼‰
  if(prog.kills >= requiredKills){
    prog.bossReady = true;
    // ä¸é‡ç½® bossDefeatedï¼Œä¿ç•™æ­·å²è¨˜éŒ„
  }

  // é¡¯ç¤ºé‚è¼¯ï¼šåªè¦ bossReady å°±èƒ½æŒ‘æˆ°
  if(prog.bossReady){
    var statusPrefix = prog.bossDefeated ? 'é‡æ–°æŒ‘æˆ°' : 'é¦–æ¬¡æŒ‘æˆ°';
    hint.textContent = `${area.name}ï¼šè¨ä¼å·²é” ${prog.kills}/${requiredKills} â†’ å¯ä»¥${statusPrefix} BOSSï¼`;
    hint.style.display = 'block';
    btnBoss.style.display = 'inline-block';
    btnBoss.textContent = statusPrefix + ' BOSS';
    btnBoss.style.background = '#b91c1c';
  }else{
    var statusText = prog.bossDefeated 
      ? `${area.name}ï¼šBOSS å·²æ“Šæ•—ï¼Œéœ€é‡æ–°ç´¯ç©è¨ä¼é€²åº¦ ${prog.kills}/${requiredKills}`
      : `${area.name}ï¼šæ€ªç‰©è¨ä¼é€²åº¦ ${prog.kills}/${requiredKills}ï¼ˆé”æˆå¾Œå°‡å‡ºç¾ BOSSï¼‰`;
    
    hint.textContent = statusText;
    hint.style.display = 'block';
    btnBoss.style.display = 'none';
  }
}


function updateActionPanel(){
  const btnEnter   = qs('#btnEnter');
  const btnExplore = qs('#btnExplore');
  const btnFight   = qs('#btnFight');

  const canEnter = !!curBig && !!curSmall;
  btnEnter.disabled = !canEnter;

  if(!entered){
    btnEnter.style.display   = 'inline-block';
    btnExplore.style.display = 'none';
    btnFight.style.display   = 'none';
  }else{
    btnEnter.style.display   = 'none';
    btnExplore.style.display = 'inline-block';
    btnFight.style.display   = 'inline-block';
  }

  // â˜… åŒæ­¥æ›´æ–° BOSS UI
  updateBossUI();
}

/* ===== æ¢éšª ===== */
async function doExplore(){
  if(!curSmall){ log('è«‹å…ˆé¸æ“‡å‰¯åœ°åœ–ã€‚'); return; }
  if(!entered){ log('è«‹å…ˆæŒ‰ã€Œé€²å…¥ã€è©²åœ°å€ã€‚'); return; }

  var staCur = (P && P.sta && typeof P.sta.cur === 'number') ? P.sta.cur : 0;
  if(staCur < 2){ log('é«”åŠ›ä¸è¶³ï¼ˆéœ€è¦ 2ï¼‰', 'warn'); return; }
  P.sta.cur = staCur - 2;

  var r = Math.random();
  if(r < 0.5){
    var got = 5 + Math.floor(Math.random()*16); // 5~20
    P.currencies.stone = (P.currencies.stone||0) + got;
    log('æ¢éšªç²å¾— éˆçŸ³ Ã—' + got, 'ok');
  }else if(r < 0.8){
    // ç´ æ
    var picks = ['wood_shard','stone_core','ghost_essence'];
    var id = picks[Math.floor(Math.random()*picks.length)];
    var hasDef = (ItemDB && typeof ItemDB.getDef==='function' && ItemDB.getDef('materials', id));
    if(!hasDef){ id = 'wood_shard'; }
    var qty = 1 + Math.floor(Math.random()*2);
    if(ItemDB && typeof ItemDB.addMaterialToBag==='function') ItemDB.addMaterialToBag(P.bag, id, qty);
    var mdef = (ItemDB && ItemDB.getDef) ? ItemDB.getDef('materials', id) : null;
    var mname = (mdef && mdef.name) ? mdef.name : id;
    log('æ¢éšªç²å¾—ç´ æï¼š' + mname + ' Ã—' + qty, 'ok');
  }else{
    // æ¶ˆè€—å“
    var ids = ['hp_small','mp_small'];
    var filtered = [];
    for (var i=0; i<ids.length; i++){
      var ok = (ItemDB && typeof ItemDB.getDef==='function' && ItemDB.getDef('consumables', ids[i]));
      if(ok) filtered.push(ids[i]);
    }
    var cid = filtered.length ? filtered[Math.floor(Math.random()*filtered.length)] : 'hp_small';
    if(ItemDB && typeof ItemDB.addConsumableToBag==='function') ItemDB.addConsumableToBag(P.bag, cid, 1);
    var cdef = (ItemDB && ItemDB.getDef) ? ItemDB.getDef('consumables', cid) : null;
    var cname = (cdef && cdef.name) ? cdef.name : cid;
    log('æ¢éšªç²å¾—ä¸¹è—¥ï¼š' + cname + ' Ã—1', 'ok');
  }

  refreshLive();
  renderHeader();
  renderBars();
  
  // â˜… æ¢éšªå¾Œç«‹å³åŒæ­¥åˆ° Auth å¿«å–ï¼ˆåŠ å¼·ç‰ˆï¼‰
  if (window.Auth && Auth.setCharacter) {
    try { 
      var cleanData = JSON.parse(JSON.stringify(P));
      delete cleanData._live;
      Auth.setCharacter(cleanData); 
      console.log('ğŸ—ºï¸ æ¢éšªå¾ŒåŒæ­¥æˆåŠŸ - é«”åŠ›:', P.sta.cur, 'éˆçŸ³:', P.currencies.stone);
    } catch(_e) {
      console.error('âŒ æ¢éšªå¾ŒåŒæ­¥å¤±æ•—:', _e);
    }
  }
}


/* ===== æˆ°é¬¥ï¼ˆATBï¼‰ ===== */
const ATB_MAX = 1000;      // æ»¿æ ¼é–€æª»
let battle = null;         // æˆ°é¬¥ç‹€æ…‹
let loop = null;           // è¨ˆæ™‚å™¨

function startBattle(){
  if(!curSmall){ log('è«‹å…ˆé¸æ“‡å‰¯åœ°åœ–ã€‚'); return; }
  if(!entered){ log('è«‹å…ˆæŒ‰ã€Œé€²å…¥ã€è©²åœ°å€ã€‚'); return; }

  // æ‰¾åˆ°ç›®å‰å€åŸŸ
  var big = null, area = null, i, j;
  for (i = 0; i < MAPS.length; i++){
    if (MAPS[i].id === curBig){ big = MAPS[i]; break; }
  }
  if (big && big.small){
    for (j = 0; j < big.small.length; j++){
      if (big.small[j].id === curSmall){ area = big.small[j]; break; }
    }
  }
  if(!area){ log('æ‰¾ä¸åˆ°è©²åœ°å€'); return; }

  // æŒ‡å®šæ€ªï¼ˆBOSSï¼‰æˆ–éš¨æ©Ÿ
  var enemy = null;
  if(window.FORCE_MONSTER_ID){
    var def = (window.MonsterDB && MonsterDB.DB) ? MonsterDB.DB[window.FORCE_MONSTER_ID] : null;
    if(def) enemy = JSON.parse(JSON.stringify(def));
    window.FORCE_MONSTER_ID = null;
  }
  if(!enemy){
    var pool = [];
    if (area.monsters && window.MonsterDB && MonsterDB.DB){
      for (i = 0; i < area.monsters.length; i++){
        var mid = area.monsters[i];
        var mdef = MonsterDB.DB[mid];
        if (mdef) pool.push(mdef);
      }
    }
    if(!pool.length){ log('æ­¤åœ°å°šç„¡æ€ªç‰©è³‡æ–™'); return; }
    enemy = JSON.parse(JSON.stringify(pool[Math.floor(Math.random()*pool.length)]));
  }

  // é¡¯ç¤ºæˆ°é¬¥å€
  qs('#mapSection').style.display = 'none';
  qs('#battleSection').classList.add('show');
  if (loop){ clearInterval(loop); loop = null; }

  // ç©å®¶è¡ç”Ÿå€¼å¿«ç…§
  refreshLive();
  var d = (P && P._live) ? P._live : {};

  // å–æ€ªç‰©è¡ç”Ÿè¡¨
  var dMon = null;
  try{
    if (window.MonsterDB && MonsterDB.getDerived){
      dMon = MonsterDB.getDerived(enemy.id) || null;
    }
  }catch(_err){ dMon = null; }

  function pickD(key, fallback){
    var v = (dMon && typeof dMon[key]==='number') ? dMon[key] : fallback;
    return (typeof v==='number') ? v : (fallback||0);
  }

  var eStats = {
    atk  : pickD('ç‰©ç†æ”»æ“Š',   10),
    matk : pickD('æ³•è¡“æ”»æ“Š',   10),
    def  : pickD('ç‰©ç†é˜²ç¦¦',    8),
    mdef : pickD('æ³•è¡“é˜²ç¦¦',    8),
    acc  : pickD('å‘½ä¸­ç‡',     75),
    eva  : pickD('é–ƒé¿',        5),
    crit : Math.min(100, pickD('æš´æ“Šç‡', 3)),
    aspd : Math.max(0.5, pickD('è¡Œå‹•æ¢é€Ÿåº¦', 100) / 100),
    pen  : pickD('ç ´ç”²',        0)
  };

  battle = {
    enemy: enemy,
    enemyStats: eStats,
    p:{
      hp   : (P && P.hp && typeof P.hp.cur==='number') ? P.hp.cur : 100,
      hpMax: (P && P.hp && typeof P.hp.max==='number') ? P.hp.max : 100,
      mp   : (P && P.mp && typeof P.mp.cur==='number') ? P.mp.cur : 0,
      mpMax: (P && P.mp && typeof P.mp.max==='number') ? P.mp.max : 0,
      atb  : 0,
      // ç›´æ¥åƒè¡Œå‹•æ¢é€Ÿåº¦ï¼ˆ0~ä»»æ„ï¼‰ï¼Œä¸è¦ä¿åº•ï¼›æ¯”ä¾‹åŒ–æ­¥å¹…æœƒåœ¨äººæ€§åŒ–æ¼”ç®—æ³•ä¸­è™•ç†
      speed: (d && typeof d['è¡Œå‹•æ¢é€Ÿåº¦']==='number') ? d['è¡Œå‹•æ¢é€Ÿåº¦'] : 100
    },
    e:{
      hp   : pickD('æ°£è¡€ä¸Šé™', 100),
      hpMax: pickD('æ°£è¡€ä¸Šé™', 100),
      atb  : 0,
      // ç›´æ¥åƒè¡Œå‹•æ¢é€Ÿåº¦ï¼ˆ0~ä»»æ„ï¼‰
      speed: pickD('è¡Œå‹•æ¢é€Ÿåº¦', 100)
    },
    turn:'none',
    over:false
  };



  qs('#eName').textContent = enemy.name;
  qs('#eLv').textContent = enemy.level;
  qs('#pLv').textContent = P.level;

  var getElemLabel = function(k){ return (ELEMENT_LABEL && ELEMENT_LABEL[k]) ? ELEMENT_LABEL[k] : k; };
  var pElem = (P && (P.element || P.elem)) ? (P.element || P.elem) : 'none';
  var eElem = (enemy && (enemy.element || enemy.elem)) ? (enemy.element || enemy.elem) : 'none';

  var pEl = qs('#pElem'), eEl = qs('#eElem');
  if (pEl) { pEl.textContent = getElemLabel(pElem); pEl.className = 'pill elem ' + pElem; }
  if (eEl) { eEl.textContent = getElemLabel(eElem); eEl.className = 'pill elem ' + eElem; }

  log('å…ƒç´ è³‡è¨Šï½œä½ ï¼š' + getElemLabel(pElem) + 'ã€€æ•µäººï¼š' + getElemLabel(eElem));

  var pImg = qs('#pImg'); var eImg = qs('#eImg');
  // å„ªå…ˆä½¿ç”¨å¤–è§€åœ–ç¤ºï¼Œæ²’æœ‰å¤–è§€æ™‚æ‰å›é€€åˆ°é ­åƒ/é è¨­
  var pSrc = (P && P.equip && P.equip.character && P.equip.character.icon && String(P.equip.character.icon).trim())
    ? P.equip.character.icon
    : ((P && P.avatar && typeof P.avatar==='string' && P.avatar.trim()) ? P.avatar : PLAYER_IMG_URL);
  var pic = (window.MonsterDB && MonsterDB.getImage) ? MonsterDB.getImage(enemy.id) : {url:'',mirror:false};

  if (pImg) { pImg.src = pSrc; }


  if (eImg){
    // â˜… é–‹æˆ°å…ˆå®Œæ•´é‡ç½®æ•µäººç«‹ç¹ªç‹€æ…‹ï¼ˆé¿å…ä¸Šä¸€å ´çš„ 0 é€æ˜åº¦/å‹•ç•«æ®˜ç•™ï¼‰
    eImg.style.opacity = '1';
    eImg.style.transition = '';
    eImg.classList.remove('fade-out');
    // æ¸…æ‰ä¸Šä¸€å ´ç‰¹æ•ˆæ®˜ç•™
    var eFx = qs('#eFx'); if (eFx) eFx.innerHTML = '';
    var pFx = qs('#pFx'); if (pFx) pFx.innerHTML = '';

    // è¨­ç½®åœ–ç‰‡èˆ‡é¡åƒ
    var finalUrl = (pic && typeof pic.url==='string' && pic.url.trim()) ? pic.url : 'https://picsum.photos/seed/monster/500/500';
    eImg.classList.toggle('mirror', !!(pic && pic.mirror));

    // å®‰å…¨é è¼‰ï¼šå¤±æ•—æ™‚å›é€€é è¨­åœ–ï¼Œé¿å…ç©ºé»‘ç•«é¢
    var test = new Image();
    test.onload = function(){
      if (test.naturalWidth > 0 && test.naturalHeight > 0){
        eImg.src = finalUrl;
      }else{
        eImg.src = 'https://picsum.photos/seed/monster/500/500';
      }
    };
    test.onerror = function(){
      eImg.src = 'https://picsum.photos/seed/monster/500/500';
    };
    test.src = finalUrl;

    /* â˜…â˜…â˜… é€™è£¡é—œéµï¼šæ¯ä¸€å ´æˆ°é¬¥éƒ½é‡æ–°è§¸ç™¼ç¿»è½‰å‹•ç•« â˜…â˜…â˜… */
    var eFrame = document.querySelector('.e-frame');
    if (eFrame){
      // ç§»é™¤èˆŠå‹•ç•« â†’ å¼·åˆ¶å›æµ â†’ å†åŠ å›å»ï¼Œç¢ºä¿æ¯æ¬¡éƒ½æœƒæ’­æ”¾
      eFrame.classList.remove('flip-in');
      void eFrame.offsetWidth;  // å¼·åˆ¶å›æµï¼ˆä¸è¦åˆªï¼‰
      eFrame.classList.add('flip-in');
    }
  }

  updateBattleBars();
  updateCmdEnabled();
  log('åœ¨ ' + (area.name||'ç•¶å‰åœ°å€') + ' é­é‡ ' + enemy.name + 'ï¼');
  loop = setInterval(tickATB, 60);
}


function tickATB(){
  if(!battle || battle.over) return;
  if (battle.p.atb >= ATB_MAX) {
    updateCmdEnabled();
    updateBattleBars();
    return;
  }

  // â€”â€” äººæ€§åŒ–æ¯”ä¾‹ï¼šä»¥é›™æ–¹æœ€å¤§é€Ÿåº¦ç•¶åŸºæº–åšæ˜ å°„ï¼ˆç¢ºä¿å·®è·å¯è¦‹ä½†ä¸é›¢è­œï¼‰
  var spP = (typeof battle.p.speed==='number') ? battle.p.speed : 100;
  var spE = (typeof battle.e.speed==='number') ? battle.e.speed : 100;
  if (spP < 0) spP = 0;
  if (spE < 0) spE = 0;
  var spMax = Math.max(spP, spE, 1);  // é¿å…é™¤ 0

  // å¯å¾®èª¿çš„äººæ€§åŒ–æ­¥å¹…å€é–“
  var MIN_STEP = 2;   // æ¯ tick æœ€å°‘+2ï¼ˆè®“éå¸¸æ…¢çš„ä¸€æ–¹é‚„æ˜¯èƒ½å‹•ï¼‰
  var MAX_STEP = 24;  // æ¯ tick æœ€å¤š+24ï¼ˆéå¸¸å¿«çš„ä¸€æ–¹ï¼‰

  function mapStep(sp){
    var ratio = sp / spMax;                   // 0~1
    var step  = Math.round(MIN_STEP + ratio * (MAX_STEP - MIN_STEP));
    if (step < 1) step = 1;                   // å†ä¿ä¸€å±¤ä¸æœƒ 0
    return step;
  }

  var pStep = mapStep(spP);
  var eStep = mapStep(spE);

  battle.p.atb = clamp(battle.p.atb + pStep, 0, ATB_MAX);
  battle.e.atb = clamp(battle.e.atb + eStep, 0, ATB_MAX);

  updateBattleBars();
  updateCmdEnabled();

  if (battle.e.atb >= ATB_MAX){
    enemyAttack();
    battle.e.atb = 0;
    updateBattleBars();
  }
}



function updateBattleBars(){
  qs('#pHp').style.width  = pct(battle.p.hp, battle.p.hpMax) + '%';
  qs('#eHp').style.width  = pct(battle.e.hp, battle.e.hpMax) + '%';
  qs('#pATB').style.width = pct(battle.p.atb, ATB_MAX) + '%';
  qs('#eATB').style.width = pct(battle.e.atb, ATB_MAX) + '%';
  qs('#btState').textContent = battle.over ? 'æˆ°é¬¥çµæŸ' : (battle.p.atb>=ATB_MAX?'è¼ªåˆ°ä½ è¡Œå‹•':'ç­‰å¾…è¡Œå‹•æ¢â€¦');

  if(P && P.hp){
    P.hp.cur = battle.p.hp;
    P.hp.max = battle.p.hpMax;
  }
  if(P && P.mp){
    P.mp.cur = battle.p.mp || P.mp.cur || 0;
    P.mp.max = battle.p.mpMax || P.mp.max || 0;
  }
  renderBars();
}

// å—æ“Šæµ®å­— / é–ƒå…‰ / æŠ–å‹•
function spawnFloat(side, value, type){
  type = type || 'dmg';
  var host = (side==='player') ? qs('#pFx') : qs('#eFx');
  if(!host) return;
  var el = document.createElement('div');
  if (type==='miss'){
    el.className = 'dmg-float';
    el.textContent = 'MISS';
  }else{
    el.className = 'dmg-float ' + (type==='heal'?'heal':(type==='crit'?'crit dmg':'dmg'));
    el.textContent = (type==='heal' ? '+' : '-') + value;
  }
  host.appendChild(el);
  setTimeout(function(){ el.remove(); }, 1000);
}
function flashShake(side){
  var img = (side==='player') ? qs('#pImg') : qs('#eImg');
  var fx  = (side==='player') ? qs('#pFx') : qs('#eFx');
  if(!img || !fx) return;
  var f = document.createElement('div');
  f.className = 'flash';
  fx.appendChild(f);
  setTimeout(function(){ f.remove(); }, 260);
  img.classList.add('shake');
  setTimeout(function(){ img.classList.remove('shake'); }, 520);
}
function showHit(side, amount, isCrit, kind){
  if(kind==='heal'){
    spawnFloat(side, amount, 'heal');
    return;
  }
  spawnFloat(side, amount, isCrit?'crit':'dmg');
  flashShake(side);
}

function updateCmdEnabled(){
  var canAct = battle && !battle.over && battle.p.atb>=ATB_MAX;
  ['actAttack','actSkill','actItem','actRun'].forEach(function(id){ qs('#'+id).disabled = !canAct; });
}

function calcDamage(isPlayer){
  function clamp01(x,min,max){ return Math.max(min, Math.min(max, x)); }
  function hitChanceOf(attAcc, defEva, base){ base = (typeof base==='number')?base:75; return clamp01(base + (attAcc|0) - (defEva|0), 5, 98); }

  if(isPlayer){
    if (!P._live) refreshLive();
    var D = P._live;

    var attAcc = D['å‘½ä¸­ç‡'] || 0;
    var defEva = (battle.enemyStats && battle.enemyStats.eva) ? battle.enemyStats.eva : 0;
    var hitChance = hitChanceOf(attAcc, defEva, 75);
    if (Math.random()*100 >= hitChance){
      var atkElem0 = (P && (P.element||P.elem)) ? (P.element||P.elem) : 'none';
      var defElem0 = (battle.enemy && (battle.enemy.element||battle.enemy.elem)) ? (battle.enemy.element||battle.enemy.elem) : 'none';
      return { dmg:0, miss:true, crit:false, note:'', elemMul:1, stabMul:1, atkElem:atkElem0, defElem:defElem0, hitChance:hitChance };
    }

    var atk = D['ç‰©ç†æ”»æ“Š']||0;
    var pen = D['ç ´ç”²']||0;
    var critRate = D['æš´æ“Šç‡']||0;
    var critDmg  = (100 + (D['æš´æ“Šå‚·å®³']||50)) / 100;
    var eDef = Math.max(0, ((battle.enemyStats && battle.enemyStats.def) ? battle.enemyStats.def : 0) - pen);
    var base = Math.max(1, atk - eDef);
    base = Math.round(base * (0.9 + Math.random()*0.2));
    var isCrit = Math.random()*100 < critRate;
    var out = Math.max(1, Math.round(base * (isCrit ? critDmg : 1)));

    var atkElem = (P && (P.element||P.elem)) ? (P.element||P.elem) : 'none';
    var defElem = (battle.enemy && (battle.enemy.element||battle.enemy.elem)) ? (battle.enemy.element||battle.enemy.elem) : 'none';
    var elemMul = elemMult(atkElem, defElem);
    var stabMul = (atkElem!=='none') ? (window.STAB||1) : 1;
    out = Math.max(1, Math.round(out * elemMul * stabMul));

    return { dmg: out, miss:false, crit:isCrit, note:'', elemMul:elemMul, stabMul:stabMul, atkElem:atkElem, defElem:defElem, hitChance:hitChance };
  }else{
    var eS = battle.enemyStats || {};
    if (!P._live) refreshLive();
    var attAcc2 = eS.acc || 0;
    var defEva2 = P._live['é–ƒé¿'] || 0;
    var hitChance2 = hitChanceOf(attAcc2, defEva2, 75);
    if (Math.random()*100 >= hitChance2){
      var atkElem1 = (battle.enemy && (battle.enemy.element||battle.enemy.elem)) ? (battle.enemy.element||battle.enemy.elem) : 'none';
      var defElem1 = (P && (P.element||P.elem)) ? (P.element||P.elem) : 'none';
      return { dmg:0, miss:true, crit:false, note:'', elemMul:1, stabMul:1, atkElem:atkElem1, defElem:defElem1, hitChance:hitChance2 };
    }
    var atk2 = Math.max(1, eS.atk || 8);
    var pen2 = Math.max(0, eS.pen || 0);
    var pDef0  = Math.max(0, (P._live['ç‰©ç†é˜²ç¦¦']||0));
    var effDef = Math.max(0, pDef0 - pen2);
    var base2 = Math.max(1, atk2 - effDef);
    base2 = Math.round(base2 * (0.9 + Math.random()*0.2));
    var out2 = Math.max(1, Math.round(base2));

    var atkElem2 = (battle.enemy && (battle.enemy.element||battle.enemy.elem)) ? (battle.enemy.element||battle.enemy.elem) : 'none';
    var defElem2 = (P && (P.element||P.elem)) ? (P.element||P.elem) : 'none';
    var elemMul2 = elemMult(atkElem2, defElem2);
    var stabMul2 = (atkElem2!=='none') ? (window.STAB||1) : 1;
    out2 = Math.max(1, Math.round(out2 * elemMul2 * stabMul2));

    return { dmg: out2, miss:false, crit:false, note:'', elemMul:elemMul2, stabMul:stabMul2, atkElem:atkElem2, defElem:defElem2, hitChance:hitChance2 };
  }
}

function playerAttack(){
  var r = calcDamage(true);
  if (r.miss){
    spawnFloat('enemy', 0, 'miss');
    log('ä½ æ”»æ“Šè½ç©ºï¼ï¼ˆå‘½ä¸­æ©Ÿç‡ ' + Math.round(r.hitChance) + '%ï¼‰', 'warn');
  }else{
    battle.e.hp = clamp(battle.e.hp - r.dmg, 0, battle.e.hpMax);
    showHit('enemy', r.dmg, !!r.crit, 'hit');
    var rel = elemRelationText(r.atkElem, r.defElem, r.elemMul, r.stabMul);
    log('ä½ å° ' + battle.enemy.name + ' é€ æˆ ' + r.dmg + ' å‚·å®³' + (r.crit?'ï¼ˆæš´æ“Šï¼‰':'') + ' ' + rel);
  }
  battle.p.atb = 0;
  endCheck();
  updateBattleBars(); updateCmdEnabled();
  if(!battle.over && battle.e.atb>=ATB_MAX){ enemyAttack(); battle.e.atb=0; updateBattleBars(); }
}

function enemyAttack(){
  var E = battle.enemy || {};
  var skills = E.skills || [];
  if (skills.length){
    var s = skills[0];
    var hpRate = Math.max(0, battle.e.hp) / Math.max(1, battle.e.hpMax);
    var useChance = (typeof s.chance==='number'?s.chance:0) + ((hpRate < 0.5) ? (typeof s.lowHpBonus==='number'?s.lowHpBonus:0) : 0);
    if (Math.random() < useChance){
      // ğŸŒŸ æ·»åŠ æŠ€èƒ½é å‘Šè¨Šæ¯
      log('ğŸ’€ ' + E.name + ' æº–å‚™æ–½æ”¾ã€Œ' + s.name + 'ã€ï¼', 'warn');
      
      // â˜… æ•µäººæŠ€èƒ½æ©«å¹…æ•ˆæœï¼ˆèˆ‡ç©å®¶ç›¸åŒï¼‰
      if (typeof showSkillBanner === 'function') {
        showSkillBanner('æ•µäººæ–½æ”¾ï¼š' + s.name, s.elem);
      }
      
      var damage;
      if (s.kind === 'physical') {
        damage = calcPhysicalDamageFromEnemy(s.elem || 'none', s.power || 100);
        showHit('player', damage.dmg, false, 'hit');
        var rel2 = elemRelationText(damage.atkElem, damage.defElem, damage.elemMul, damage.stabMul);
        log(E.name + ' æ–½æ”¾ã€Œ' + s.name + 'ã€ï¼Œå°ä½ é€ æˆ ' + damage.dmg + ' ç‰©ç†å‚·å®³ ' + rel2);
      } else {
        damage = calcMagicDamageFromEnemy(s.elem || 'none', s.power || 100);
        showHit('player', damage.dmg, false, 'hit');
        var rel2 = elemRelationText(damage.atkElem, damage.defElem, damage.elemMul, damage.stabMul);
        log(E.name + ' æ–½æ”¾ã€Œ' + s.name + 'ã€ï¼Œå°ä½ é€ æˆ ' + damage.dmg + ' æ³•è¡“å‚·å®³ ' + rel2);
      }
      battle.p.hp = clamp(battle.p.hp - damage.dmg, 0, battle.p.hpMax);
      applyDotToPlayer(s.dps|0, s.duration|0, s.name);
      endCheck();
      updateBattleBars();
      return;
    }

  }
  var r = calcDamage(false);
  if (r.miss){
    spawnFloat('player', 0, 'miss');
    log(E.name + ' çš„æ”»æ“Šè½ç©ºï¼ï¼ˆå‘½ä¸­æ©Ÿç‡ ' + Math.round(r.hitChance) + '%ï¼‰', 'warn');
  }else{
    battle.p.hp = clamp(battle.p.hp - r.dmg, 0, battle.p.hpMax);
    showHit('player', r.dmg, false, 'hit');
    var rel = elemRelationText(r.atkElem, r.defElem, r.elemMul, r.stabMul);
    log(E.name + ' å°ä½ é€ æˆ ' + r.dmg + ' å‚·å®³ ' + rel);
  }
  endCheck();
  updateBattleBars();
}


// â˜… æ–°å¢ï¼šæ•µäººç‰©ç†æŠ€èƒ½å‚·å®³è¨ˆç®—
function calcPhysicalDamageFromEnemy(atkElem, power){
  atkElem = atkElem || 'none';
  power = power || 100;
  var eS = battle.enemyStats || {};
  var atk = Math.max(1, eS.atk || 8);
  var pen = Math.max(0, eS.pen || 0);
  if (!P._live) refreshLive();
  var pDef0  = Math.max(0, (P._live['ç‰©ç†é˜²ç¦¦']||0));
  var effDef = Math.max(0, pDef0 - pen);
  
  // å¥—ç”¨æŠ€èƒ½å¨åŠ›
  var base = Math.max(1, (atk * power / 100) - effDef);
  base = Math.round(base * (0.9 + Math.random()*0.2));
  var out = Math.max(1, Math.round(base));
  
  var defElem = (P && (P.element||P.elem)) ? (P.element||P.elem) : 'none';
  var elemMul = elemMult(atkElem, defElem);
  var stabMul = (atkElem!=='none') ? (window.STAB||1) : 1;
  out = Math.max(1, Math.round(out * elemMul * stabMul));
  return { dmg: out, atkElem:atkElem, defElem:defElem, elemMul:elemMul, stabMul:stabMul };
}

function calcMagicDamageFromEnemy(atkElem, power){
  atkElem = atkElem || 'none';
  power = power || 100;
  var eS = battle.enemyStats || {};
  var matk = Math.max(1, eS.matk || 8);
  var mpen = Math.max(0, eS.mpen || 0);
  if (!P._live) refreshLive();
  var pMdef0  = Math.max(0, (P._live['æ³•è¡“é˜²ç¦¦']||0));
  var effMdef = Math.max(0, pMdef0 - mpen);
  
  // å¥—ç”¨æŠ€èƒ½å¨åŠ›
  var base = Math.max(1, (matk * power / 100) - effMdef);
  base = Math.round(base * (0.9 + Math.random()*0.2));
  var out = Math.max(1, Math.round(base));
  
  var defElem = (P && (P.element||P.elem)) ? (P.element||P.elem) : 'none';
  var elemMul = elemMult(atkElem, defElem);
  var stabMul = (atkElem!=='none') ? (window.STAB||1) : 1;
  out = Math.max(1, Math.round(out * elemMul * stabMul));
  return { dmg: out, atkElem:atkElem, defElem:defElem, elemMul:elemMul, stabMul:stabMul };
}


function applyDotToPlayer(dps, seconds, label){
  dps = dps|0; seconds = seconds|0; label = label || 'æŒçºŒå‚·å®³';
  if(!battle.dotTimers) battle.dotTimers = [];
  var t = 0;
  var timer = setInterval(function(){
    if(!battle || battle.over){ clearInterval(timer); return; }
    if(battle.p.hp<=0 || battle.e.hp<=0){ clearInterval(timer); return; }
    t++;
    battle.p.hp = clamp(battle.p.hp - Math.max(0,dps), 0, battle.p.hpMax);
    showHit('player', Math.max(0,dps), false, 'hit');
    log('ã€æŒçºŒå‚·å®³ã€‘' + label + 'ï¼š-' + dps + 'ï¼ˆ' + t + '/' + seconds + 'ï¼‰', 'warn');
    updateBattleBars();
    endCheck();
    if(t>=seconds) clearInterval(timer);
  }, 1000);
  battle.dotTimers.push(timer);
}

function useItem(){
  var bag = P.bag || {};
  var list = (bag.consumables || []).filter(function(x){ return x && x.count>0; });
  if(!list.length){
    log('æ²’æœ‰å¯ç”¨çš„æ¶ˆè€—å“','warn');
    return;
  }
  var menu = document.createElement('div');
  menu.style.position='fixed';
  menu.style.inset='0';
  menu.style.background='rgba(0,0,0,0.6)';
  menu.style.zIndex='9999';
  menu.style.display='grid';
  menu.style.placeItems='center';

  var box = document.createElement('div');
  box.style.background='#1e293b';
  box.style.padding='12px';
  box.style.borderRadius='12px';
  box.style.maxWidth='300px';
  box.style.display='grid';
  box.style.gap='8px';

  var title = document.createElement('div');
  title.textContent = 'é¸æ“‡è¦ä½¿ç”¨çš„æ¶ˆè€—å“';
  title.style.fontWeight='700';
  title.style.marginBottom='6px';
  box.appendChild(title);

  list.forEach(function(it){
    var btn = document.createElement('button');
    btn.style.display='flex';
    btn.style.alignItems='center';
    btn.style.gap='6px';
    btn.style.padding='6px 8px';
    btn.style.borderRadius='8px';
    btn.style.background='rgba(255,255,255,0.08)';
    btn.style.color='#fff';
    btn.style.border='1px solid rgba(255,255,255,0.15)';
    btn.style.cursor='pointer';

    var img = document.createElement('img');
    img.src = it.icon || '';
    img.style.width='28px';
    img.style.height='28px';
    img.style.objectFit='cover';
    img.style.borderRadius='6px';

    var txt = document.createElement('div');
    txt.innerHTML = '<b>' + it.name + '</b> Ã—' + it.count + '<br/><small>' + (it.effect && it.effect.hp ? ('å›å¾©HP ' + it.effect.hp) : '') + (it.effect && it.effect.mp ? (' å›å¾©MP ' + it.effect.mp) : '') + '</small>';

    btn.appendChild(img);
    btn.appendChild(txt);

    btn.onclick = function(){
      it.count--; if(it.count<=0) bag.consumables = (bag.consumables||[]).filter(function(x){ return x.count>0; });
      if(it.effect && typeof it.effect.hp==='number'){
        var heal = it.effect.hp;
        battle.p.hp = clamp(battle.p.hp + heal, 0, battle.p.hpMax);
        if (P && P.hp) P.hp.cur = battle.p.hp;
        showHit('player', heal, false, 'heal');
        log('ä½¿ç”¨ ' + it.name + ' å›å¾© ' + heal + ' æ°£è¡€ã€‚');
      }
      if(it.effect && typeof it.effect.mp==='number'){
        var heal2 = it.effect.mp;
        battle.p.mp = clamp((battle.p.mp||0) + heal2, 0, battle.p.mpMax);
        if (P && P.mp) P.mp.cur = battle.p.mp;
        showHit('player', heal2, false, 'heal');
        log('ä½¿ç”¨ ' + it.name + ' å›å¾© ' + heal2 + ' çœŸå…ƒã€‚');
      }
      battle.p.atb = 0;
      renderBars();
    // â˜… ä½¿ç”¨é“å…·å¾Œç«‹å³åŒæ­¥åˆ° Auth å¿«å–
    if (window.Auth && Auth.setCharacter) {
      try { 
        var cleanData = JSON.parse(JSON.stringify(P));
        delete cleanData._live;
        Auth.setCharacter(cleanData); 
      } catch(_) {}
    }
      savePlayer();
      updateBattleBars(); updateCmdEnabled();
      menu.remove();
    };

    box.appendChild(btn);
  });

  var cancel = document.createElement('button');
  cancel.textContent='å–æ¶ˆ';
  cancel.style.marginTop='6px';
  cancel.onclick=function(){ menu.remove(); };
  box.appendChild(cancel);

  menu.appendChild(box);
  document.body.appendChild(menu);
}

function tryRun(){
  var ok = Math.random()<0.6;
  if(ok){
    log('æˆåŠŸè„«é›¢æˆ°é¬¥ã€‚','ok');
    finishBattle(false);
  }else{
    log('é€ƒè·‘å¤±æ•—ï¼','warn');
    battle.p.atb = 0;
    updateCmdEnabled();
  }
}

async function endCheck(){
  if(!battle || battle.over) return;

  if(battle.e.hp<=0){
    log('ä½ æ‰“å€’äº† ' + (battle.e.name||'æ•µäºº') + 'ï¼','ok');

    // 1) åœæ­¢æ•µæ–¹è¡Œå‹•ã€æ·¡å‡ºï¼ˆä¸å†è·‘ ATBï¼‰
    finishBattle();
    var eImg = document.getElementById('eImg');
    if(eImg){ eImg.classList.add('fade-out'); }


    try{
      // æ‰¾ç•¶å‰çš„å°åœ°åœ–
      var big=null, area=null, i,j;
      for(i=0;i<MAPS.length;i++){ if(MAPS[i].id===curBig){ big=MAPS[i]; break; } }
      if(big && big.small){
        for(j=0;j<big.small.length;j++){ if(big.small[j].id===curSmall){ area=big.small[j]; break; } }
      }
      
      // â˜… é€šç”¨å¤šåœ°åœ–è™•ç†
      if(area && area.boss){
        P.mapProg = P.mapProg || {};
        var progKey = area.id;
        var prog = P.mapProg[progKey] || { kills:0, bossReady:false, bossDefeated:false };
        
        // å–å¾—è©²åœ°åœ–éœ€è¦çš„æ“Šæ®ºæ•¸ï¼ˆé è¨­ 10ï¼‰
        var requiredKills = area.killsRequired || 10;
        
        // æª¢æŸ¥æ˜¯å¦ç‚º BOSS æˆ°
        var isBossKill = (battle.enemy && battle.enemy.id === area.boss);
        
        if(isBossKill){
          // â˜… BOSS è¢«æ“Šæ•— - é‡ç½®é€²åº¦ï¼Œéœ€é‡æ–°ç´¯ç©
          prog.bossDefeated = true;
          prog.bossReady = false;    // â† é—œéµï¼šé‡ç½®ç‚º false
          prog.kills = 0;            // â† é—œéµï¼šé‡ç½®æ“Šæ®ºæ•¸
          log('ğŸ‰ æ­å–œï¼ä½ æ“Šæ•—äº† ' + area.name + ' çš„ BOSSï¼éœ€é‡æ–°ç´¯ç©è¨ä¼é€²åº¦æ‰èƒ½å†æ¬¡æŒ‘æˆ°ã€‚', 'ok');
          
        }else if(!prog.bossReady){

          // â˜… ä¸€èˆ¬æ€ªç‰©ï¼Œç´¯ç©æ“Šæ®ºæ•¸
          prog.kills = (prog.kills|0) + 1;
          
          if(prog.kills >= requiredKills){
            prog.kills = requiredKills;    // å°é ‚
            prog.bossReady = true;
            log(area.name + ' BOSS å·²å‡ºç¾ï¼å¯ä»¥æŒ‘æˆ°äº†ï¼','ok');
          }else{
            log(area.name + ' è¨ä¼é€²åº¦ï¼š' + prog.kills + '/' + requiredKills);
          }
        }
        
        // å„²å­˜é€²åº¦
        P.mapProg[progKey] = prog;
        
        // æ›´æ–° UI
        if(typeof updateBossUI === 'function') updateBossUI();
      }
    }catch(_e){
      console.error('åœ°åœ–é€²åº¦æ›´æ–°éŒ¯èª¤:', _e);
    }

    // 2) æ‰è½ï¼ˆMonsterDBï¼‰
    (function resolveDrops(monId){
      try{
        var loots = (window.MonsterDB && typeof MonsterDB.rollDrops==='function') ? MonsterDB.rollDrops(monId) : [];
        if(!loots || !loots.length){
          log('æˆ°åˆ©å“ï¼šâ€”');
        }else{
          if(window.MonsterDB && typeof MonsterDB.applyDrops==='function'){ MonsterDB.applyDrops(P, loots); }
          var txt = [];
          for (var i=0;i<loots.length;i++){
            var it = loots[i]||{};
            var shown = it.name || it.id || '';
            if(!shown){
              if (it.type==='material' && window.ItemDB && ItemDB.getDef){
                var mdef = ItemDB.getDef('materials', it.id); if(mdef && mdef.name) shown = mdef.name;
              }else if (it.type==='consumable' && window.ItemDB && ItemDB.getDef){
                var cdef = ItemDB.getDef('consumables', it.id); if(cdef && cdef.name) shown = cdef.name;
              }
            }
            if(it.type==='currency' && it.id==='stone') shown = 'éˆçŸ³';
            if(it.type==='currency' && it.id==='diamond') shown = 'é‘½çŸ³';
            var amount = it.amount|0;
            if(amount>0) txt.push(shown + ' Ã—' + amount);
          }
          log('æˆ°åˆ©å“ï¼š' + (txt.length ? txt.join('ï¼›') : 'â€”'), txt.length ? 'ok' : undefined);
        }
      }catch(_e){}
    })((battle.enemy && battle.enemy.id) ? battle.enemy.id : battle.enemy);

    // 3) ç¶“é©—èˆ‡å‡ç´šï¼ˆä¿ç•™æº¢å‡ºï¼‰
    var baseExp = 10 + ((battle.enemy && battle.enemy.level) || 1) * 4;
    var expGain = baseExp;
    var bonusExp = 0;
    
    try{
      if (window.MonsterDB && typeof MonsterDB.expFor === 'function') {
        // ç”¨çœŸæ­£çš„æ€ªç‰©ï¼ˆæˆ–å…¶ idï¼‰ä¾†è¨ˆç®—ï¼Œæ‰æœ‰æ­£ç¢ºç­‰ç´š/Rank/xpBonus
        var monForExp = (battle.enemy && battle.enemy.id) ? battle.enemy.id : battle.enemy;
        expGain = MonsterDB.expFor(monForExp, (P && typeof P.level==='number') ? P.level : null);
        bonusExp = expGain - baseExp;
      }
    }catch(_){}


    
    if (!P.exp) P.exp = {cur:0, max:100};
    if (typeof P.exp.cur!=='number') P.exp.cur = 0;
    if (typeof P.exp.max!=='number' || P.exp.max<=0) P.exp.max = 100;
    P.exp.cur = (P.exp.cur|0) + (expGain|0);
    
    // â˜…åˆ†é–‹é¡¯ç¤ºåŸºç¤ç¶“é©—å’Œé¡å¤–ç¶“é©—
    if (bonusExp > 0) {
      log('ç²å¾—ç¶“é©—ï¼š' + baseExp + ' + ' + bonusExp + ' = ' + expGain + 'ï¼ˆå«é¡å¤–åŠ æˆï¼‰', 'ok');
    } else if (bonusExp < 0) {
      log('ç²å¾—ç¶“é©—ï¼š' + baseExp + ' - ' + Math.abs(bonusExp) + ' = ' + expGain + 'ï¼ˆç­‰ç´šå·®è·æ¸›å°‘ï¼‰', 'ok');
    } else {
      log('ç²å¾—ç¶“é©—ï¼š' + expGain, 'ok');
    }


    // â˜… æ¯å‡ä¸€ç´š +2 åŸºç¤å±¬æ€§é»ï¼ˆunspentPointsï¼‰
    var leveled = 0;
    while (P.exp.cur >= P.exp.max){
      P.exp.cur = P.exp.cur - P.exp.max;
      P.level = (P.level|0) + 1;
      P.exp.max = Math.max(50, Math.round((P.exp.max||100) * 1.25));
      leveled = leveled + 1;
    }
    if (leveled>0){
      if (typeof P.unspentPoints!=='number') P.unspentPoints = 0;
      P.unspentPoints = P.unspentPoints + (leveled * 2);
      log('å‡åˆ° ' + P.level + ' ç´šï¼ç²å¾—å±¬æ€§é» +' + (leveled*2) + 'ï¼ˆå¯åˆ°ä¸»åŸåˆ†é…ï¼‰','ok');
      refreshLive();
      renderHeader();
      renderBars();
      if(battle && !battle.over){
        var newHpMax = P._live['æ°£è¡€ä¸Šé™'] || P.hp.max;
        var newMpMax = P._live['çœŸå…ƒä¸Šé™'] || P.mp.max;
        battle.p.hpMax = newHpMax;
        battle.p.mpMax = newMpMax;
        P.hp.max = newHpMax;
        P.mp.max = newMpMax;
        updateBattleBars();
      }
      // â˜… é—œéµï¼šå‡ç´šå¾Œç«‹å³åŒæ­¥åˆ° Auth å¿«å–ï¼ˆåŠ å¼·ç‰ˆï¼‰
      if (window.Auth && Auth.setCharacter) {
        try { 
          var cleanData = JSON.parse(JSON.stringify(P));
          delete cleanData._live;
          Auth.setCharacter(cleanData); 
          console.log('ğŸ‰ å‡ç´šå¾ŒåŒæ­¥æˆåŠŸ - ç­‰ç´š:', P.level, 'ç¶“é©—:', P.exp.cur + '/' + P.exp.max);
        } catch(_e) {
          console.error('âŒ å‡ç´šå¾ŒåŒæ­¥å¤±æ•—:', _e);
        }
      }
    }


    renderHeader();
    renderBars();
    
    // â˜… æˆ°é¬¥çµæŸå¾Œç«‹å³åŒæ­¥åˆ° Auth å¿«å–ï¼ˆåŠ å¼·ç‰ˆï¼‰
    if (window.Auth && Auth.setCharacter) {
      try { 
        var cleanData = JSON.parse(JSON.stringify(P));
        delete cleanData._live;
        Auth.setCharacter(cleanData); 
        console.log('âš”ï¸ æˆ°é¬¥çµæŸå¾ŒåŒæ­¥æˆåŠŸ - ç­‰ç´š:', P.level, 'æ°£è¡€:', P.hp.cur + '/' + P.hp.max);
      } catch(_e) {
        console.error('âŒ æˆ°é¬¥çµæŸå¾ŒåŒæ­¥å¤±æ•—:', _e);
      }
    }
    // â˜… ä¿®æ­£ï¼šæˆ°é¬¥çµæŸå­˜æª”å‰å…ˆæ¸…ç† _live
    var tempLive = P._live;  // æš«å­˜ _live
    delete P._live;          // ç§»é™¤ _live
    try{ await savePlayer(); }catch(_){}
    P._live = tempLive;      // æ¢å¾© _liveï¼ˆä¾›å¾ŒçºŒä½¿ç”¨ï¼‰


    setTimeout(function(){ leaveBattle(); }, 1200);
    }else if(battle.p.hp<=0){
    log('ä½ è¢«æ“Šå€’äº†â€¦ï¼ˆä¿ç•™ 1 é»æ°£è¡€ï¼‰', 'warn');
    battle.p.hp = 1;
    if (P && P.hp) {
      P.hp.cur = 1;
      P.hp.max = battle.p.hpMax || P.hp.max;
    }
    renderBars();
    
    // â˜… æˆ°é¬¥çµæŸå¾Œç«‹å³åŒæ­¥åˆ° Auth å¿«å–ï¼ˆåŠ å¼·ç‰ˆï¼‰
    if (window.Auth && Auth.setCharacter) {
      try { 
        var cleanData = JSON.parse(JSON.stringify(P));
        delete cleanData._live;
        Auth.setCharacter(cleanData); 
        console.log('âš”ï¸ æˆ°é¬¥çµæŸå¾ŒåŒæ­¥æˆåŠŸ - ç­‰ç´š:', P.level, 'æ°£è¡€:', P.hp.cur + '/' + P.hp.max);
      } catch(_e) {
        console.error('âŒ æˆ°é¬¥çµæŸå¾ŒåŒæ­¥å¤±æ•—:', _e);
      }
    }

    // â˜… ä¿®æ­£ï¼šæˆ°é¬¥çµæŸå­˜æª”å‰å…ˆæ¸…ç† _live
    var tempLive2 = P._live;  // æš«å­˜ _live
    delete P._live;           // ç§»é™¤ _live
    try{ await savePlayer(); }catch(_){}
    P._live = tempLive2;      // æ¢å¾© _liveï¼ˆä¾›å¾ŒçºŒä½¿ç”¨ï¼‰


    setTimeout(function(){ leaveBattle(); }, 1200);
  }
}


function finishBattle(){
  battle.over = true;
  if(loop){ clearInterval(loop); loop=null; }
  if(battle && Array.isArray(battle.dotTimers)){
    for(var i=0;i<battle.dotTimers.length;i++){ try{ clearInterval(battle.dotTimers[i]); }catch(e){} }
    battle.dotTimers.length = 0;
  }
  updateBattleBars(); updateCmdEnabled();
  qs('#btnLeaveBattle').style.display='none';
}

function leaveBattle(){
  qs('#battleSection').classList.remove('show');
  qs('#btnLeaveBattle').style.display='none';
  qs('#mapSection').style.display='grid';
  battle=null;
}

/* ===== Logï¼ˆåŒæ­¥å¯«å…¥åœ°åœ–ï¼†æˆ°é¬¥å…©é‚Šï¼‰ ===== */
function log(t, cls){
  const targets = [ qs('#logMap'), qs('#logBattle') ].filter(Boolean);
  for(const box of targets){
    const el = document.createElement('div');
    el.textContent = t;
    if (cls) el.classList.add(cls);
    box.appendChild(el);
    // â˜… è‹¥è¡Œæ•¸éå¤šï¼Œåˆªé™¤æœ€èˆŠçš„ï¼Œä»¥å…æ—¥èªŒéé•·
    while(box.childElementCount > 60){ box.removeChild(box.firstChild); }
    box.scrollTop = 1e9;
  }
}


/* ===== äº‹ä»¶ ===== */
qs('#btnBackHome').onclick = async function(){
  try{ if (P) { await savePlayer(); } }catch(e){}
  location.href = 'game.html';
};

/* â˜… æ–°å¢ï¼šé é¢é›¢é–‹/éš±è—æ™‚ä¹Ÿå¼·åˆ¶å­˜æª”ï¼Œé¿å…æ²’é»åˆ°ã€Œå›ä¸»åŸã€å°è‡´æ²’å­˜åˆ° */
addEventListener('pagehide', function(){
  try { 
    if (P && window.Auth && Auth.saveCharacter) { 
      var cleanData = JSON.parse(JSON.stringify(P));
      delete cleanData._live;
      Auth.saveCharacter(cleanData); 
    } 
  } catch(_){}
});
addEventListener('visibilitychange', function(){
  try { 
    if (document.visibilityState === 'hidden' && P && window.Auth && Auth.saveCharacter) { 
      var cleanData = JSON.parse(JSON.stringify(P));
      delete cleanData._live;
      Auth.saveCharacter(cleanData); 
    } 
  } catch(_){}
});


qs('#btnLogout').onclick = ()=>{ if(window.Auth && Auth.logout) Auth.logout(); location.href='index.html'; };

  qs('#btnEnter').onclick = ()=>{
    if(!curSmall){ log('è«‹å…ˆé¸æ“‡å‰¯åœ°åœ–ã€‚'); return; }
    entered = true;
    refreshLive();
    setLocBadge();
    updateActionPanel();
    log('å·²é€²å…¥ç•¶å‰å€åŸŸï¼Œå¯ä»¥é€²è¡Œã€Œæ¢éšª / æˆ°é¬¥ã€ã€‚','ok');
  };

  qs('#btnExplore').onclick = doExplore;
  qs('#btnFight').onclick   = startBattle;
// BOSS ç›´é€²æˆ°é¬¥ï¼ˆå®‰å…¨å–ç•¶å‰å°åœ°åœ–ï¼‰
qs('#btnBoss').onclick = function(){
  // æ‰¾åˆ°ç›®å‰çš„å°åœ°åœ–è³‡æ–™
  var big = null, s = null, i, j;
  for (i=0;i<MAPS.length;i++){
    if (MAPS[i].id === curBig){ big = MAPS[i]; break; }
  }
  if (big && big.small){
    for (j=0;j<big.small.length;j++){
      if (big.small[j].id === curSmall){ s = big.small[j]; break; }
    }
  }
  var bossId = s && s.boss;
  if (!bossId){ log('é€™å€æ²’æœ‰ BOSS'); return; }
  window.FORCE_MONSTER_ID = bossId; // äº¤çµ¦ startBattle èµ°æ—¢æœ‰æµç¨‹
  startBattle();
};




  qs('#actAttack').onclick = playerAttack;
  qs('#actSkill').onclick  = openSkillMenu; // â˜…æ–°å¢ï¼šæ‰“é–‹æŠ€èƒ½é¸å–®
  qs('#actItem').onclick   = useItem;
  qs('#actRun').onclick    = tryRun;

  qs('#btnLeaveBattle').onclick = leaveBattle;

// ====== æŠ€èƒ½ç³»çµ±å‡½æ•¸ ======
function getAvailableSkills(){
  // ä»¥ Game.getPlayer() å„ªå…ˆï¼Œå¦å‰‡ç”¨ P
  var pl = (window.Game && typeof Game.getPlayer === 'function') ? Game.getPlayer() : P;
  var out = new Set();

  function addId(raw){
    if(!raw) return;
    var s = String(raw).trim();
    if(!s) return;
    out.add(s);
  }
  function addFromArray(arr){
    for(var i=0;i<arr.length;i++){
      var v = arr[i];
      if(typeof v === 'string'){ addId(v); }
      else if(v && (v.id || v.skillId || v.key)){ addId(v.id || v.skillId || v.key); }
      else if(v && typeof v === 'object'){
        // å…¼å®¹ [{name:'xxx', id:'xxx'}] or [{sid:'xxx'}]
        addId(v.sid || v.name || v.title);
      }
    }
  }
  function addFromObject(obj){
    var ks = Object.keys(obj||{});
    for(var i=0;i<ks.length;i++){
      var k = ks[i]; var v = obj[k];
      var learned =
        v === true || v === 1 || v === '1' ||
        (v && (v.learned || v.unlocked || v.acquired || v.level > 0 || v.state === 'learned'));
      if(learned) addId(k);
      // å…¼å®¹ { k: { id:'xxx', learned:true } } çš„æ€ªæ ¼å¼
      if(v && (v.id || v.skillId) && (v.learned || v.unlocked || v.acquired || v.level > 0)){
        addId(v.id || v.skillId);
      }
    }
  }
  function collect(x){
    if(!x) return;
    if(Array.isArray(x)) return addFromArray(x);
    if(typeof x === 'string') return addId(x);
    if(typeof x === 'object') return addFromObject(x);
  }

  // ä¸»è¦ä¾†æº
  collect(pl && pl.skills);

  // å¸¸è¦‹åˆ¥å/å…¶ä»–å­˜æ”¾é»
  collect(pl && pl.skillsLearned);
  collect(pl && pl.skillsUnlocked);
  collect(pl && pl.skillSet);
  collect(pl && pl.skillMap);
  collect(pl && pl.skillIds);

  // å¤–è§€/è£å‚™å¯èƒ½æ›çš„åœ°æ–¹
  collect(pl && pl.appearance && pl.appearance.skills);
  collect(pl && pl.equip && pl.equip.skills);
  collect(pl && pl.equip && pl.equip.character && pl.equip.character.skills);

  // æœ€å¾Œè¼¸å‡ºå»é‡å¾Œçš„é™£åˆ—
  return Array.from(out);
}


function renderSkillsPanel(){
// ğŸ†• é‡å¤–åœ°åœ–æŠ€èƒ½é¸å–®åŒæ­¥å‡½æ•¸
// ç•¶å¤–è§€ç³»çµ±æ›´æ–°æŠ€èƒ½æ™‚æœƒå‘¼å«æ­¤å‡½æ•¸ï¼Œé‡æ–°æ•´ç†æŠ€èƒ½é¸å–®
console.log('ğŸ¯ é‡å¤–åœ°åœ–æŠ€èƒ½é¸å–®å·²åŒæ­¥æ›´æ–°');

// å¦‚æœç•¶å‰æœ‰æŠ€èƒ½é¸å–®é–‹å•Ÿï¼Œé‡æ–°æ¸²æŸ“
var existingMenu = document.querySelector('[data-skill-menu="true"]');
if (existingMenu) {
  try {
    document.body.removeChild(existingMenu);
    // å»¶é²ä¸€é»é‡æ–°é–‹å•Ÿï¼Œè®“ DOM æœ‰æ™‚é–“æ¸…ç†
    setTimeout(function() {
      if (battle && !battle.over && battle.p && battle.p.atb >= ATB_MAX) {
        openSkillMenu();
      }
    }, 100);
  } catch(_) {}
}
}


  // ====== æŠ€èƒ½é¸å–®ï¼ˆå‹•æ…‹å»ºç«‹è¦†è“‹å±¤ï¼‰======

function openSkillMenu(){
  if(!battle || battle.over){ return; }
  // ğŸ†• èˆ‡ updateCmdEnabled çš„é‚è¼¯ä¸€è‡´ï¼šå¿…é ˆæ»¿ ATB_MAX æ‰èƒ½è¡Œå‹•/é–‹å–®
  if(!(battle.p && typeof ATB_MAX === 'number' && battle.p.atb >= ATB_MAX)){
    log('å°šæœªè¼ªåˆ°ä½ è¡Œå‹•'); 
    return;
  }

    var skills = getAvailableSkills();
    // å»ºç«‹è¦†è“‹å±¤ï¼ˆæ²¿ç”¨ useItem çš„ç°¡æ˜“æ¨£å¼é¢¨æ ¼ï¼‰
    var menu = document.createElement('div');
    menu.style.position='fixed';
    menu.style.left='0'; menu.style.top='0';
    menu.style.right='0'; menu.style.bottom='0';
    menu.style.zIndex='9999';
    menu.setAttribute('data-skill-menu', 'true');

    var mask = document.createElement('div');
    mask.style.position='absolute'; mask.style.left='0'; mask.style.top='0';
    mask.style.right='0'; mask.style.bottom='0'; mask.style.background='rgba(0,0,0,0.4)';
    menu.appendChild(mask);

    var sheet = document.createElement('div');
    sheet.style.position='absolute';
    sheet.style.left='50%'; sheet.style.top='50%';
    sheet.style.transform='translate(-50%,-50%)';
    sheet.style.width='min(680px, 92vw)';
    sheet.style.maxHeight='70vh';
    sheet.style.overflow='auto';
    sheet.style.background='#111';
    sheet.style.border='1px solid #333';
    sheet.style.borderRadius='10px';
    sheet.style.boxShadow='0 10px 30px rgba(0,0,0,0.5)';
    sheet.style.padding='8px 10px';
    menu.appendChild(sheet);

    var title = document.createElement('div');
    title.textContent='é¸æ“‡æŠ€èƒ½';
    title.style.fontWeight='bold';
    title.style.fontSize='18px';
    title.style.padding='6px 2px 10px';
    sheet.appendChild(title);

    var box = document.createElement('div');
    sheet.appendChild(box);

    if(!skills.length){
      var row = document.createElement('div');
      row.textContent='å°šæœªå­¸æœƒä»»ä½•æŠ€èƒ½';
      row.style.textAlign='center'; row.style.padding='16px';
      box.appendChild(row);
    }else{
      for(var i=0;i<skills.length;i++){
        var sid = skills[i];
        var sk = null;
        if(window.SkillDB && typeof SkillDB.get === 'function'){
          var key = String(sid).trim();
          sk = SkillDB.get(key) || SkillDB.get(key.toLowerCase()) || SkillDB.get(key.toUpperCase());
        }
        if(!sk){
          console.warn('[skills] æ‰¾ä¸åˆ°æŠ€èƒ½å®šç¾©ï¼š', sid);
          continue;
        }

        // ğŸ†• æª¢æŸ¥æŠ€èƒ½ä¾†æºä¸¦æ·»åŠ æ¨™è¨˜
        var skillSource = '';
        if (P && P.skills && typeof P.skills === 'object' && P.skills[sid] && P.skills[sid].source === 'appearance') {
          skillSource = 'ï¼ˆå¤–è§€æŠ€èƒ½ï¼‰';
        }


        var row = document.createElement('div');
        row.style.display='grid';
        row.style.gridTemplateColumns='60px 1fr 90px';
        row.style.gridGap='10px';
        row.style.alignItems='center';
        row.style.padding='8px';
        row.style.border='1px solid #222';
        row.style.borderRadius='8px';
        row.style.margin='6px 0';
        row.style.background='#0b0b0b';

        // åœ–ç¤º
        var ico = document.createElement('div');
        ico.style.width='60px'; ico.style.height='60px';
        ico.style.borderRadius='8px'; ico.style.background='#1a1a1a';
        ico.style.display='flex'; ico.style.alignItems='center'; ico.style.justifyContent='center';
        if(sk.icon){
          var im = document.createElement('img'); im.src=sk.icon; im.alt=sk.name||sid;
          im.style.maxWidth='60px'; im.style.maxHeight='60px';
          ico.appendChild(im);
        }else{
          ico.textContent='æŠ€';
        }
        row.appendChild(ico);

        // æ–‡å­—
        var main = document.createElement('div');
        var nm = document.createElement('div');
        nm.textContent = (sk.name||sid);
        nm.style.fontWeight='bold'; nm.style.fontSize='16px';
        main.appendChild(nm);

        var sub = document.createElement('div');
        var elemText = (window.ELEMENT_LABEL && sk.elem) ? (ELEMENT_LABEL[sk.elem] || sk.elem) : '';
        var desc = (sk.desc || '') + (elemText ? ('ã€€[å±¬æ€§ï¼š' + elemText + ']') : '') + skillSource;
        sub.textContent = desc;
        sub.style.opacity='0.85';
        sub.style.fontSize='13px';
        sub.style.marginTop='4px';
        main.appendChild(sub);
        row.appendChild(main);

        // æ“ä½œ
        var ops = document.createElement('div');
        var btn = document.createElement('button');
        btn.textContent='æ–½ æ”¾ï¼ˆMP ' + (sk.mp||0) + 'ï¼‰';
        btn.className='btn primary';
        btn.style.width='100%';
        btn.setAttribute('data-skill', sid);
        ops.appendChild(btn);
        row.appendChild(ops);

        box.appendChild(row);
      }
    }

    // é»ç©ºç™½æˆ–å³ä¸Šè§’é—œé–‰
    mask.addEventListener('click', function(){ try{ document.body.removeChild(menu); }catch(_){ } });

    // é»ã€Œæ–½æ”¾ã€
    sheet.addEventListener('click', function(e){
      var t = e.target || e.srcElement;
      var b = null;
      while(t && t !== sheet){
        if(t.getAttribute && t.getAttribute('data-skill')){ b=t; break; }
        t = t.parentNode;
      }
      if(!b) return;
      var sid = b.getAttribute('data-skill');
      var ok  = useSkill(sid);
      if(ok){ try{ document.body.removeChild(menu); }catch(_){ } }
    });

    document.body.appendChild(menu);
  }

  /* === æŠ€èƒ½æ©«å¹…ï¼šæ–½æ”¾æ™‚é¡¯ç¤ºé€æ˜è­¦ç¤ºï¼†ç•«é¢è¼•å¾®æ»‘å‹• === */
function showSkillBanner(skillName, elemKey){
  try{
    // é¢¨æ ¼ï¼šå…ƒç´ ä¸­æ–‡å
    var elabel = (window.ELEMENT_LABEL && ELEMENT_LABEL[elemKey]) ? ELEMENT_LABEL[elemKey] : 'ç„¡';
    // å¤–å±¤
    var host = document.createElement('div');
    host.className = 'skill-banner';
    host.innerHTML =
      '<div class="wrap">'+
        '<div class="title">ä½¿ å‡º æŠ€ èƒ½</div>'+
        '<div class="name">'+ (skillName||'â€”') +'</div>'+
        '<div class="elem-pill '+(elemKey||'none')+'">'+ elabel +'</div>'+
      '</div>';
    document.body.appendChild(host);

    // ç•«é¢æ»‘å‹•ï¼ˆç›¸æ©Ÿå¾®ç§»ï¼‰
    var app = document.querySelector('.app');
    if(app){ app.classList.add('pan'); setTimeout(function(){ app.classList.remove('pan'); }, 420); }

    // è‡ªå‹•ç§»é™¤
    setTimeout(function(){ try{ document.body.removeChild(host); }catch(_){ } }, 950);
  }catch(_){}
}


// ====== æ–½æ”¾æŠ€èƒ½ï¼ˆæ‰£ MPã€è¨ˆç®—å‚·å®³ã€é€²å…¥æ•µæ–¹å›åˆï¼‰======
function useSkill(sid){
  if(!battle || battle.over) return false;
  if(!(battle.p && battle.p.atb >= ATB_MAX)){ log('å°šæœªè¼ªåˆ°ä½ è¡Œå‹•'); return false; }

  var sk  = (window.SkillDB && SkillDB.get) ? SkillDB.get(sid) : null;
  if(!sk){ log('æœªçŸ¥æŠ€èƒ½ï¼š' + sid, 'warn'); return false; }

  // â”€â”€ MPï¼ˆçœŸå…ƒï¼‰æª¢æŸ¥
  var need = sk.mp || 0;
  var curMp = 0, mpMax = 0;
  if (P && P.mp && typeof P.mp === 'object') {
    curMp = +((P.mp.cur!=null)?P.mp.cur:0);
    mpMax = +((P.mp.max!=null)?P.mp.max:0);
  } else if (P && typeof P.mp === 'number') {
    curMp = P.mp|0;
    mpMax = Math.max(curMp, mpMax|0);
    P.mp = { cur: curMp, max: mpMax||curMp };
  }

  if(curMp < need){ log('çœŸå…ƒä¸è¶³ï¼ˆéœ€è¦ ' + need + 'ï¼‰','warn'); return false; }

  // â”€â”€ æ‰£é™¤ MP
  var after = Math.max(0, curMp - need);
  if (P && P.mp && typeof P.mp === 'object') {
    P.mp.cur = after;
    if (mpMax > 0) P.mp.max = mpMax;
  }
  if (battle.p){
    battle.p.mp = after;
    if (typeof battle.p.mpMax === 'number' && mpMax > 0) battle.p.mpMax = mpMax;
  }

  // â˜… æŠ€èƒ½æ©«å¹…ï¼ˆé€æ˜è­¦ç¤ºï¼‹ç•«é¢æ»‘å‹•ï¼‰
  if (typeof showSkillBanner === 'function') {
    showSkillBanner(sk.name, sk.elem);
  }


  // â”€â”€ ğŸ”¥ ç°¡åŒ–çš„æŠ€èƒ½å‚·å®³è¨ˆç®—ï¼ˆåªç”¨å¨åŠ›ï¼‰
  if (!P._live) refreshLive();
  var baseDamage = P._live['ç‰©ç†æ”»æ“Š'] || 10;

  // æŠ€èƒ½å¨åŠ›ç›´æ¥ä½œç‚ºå€ç‡ä½¿ç”¨
  var skillMultiplier = (sk.power || 100) / 100; // 120 -> 1.2å€ï¼Œ150 -> 1.5å€

  // è¨ˆç®—æŠ€èƒ½å‚·å®³
  var skillDamage = baseDamage * skillMultiplier;

  // æš´æ“Šåˆ¤å®š (10% æ©Ÿç‡)
  var isCrit = Math.random() < 0.1;
  if (isCrit) {
    skillDamage *= 1.5;
  }

  // éš¨æ©Ÿè®Šå‹• (Â±20%)
  var dmg = Math.max(1, Math.floor(skillDamage * (0.8 + Math.random() * 0.4)));

  // é€ æˆå‚·å®³
  battle.e.hp = Math.max(0, (battle.e.hp|0) - dmg);

  // é¡¯ç¤ºæˆ°é¬¥è¨Šæ¯
  var name = sk.name || sid;
  var criticalText = isCrit ? 'ï¼ˆæš´æ“Šï¼‰' : '';
  log('ä½ æ–½æ”¾ã€' + name + 'ã€‘å° ' + (battle.e.name||'æ•µäºº') + ' é€ æˆ ' + dmg + ' é»å‚·å®³' + criticalText + 'ã€‚');

  // â˜…é›·è½é¡å¤–æ•ˆæœï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰
  if(sid === 'thunder_drop' && P && P.element === 'spirit'){
    var heal = 20;
    var maxHp = (battle.p && battle.p.hpMax) ? battle.p.hpMax : ((P.hp && P.hp.max) ? P.hp.max : 0);
    var curHp = (battle.p && typeof battle.p.hp === 'number') ? battle.p.hp : ((P.hp && P.hp.cur) ? P.hp.cur : 0);
    curHp = Math.min(maxHp, curHp + heal);
    if(battle.p) battle.p.hp = curHp;
    if(P && P.hp){ P.hp.cur = curHp; P.hp.max = maxHp; }
    log('é›·è½è¿½åŠ æ•ˆæœï¼šä½ å›å¾© ' + heal + ' é»æ°£è¡€ã€‚','ok');
  }

  // é‡ç½®æˆ‘æ–¹ ATBï¼Œè¼ªåˆ°æ•µæ–¹
  battle.p.atb = 0;
  updateBattleBars();
  if(battle.e.hp <= 0){ endCheck(); return true; }

  setTimeout(function(){ enemyAttack(); }, 400);
  return true;
}


/* ===== å•Ÿå‹•ï¼ˆä»¥ API ç‚ºä¸»ï¼Œå¿…è¦æ™‚ç”¨æœ¬åœ°è¼ƒæ–°å¿«å–ï¼‰===== */
window.addEventListener('DOMContentLoaded', async function(){
  // 1) ç™»å…¥æª¢æŸ¥
  var user = (window.Auth && Auth.currentUser) ? Auth.currentUser() : null;
  if(!user){ location.href = 'index.html'; return; }

  // 2) è®€é›²ç«¯è§’è‰²
  var char = null;
  try{
    char = (window.Auth && Auth.loadCharacter) ? (await Auth.loadCharacter()) : null;
  }catch(e){
    char = null;
  }

  // 3) è‹¥æœ¬åœ°å¿«å–è¼ƒæ–° â†’ å„ªå…ˆç”¨æœ¬åœ°ï¼ˆé¿å…å‰›åœ¨ä¸»åŸå­˜æª”å°šæœªåŒæ­¥ï¼‰
  var cached = (window.Auth && Auth.getCharacter) ? Auth.getCharacter() : null;
  if (cached){
    var useCached = false;
    if (!char){ useCached = true; }
    else{
      var t1 = (cached && cached._updatedAt) ? cached._updatedAt : 0;
      var t2 = (char   && char._updatedAt)   ? char._updatedAt   : 0;
      if (t1 > t2){ useCached = true; }
    }
    if (useCached){ char = cached; }
  }

  if(!char){ location.href = 'index.html#create'; return; }

  // 4) ä»¥ API ç‚ºä¸»ï¼šæŠŠè³‡æ–™å¯«å…¥å…¨åŸŸ Pï¼Œåœ°åœ–ä¸Šæ‰€æœ‰é¡¯ç¤ºéƒ½è®€ P
  P = char;

  // 5) æ›è£å‚™æ¨¡çµ„ï¼ˆæ­¤æ™‚ P å·²å¯ç”¨ï¼‰
  if (window.Equip && Equip.mount) {
    Equip.mount({
      getPlayer: function(){ return P; },
      save:      function(){ try{ if (window.Auth && Auth.saveCharacter && P){ var cleanData = JSON.parse(JSON.stringify(P)); delete cleanData._live; Auth.saveCharacter(cleanData); } }catch(_){ } },
      recalc:    function(){ try{ renderHeader(); renderBars(); }catch(_){} },
      log:       function(t){ try{ console.log(t); }catch(_){} }
    });
  }

  // 6) å•Ÿå‹•å¾Œç¬¬ä¸€æ¬¡æ¸²æŸ“
  console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆ - è§’è‰²ç‹€æ…‹:', {
    level: P.level,
    exp: P.exp,
    hp: P.hp,
    sta: P.sta,
    currencies: P.currencies
  });
  
  renderHeader();
  refreshLive();
  renderBars();
  buildMapUI();
  setLocBadge();
  updateActionPanel();

});



</script>
</body>
</html>